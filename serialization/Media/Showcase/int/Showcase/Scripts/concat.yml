---
ID: "671326f6-a42b-4c7c-8988-8b804c8390e8"
Parent: "f96e1925-a3cc-4752-b969-70feb5b5d696"
Template: "962b53c4-f93b-4df9-9821-415c867b8903"
Path: /sitecore/media library/Project/Showcase/int/Showcase/Scripts/concat
DB: master
SharedFields:
- ID: "06d5295c-ed2f-4a54-9bf2-26228d113318"
  Hint: __Icon
  Value: "-/media/671326F6A42B4C7C89888B804C8390E8.ashx?h=16&thn=1&w=16"
- ID: "40e50ed9-ba07-4702-992e-a912738d32dc"
  Hint: Blob
  BlobID: "a5cc358e-60f9-4b1f-8c77-5be646d87847"
  Value: WEEuY29tcG9uZW50LmFjY29yZGlvbnMgPSAoZnVuY3Rpb24gKCQpIHsNCiAgICB2YXIgcHViID0ge307DQoNCiAgICBmdW5jdGlvbiBwYWdlRWRpdG9yKCkgew0KICAgICAgICBpZiAoJCgnYm9keScpLmhhc0NsYXNzKCdvbi1wYWdlLWVkaXRvcicpKSB7DQogICAgICAgICAgICBTaXRlY29yZS5QYWdlTW9kZXMuQ2hyb21lTWFuYWdlci5yZXNldENocm9tZXMoKTsgLy9wYWdlIGVkaXRvciBsaW5lcyBmaXgNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIHZhciB0b29nbGVFdmVudHMgPSB7DQogICAgICAgIGZvY3VzOiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJzaG93Iik7DQogICAgICAgIH0sDQogICAgICAgIGJsdXI6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICQodGhpcykucmVtb3ZlQ2xhc3MoInNob3ciKTsNCiAgICAgICAgfQ0KICAgIH07DQoNCiAgICBmdW5jdGlvbiBoZWFkZXJCYWNrZ3JvdW5kKGhlYWRlcikgew0KICAgICAgICB2YXIgYmFja2dyb3VuZEljb24gPSAkKGhlYWRlciksDQogICAgICAgICAgICBiYWNrZ3JvdW5kID0gJChoZWFkZXIpLmZpbmQoJ2ltZycpLA0KICAgICAgICAgICAgYmFja2dyb3VuZFNyYyA9IGJhY2tncm91bmQuYXR0cignc3JjJyk7DQoNCiAgICAgICAgaWYgKGJhY2tncm91bmRTcmMpIHsNCiAgICAgICAgICAgIGJhY2tncm91bmRJY29uLnBhcmVudHMoJy5hY2NvcmRpb24nKS5hZGRDbGFzcygnYWNjb3JkaW9uLWltYWdlJyk7DQoNCiAgICAgICAgICAgIGJhY2tncm91bmRJY29uLmNzcyh7DQogICAgICAgICAgICAgICAgJ2JhY2tncm91bmQnOiAndXJsKCcgKyBiYWNrZ3JvdW5kU3JjICsgJyknLA0KICAgICAgICAgICAgICAgICdiYWNrZ3JvdW5kLXJlcGVhdCc6ICduby1yZXBlYXQnLA0KICAgICAgICAgICAgICAgICdiYWNrZ3JvdW5kLXNpemUnOiAnY292ZXInLA0KICAgICAgICAgICAgICAgICdiYWNrZ3JvdW5kLXBvc2l0aW9uJzogJzUwJSAxMDAlJw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIGJhY2tncm91bmQuaGlkZSgpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgZnVuY3Rpb24gY2FsY1NsaWRlU2l6ZShhY2MpIHsNCiAgICAgICAgdmFyIGFjY29yZGlvbldpZHRoID0gJChhY2MpLndpZHRoKCksDQogICAgICAgICAgICBhY2NvcmRpb25JdGVtcyA9ICQoYWNjKS5maW5kKCcuaXRlbScpLA0KICAgICAgICAgICAgbWF4SGVpZ2h0ID0gMDsNCg0KICAgICAgICBfLmVhY2goYWNjb3JkaW9uSXRlbXMsIGZ1bmN0aW9uIChpdGVtKSB7DQogICAgICAgICAgICB2YXIgaXRlbUNvbnRlbnQgPSAkKGl0ZW0pLmZpbmQoJy50b2dnbGUtY29udGVudCcpLA0KICAgICAgICAgICAgICAgIGl0ZW1IZWFkZXIgPSAkKGl0ZW0pLmZpbmQoJy50b2dnbGUtaGVhZGVyJyksDQogICAgICAgICAgICAgICAgc2xpZGVXaWR0aCA9IGFjY29yZGlvbldpZHRoIC0gKGFjY29yZGlvbkl0ZW1zLmxlbmd0aCAqIGl0ZW1IZWFkZXIub3V0ZXJXaWR0aCgpKTsNCg0KICAgICAgICAgICAgaWYgKCQoaXRlbSkuaGFzQ2xhc3MoJ2FjdGl2ZScpKSB7DQogICAgICAgICAgICAgICAgJChpdGVtKS5jc3Moew0KICAgICAgICAgICAgICAgICAgICAnd2lkdGgnOiBzbGlkZVdpZHRoDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vd2lkdGgNCiAgICAgICAgICAgIGl0ZW1Db250ZW50LmNzcyh7DQogICAgICAgICAgICAgICAgJ3dpZHRoJzogKCQoYWNjKS5oYXNDbGFzcygnYWNjb3JkaW9uLWltYWdlJykpID8gc2xpZGVXaWR0aCArIGl0ZW1IZWFkZXIub3V0ZXJXaWR0aCgpIDogc2xpZGVXaWR0aCAtIGl0ZW1IZWFkZXIub3V0ZXJXaWR0aCgpIC0gcGFyc2VJbnQoaXRlbUhlYWRlci5jc3MoJ3BhZGRpbmcnKSkNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAvL2hlaWdodA0KICAgICAgICAgICAgaWYgKCQoaXRlbSkuZmluZCgnLnRvZ2dsZS1jb250ZW50JykuaGVpZ2h0KCkgPiBtYXhIZWlnaHQpIHsNCiAgICAgICAgICAgICAgICBtYXhIZWlnaHQgPSAkKGl0ZW0pLmZpbmQoJy50b2dnbGUtY29udGVudCcpLmhlaWdodCgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBhbmltYXRlSG9yaXpvbnRhbChwcm9wZXJ0aWVzKSB7DQogICAgICAgIHZhciBhY2NvcmRpb24gPSAkKHRoaXMpLnBhcmVudHMoJy5hY2NvcmRpb24nKSwNCiAgICAgICAgICAgIHBhbmVsID0gJCh0aGlzKS5wYXJlbnQoKSwNCiAgICAgICAgICAgIGhlYWRlciA9IHBhbmVsLmZpbmQoJy50b2dnbGUtaGVhZGVyJyksDQogICAgICAgICAgICBjb250ZW50ID0gcGFuZWwuZmluZCgnLnRvZ2dsZS1jb250ZW50JyksDQogICAgICAgICAgICBzaWJsaW5ncyA9IHBhbmVsLnNpYmxpbmdzKCksDQogICAgICAgICAgICBzaWJsaW5nc0NvbnRlbnQgPSBzaWJsaW5ncy5maW5kKCcudG9nZ2xlLWNvbnRlbnQnKTsNCg0KICAgICAgICBzaWJsaW5ncy5zdG9wKHRydWUpLmFuaW1hdGUoew0KICAgICAgICAgICAgIndpZHRoIjogMA0KICAgICAgICB9LCBwcm9wZXJ0aWVzLnNwZWVkLCBwcm9wZXJ0aWVzLmVhc2luZywgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgc2libGluZ3NDb250ZW50LmNzcyh7DQogICAgICAgICAgICAgICAgImRpc3BsYXkiOiAibm9uZSINCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9KTsNCg0KICAgICAgICBpZiAocGFuZWwuaGFzQ2xhc3MoJ2FjdGl2ZScpKSB7DQoNCiAgICAgICAgICAgIHZhciBzbGlkZVdpZHRoID0gYWNjb3JkaW9uLmhhc0NsYXNzKCdhY2NvcmRpb24taW1hZ2UnKSA/IGNvbnRlbnQub3V0ZXJXaWR0aCgpIDogY29udGVudC5vdXRlcldpZHRoKCkgLSBwYW5lbC5vdXRlcldpZHRoKCksDQogICAgICAgICAgICAgICAgY29udGVudFdpZHRoID0gYWNjb3JkaW9uLmhhc0NsYXNzKCdhY2NvcmRpb24taW1hZ2UnKSA/IHNsaWRlV2lkdGggOiBzbGlkZVdpZHRoIC0gaGVhZGVyLm91dGVyV2lkdGgoKTsNCg0KICAgICAgICAgICAgcGFuZWwuc3RvcCh0cnVlKS5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAid2lkdGgiOiBzbGlkZVdpZHRoDQogICAgICAgICAgICB9LCBwcm9wZXJ0aWVzLnNwZWVkLCBwcm9wZXJ0aWVzLmVhc2luZywgZnVuY3Rpb24oKSB7DQoNCiAgICAgICAgICAgIH0pOw0KDQoNCiAgICAgICAgICAgIGNvbnRlbnQuY3NzKHsNCiAgICAgICAgICAgICAgICAid2lkdGgiIDogY29udGVudFdpZHRoLA0KICAgICAgICAgICAgICAgICJkaXNwbGF5IjogImJsb2NrIg0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgfSBlbHNlIHsNCg0KICAgICAgICAgICAgcGFuZWwuc3RvcCh0cnVlKS5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAid2lkdGgiOiAwDQogICAgICAgICAgICB9LCBwcm9wZXJ0aWVzLnNwZWVkLCBwcm9wZXJ0aWVzLmVhc2luZywgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIGNvbnRlbnQuY3NzKHsNCiAgICAgICAgICAgICAgICAgICAgImRpc3BsYXkiOiAibm9uZSINCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgZnVuY3Rpb24gYWNjb3JkaW9uKGFjYywgcHJvcGVydGllcykgew0KICAgICAgICB2YXIgZXYgPSAnY2xpY2snLA0KICAgICAgICAgICAgJGJvZHkgPSAkKCdib2R5JyksDQogICAgICAgICAgICB0b2dnbGVIZWFkZXIgPSBhY2MuZmluZCgnLnRvZ2dsZS1oZWFkZXInKTsNCg0KICAgICAgICBpZiAocHJvcGVydGllcy5leHBhbmRPbkhvdmVyKSB7DQogICAgICAgICAgICBpZighJGJvZHkuaGFzQ2xhc3MoJ29uLXBhZ2UtZWRpdG9yJykpIHsNCiAgICAgICAgICAgICAgICBldiA9ICdtb3VzZWVudGVyJzsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgZXYgPSAnY2xpY2snOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgIH0NCg0KICAgICAgICB0b2dnbGVIZWFkZXIub24oIm1vdXNlb3ZlciIsIHRvb2dsZUV2ZW50cy5mb2N1cyk7DQogICAgICAgIHRvZ2dsZUhlYWRlci5vbigibW91c2VsZWF2ZSIsIHRvb2dsZUV2ZW50cy5ibHVyKTsNCiAgICAgICAgdG9nZ2xlSGVhZGVyLm9uKCJmb2N1cyIsIHRvb2dsZUV2ZW50cy5mb2N1cyk7DQogICAgICAgIHRvZ2dsZUhlYWRlci5vbigiYmx1ciIsIHRvb2dsZUV2ZW50cy5ibHVyKTsNCiAgICAgICAgdG9nZ2xlSGVhZGVyLm9uKCJrZXl1cCIsIGZ1bmN0aW9uIChlKSB7DQogICAgICAgICAgICBpZiAoZS5rZXlDb2RlID09IDEzKSB7DQogICAgICAgICAgICAgICAgJCh0aGlzKS5jbGljaygpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCg0KDQogICAgICAgIGlmIChhY2MuaGFzQ2xhc3MoJ2FjY29yZGlvbi1ob3Jpem9udGFsJykpIHsNCiAgICAgICAgICAgIC8vY2FsYyBzbGlkZSB3aWR0aA0KICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICBjYWxjU2xpZGVTaXplKGFjYyk7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgXy5lYWNoKHRvZ2dsZUhlYWRlciwgZnVuY3Rpb24oaGVhZGVyKSB7DQogICAgICAgICAgICAgICAgaGVhZGVyQmFja2dyb3VuZChoZWFkZXIpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgdG9nZ2xlSGVhZGVyLm9uKGV2LCBmdW5jdGlvbiAoZSkgew0KICAgICAgICAgICAgdmFyIGFjY29yZGlvbiA9ICQodGhpcykucGFyZW50cygnLmFjY29yZGlvbicpLA0KICAgICAgICAgICAgICAgIHBhbmVsID0gJCh0aGlzKS5wYXJlbnQoKSwNCiAgICAgICAgICAgICAgICAkYm9keSA9ICQoJ2JvZHknKSwNCiAgICAgICAgICAgICAgICBjb250ZW50ID0gcGFuZWwuZmluZCgnLnRvZ2dsZS1jb250ZW50JyksDQogICAgICAgICAgICAgICAgc2libGluZ3MgPSBwYW5lbC5zaWJsaW5ncygpLA0KICAgICAgICAgICAgICAgIHNpYmxpbmdzQ29udGVudCA9IHNpYmxpbmdzLmZpbmQoJy50b2dnbGUtY29udGVudCcpLA0KICAgICAgICAgICAgICAgIHRpbWVvdXRJZDsNCg0KICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIHBhZ2VFZGl0b3IoKTsNCiAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgIGlmICghcHJvcGVydGllcy5leHBhbmRPbkhvdmVyKSB7DQogICAgICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMuY2FuT3Blbk11bHRpcGxlKSB7DQogICAgICAgICAgICAgICAgICAgIHBhbmVsLnRvZ2dsZUNsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICAgICAgY29udGVudC5zdG9wKCkuc2xpZGVUb2dnbGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBwcm9wZXJ0aWVzLnNwZWVkLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVhc2luZzogcHJvcGVydGllcy5lYXNpbmcNCiAgICAgICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayk7DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMuY2FuVG9nZ2xlKSB7DQoNCg0KICAgICAgICAgICAgICAgICAgICAgICAgc2libGluZ3MucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOw0KDQogICAgICAgICAgICAgICAgICAgICAgICBwYW5lbC50b2dnbGVDbGFzcygnYWN0aXZlJyk7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhY2NvcmRpb24uaGFzQ2xhc3MoImFjY29yZGlvbi1ob3Jpem9udGFsIikpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2FuaW1hdGlvbiBmb3IgaG9yaXpvbnRhbCBhY2NvcmRpb24NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmltYXRlSG9yaXpvbnRhbC5jYWxsKHRoaXMsIHByb3BlcnRpZXMpOw0KDQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpYmxpbmdzQ29udGVudC5zdG9wKCkuc2xpZGVVcCh7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogcHJvcGVydGllcy5zcGVlZCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVhc2luZzogcHJvcGVydGllcy5lYXNpbmcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2spOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudC5zdG9wKCkuc2xpZGVUb2dnbGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IHByb3BlcnRpZXMuc3BlZWQsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlYXNpbmc6IHByb3BlcnRpZXMuZWFzaW5nDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICBzaWJsaW5ncy5yZW1vdmVDbGFzcygnYWN0aXZlJyk7DQogICAgICAgICAgICAgICAgICAgICAgICBzaWJsaW5nc0NvbnRlbnQuc2xpZGVVcCh7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBwcm9wZXJ0aWVzLnNwZWVkLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlYXNpbmc6IHByb3BlcnRpZXMuZWFzaW5nDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayk7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIHBhbmVsLmFkZENsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQuc2xpZGVEb3duKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IHByb3BlcnRpZXMuc3BlZWQsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVhc2luZzogcHJvcGVydGllcy5lYXNpbmcNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICBpZiAocHJvcGVydGllcy5jYW5Ub2dnbGUpIHsNCiAgICAgICAgICAgICAgICAgICAgcGFuZWwudW5iaW5kKCdtb3VzZWxlYXZlJyk7DQoNCiAgICAgICAgICAgICAgICAgICAgaWYgKCEkYm9keS5oYXNDbGFzcygnb24tcGFnZS1lZGl0b3InKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgcGFuZWwub24oJ21vdXNlbGVhdmUnLCBmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFuZWwucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50LnN0b3AoKS5zbGlkZVVwKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogcHJvcGVydGllcy5zcGVlZCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlYXNpbmc6IHByb3BlcnRpZXMuZWFzaW5nDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2spOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMzAwKTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAkYm9keS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFuZWwucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50LnN0b3AoKS5zbGlkZVVwKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogcHJvcGVydGllcy5zcGVlZCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlYXNpbmc6IHByb3BlcnRpZXMuZWFzaW5nDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2spOw0KDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMzAwKTsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KDQoNCiAgICAgICAgICAgICAgICAgICAgY29udGVudC51bmJpbmQoJ21vdXNlZW50ZXInKTsNCiAgICAgICAgICAgICAgICAgICAgY29udGVudC5vbignbW91c2VlbnRlcicsIGZ1bmN0aW9uIChldmVudCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIHNpYmxpbmdzLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICBzaWJsaW5nc0NvbnRlbnQuc3RvcCgpLnNsaWRlVXAoew0KICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IHByb3BlcnRpZXMuc3BlZWQsDQogICAgICAgICAgICAgICAgICAgICAgICBlYXNpbmc6IHByb3BlcnRpZXMuZWFzaW5nDQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKTsNCg0KICAgICAgICAgICAgICAgIHBhbmVsLmFkZENsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICBjb250ZW50LnNsaWRlRG93bih7DQogICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogcHJvcGVydGllcy5zcGVlZCwNCiAgICAgICAgICAgICAgICAgICAgICAgIGVhc2luZzogcHJvcGVydGllcy5lYXNpbmcNCiAgICAgICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2spOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9DQoNCiAgICBwdWIuaW5pdCA9IGZ1bmN0aW9uIChzZWxlY3RvciwgcHJvcGVydGllcykgew0KICAgICAgICB2YXIgYWNjb3JkaW9ucyA9ICQoJy5hY2NvcmRpb246bm90KC5pbml0aWFsaXplZCksIC50b2dnbGU6bm90KC5pbml0aWFsaXplZCknKTsNCg0KICAgICAgICBhY2NvcmRpb25zLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSAkKHRoaXMpLmRhdGEoJ3Byb3BlcnRpZXMnKSwNCiAgICAgICAgICAgICAgICBhY2MgPSAkKHRoaXMpOw0KDQogICAgICAgICAgICBpZiAoJCh0aGlzKS5oYXNDbGFzcygndG9nZ2xlJykpIHsNCiAgICAgICAgICAgICAgICAkLmV4dGVuZChwcm9wZXJ0aWVzLCB7DQogICAgICAgICAgICAgICAgICAgICdjYW5Ub2dnbGUnOiB0cnVlLA0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBhY2MuZmluZCgnLnRvZ2dsZS1jb250ZW50JykuaGlkZSgpOw0KICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMuZXhwYW5kZWRCeURlZmF1bHQpIHsNCiAgICAgICAgICAgICAgICBhY2MuZmluZCgnbGk6Zmlyc3QtY2hpbGQnKS5hZGRDbGFzcygnYWN0aXZlJyk7DQogICAgICAgICAgICAgICAgYWNjLmZpbmQoJ2xpOmZpcnN0LWNoaWxkJykuZmluZCgnLnRvZ2dsZS1jb250ZW50Jykuc2hvdygpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBhY2NvcmRpb24oYWNjLCBwcm9wZXJ0aWVzKTsNCiAgICAgICAgICAgIGFjYy5hZGRDbGFzcygnaW5pdGlhbGl6ZWQnKTsNCiAgICAgICAgfSk7DQogICAgfTsNCg0KICAgIHJldHVybiBwdWI7DQoNCn0oalF1ZXJ5KSk7DQoNClhBLnJlZ2lzdGVyKCdhY2NvcmRpb25zJywgWEEuY29tcG9uZW50LmFjY29yZGlvbnMpOw0KWEEuY29tcG9uZW50LmFyY2hpdmUgPSAoZnVuY3Rpb24gKCQsIF8pIHsNCgl2YXIgYXBpID0ge307DQoJDQoJdmFyIHRvZ2dsZUNsaWNrID0gZnVuY3Rpb24oYXJncyl7DQoJCXZhciBncm91cEhlYWRlciA9ICQoYXJncy50YXJnZXQpOw0KCQlncm91cEhlYWRlci5zaWJsaW5ncygidWwiKS50b2dnbGUoKTsNCgl9Ow0KCQ0KCWFwaS5pbml0ID0gZnVuY3Rpb24oKXsNCgkJdmFyIGFyY2hpdmVzID0gJCgiLnplbi1hcmNoaXZlOm5vdCguaW5pdGlhbGl6ZWQpIiksDQoJCQl0b2dnbGVzLA0KCQkJYXJjaGl2ZTsNCgkJCQ0KCQlmb3IodmFyIGk9MCxsPWFyY2hpdmVzLmxlbmd0aDtpPGw7aSsrKXsNCgkJCWFyY2hpdmUgPSAkKGFyY2hpdmVzW2ldKTsNCgkJCXRvZ2dsZXMgPSBhcmNoaXZlLmZpbmQoIi5ncm91cC1oZWFkZXIiKTsNCgkJCXRvZ2dsZXMub24oImNsaWNrIix0b2dnbGVDbGljayk7DQoJCQlhcmNoaXZlLmFkZENsYXNzKCJpbml0aWFsaXplZCIpOwkNCgkJfQ0KCX07DQoJDQoJcmV0dXJuIGFwaTsNCn0pKGpRdWVyeSwgXyk7DQoNClhBLnJlZ2lzdGVyKCJhcmNoaXZlIiwgWEEuY29tcG9uZW50LmFyY2hpdmUpOw0KWEEuY29tcG9uZW50LmJyZWFkY3J1bWIgPSAoZnVuY3Rpb24gKCQsIGRvY3VtZW50KSB7DQoJdmFyIGFwaSA9IHt9Ow0KDQoJZnVuY3Rpb24gQnJlYWRjcnVtYk1hbmFnZXIoZWxlbSkgew0KCQl0aGlzLmJyZWFkY3J1bWIgPSBlbGVtOw0KCQl0aGlzLmhpZGVIaXN0b3J5ID0gW107DQoJCXRoaXMuaGlkZUhpc3RvcnkuZWxlbXMgPSBbXTsNCgkJdGhpcy5oaWRlSGlzdG9yeS53aWR0aHMgPSBbXTsNCgl9DQoNCglCcmVhZGNydW1iTWFuYWdlci5wcm90b3R5cGUuZ2V0RWxlbWVudHMgPSBmdW5jdGlvbiAoJGxpc3QpIHsNCgkJdmFyIGVsZW1lbnRzID0gW107DQoNCgkJJGxpc3QuZmluZCgnbGknKS5lYWNoKGZ1bmN0aW9uICgpIHsNCgkJCWVsZW1lbnRzLnB1c2godGhpcyk7DQoJCX0pOw0KDQoJCXJldHVybiBlbGVtZW50czsNCgl9Ow0KDQoJQnJlYWRjcnVtYk1hbmFnZXIucHJvdG90eXBlLmNhbGN1bGF0ZUxpc3RFbGVtZW50c1dpZHRoID0gZnVuY3Rpb24gKCRsaXN0KSB7DQoJCXZhciB3aWR0aFN1bSA9IDA7DQoNCgkJJGxpc3QuZmluZCgnbGknKS5lYWNoKGZ1bmN0aW9uICgpIHsNCgkJCXdpZHRoU3VtICs9ICQodGhpcykud2lkdGgoKTsNCgkJfSk7DQoNCgkJcmV0dXJuIHdpZHRoU3VtOw0KCX07DQoNCglCcmVhZGNydW1iTWFuYWdlci5wcm90b3R5cGUuY2FsY3VsYXRlV2lkdGggPSBmdW5jdGlvbiAoKSB7DQoJCXZhciBpbnN0ID0gdGhpcywNCgkJCSRsaXN0ID0gJChpbnN0LmJyZWFkY3J1bWIpLmZpbmQoJ29sJyksDQoJCQlsaXN0V2lkdGggPSAkbGlzdC53aWR0aCgpLA0KCQkJd2lkdGhTdW0gPSB0aGlzLmNhbGN1bGF0ZUxpc3RFbGVtZW50c1dpZHRoKCRsaXN0KSwNCgkJCWVsZW1lbnRzID0gdGhpcy5nZXRFbGVtZW50cygkbGlzdCksDQoJCQkkZWxlbWVudFRvSGlkZSwNCgkJCXJlbW92ZUluZHggPSAwOw0KDQoJCXZhciB3aWR0aCA9IGluc3QuaGlkZUhpc3Rvcnkud2lkdGhzW2luc3QuaGlkZUhpc3Rvcnkud2lkdGhzLmxlbmd0aCAtIDFdOw0KCQlpZiAobGlzdFdpZHRoID4gKHdpZHRoU3VtICsgd2lkdGgpKSB7DQoJCQl2YXIgZWxlbSA9IGluc3QuaGlkZUhpc3RvcnkuZWxlbW5zLnBvcCgpOw0KCQkJaW5zdC5oaWRlSGlzdG9yeS53aWR0aHMucG9wKCk7DQoJCQkkKGVsZW0pLnJlbW92ZUNsYXNzKCdoaWRlJyk7DQoJCX0NCg0KDQoJCXdoaWxlICgobGlzdFdpZHRoIDwgd2lkdGhTdW0pICYmIChlbGVtZW50cy5sZW5ndGggPiAyKSkgew0KCQkJcmVtb3ZlSW5keCA9IE1hdGgucm91bmQoZWxlbWVudHMubGVuZ3RoIC8gMikgLSAxOw0KCQkJJGVsZW1lbnRUb0hpZGUgPSAkKGVsZW1lbnRzW3JlbW92ZUluZHhdKTsNCg0KCQkJaW5zdC5oaWRlSGlzdG9yeS5lbGVtcy5wdXNoKGVsZW1lbnRzW3JlbW92ZUluZHhdKTsNCgkJCWluc3QuaGlkZUhpc3Rvcnkud2lkdGhzLnB1c2goJGVsZW1lbnRUb0hpZGUud2lkdGgoKSk7DQoJCQkkZWxlbWVudFRvSGlkZS5hZGRDbGFzcygnaGlkZScpOw0KDQoJCQl3aWR0aFN1bSA9IGluc3QuY2FsY3VsYXRlTGlzdEVsZW1lbnRzV2lkdGgoJGxpc3QpOw0KCQkJZWxlbWVudHMuc3BsaWNlKHJlbW92ZUluZHgsIDEpOw0KCQl9DQoJfTsNCg0KICAgIEJyZWFkY3J1bWJNYW5hZ2VyLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKCkgew0KCQl2YXIgaW5zdCA9IHRoaXMsDQoJCQl0YXNrSWQgPSBudWxsOw0KDQoJCWluc3QuY2FsY3VsYXRlV2lkdGgoKTsNCgkJJCh3aW5kb3cpLnJlc2l6ZShmdW5jdGlvbiAoKSB7DQoJCQlpbnN0LmNhbGN1bGF0ZVdpZHRoKCk7DQoJCX0pOw0KCX07DQoNCiAgICBCcmVhZGNydW1iTWFuYWdlci5wcm90b3R5cGUubWFrZU5hdmlnYXRpb24gPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBicmVhZGNydW1iID0gJCh0aGlzLmJyZWFkY3J1bWIpLA0KICAgICAgICAgICAgY2hpbGRyZW4gPSBicmVhZGNydW1iLmZpbmQoJ2xpID4gb2wnKTsNCg0KICAgICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoID4gMCkgew0KICAgICAgICAgICAgYnJlYWRjcnVtYi5hZGRDbGFzcygnYnJlYWRjcnVtYi1uYXZpZ2F0aW9uJyk7DQogICAgICAgIH0NCiAgICB9Ow0KDQoNCglhcGkuaW5pdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGJyZWFkY3J1bWIgPSAkKCcuYnJlYWRjcnVtYjpub3QoLmluaXRpYWxpemVkKScpOw0KDQogICAgICAgIGJyZWFkY3J1bWIuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB2YXIgYnJlYWRjcnVtYiA9IG5ldyBCcmVhZGNydW1iTWFuYWdlcih0aGlzKTsNCg0KICAgICAgICAgICAgaWYgKCQodGhpcykuaGFzQ2xhc3MoJ2JyZWFkY3J1bWItaGlkZScpKSB7DQogICAgICAgICAgICAgICAgYnJlYWRjcnVtYi5pbml0KCk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGJyZWFkY3J1bWIubWFrZU5hdmlnYXRpb24oKTsNCiAgICAgICAgICAgIH0NCg0KCQkJJCh0aGlzKS5hZGRDbGFzcygnaW5pdGlhbGl6ZWQnKTsNCgkJfSk7DQoJfTsNCg0KCXJldHVybiBhcGk7DQoNCn0pKGpRdWVyeSwgZG9jdW1lbnQpOw0KDQpYQS5yZWdpc3RlcignYnJlYWRjcnVtYicsIFhBLmNvbXBvbmVudC5icmVhZGNydW1iKTsNCi8qKg0KICogQ29nbmlmaWRlDQogKg0KICogWEEuY29tcG9uZW50LmNhcm91c2VscyBtb2R1bGUuDQogKg0KICogRXhwb3NlcyByZWdpc3RlcihzZWxlY3Rvciwgb3B0aW9ucykgbWV0aG9kLCB3aGljaCBpbml0aWFsaXplcyBDYXJvdXNlbA0KICogZm9yIGVhY2ggZWxlbWVudHMgdGhhdCBtYXRjaCB0aGUgcHJvdmlkZWQgc2VsZWN0b3IsIHdpdGggZ2l2ZW4gb3B0aW9ucy4NCiAqIEVsZW1lbnQgdXNlZCBhcyBhIGNhcm91c2VsIG11c3QgY29udGFpbiBhIDx1bCBjbGFzcz0ic2xpZGVzIj4gdGFnLg0KICogVGhhdCB0YWcgaGF2ZSB0byBiZSBmaWxsZWQgd2l0aCA8bGk+IGVsZW1lbnRzLiBFYWNoIDxsaT4gZWxlbWVudCB3aWxsIGJlIGNvbnNpZGVyZWQgYXMgYSBzbGlkZS4NCiAqIEZvciBtb3JlIGRldGFpbHMgcmVhZCB0aGUgZG9jdW1lbnRhdGlvbiBvZiBhIHJlZ2lzdGVyKHNlbGVjdG9yLCBvcHRpb25zKSBtZXRob2QuDQogKg0KICogQHJlcXVpcmVzIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjEuNC40IG9yIGhpZ2hlcg0KICovDQpYQS5jb21wb25lbnQuY2Fyb3VzZWxzID0gKGZ1bmN0aW9uKCQpIHsNCiAgICB2YXIgcHViID0ge30sDQogICAgICAgIE5hdmlnYXRpb25CdWlsZGVyID0gbnVsbCwNCiAgICAgICAgU2xpZGVySW5pdGlhbGl6ZXIgPSBudWxsOw0KDQogICAgLyoqDQogICAgICogVGltZXIgY2xhc3Mgc2F2ZXMgdGltZSBzdGFtcCBhbmQgY291bnRzIHRpbWUgZGlmZmVyZW5jZSBiZXR3ZWVuDQogICAgICogY3VycmVudCB0aW1lICh1cGRhdGUoKSBtZXRob2QpIGFuZCBzYXZlZCB0aW1lIHN0YW1wLg0KICAgICAqIEBjb25zdHJ1Y3Rvcg0KICAgICAqLw0KICAgIGZ1bmN0aW9uIFRpbWVyKCkgew0KICAgICAgICAvKioNCiAgICAgICAgICogVGltZSBkaWZmZXJlbmNlIGJldHdlZW4gbGFzdCB1cGRhdGUoKSBjYWxsIGFuZCBsYXN0IHNldCgpIGNhbGwNCiAgICAgICAgICoNCiAgICAgICAgICogQG1lbWJlciBUaW1lcg0KICAgICAgICAgKi8NCiAgICAgICAgdGhpcy5lbGFwc2VkID0gMDsNCiAgICAgICAgLyoqDQogICAgICAgICAqIFRpbWUgc3RhbXANCiAgICAgICAgICoNCiAgICAgICAgICogQG1lbWJlciBUaW1lcg0KICAgICAgICAgKi8NCiAgICAgICAgdGhpcy5zdGFtcCA9IG51bGw7DQogICAgfQ0KDQogICAgLyoqDQogICAgICogIENvdW50cyB0aW1lIGRpZmZlcmVuY2UgYmV0d2VlbiBjdXJyZW50IHRpbWUgYW5kIHNhdmVkIHRpbWUgc3RhbXANCiAgICAgKg0KICAgICAqIEBtZW1iZXIgVGltZXINCiAgICAgKi8NCiAgICBUaW1lci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24oKSB7DQogICAgICAgIGlmICh0aGlzLnN0YW1wICE9PSBudWxsKSB7DQogICAgICAgICAgICB0aGlzLmVsYXBzZWQgKz0gdGhpcy5uZXdTdGFtcCgpIC0gdGhpcy5zdGFtcDsNCiAgICAgICAgfQ0KICAgIH07DQoNCiAgICAvKioNCiAgICAgKiAgU2F2ZXMgbmV3IHRpbWUgc3RhbXANCiAgICAgKg0KICAgICAqIEBtZW1iZXIgVGltZXINCiAgICAgKi8NCiAgICBUaW1lci5wcm90b3R5cGUuc2V0ID0gZnVuY3Rpb24oKSB7DQogICAgICAgIHRoaXMuc3RhbXAgPSB0aGlzLm5ld1N0YW1wKCk7DQogICAgfTsNCg0KICAgIC8qKg0KICAgICAqICBDb3VudHMgdGltZSBkaWZmZXJlbmNlIGJldHdlZW4gY3VycmVudCB0aW1lIGFuZCBzYXZlZCB0aW1lIHN0YW1wDQogICAgICoNCiAgICAgKiBAbWVtYmVyIFRpbWVyDQogICAgICogQHJldHVybiBzdGFtcCBvZiBhIGN1cnJlbnQgdGltZQ0KICAgICAqIEB0eXBlIE51bWJlcg0KICAgICAqLw0KICAgIFRpbWVyLnByb3RvdHlwZS5uZXdTdGFtcCA9IGZ1bmN0aW9uKCkgew0KICAgICAgICByZXR1cm4gbmV3IERhdGUoKS52YWx1ZU9mKCk7DQogICAgfTsNCg0KICAgIC8qKg0KICAgICAqICBSZXNldHMgZWxhcHNlZCB0aW1lLg0KICAgICAqDQogICAgICogQG1lbWJlciBUaW1lcg0KICAgICAqLw0KICAgIFRpbWVyLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uKCkgew0KICAgICAgICB0aGlzLmVsYXBzZWQgPSAwOw0KICAgIH07DQogICAgLyoqDQogICAgICogRW5kIG9mIFRpbWVyIGNsYXNzDQogICAgICovDQoNCiAgICAvKioNCiAgICAgKiBUaW1lSW5kaWNhdG9yIGNsYXNzIGV4dGVuZHMgVGltZXIgY2xhc3MNCiAgICAgKiBAY29uc3RydWN0b3INCiAgICAgKiBAcGFyYW0ge09iamVjdH0gJCAgICAgYSBqUXVlcnkgb2JqZWN0DQogICAgICogQHBhcmFtIHtYQS5jb21wb25lbnQuY2Fyb3VzZWxzLkluZGljYXRvclZpZXdzLlZpZXd9IHZpZXcgIGEgdGltZSBpbmRpY2F0b3Igdmlldy4NCiAgICAgKiBAcGFyYW0ge051bWJlcn0gdGltZW91dCAgIGEgdmlldyB0aW1lb3V0DQogICAgICogQGJhc2UgVGltZXINCiAgICAgKi8NCiAgICBmdW5jdGlvbiBUaW1lSW5kaWNhdG9yKCQsIHZpZXcsIHRpbWVvdXQpIHsNCiAgICAgICAgLyoqDQogICAgICAgICAqIEEgdGltZSBpbmRpY2F0b3Igdmlldy4NCiAgICAgICAgICoNCiAgICAgICAgICogQG1lbWJlciBUaW1lckluZGljYXRvcg0KICAgICAgICAgKi8NCiAgICAgICAgdGhpcy52aWV3ID0gdmlldzsNCg0KICAgICAgICB0aGlzLnZpZXcuaW5pdCh0aW1lb3V0KTsNCiAgICB9DQogICAgVGltZUluZGljYXRvci5wcm90b3R5cGUgPSBuZXcgVGltZXIoKTsNCiAgICBUaW1lSW5kaWNhdG9yLmNvbnN0cnVjdG9yID0gVGltZXI7DQoNCiAgICAvKioNCiAgICAgKiBQbGF5cyB0aGUgYXR0YWNoZWQgdmlldy4NCiAgICAgKg0KICAgICAqIEBtZW1iZXIgVGltZXJJbmRpY2F0b3INCiAgICAgKi8NCiAgICBUaW1lSW5kaWNhdG9yLnByb3RvdHlwZS5wbGF5ID0gZnVuY3Rpb24oKSB7DQogICAgICAgIHRoaXMudmlldy5wbGF5KCk7DQogICAgfTsNCg0KICAgIC8qKg0KICAgICAqIFBhdXNlcyB0aGUgYXR0YWNoZWQgdmlldy4NCiAgICAgKg0KICAgICAqIEBtZW1iZXIgVGltZXJJbmRpY2F0b3INCiAgICAgKi8NCiAgICBUaW1lSW5kaWNhdG9yLnByb3RvdHlwZS5wYXVzZSA9IGZ1bmN0aW9uKCkgew0KICAgICAgICB0aGlzLnZpZXcucGF1c2UoKTsNCiAgICB9Ow0KDQogICAgLyoqDQogICAgICogUmVzZXRzIGVsYXBzZWQgdGltZSBhbmQgcmVzZXRzIHRoZSBhdHRhY2hlZCB2aWV3Lg0KICAgICAqDQogICAgICogQG1lbWJlciBUaW1lckluZGljYXRvcg0KICAgICAqLw0KICAgIFRpbWVJbmRpY2F0b3IucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24oKSB7DQogICAgICAgIFRpbWVyLnByb3RvdHlwZS5yZXNldC5jYWxsKHRoaXMpOw0KICAgICAgICB0aGlzLnZpZXcucmVzZXQoKTsNCiAgICB9Ow0KDQogICAgLyoqDQogICAgICogQ291bnRzIHRpbWUgZGlmZmVyZW5jZSBiZXR3ZWVuIGN1cnJlbnQgdGltZSBhbmQgc2F2ZWQgdGltZSBzdGFtcC4NCiAgICAgKiBhbmQgdXBkYXRlcyB0aGUgYXR0YWNoZWQgdmlldw0KICAgICAqDQogICAgICogQG1lbWJlciBUaW1lckluZGljYXRvcg0KICAgICAqLw0KICAgIFRpbWVJbmRpY2F0b3IucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgew0KICAgICAgICBUaW1lci5wcm90b3R5cGUudXBkYXRlLmNhbGwodGhpcyk7DQogICAgICAgIHRoaXMudmlldy51cGRhdGUodGhpcy5lbGFwc2VkKTsNCiAgICB9Ow0KICAgIC8qKg0KICAgICAqIGVuZCBvZiBUaW1lSW5kaWNhdG9yIGNsYXNzDQogICAgICovDQoNCiAgICAvKioNCiAgICAgKiBOYXZpZ2F0aW9uQnVpbGRlciBvYmplY3QgY3JlYXRlcyBuYXZpZ2F0aW9uIGl0ZW1zDQogICAgICovDQogICAgTmF2aWdhdGlvbkJ1aWxkZXIgPSAoZnVuY3Rpb24oJCkgew0KDQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgICBjcmVhdGVJdGVtIDogZnVuY3Rpb24oc2V0dGluZ3MpIHsNCiAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IHNldHRpbmdzLnRleHQsDQogICAgICAgICAgICAgICAgICAgICRuYXZJdGVtID0gbnVsbDsNCg0KICAgICAgICAgICAgICAgIHNldHRpbmdzLnRleHQgPSAnJzsNCiAgICAgICAgICAgICAgICBzZXR0aW5ncy5ocmVmID0gJyMnOw0KDQogICAgICAgICAgICAgICAgJG5hdkl0ZW0gPSAkKCc8YT4nLCBzZXR0aW5ncyk7DQogICAgICAgICAgICAgICAgJCgnPHNwYW4+Jywgew0KICAgICAgICAgICAgICAgICAgICAndGV4dCc6IHRleHQNCiAgICAgICAgICAgICAgICB9KS5hcHBlbmRUbygkbmF2SXRlbSk7DQoNCiAgICAgICAgICAgICAgICByZXR1cm4gJG5hdkl0ZW07DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgLyoqDQogICAgICAgICAgICAgKiBSZXR1cm5zIHRoZSBlbGVtZW50KHMpIHRoYXQgbWF0Y2goZXMpIHRoZSBwcm92aWRlZCBzZWxlY3RvciBvciBudWxsDQogICAgICAgICAgICAgKg0KICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHNlbGVjdG9yIGEgc2VsZWN0b3IgdXNlZCBmb3Igc2VhcmNoaW5nDQogICAgICAgICAgICAgKiBAcmV0dXJuIGEgalF1ZXJ5IG9iamVjdCBjb250YWluaW5nIGVsZW1lbnQocykgdGhhdCBtYXRjaChlcykgdGhlIHByb3ZpZGVkIHNlbGVjdG9yIG9yIG51bGwgaWYgbm8gZWxlbWVudCBtYXRjaA0KICAgICAgICAgICAgICogQHR5cGUgT2JqZWN0DQogICAgICAgICAgICAgKi8NCiAgICAgICAgICAgIGdldEVsZW1lbnQ6IGZ1bmN0aW9uKHNlbGVjdG9yLCB3cmFwcGVyKSB7DQogICAgICAgICAgICAgICAgdmFyICRlbGVtZW50ID0gJCh3cmFwcGVyKS5maW5kKCIubmF2LWl0ZW1zIik7DQoNCiAgICAgICAgICAgICAgICBpZiAoJGVsZW1lbnQubGVuZ3RoID09PSAwKSB7DQogICAgICAgICAgICAgICAgICAgICRlbGVtZW50ID0gbnVsbDsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICByZXR1cm4gJGVsZW1lbnQ7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgLyoqDQogICAgICAgICAgICAgKiBDcmVhdGVzIG5hdmlnYXRpb24gaXRlbXMgYW5kIGFwcGVuZHMgdGhlbSB0byAkY29udGFpbmVyLg0KICAgICAgICAgICAgICoNCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSAkY29udGFpbmVyICAgbmF2aWdhdGlvbiBpdGVtcyBjb250YWluZXIgKGpRdWVyeSBvYmplY3QpDQogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbGFiZWwgICBuYXZpZ2F0aW9uIGl0ZW1zIGxhYmVsIHRlbXBsYXRlDQogICAgICAgICAgICAgKiBAcGFyYW0ge051bWJlcn0gY291bnQgICAgbnVtYmVyIG9mIG5hdmlnYXRpb24gaXRlbXMgdG8gY3JlYXRlDQogICAgICAgICAgICAgKi8NCiAgICAgICAgICAgIGNyZWF0ZUl0ZW1zOiBmdW5jdGlvbigkY29udGFpbmVyLCBsYWJlbCwgY291bnQpIHsNCiAgICAgICAgICAgICAgICB2YXIgaSwNCiAgICAgICAgICAgICAgICAgICAgcGF0dGVybiA9IC8jXHtpbmRleFx9L2csDQogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzOw0KDQogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvdW50OyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAndGV4dCc6IGxhYmVsLnJlcGxhY2UocGF0dGVybiwgaSArIDEpDQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzLnRleHQgPSAnJzsNCiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MuaHJlZiA9ICcjJzsNCg0KDQogICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlSXRlbShzZXR0aW5ncykuYXBwZW5kVG8oJGNvbnRhaW5lcik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIC8qKg0KICAgICAgICAgICAgICogQ3JlYXRlcyBvciBzZWxlY3RzICdwcmV2aW91cycvJ25leHQnIG5hdmlnYXRpb24gaXRlbS4NCiAgICAgICAgICAgICAqIE1vZGUgb2YgYWN0aW9uIGRlcGVuZHMgb24gc2V0dGluZ3Mgb2JqZWN0Og0KICAgICAgICAgICAgICogdmFyIHNldHRpbmdzID0gew0KICAgICAgICAgICAgICogICAgIGlzQ29udGFpbmVyOiBCb29sZWFuIHZhbHVlLA0KICAgICAgICAgICAgICogICAgIGxhYmVsOiBTdHJpbmcgdmFsdWUsDQogICAgICAgICAgICAgKiAgICAgc2VsZWN0b3I6IFN0cmluZyB2YWx1ZSwNCiAgICAgICAgICAgICAqICAgICBtZXRob2Q6IFN0cmluZyB2YWx1ZQ0KICAgICAgICAgICAgICogfTsNCiAgICAgICAgICAgICAqDQogICAgICAgICAgICAgKiBJZiBzZXR0aW5ncy5zZWxlY3RvciA9PT0gbnVsbCBvciBpZiBzZXR0aW5ncy5zZWxlY3RvciAhPT0gbnVsbCBhbmQgc2V0dGluZ3MuaXNDb250YWluZXIgPT0gdHJ1ZQ0KICAgICAgICAgICAgICogbmF2aWdhdGlvbiBpdGVtIGlzIGNyZWF0ZWQgYW5kIGF0dGFjaGVkIHRvICRlbGVtZW50LmZpcnN0KCkgKHVzaW5nIHNldHRpbmdzLm1ldGhvZCkuDQogICAgICAgICAgICAgKiBJZiBzZXR0aW5ncy5zZWxlY3RvciAhPT0gbnVsbCBhbmQgc2V0dGluZ3MuaXNDb250YWluZXIgPT0gZmFsc2UNCiAgICAgICAgICAgICAqICRlbGVtZW50LmZpcnN0KCkgaXMgc2VsZWN0ZWQgYXMgbmF2aWdhdGlvbiBpdGVtDQogICAgICAgICAgICAgKg0KICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIHNldHRpbmdzIG9mIG5hdmlnYXRpb24gaXRlbQ0KICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGl0ZW1TZXR0aW5ncyAgIGh0bWwgYXR0cmlidXRlcyBvZiBuYXZpZ2F0aW9uIGl0ZW0NCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSAkZWxlbWVudCAgICBuYXZpZ2F0aW9uIGl0ZW1zIGNvbnRhaW5lciAoalF1ZXJ5IG9iamVjdCkNCiAgICAgICAgICAgICAqIEByZXR1cm4gVGhlICdwcmV2Jy8nbmV4dCcgbmF2aWdhdGlvbiBpdGVtDQogICAgICAgICAgICAgKiBAdHlwZSBPYmplY3QNCiAgICAgICAgICAgICAqLw0KICAgICAgICAgICAgY3JlYXRlUHJldk5leHRJdGVtOiBmdW5jdGlvbihzZXR0aW5ncywgaXRlbVNldHRpbmdzLCAkZWxlbWVudCkgew0KICAgICAgICAgICAgICAgIHZhciAkaXRlbSA9IG51bGwsDQogICAgICAgICAgICAgICAgICAgIGlzU2VsZWN0b3JFeGlzdHMgPSBzZXR0aW5ncy5zZWxlY3RvciAhPT0gbnVsbDsNCg0KDQogICAgICAgICAgICAgICAgaWYgKGlzU2VsZWN0b3JFeGlzdHMpIHsNCiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnQoc2V0dGluZ3Muc2VsZWN0b3IpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmICgkZWxlbWVudCAhPT0gbnVsbCkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3MuaXNDb250YWluZXIgfHwgIWlzU2VsZWN0b3JFeGlzdHMpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICRpdGVtID0gdGhpcy5jcmVhdGVJdGVtKCQuZXh0ZW5kKHt9LCB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3RleHQnOiBzZXR0aW5ncy5sYWJlbA0KICAgICAgICAgICAgICAgICAgICAgICAgfSwgaXRlbVNldHRpbmdzKSk7DQogICAgICAgICAgICAgICAgICAgICAgICAoJGVsZW1lbnQuZmlyc3QoKSlbc2V0dGluZ3MubWV0aG9kXSgkaXRlbSk7DQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAkaXRlbSA9ICRlbGVtZW50LmZpcnN0KCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICByZXR1cm4gJGl0ZW07DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgfSgkKSk7DQogICAgLyoqDQogICAgICogZW5kIG9mIE5hdmlnYXRpb25CdWlsZGVyIG9iamVjdA0KICAgICAqLw0KDQogICAgLyoqDQogICAgICogTmF2aWdhdGlvbiBjbGFzcyBob2xkcyBuYXZpZ2F0aW9uIGl0ZW1zLg0KICAgICAqIEBjb25zdHJ1Y3Rvcg0KICAgICAqLw0KICAgIGZ1bmN0aW9uIE5hdmlnYXRpb24oJCwgJHdyYXBwZXIsIG9wdGlvbnMpIHsNCiAgICAgICAgdmFyIGRlZmF1bHRzID0gew0KICAgICAgICAgICAgICAgICdpc0VuYWJsZWQnOiB0cnVlLA0KICAgICAgICAgICAgICAgICdoYXNQcmV2TmV4dEl0ZW1zJzogdHJ1ZSwNCiAgICAgICAgICAgICAgICAnaXRlbSc6IHsNCiAgICAgICAgICAgICAgICAgICAgJ2xhYmVsJzogJyN7aW5kZXh9JywNCiAgICAgICAgICAgICAgICAgICAgJ3NlbGVjdG9yJzogbnVsbA0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgJ3ByZXZJdGVtJzogew0KICAgICAgICAgICAgICAgICAgICAnbGFiZWwnOiAnPCcsDQogICAgICAgICAgICAgICAgICAgICdzZWxlY3Rvcic6IG51bGwsDQogICAgICAgICAgICAgICAgICAgICdpc0NvbnRhaW5lcic6IGZhbHNlDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICAnbmV4dEl0ZW0nOiB7DQogICAgICAgICAgICAgICAgICAgICdsYWJlbCc6ICc+JywNCiAgICAgICAgICAgICAgICAgICAgJ3NlbGVjdG9yJzogbnVsbCwNCiAgICAgICAgICAgICAgICAgICAgJ2lzQ29udGFpbmVyJzogZmFsc2UNCiAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICdzbGlkZXNDb3VudCc6IDANCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBzZXR0aW5ncyA9ICQuZXh0ZW5kKHRydWUsIHt9LCBkZWZhdWx0cywgb3B0aW9ucyksDQogICAgICAgICAgICAkY29udGFpbmVyOw0KDQogICAgICAgIC8qKg0KICAgICAgICAgKiBqUXVlcnkgb2JqZWN0DQogICAgICAgICAqDQogICAgICAgICAqIEBtZW1iZXIgTmF2aWdhdGlvbg0KICAgICAgICAgKi8NCiAgICAgICAgdGhpcy4kID0gJDsNCiAgICAgICAgLyoqDQogICAgICAgICAqIE5hdmlnYXRpb24gaXRlbXMgKG9uZSBmb3IgZWFjaCBzbGlkZSBpZiBuYXZpZ2F0aW9uIGlzIGVuYWJsZWQpLg0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIE5hdmlnYXRpb24NCiAgICAgICAgICovDQogICAgICAgIHRoaXMuJGl0ZW1zID0gJCgpOw0KICAgICAgICAvKioNCiAgICAgICAgICogTmF2aWdhdGlvbiAnbmV4dCcgaXRlbSAoaWYgcHJldi9uZXh0IGl0ZW1zIGFyZSBlbmFibGVkKS4NCiAgICAgICAgICoNCiAgICAgICAgICogQG1lbWJlciBOYXZpZ2F0aW9uDQogICAgICAgICAqLw0KICAgICAgICB0aGlzLiRuZXh0SXRlbSA9ICQoKTsNCiAgICAgICAgLyoqDQogICAgICAgICAqIE5hdmlnYXRpb24gJ3ByZXZpb3VzJyBpdGVtIChpZiBwcmV2L25leHQgaXRlbXMgYXJlIGVuYWJsZWQpLg0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIE5hdmlnYXRpb24NCiAgICAgICAgICovDQogICAgICAgIHRoaXMuJHByZXZJdGVtID0gJCgpOw0KICAgICAgICAvKioNCiAgICAgICAgICogU2VsZWN0ZWQgaXRlbSAob25lIGZyb20gdGhpcy4kaXRlbXMgb3IgbnVsbCkuDQogICAgICAgICAqDQogICAgICAgICAqIEBtZW1iZXIgTmF2aWdhdGlvbg0KICAgICAgICAgKi8NCiAgICAgICAgdGhpcy4kc2VsZWN0ZWRJdGVtID0gbnVsbDsNCg0KICAgICAgICAvL2luaXRpYWxpemF0aW9uDQogICAgICAgIGlmIChzZXR0aW5ncy5pc0VuYWJsZWQpIHsNCiAgICAgICAgICAgICRjb250YWluZXIgPSB0aGlzLnByZXBhcmVJdGVtcyhzZXR0aW5ncy5pdGVtLCBzZXR0aW5ncy5zbGlkZXNDb3VudCwgJHdyYXBwZXIpOw0KICAgICAgICAgICAgaWYgKHNldHRpbmdzLmhhc1ByZXZOZXh0SXRlbXMpIHsNCiAgICAgICAgICAgICAgICB0aGlzLnByZXBhcmVQcmV2TmV4dEl0ZW1zKHNldHRpbmdzLCAkY29udGFpbmVyKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgJHdyYXBwZXIuZmluZCgnLm5hdicpLnRyaWdnZXIoJ25hdmlnYXRpb24tY3JlYXRlZCcsIHRoaXMpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgLyoqDQogICAgICogQ1NTIGNsYXNzbSB3aGljaCB3aWxsIGJlIHVzZWQgZm9yIG1hcmsgc2VsZWN0ZWQgaXRlbQ0KICAgICAqDQogICAgICogQG1lbWJlciBOYXZpZ2F0aW9uDQogICAgICovDQogICAgTmF2aWdhdGlvbi5wcm90b3R5cGUuc2VsZWN0ZWRJdGVtQ2xhc3MgPSAnYWN0aXZlJzsNCg0KICAgIC8qKg0KICAgICAqIE1hcmsgbmF2aWdhdGlvbiBpdGVtIHdpdGggZ2l2ZW4gaW5kZXggYXMgc2VsZWN0ZWQuDQogICAgICoNCiAgICAgKiBAbWVtYmVyIE5hdmlnYXRpb24NCiAgICAgKiBAcGFyYW0ge051bWJlcn0gaW5kZXggICAgIGluZGV4IG9mIG5hdmlnYXRpb24gaXRlbQ0KICAgICAqLw0KICAgIE5hdmlnYXRpb24ucHJvdG90eXBlLnNlbGVjdEl0ZW0gPSBmdW5jdGlvbihpbmRleCkgew0KICAgICAgICBpZiAodGhpcy4kc2VsZWN0ZWRJdGVtICE9PSBudWxsKSB7DQogICAgICAgICAgICB0aGlzLiRzZWxlY3RlZEl0ZW0ucmVtb3ZlQ2xhc3ModGhpcy5zZWxlY3RlZEl0ZW1DbGFzcyk7DQogICAgICAgIH0NCg0KICAgICAgICB0aGlzLiRzZWxlY3RlZEl0ZW0gPSB0aGlzLiRpdGVtcy5lcShpbmRleCkuYWRkQ2xhc3ModGhpcy5zZWxlY3RlZEl0ZW1DbGFzcyk7DQogICAgfTsNCg0KICAgIC8qKg0KICAgICAqIENyZWF0ZXMgb3Igc2VsZWN0cyBuYXZpZ2F0aW9uIGl0ZW1zIGNvbnRhaW5lciBhbmQgZmlsbHMgaXQgd2l0aCBuYXZpZ2F0aW9uIGl0ZW1zLg0KICAgICAqIElmIG5hdmlnYXRpb24gaXRlbXMgY29udGFpbmVyIGlzIG5vdCBlbXB0eSwgY2hpbGQgZWxlbWVudHMgYXJlIGFkb3B0ZWQgYXMgbmF2aWdhdGlvbiBpdGVtcy4NCiAgICAgKiBNb2RlIG9mIGFjdGlvbiBkZXBlbmRzIG9uIHNldHRpbmdzIG9iamVjdDoNCiAgICAgKiB2YXIgc2V0dGluZ3MgPSB7DQogICAgICogICAgICdsYWJlbCc6ICcje2luZGV4fScsDQogICAgICogICAgICdzZWxlY3Rvcic6IG51bGwNCiAgICAgKiB9Ow0KICAgICAqIElmIHNldHRpbmdzLnNlbGVjdG9yID09PSBudWxsIG5hdmlnYXRpb24gaXRlbSBjb250YWluZXIgaXMgY3JlYXRlZC4NCiAgICAgKiBJZiBzZXR0aW5ncy5zZWxlY3RvciAhPT0gbnVsbCBlbGVtZW50IHRoYXQgbWF0Y2ggc2V0dGluZ3Muc2VsZWN0b3IgaXMgYWRhcHRlZCBhcyBuYXZpZ2FnYXRpb24gaXRlbXMgY29udGFpbmVyLg0KICAgICAqDQogICAgICogQG1lbWJlciBOYXZpZ2F0aW9uDQogICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIHNldHRpbmdzIG9mIG5hdmlnYXRpb24gaXRlbXMNCiAgICAgKiBAcGFyYW0ge051bWJlcn0gY291bnQgICBudW1iZXIgb2YgbmF2aWdhdGlvbiBpdGVtcw0KICAgICAqIEBwYXJhbSB7T2JqZWN0fSAkd3JhcHBlciAgICB3cmFwcGVyIG9mIG5hdmlnYXRpb24gaXRlbXMgY29udGFpbmVyIChqUXVlcnkgb2JqZWN0KQ0KICAgICAqIEByZXR1cm4gVGhlIGNvbnRhaW5lciBmaWxsZWQgd2l0aCBuYXZpZ2F0aW9uIGl0ZW1zLg0KICAgICAqIEB0eXBlIE9iamVjdA0KICAgICAqLw0KICAgIE5hdmlnYXRpb24ucHJvdG90eXBlLnByZXBhcmVJdGVtcyA9IGZ1bmN0aW9uKHNldHRpbmdzLCBjb3VudCwgJHdyYXBwZXIpIHsNCiAgICAgICAgdmFyICRjb250YWluZXIgPSBudWxsOw0KDQogICAgICAgIGlmIChzZXR0aW5ncy5zZWxlY3RvciAhPT0gbnVsbCkgew0KICAgICAgICAgICAgJGNvbnRhaW5lciA9IE5hdmlnYXRpb25CdWlsZGVyLmdldEVsZW1lbnQoc2V0dGluZ3Muc2VsZWN0b3IsICR3cmFwcGVyKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICRjb250YWluZXIgPSAkKCc8ZGl2Lz4nLCB7DQogICAgICAgICAgICAgICAgJ2NsYXNzJzogJ25hdicNCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgJGNvbnRhaW5lci5hcHBlbmRUbygkd3JhcHBlcik7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoJGNvbnRhaW5lciAhPT0gbnVsbCkgew0KICAgICAgICAgICAgaWYgKCRjb250YWluZXIuY2hpbGRyZW4oKS5sZW5ndGggPT09IDApIHsNCiAgICAgICAgICAgICAgICBOYXZpZ2F0aW9uQnVpbGRlci5jcmVhdGVJdGVtcygkY29udGFpbmVyLCBzZXR0aW5ncy5sYWJlbCwgY291bnQpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgdGhpcy4kaXRlbXMgPSAkY29udGFpbmVyLmNoaWxkcmVuKCkuc2xpY2UoMCwgY291bnQpOw0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuICRjb250YWluZXI7DQogICAgfTsNCg0KICAgIC8qKg0KICAgICAqIENyZWF0ZXMgb3Igc2VsZWN0cyBuYXZpZ2F0aW9uICdwcmV2aW91cycgYW5kICduZXh0JyBuYXZpZ2F0aW9uIGl0ZW1zIChAc2VlIE5hdmlnYXRpb25CdWlsZGVyLmNyZWF0ZVByZXZOZXh0SXRlbSgpKS4NCiAgICAgKiBJZiBuYXZpZ2F0aW9uIGl0ZW1zIGNvbnRhaW5lciBpcyBub3QgZW1wdHksIGNoaWxkIGVsZW1lbnRzIGFyZSBhZG9wdGVkIGFzIG5hdmlnYXRpb24gaXRlbXMuDQogICAgICoNCiAgICAgKiBAbWVtYmVyIE5hdmlnYXRpb24NCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3Mgc2V0dGluZ3Mgb2YgbmF2aWdhdGlvbg0KICAgICAqIEBwYXJhbSB7T2JqZWN0fSAkY29udGFpbmVyICAgIG5hdmlnYXRpb24gaXRlbXMgY29udGFpbmVyIChqUXVlcnkgb2JqZWN0KQ0KICAgICAqLw0KICAgIE5hdmlnYXRpb24ucHJvdG90eXBlLnByZXBhcmVQcmV2TmV4dEl0ZW1zID0gZnVuY3Rpb24oc2V0dGluZ3MsICRjb250YWluZXIpIHsNCiAgICAgICAgdmFyICRpdGVtOw0KDQogICAgICAgIHNldHRpbmdzLnByZXZJdGVtLm1ldGhvZCA9ICdwcmVwZW5kJzsNCiAgICAgICAgJGl0ZW0gPSBOYXZpZ2F0aW9uQnVpbGRlci5jcmVhdGVQcmV2TmV4dEl0ZW0oc2V0dGluZ3MucHJldkl0ZW0sIHsNCiAgICAgICAgICAgICdjbGFzcyc6ICdwcmV2Jw0KICAgICAgICB9LCAkY29udGFpbmVyKTsNCiAgICAgICAgdGhpcy4kcHJldkl0ZW0gPSAoJGl0ZW0gPT09IG51bGwpID8gdGhpcy4kcHJldkl0ZW0gOiAkaXRlbTsNCg0KICAgICAgICBzZXR0aW5ncy5uZXh0SXRlbS5tZXRob2QgPSAnYXBwZW5kJzsNCiAgICAgICAgJGl0ZW0gPSBOYXZpZ2F0aW9uQnVpbGRlci5jcmVhdGVQcmV2TmV4dEl0ZW0oc2V0dGluZ3MubmV4dEl0ZW0sIHsNCiAgICAgICAgICAgICdjbGFzcyc6ICduZXh0Jw0KICAgICAgICB9LCAkY29udGFpbmVyKTsNCiAgICAgICAgdGhpcy4kbmV4dEl0ZW0gPSAoJGl0ZW0gPT09IG51bGwpID8gdGhpcy4kbmV4dEl0ZW0gOiAkaXRlbTsNCiAgICB9Ow0KICAgIC8qKg0KICAgICAqIGVuZCBvZiBOYXZpZ2F0aW9uIGNsYXNzDQogICAgICovDQoNCiAgICAvKioNCiAgICAgKiBTbGlkZXJDb250ZXh0IGNsYXNzIGlzIGJpbmRlZCB0byBhIFNsaWRlciBjbGFzcyBpbnN0YW5jZQ0KICAgICAqIGFuZCBob2xkcyBpdHMgcHJvcGVydGllcy4NCiAgICAgKiBAY29uc3RydWN0b3INCiAgICAgKi8NCiAgICBmdW5jdGlvbiBTbGlkZXJDb250ZXh0KCkgew0KICAgICAgICAvKioNCiAgICAgICAgICogRmxhZywgd2hpY2ggZGV0ZXJtaW5lcyBpZiBzbGlkZSBjYW4gb3IgY2FuIG5vdCBiZSBjaGFuZ2VkIChmb3IgdXNlciByZXF1ZXN0KQ0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQNCiAgICAgICAgICovDQogICAgICAgIHRoaXMuY2FuQ2hhbmdlU2xpZGUgPSB0cnVlOw0KICAgICAgICAvKioNCiAgICAgICAgICogRGVmYXVsdCBTbGlkZXIgc2V0dGluZyBvYmplY3QgKEBzZWUgU2xpZGVyKQ0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQNCiAgICAgICAgICovDQogICAgICAgIHRoaXMuZGVmYXVsdHMgPSBudWxsOw0KICAgICAgICAvKioNCiAgICAgICAgICogTmF2aWdhdGlvbiBvYmplY3QgKEBzZWUgTmF2aWdhdGlvbikNCiAgICAgICAgICoNCiAgICAgICAgICogQG1lbWJlciBTbGlkZXJDb250ZXh0DQogICAgICAgICAqLw0KICAgICAgICB0aGlzLm5hdmlnYXRpb24gPSBudWxsOw0KICAgICAgICAvKioNCiAgICAgICAgICogU2xpZGVyIG9iamVjdCwgd2hpY2ggdGhpcyBjb250ZXh0IGlzIGF0dGFjZWhkIHRvLg0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQNCiAgICAgICAgICovDQogICAgICAgIHRoaXMub3duZXIgPSBudWxsOw0KICAgICAgICAvKioNCiAgICAgICAgICogRmxhZywgd2hpY2ggZGV0ZXJtaW5lcyBpZiBjaGFuZ2Ugb2YgYSBzbGlkZSBjYW4gb3IgY2FuIG5vdCBiZSBzY2hlZHVsZWQNCiAgICAgICAgICoNCiAgICAgICAgICogQG1lbWJlciBTbGlkZXJDb250ZXh0DQogICAgICAgICAqLw0KICAgICAgICB0aGlzLnByZXZlbnRTY2hlZHVsaW5nID0gZmFsc2U7DQogICAgICAgIC8qKg0KICAgICAgICAgKiBTbGlkZXIgc2V0dGluZyBvYmplY3QNCiAgICAgICAgICoNCiAgICAgICAgICogQG1lbWJlciBTbGlkZXJDb250ZXh0DQogICAgICAgICAqLw0KICAgICAgICB0aGlzLnNldHRpbmdzID0gbnVsbDsNCiAgICAgICAgLyoqDQogICAgICAgICAqIEluc3RhbmNlIG9mIFRpbWVyIGNsYXNzIChAc2VlIFRpbWVyKSwgd2hpY2ggaXMgdXNlZCB0byBzdG9yZSBob3cgbXVjaA0KICAgICAgICAgKiB0aW1lIGlzIGxlZnQgdG8gY2hhbmdlIHRoZSBzbGlkZQ0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQNCiAgICAgICAgICovDQogICAgICAgIHRoaXMuc2xpZGVUaW1lciA9IG5ldyBUaW1lcigpOw0KICAgICAgICAvKioNCiAgICAgICAgICogSW5zdGFuY2Ugb2YgVGltZUluZGljYXRvciBjbGFzcyAoQHNlZSBUaW1lSW5kaWNhdG9yKQ0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQNCiAgICAgICAgICovDQogICAgICAgIHRoaXMudGltZUluZGljYXRvciA9IG51bGw7DQogICAgICAgIC8qKg0KICAgICAgICAgKiBUaW1lcnMgYXJyYXkuDQogICAgICAgICAqDQogICAgICAgICAqIEBtZW1iZXIgU2xpZGVyQ29udGV4dA0KICAgICAgICAgKi8NCiAgICAgICAgdGhpcy50aW1lcnMgPSBbXTsNCiAgICAgICAgLyoqDQogICAgICAgICAqIExhc3QgdGltZW91dCBpZGVudGlmaWVyLg0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQNCiAgICAgICAgICovDQogICAgICAgIHRoaXMudGltZW91dElkID0gbnVsbDsNCiAgICAgICAgLyoqDQogICAgICAgICAqIFRyYW5zaXRpb24gKEBzZWUgWEEuY29tcG9uZW50LmNhcm91c2Vscy5UcmFuc2l0aW9ucy5UcmFuc2l0aW9uKSB1c2VkIHdoaWxlIGNoYW5naW5nIHNsaWRlcw0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQNCiAgICAgICAgICovDQogICAgICAgIHRoaXMudHJhbnNpdGlvbiA9IG51bGw7DQogICAgICAgIC8qKg0KICAgICAgICAgKiBUcmFuc2l0aW9uIHNldHRpbmdzIG9iamVjdCAoQHNlZSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zLlRyYW5zaXRpb25TZXR0aW5ncykNCiAgICAgICAgICoNCiAgICAgICAgICogQG1lbWJlciBTbGlkZXJDb250ZXh0DQogICAgICAgICAqLw0KICAgICAgICB0aGlzLnRyYW5zaXRpb25TZXR0aW5ncyA9IG5ldyBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zLlRyYW5zaXRpb25TZXR0aW5ncygpOw0KICAgICAgICAvKioNCiAgICAgICAgICogalF1ZXJ5IG9iamVjdCB3aGljaCBjb250YWlucyBhbGwgc2xpZGVzDQogICAgICAgICAqDQogICAgICAgICAqIEBtZW1iZXIgU2xpZGVyQ29udGV4dA0KICAgICAgICAgKi8NCiAgICAgICAgdGhpcy4kc2xpZGVzID0gbnVsbDsNCiAgICAgICAgLyoqDQogICAgICAgICAqIGpRdWVyeSBvYmplY3QgY29udGFpbmluZyBlbGVtZW50IHRoYXQgd3JhcHBzIHNsaWRlcw0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQNCiAgICAgICAgICovDQogICAgICAgIHRoaXMuJHdyYXBwZXIgPSBudWxsOw0KICAgICAgICAvKioNCiAgICAgICAgICogUmVmZXJlbmNlIHRvIG1ldGhvZCwgd2hpY2ggc2hvdWxkIGNoYW5nZSBjdXJyZW50IHNsaWRlDQogICAgICAgICAqDQogICAgICAgICAqIEBtZW1iZXIgU2xpZGVyQ29udGV4dA0KICAgICAgICAgKi8NCiAgICAgICAgdGhpcy5jaGFuZ2VDdXJyZW50U2xpZGUgPSBudWxsOw0KICAgICAgICAvKioNCiAgICAgICAgICogUmVmZXJlbmNlIHRvIG1ldGhvZCwgd2hpY2ggc2hvdWxkIHJldHVybiBqUXVlcnkgb2JqZWN0IHdpdGggY3VycmVudCBzbGlkZQ0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIFNsaWRlckNvbnRleHQNCiAgICAgICAgICovDQogICAgICAgIHRoaXMuZ2V0Q3VycmVudFNsaWRlID0gbnVsbDsNCg0KICAgICAgICB0aGlzLnRpbWVycy5wdXNoKHRoaXMuc2xpZGVUaW1lcik7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIGVuZCBvZiBTbGlkZXJDb250ZXh0IGNsYXNzDQogICAgICovDQoNCiAgICAvKioNCiAgICAgKiBTbGlkZXIgY2xhc3MgbWFuYWdlcyBjaGFuZ2luZyBvZiBzbGlkZXMuDQogICAgICoNCiAgICAgKiBPcHRpb25zIG9iamVjdDoNCiAgICAgKiB7DQogICAgICogICAgICduYXZpZ2F0aW9uJzogT2JqZWN0IHZhbHVlLCAvL25hdmlnYXRpb24gc2V0dGluZ3Mgb2JqZWN0DQogICAgICogICAgICd0aW1lb3V0JzogTnVtYmVyIHZhbHVlLCAvL3RpbWUgYmV0d2VlbiBzbGlkZXMgY2hhbmdpbmcNCiAgICAgKiAgICAgJ3RyYW5zaXRpb24nOiBTdHJpbmcgdmFsdWUsIC8vbmFtZSBvZiB0cmFuc2l0aW9uIGNsYXNzIChAc2VlIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuVHJhbnNpdGlvbnMuVHJhbnNpdGlvbikNCiAgICAgKiAgICAgJ2lzUGF1c2VFbmFibGVkJzogQm9vbGVhbiB2YWx1ZSwgLy9mbGFnLCB3aGljaCBkZXRlcm1pbmVzIGlmIHBhdXNlIGZlYXR1cmUgaXMgZW5hYmxlZA0KICAgICAqICAgICAndGltZUluZGljYXRvcic6IHsNCiAgICAgKiAgICAgICAgICdpc0VuYWJsZWQnOiBCb29sZWFuIHZhbHVlLCAvL2ZsYWcsIHdoaWNoIGRldGVybWluZXMgaWYgdGltZSBpbmRpY2F0b3IgaXMgZW5hYmxlZA0KICAgICAqICAgICAgICAgJ3NlbGVjdG9yJzogU3RyaW5nIHZhbHVlLCAvL3NlbGVjdG9yIG9mIHRpbWUgaW5kaWNhdG9yIGh0bWwgZWxlbWVudA0KICAgICAqICAgICAgICAgJ3ZpZXcnOiBTdHJpbmcgdmFsdWUsIC8vbmFtZSBvZiB2aWV3IGNsYXNzIChAc2VlIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuSW5kaWNhdG9yVmlld3MuVmlldw0KICAgICAqICAgICAgICAgJ29wdGlvbnMnOiBPYmplY3QgdmFsdWUgLy9vYmplY3Qgd2l0aCBvcHRpb25zLCB3aGljaCB3aWxsIGJlIHBhc3NlZCB0byBhIHRpbWUgaW5kaWNhdG9yIHZpZXcNCiAgICAgKiAgICAgfQ0KICAgICAqIH0NCiAgICAgKiBAY29uc3RydWN0b3INCiAgICAgKiBAcGFyYW0ge09iamVjdH0gJCAgICAgdGhlIGpRdWVyeSBvYmplY3QNCiAgICAgKiBAcGFyYW0ge1NsaWRlckNvbnRleHR9IGNvbnRleHQgICAgaW5zdGFuY2Ugb2YgU2xpZGVyQ29udGV4dCBjbGFzczsgbXVzdCBiZSBzZXBhcmF0ZSBmb3IgZWFjaCBpbnN0YW5jZSAoQHNlZSBTbGlkZXJDb250ZXh0KQ0KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zICAgIFNsaWRlciBvcHRpb25zIG9iamVjdA0KICAgICAqLw0KICAgIGZ1bmN0aW9uIFNsaWRlcigkLCBjb250ZXh0LCBvcHRpb25zKSB7DQogICAgICAgIHZhciBkZWZhdWx0cyA9IHsNCiAgICAgICAgICAgICduYXZpZ2F0aW9uJzoge30sDQogICAgICAgICAgICAndGltZW91dCc6IDEwMDAwLA0KICAgICAgICAgICAgJ3RyYW5zaXRpb24nOiAnQmFzaWNUcmFuc2l0aW9uJywNCiAgICAgICAgICAgICdpc1BhdXNlRW5hYmxlZCc6IHRydWUsDQogICAgICAgICAgICAndGltZUluZGljYXRvcic6IHsNCiAgICAgICAgICAgICAgICAnaXNFbmFibGVkJzogZmFsc2UsDQogICAgICAgICAgICAgICAgJ3NlbGVjdG9yJzogbnVsbCwNCiAgICAgICAgICAgICAgICAndmlldyc6ICdWaWV3JywNCiAgICAgICAgICAgICAgICAnb3B0aW9ucyc6IHt9DQogICAgICAgICAgICB9DQogICAgICAgIH07DQoNCiAgICAgICAgLyoqDQogICAgICAgICAqIEluc3RhbmNlIG9mIFNsaWRlckNvbnRleHQgY2xhc3MgKEBzZWUgU2xpZGVyQ29udGV4dCkNCiAgICAgICAgICoNCiAgICAgICAgICogQG1lbWJlciBOYXZpZ2F0aW9uDQogICAgICAgICAqLw0KICAgICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0Ow0KDQogICAgICAgIGNvbnRleHQub3duZXIgPSB0aGlzOw0KICAgICAgICBjb250ZXh0LmRlZmF1bHRzID0gZGVmYXVsdHM7DQogICAgICAgIGNvbnRleHQuc2V0dGluZ3MgPSAkLmV4dGVuZCh0cnVlLCB7fSwgZGVmYXVsdHMsIG9wdGlvbnMpOw0KICAgICAgICBjb250ZXh0LnRyYW5zaXRpb25TZXR0aW5ncy4kc2xpZGVzID0gY29udGV4dC4kc2xpZGVzOw0KICAgIH0NCg0KICAgIC8qKg0KICAgICAqIEV4ZWN1dGVzIG1ldGhvZCB3aXRoIGdpdmVuIG1ldGhvZE5hbWUgb24gZWFjaCBUaW1lciBpbiBjb250ZXh0LnRpbWVycyAoQHNlZSBUaW1lcikNCiAgICAgKg0KICAgICAqIEBtZW1iZXIgU2xpZGVyDQogICAgICogQHBhcmFtIHtTdHJpbmd9IG1ldGhvZE5hbWUgICBuYW1lIG9mIGEgbWV0aG9kLCB3aGljaCB3aWxsIGJlIGV4ZWN1dGVkIG9uIHRpbWVycw0KICAgICAqIEBwYXJhbSB7U2xpZGVyQ29udGV4dH0gY29udGV4dCAgICBjdXJyZW50IGNvbnRleHQNCiAgICAgKi8NCiAgICBTbGlkZXIucHJvdG90eXBlLmV4ZWN1dGVPblRpbWVycyA9IGZ1bmN0aW9uKG1ldGhvZE5hbWUsIGNvbnRleHQpIHsNCiAgICAgICAgdmFyIGkgPSBudWxsLA0KICAgICAgICAgICAgdGltZXIgPSBudWxsLA0KICAgICAgICAgICAgdGltZXJzID0gY29udGV4dC50aW1lcnM7DQoNCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKykgew0KICAgICAgICAgICAgdGltZXIgPSB0aW1lcnNbaV07DQogICAgICAgICAgICBpZiAodHlwZW9mKHRpbWVyW21ldGhvZE5hbWVdKSA9PT0gJ2Z1bmN0aW9uJykgew0KICAgICAgICAgICAgICAgIHRpbWVyW21ldGhvZE5hbWVdKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9Ow0KDQogICAgLyoqDQogICAgICogRGVzY2hlZHVsZXMgY2hhbmdlIG9mIGEgc2xpZGUsIGJ5IGNsZWFyaW5nIHRpbWVvdXQgcHJldmlvdXNseSBzZXQgYnkgc2V0VGllbW91dCgpIGZ1bmN0aW9uLg0KICAgICAqDQogICAgICogQG1lbWJlciBTbGlkZXINCiAgICAgKiBAcGFyYW0ge1NsaWRlckNvbnRleHR9IGNvbnRleHQgICAgY3VycmVudCBjb250ZXh0DQogICAgICovDQogICAgU2xpZGVyLnByb3RvdHlwZS5kZXNjaGVkdWxlU2xpZGUgPSBmdW5jdGlvbihjb250ZXh0KSB7DQogICAgICAgIGlmIChjb250ZXh0LnRpbWVvdXRJZCAhPT0gbnVsbCkgew0KICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGNvbnRleHQudGltZW91dElkKTsNCiAgICAgICAgICAgIGNvbnRleHQudGltZW91dElkID0gbnVsbDsNCiAgICAgICAgfQ0KICAgIH07DQoNCiAgICAvKioNCiAgICAgKiBTY2hlZHVsZXMgY2hhbmdlIG9mIGEgc2xpZGUsIGJ5IHNldHRpbmcgdGltZW91dCAodXNpbmcgc2V0VGllbW91dCgpIGZ1bmN0aW9uKSBpZiBjYW4uDQogICAgICogSWYgY2FuJ3QsIHRyaWVzIGFnYWluIGFmdGVyIHNob3J0IHBlcmlvZCBvZiB0aW1lLg0KICAgICAqDQogICAgICogQG1lbWJlciBTbGlkZXINCiAgICAgKiBAcGFyYW0ge1NsaWRlckNvbnRleHR9IGNvbnRleHQgICAgY3VycmVudCBjb250ZXh0DQogICAgICovDQogICAgU2xpZGVyLnByb3RvdHlwZS5zY2hlZHVsZVNsaWRlID0gZnVuY3Rpb24oY29udGV4dCkgew0KICAgICAgICB2YXIgb3duZXIgPSBjb250ZXh0Lm93bmVyOw0KDQogICAgICAgIG93bmVyLmRlc2NoZWR1bGVTbGlkZShjb250ZXh0KTsNCg0KICAgICAgICBpZiAoIWNvbnRleHQucHJldmVudFNjaGVkdWxpbmcgJiYgY29udGV4dC4kc2xpZGVzLnNpemUoKSA+IDEpIHsNCiAgICAgICAgICAgIG93bmVyLmV4ZWN1dGVPblRpbWVycygnc2V0JywgY29udGV4dCk7DQoNCiAgICAgICAgICAgIGlmIChjb250ZXh0LmNhbkNoYW5nZVNsaWRlKSB7DQogICAgICAgICAgICAgICAgaWYgKGNvbnRleHQudGltZUluZGljYXRvciAhPT0gbnVsbCkgew0KICAgICAgICAgICAgICAgICAgICBjb250ZXh0LnRpbWVJbmRpY2F0b3IucGxheSgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBjb250ZXh0LnRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgIG93bmVyLmNoYW5nZUN1cnJlbnRTbGlkZUJ5KDEsIGNvbnRleHQpOw0KICAgICAgICAgICAgICAgIH0sIGNvbnRleHQuc2V0dGluZ3MudGltZW91dCAtIGNvbnRleHQuc2xpZGVUaW1lci5lbGFwc2VkKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgb3duZXIuc2NoZWR1bGVTbGlkZShjb250ZXh0KTsNCiAgICAgICAgICAgICAgICB9LCAxMDApOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfTsNCg0KICAgIC8qKg0KICAgICAqIENoYW5nZXMgY3VycmVudCBzbGlkZSwgYnkgb2Zmc2V0IHBlcmZvcm1pbmcgY29udGV4dC50cmFuc2l0aW9uDQogICAgICogQW55IG9mZnNldCB2YWx1ZSBpcyBzYXZlIChpZiBpdCBpcyBhbiBpbnRlZ2VyKS4NCiAgICAgKg0KICAgICAqIEBtZW1iZXIgU2xpZGVyDQogICAgICogQHBhcmFtIHtOdW1iZXJ9IG9mZnNldCAgICB0aGUgb2Zmc2V0IHRvIGFuIGluZGV4IG9mIGEgbmV3IHNsaWRlDQogICAgICogQHBhcmFtIHtTbGlkZXJDb250ZXh0fSBjb250ZXh0ICAgIGN1cnJlbnQgY29udGV4dA0KICAgICAqLw0KICAgIFNsaWRlci5wcm90b3R5cGUuY2hhbmdlQ3VycmVudFNsaWRlQnkgPSBmdW5jdGlvbihvZmZzZXQsIGNvbnRleHQpIHsNCiAgICAgICAgdmFyIHNldHRpbmdzID0gY29udGV4dC50cmFuc2l0aW9uU2V0dGluZ3MsDQogICAgICAgICAgICAkY3VycmVudFNsaWRlID0gY29udGV4dC5nZXRDdXJyZW50U2xpZGUoKSwNCiAgICAgICAgICAgICRzbGlkZXMgPSBjb250ZXh0LiRzbGlkZXM7DQoNCiAgICAgICAgaWYgKChvZmZzZXQgJSAkc2xpZGVzLnNpemUoKSkgIT09IDApIHsNCiAgICAgICAgICAgIGNvbnRleHQuY2FuQ2hhbmdlU2xpZGUgPSBmYWxzZTsNCg0KICAgICAgICAgICAgc2V0dGluZ3Mub2Zmc2V0ID0gb2Zmc2V0Ow0KICAgICAgICAgICAgc2V0dGluZ3MuJGN1cnJlbnRTbGlkZSA9ICRjdXJyZW50U2xpZGU7DQogICAgICAgICAgICBzZXR0aW5ncy4kbmV4dFNsaWRlID0gJHNsaWRlcy5lcSgoJGN1cnJlbnRTbGlkZS5pbmRleCgpICsgb2Zmc2V0KSAlICRzbGlkZXMuc2l6ZSgpKTsNCg0KICAgICAgICAgICAgY29udGV4dC5jaGFuZ2VDdXJyZW50U2xpZGUoc2V0dGluZ3MuJG5leHRTbGlkZSk7DQogICAgICAgICAgICBjb250ZXh0LnRyYW5zaXRpb24ucGVyZm9ybShjb250ZXh0LnRyYW5zaXRpb25TZXR0aW5ncyk7DQogICAgICAgICAgICBjb250ZXh0Lm93bmVyLmV4ZWN1dGVPblRpbWVycygncmVzZXQnLCBjb250ZXh0KTsNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgdmFyICRjYXJvdXNlbCA9ICQoY29udGV4dC4kd3JhcHBlcikucGFyZW50cygiLmNhcm91c2VsIik7DQogICAgICAgICRjYXJvdXNlbC50cmlnZ2VyKCJzbGlkZS1jaGFuZ2VkIik7DQogICAgfTsNCg0KICAgIC8qKg0KICAgICAqIFN0YXJ0cyBhdXRvbWF0aWMgc2xpZGVzIGNoYW5naW5nDQogICAgICoNCiAgICAgKiBAbWVtYmVyIFNsaWRlcg0KICAgICAqLw0KICAgIFNsaWRlci5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24oKSB7DQogICAgICAgIHRoaXMuZXhlY3V0ZU9uVGltZXJzKCdyZXNldCcsIHRoaXMuY29udGV4dCk7DQogICAgICAgIHRoaXMuc2NoZWR1bGVTbGlkZSh0aGlzLmNvbnRleHQpOw0KICAgIH07DQoNCiAgICAvKioNCiAgICAgKiBDYW5jZWwgdGhlIGRlZmF1bHQgYWN0aW9uIG9mIGV2ZW50IGFuZCBjaGFuZ2VzIHNsaWRlIG1hbnVhbGx5Lg0KICAgICAqDQogICAgICogQG1lbWJlciBTbGlkZXINCiAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgICAgIHRoZSBldmVudA0KICAgICAqIEBwYXJhbSB7TnVtYmVyfSBvZmZzZXQgICAgdGhlIG9mZnNldCB0byBhbiBpbmRleCBvZiBhIG5ldyBzbGlkZQ0KICAgICAqIEBwYXJhbSB7U2xpZGVyQ29udGV4dH0gY29udGV4dCAgICBjdXJyZW50IGNvbnRleHQNCiAgICAgKi8NCiAgICBTbGlkZXIucHJvdG90eXBlLm9uQ2hhbmdlQ3VycmVudFNsaWRlID0gZnVuY3Rpb24oZXZlbnQsIG9mZnNldCwgY29udGV4dCkgew0KICAgICAgICB2YXIgb3duZXIgPSBjb250ZXh0Lm93bmVyOw0KDQogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgIGlmIChjb250ZXh0LmNhbkNoYW5nZVNsaWRlKSB7DQogICAgICAgICAgICBvd25lci5kZXNjaGVkdWxlU2xpZGUoY29udGV4dCk7DQogICAgICAgICAgICBvd25lci5jaGFuZ2VDdXJyZW50U2xpZGVCeShvZmZzZXQsIGNvbnRleHQpOw0KICAgICAgICB9DQogICAgfTsNCg0KICAgIC8qKg0KICAgICAqIFNlbGVjdHMgbmF2aWdhdGlvbiBpdGVtIHdpdGggZ2l2ZW4gaW5kZXguDQogICAgICoNCiAgICAgKiBAbWVtYmVyIFNsaWRlcg0KICAgICAqIEBwYXJhbSB7TnVtYmVyfSBpbmRleCAgICAgdGhlIGluZGV4IG9mIG5hdmlnYXRpb24gaXRlbQ0KICAgICAqLw0KICAgIFNsaWRlci5wcm90b3R5cGUuc2VsZWN0TmF2aWdhdGlvbkl0ZW0gPSBmdW5jdGlvbihpbmRleCkgew0KICAgICAgICB0aGlzLmNvbnRleHQubmF2aWdhdGlvbi5zZWxlY3RJdGVtKGluZGV4KTsNCiAgICB9Ow0KICAgIC8qKg0KICAgICAqIGVuZCBvZiBTbGlkZXIgY2xhc3MNCiAgICAgKi8NCg0KICAgIC8qKg0KICAgICAqIFNsaWRlckluaXRpYWxpemVyIG9iamVjdCBzZXQgdXAgaW5zdGFuY2VzIG9mIFNsaWRlciBjbGFzcw0KICAgICAqLw0KICAgIFNsaWRlckluaXRpYWxpemVyID0gKGZ1bmN0aW9uKCQpIHsNCiAgICAgICAgLyoqDQogICAgICAgICAqIEF0dGFjaGVzIGV2ZW50cyB0byBuYXZpZ2F0aW9uIGl0ZW1zLg0KICAgICAgICAgKg0KICAgICAgICAgKiBAcGFyYW0ge1NsaWRlckNvbnRleHR9IGNvbnRleHQgICBhIGNvbnRleHQgb2YgYSBTbGlkZXIgY2xhc3MgaW5zdGFuY2UNCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGF0dGFjaE5hdmlnYXRpb25FdmVudHMoY29udGV4dCkgew0KICAgICAgICAgICAgdmFyIG93bmVyID0gY29udGV4dC5vd25lciwNCiAgICAgICAgICAgICAgICAkbmF2TGlua3MgPSBjb250ZXh0LiR3cmFwcGVyLmZpbmQoIi5uYXYgYSIpLA0KICAgICAgICAgICAgICAgICRwcmV2SXRlbVR4dCA9IGNvbnRleHQuJHdyYXBwZXIuZmluZCgnLnByZXYtdGV4dCcpLA0KICAgICAgICAgICAgICAgICRuZXh0SXRlbVR4dCA9IGNvbnRleHQuJHdyYXBwZXIuZmluZCgnLm5leHQtdGV4dCcpOw0KDQogICAgICAgICAgICBjb250ZXh0Lm5hdmlnYXRpb24uJGl0ZW1zLmVhY2goZnVuY3Rpb24oaW5kZXgpIHsNCiAgICAgICAgICAgICAgICB2YXIgJHNsaWRlID0gY29udGV4dC4kc2xpZGVzLmVxKGluZGV4KTsNCg0KICAgICAgICAgICAgICAgICQodGhpcykuY2xpY2soZnVuY3Rpb24oZXZlbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgb3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoZXZlbnQsICRzbGlkZS5pbmRleCgpIC0gY29udGV4dC5nZXRDdXJyZW50U2xpZGUoKS5pbmRleCgpLCBjb250ZXh0KTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAkcHJldkl0ZW1UeHQuY2xpY2soZnVuY3Rpb24oZXZlbnQpIHsNCiAgICAgICAgICAgICAgICBvd25lci5vbkNoYW5nZUN1cnJlbnRTbGlkZShldmVudCwgLTEsIGNvbnRleHQpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgICRuZXh0SXRlbVR4dC5jbGljayhmdW5jdGlvbihldmVudCkgew0KICAgICAgICAgICAgICAgIG93bmVyLm9uQ2hhbmdlQ3VycmVudFNsaWRlKGV2ZW50LCAxLCBjb250ZXh0KTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBjb250ZXh0Lm5hdmlnYXRpb24uJHByZXZJdGVtLmNsaWNrKGZ1bmN0aW9uKGV2ZW50KSB7DQogICAgICAgICAgICAgICAgb3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoZXZlbnQsIC0xLCBjb250ZXh0KTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBjb250ZXh0Lm5hdmlnYXRpb24uJG5leHRJdGVtLmNsaWNrKGZ1bmN0aW9uKGV2ZW50KSB7DQogICAgICAgICAgICAgICAgb3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoZXZlbnQsIDEsIGNvbnRleHQpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgICRuYXZMaW5rcy5vbigia2V5ZG93biIsIGZ1bmN0aW9uKGV2ZW50KXsNCiAgICAgICAgICAgICAgICBzd2l0Y2goZXZlbnQua2V5Q29kZSl7DQogICAgICAgICAgICAgICAgICAgIGNhc2UgMzc6DQogICAgICAgICAgICAgICAgICAgICAgICBvd25lci5vbkNoYW5nZUN1cnJlbnRTbGlkZShldmVudCwgLTEsIGNvbnRleHQpOw0KICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5maW5kKCIuYWN0aXZlIikuZm9jdXMoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICBjYXNlIDM5Og0KICAgICAgICAgICAgICAgICAgICAgICAgb3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoZXZlbnQsIDEsIGNvbnRleHQpOw0KICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5maW5kKCIuYWN0aXZlIikuZm9jdXMoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQoNCiAgICAgICAgLyoqDQogICAgICAgICAqIEF0dGFjaGVzIHBhdXNlIGV2ZW50IHRvIG5hdmlnYXRpb24gd3JhcHBlci4NCiAgICAgICAgICoNCiAgICAgICAgICogQHBhcmFtIHtTbGlkZXJDb250ZXh0fSBjb250ZXh0ICAgYSBjb250ZXh0IG9mIGEgU2xpZGVyIGNsYXNzIGluc3RhbmNlDQogICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hQYXVzZUV2ZW50KGNvbnRleHQpIHsNCiAgICAgICAgICAgIHZhciBvd25lciA9IGNvbnRleHQub3duZXIsDQogICAgICAgICAgICAgICAgJGVsZW1lbnQgPSBjb250ZXh0LiR3cmFwcGVyLA0KICAgICAgICAgICAgICAgICRuYXZMaW5rcyA9ICRlbGVtZW50LmZpbmQoIi5uYXYgYSIpOw0KDQogICAgICAgICAgICB2YXIgY2FsbGJhY2tNb3VzZWVudGVyID0gZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICBjb250ZXh0LnByZXZlbnRTY2hlZHVsaW5nID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICBvd25lci5kZXNjaGVkdWxlU2xpZGUoY29udGV4dCk7DQoNCiAgICAgICAgICAgICAgICBvd25lci5leGVjdXRlT25UaW1lcnMoJ3VwZGF0ZScsIGNvbnRleHQpOw0KICAgICAgICAgICAgICAgIGlmIChjb250ZXh0LnRpbWVJbmRpY2F0b3IgIT09IG51bGwpIHsNCiAgICAgICAgICAgICAgICAgICAgY29udGV4dC50aW1lSW5kaWNhdG9yLnBhdXNlKCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAkZWxlbWVudC5tb3VzZWVudGVyKGNhbGxiYWNrTW91c2VlbnRlcik7DQogICAgICAgICAgICAkbmF2TGlua3Mub24oImZvY3VzIiwgY2FsbGJhY2tNb3VzZWVudGVyKTsNCg0KICAgICAgICAgICAgdmFyIGNhbGxiYWNrTW91c2VMZWF2ZSA9IGZ1bmN0aW9uKCl7DQogICAgICAgICAgICAgICAgY29udGV4dC5wcmV2ZW50U2NoZWR1bGluZyA9IGZhbHNlOw0KICAgICAgICAgICAgICAgIG93bmVyLnNjaGVkdWxlU2xpZGUoY29udGV4dCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICRlbGVtZW50Lm1vdXNlbGVhdmUoY2FsbGJhY2tNb3VzZUxlYXZlKTsNCiAgICAgICAgICAgICRuYXZMaW5rcy5vbigiYmx1ciIsIGNhbGxiYWNrTW91c2VMZWF2ZSk7DQogICAgICAgIH0NCg0KICAgICAgICAvKioNCiAgICAgICAgICogQ3JlYXRlcyB0aW1lIGluZGljYXRvciB2aWV3DQogICAgICAgICAqDQogICAgICAgICAqIEBwYXJhbSB7U2xpZGVyQ29udGV4dH0gY29udGV4dCAgIGEgY29udGV4dCBvZiBhIFNsaWRlciBjbGFzcyBpbnN0YW5jZQ0KICAgICAgICAgKi8NCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSW5kaWNhdG9yKGNvbnRleHQpIHsNCiAgICAgICAgICAgIHZhciBzZXR0aW5ncyA9IGNvbnRleHQuc2V0dGluZ3MsDQogICAgICAgICAgICAgICAgdGltZUluZGljYXRvciA9IG51bGwsDQogICAgICAgICAgICAgICAgVmlld0NvbnN0cnVjdG9yID0gWEEuY29tcG9uZW50LmNhcm91c2Vscy5JbmRpY2F0b3JWaWV3c1tzZXR0aW5ncy50aW1lSW5kaWNhdG9yLnZpZXddLA0KICAgICAgICAgICAgICAgIHZpZXcgPSBudWxsOw0KDQogICAgICAgICAgICBpZiAoVmlld0NvbnN0cnVjdG9yICE9PSBudWxsKSB7DQogICAgICAgICAgICAgICAgdmlldyA9IG5ldyBWaWV3Q29uc3RydWN0b3Ioc2V0dGluZ3MudGltZUluZGljYXRvci5zZWxlY3Rvciwgc2V0dGluZ3MudGltZUluZGljYXRvci5vcHRpb25zKTsNCiAgICAgICAgICAgICAgICB0aW1lSW5kaWNhdG9yID0gbmV3IFRpbWVJbmRpY2F0b3IoJCwgdmlldywgc2V0dGluZ3MudGltZW91dCk7DQogICAgICAgICAgICAgICAgY29udGV4dC50aW1lSW5kaWNhdG9yID0gdGltZUluZGljYXRvcjsNCiAgICAgICAgICAgICAgICBjb250ZXh0LnRpbWVycy5wdXNoKHRpbWVJbmRpY2F0b3IpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLyoqDQogICAgICAgICAqIEF0dGFjaGVzIGV2ZW50cyB0byBuYXZpZ2F0aW9uLg0KICAgICAgICAgKg0KICAgICAgICAgKiBAcGFyYW0ge1NsaWRlckNvbnRleHR9IGNvbnRleHQgICBhIGNvbnRleHQgb2YgYSBTbGlkZXIgY2xhc3MgaW5zdGFuY2UNCiAgICAgICAgICovDQogICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemVOYXZpZ2F0aW9uKGNvbnRleHQpIHsNCiAgICAgICAgICAgIGNvbnRleHQuc2V0dGluZ3MubmF2aWdhdGlvbi5zbGlkZXNDb3VudCA9IGNvbnRleHQuJHNsaWRlcy5sZW5ndGg7DQogICAgICAgICAgICBjb250ZXh0Lm5hdmlnYXRpb24gPSBuZXcgTmF2aWdhdGlvbigkLCBjb250ZXh0LiR3cmFwcGVyLCBjb250ZXh0LnNldHRpbmdzLm5hdmlnYXRpb24pOw0KICAgICAgICAgICAgYXR0YWNoTmF2aWdhdGlvbkV2ZW50cyhjb250ZXh0KTsNCg0KICAgICAgICAgICAgaWYgKGNvbnRleHQuc2V0dGluZ3MuaXNQYXVzZUVuYWJsZWQpIHsNCiAgICAgICAgICAgICAgICBhdHRhY2hQYXVzZUV2ZW50KGNvbnRleHQpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLyoqDQogICAgICAgICAqIEluaXRpYWxpemVzIHRyYW5zaXRpb24gZm9yIGEgZ2l2ZW4gY29udGV4dC4NCiAgICAgICAgICoNCiAgICAgICAgICogQHBhcmFtIHtTbGlkZXJDb250ZXh0fSBjb250ZXh0ICAgYSBjb250ZXh0IG9mIGEgU2xpZGVyIGNsYXNzIGluc3RhbmNlDQogICAgICAgICAqLw0KICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplVHJhbnNpdGlvbihjb250ZXh0KSB7DQogICAgICAgICAgICB2YXIgVHJhbnNpdGlvbkNvbnN0cnVjdG9yID0gbnVsbCwNCiAgICAgICAgICAgICAgICBvd25lciA9IGNvbnRleHQub3duZXI7DQoNCiAgICAgICAgICAgIGNvbnRleHQudHJhbnNpdGlvblNldHRpbmdzLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgY29udGV4dC5jYW5DaGFuZ2VTbGlkZSA9IHRydWU7DQoNCiAgICAgICAgICAgICAgICBpZiAoY29udGV4dC5wcmV2ZW50U2NoZWR1bGluZykgew0KICAgICAgICAgICAgICAgICAgICBvd25lci5leGVjdXRlT25UaW1lcnMoJ3Jlc2V0JywgY29udGV4dCk7DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgb3duZXIuc2NoZWR1bGVTbGlkZShjb250ZXh0KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KDQogICAgICAgICAgICBUcmFuc2l0aW9uQ29uc3RydWN0b3IgPSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zW2NvbnRleHQuc2V0dGluZ3MudHJhbnNpdGlvbl07DQogICAgICAgICAgICBpZiAoKFRyYW5zaXRpb25Db25zdHJ1Y3RvciA9PT0gbnVsbCkgfHwgKFRyYW5zaXRpb25Db25zdHJ1Y3RvciA9PT0gdW5kZWZpbmVkKSkgew0KICAgICAgICAgICAgICAgIFRyYW5zaXRpb25Db25zdHJ1Y3RvciA9IFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuVHJhbnNpdGlvbnNbY29udGV4dC5kZWZhdWx0cy50cmFuc2l0aW9uXTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNvbnRleHQudHJhbnNpdGlvbiA9IG5ldyBUcmFuc2l0aW9uQ29uc3RydWN0b3IoKTsNCiAgICAgICAgICAgIGNvbnRleHQudHJhbnNpdGlvbi5pbml0KGNvbnRleHQudHJhbnNpdGlvblNldHRpbmdzKTsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAvKioNCiAgICAgICAgICAgICAqIEluaXRpYWxpemVzIFNsaWRlciBvYmplY3Qgd2l0aCBhIGdpdmVuIGNvbnRleHQuDQogICAgICAgICAgICAgKg0KICAgICAgICAgICAgICogQHBhcmFtIHtTbGlkZXJDb250ZXh0fSBjb250ZXh0ICAgYSBjb250ZXh0IG9mIGEgU2xpZGVyIGNsYXNzIGluc3RhbmNlDQogICAgICAgICAgICAgKi8NCiAgICAgICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKGNvbnRleHQpIHsNCiAgICAgICAgICAgICAgICBpbml0aWFsaXplTmF2aWdhdGlvbihjb250ZXh0KTsNCiAgICAgICAgICAgICAgICBpbml0aWFsaXplVHJhbnNpdGlvbihjb250ZXh0KTsNCg0KICAgICAgICAgICAgICAgIGlmIChjb250ZXh0LnNldHRpbmdzLnRpbWVJbmRpY2F0b3IuaXNFbmFibGVkKSB7DQogICAgICAgICAgICAgICAgICAgIGNyZWF0ZUluZGljYXRvcihjb250ZXh0KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgfSgkKSk7DQogICAgLyoqDQogICAgICogZW5kIG9mIFNsaWRlckluaXRpYWxpemVyDQogICAgICovDQoNCiAgICAvKioNCiAgICAgKiBDYXJvdXNlbCBjbGFzcyBkaXNwbGF5cyBvbmUgc2xpZGUgKHNvbWUgY29udGVudCkgYXQgdGhlIHRpbWUuDQogICAgICogSXRzIGJlaGF2aW91ciBkZXBlbmRzIG9uIHNldHRpbmdzIChwYXNzZWQgdG8gaW5pdCgpIG1ldGhvZCkuDQogICAgICogRm9yIG1vcmUgZGV0YWlscyBAc2VlIFNsaWRlciwgQHNlZSBTbGlkZXJJbml0aWFsaXplciwgQHNlZSBOYXZpZ2F0aW9uLA0KICAgICAqIEBzZWUgTmF2aWdhdGlvbkJ1aWxkZXIsIEBzZWUgWEEuY29tcG9uZW50LmNhcm91c2Vscy5UcmFuc2l0aW9ucy5UcmFuc2l0aW9uLA0KICAgICAqIEBzZWUgWEEuY29tcG9uZW50LmNhcm91c2Vscy5JbmRpY2F0b3JWaWV3cy5WaWV3DQogICAgICoNCiAgICAgKiBAY29uc3RydWN0b3INCiAgICAgKi8NCiAgICBmdW5jdGlvbiBDYXJvdXNlbCgkKSB7DQogICAgICAgIHZhciBjb250ZXh0ID0gdGhpczsNCg0KICAgICAgICAvKioNCiAgICAgICAgICogSW5zdGFuY2Ugb2YgYSBTbGlkZXIgY2xhc3MgKEBzZWUgU2xpZGVyKS4NCiAgICAgICAgICoNCiAgICAgICAgICogQG1lbWJlciBDYXJvdXNlbA0KICAgICAgICAgKi8NCiAgICAgICAgdGhpcy5zbGlkZXIgPSBudWxsOw0KICAgICAgICAvKioNCiAgICAgICAgICogRGlzcGxheWVkIHNsaWRlIChqUXVlcnkgb2JqZWN0KS4NCiAgICAgICAgICoNCiAgICAgICAgICogQG1lbWJlciBDYXJvdXNlbA0KICAgICAgICAgKi8NCiAgICAgICAgdGhpcy4kY3VycmVudFNsaWRlID0gbnVsbDsNCiAgICAgICAgLyoqDQogICAgICAgICAqIEFsbCBzbGlkZXMgKGpRdWVyeSBvYmplY3QpLg0KICAgICAgICAgKg0KICAgICAgICAgKiBAbWVtYmVyIENhcm91c2VsDQogICAgICAgICAqLw0KICAgICAgICB0aGlzLiRzbGlkZXMgPSBudWxsOw0KDQogICAgICAgIC8qKg0KICAgICAgICAgKiBDaGFuZ2VzIGN1cnJlbnQgc2xpZGUgdG8gYSAkbmV3U2xpZGUuDQogICAgICAgICAqDQogICAgICAgICAqIEBtZW1iZXIgQ2Fyb3VzZWwNCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9ICRuZXdTbGlkZSAgdGhlIG5ldyBzbGlkZSAoalF1ZXJ5KSBvYmplY3QuDQogICAgICAgICAqLw0KICAgICAgICB0aGlzLmNoYW5nZUN1cnJlbnRTbGlkZSA9IGZ1bmN0aW9uKCRuZXdTbGlkZSkgew0KICAgICAgICAgICAgY29udGV4dC4kY3VycmVudFNsaWRlID0gJG5ld1NsaWRlOw0KICAgICAgICAgICAgY29udGV4dC5zbGlkZXIuc2VsZWN0TmF2aWdhdGlvbkl0ZW0oJG5ld1NsaWRlLmluZGV4KCkpOw0KICAgICAgICB9Ow0KDQogICAgICAgIC8qKg0KICAgICAgICAgKiBSZXR1cm5zIGN1cnJlbnQgc2xpZGUuDQogICAgICAgICAqDQogICAgICAgICAqIEBtZW1iZXIgQ2Fyb3VzZWwNCiAgICAgICAgICogQHJldHVybiBjdXJyZW50IHNsaWRlIChqUXVlcnkpIG9iamVjdC4NCiAgICAgICAgICogQHR5cGUgT2JqZWN0DQogICAgICAgICAqLw0KICAgICAgICB0aGlzLmdldEN1cnJlbnRTbGlkZSA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuJGN1cnJlbnRTbGlkZTsNCiAgICAgICAgfTsNCiAgICB9DQoNCiAgICAvKioNCiAgICAgKiBSZXNldHMgdGhlIGNhcm91c2VsLg0KICAgICAqDQogICAgICogQG1lbWJlciBDYXJvdXNlbA0KICAgICAqLw0KICAgIENhcm91c2VsLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uKCkgew0KICAgICAgICB0aGlzLiRzbGlkZXMuZWFjaChmdW5jdGlvbihpbmRleCkgew0KICAgICAgICAgICAgJCh0aGlzKS5oaWRlKCk7DQogICAgICAgIH0pOw0KDQogICAgICAgIHRoaXMuY2hhbmdlQ3VycmVudFNsaWRlKHRoaXMuJHNsaWRlcy5maXJzdCgpKTsNCiAgICAgICAgdGhpcy4kY3VycmVudFNsaWRlLnNob3coKTsNCiAgICB9Ow0KDQogICAgLyoqDQogICAgICogSW5pdGlhbGl6ZXMgdGhlIGNhcm91c2VsLg0KICAgICAqIFdyYXBwcyBjYXJvdXNlbCBjb250ZW50IHdpdGggPGRpdiBjbGFzcz0id3JhcHBlciIgLz4gZWxlbWVudCwNCiAgICAgKiBzZWxlY3RzIHNsaWRlcyAoPGxpIC8+IGVsZW1lbnRzKSBmcm9tIDx1bCBjbGFzcz0ic2xpZGVzIiAvPiBlbGVtZW50LA0KICAgICAqIGluaXRpYWxpemVzIFNsaWRlciBjbGFzcyBpbmN0YW5jZSwgcmVzZXRzIHRoZSBjYXJvdXNlbCBhbmQgc3RhcnQgYXV0b21hdGljIHNsaWRlcyBjaGFuZ2luZy4NCiAgICAgKg0KICAgICAqIEBtZW1iZXIgQ2Fyb3VzZWwNCiAgICAgKiBAcGFyYW0ge09iamVjdH0gJGNvbnRhaW5lciAgICAgalF1ZXJ5IG9iamVjdCB3aXRoIGEgbWFpbiBodG1sIGVsZW1lbnQgb2YgdGhlIGNhcm91c2VsDQogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgICAgIGNhcm91c2VsIG9wdGlvbnMgb2JqZWN0DQogICAgICovDQogICAgQ2Fyb3VzZWwucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbigkY29udGFpbmVyLCBvcHRpb25zKSB7DQogICAgICAgIHZhciAkd3JhcHBlciA9ICQoJzxkaXYvPicsIHsNCiAgICAgICAgICAgICAgICAnY2xhc3MnOiAnd3JhcHBlcicNCiAgICAgICAgICAgIH0pLA0KICAgICAgICAgICAgc2xpZGVyQ29udGV4dCA9IG51bGw7DQoNCiAgICAgICAgJHdyYXBwZXIuYXBwZW5kKCRjb250YWluZXIuY2hpbGRyZW4oKS5kZXRhY2goKSk7DQogICAgICAgICRjb250YWluZXIuYXBwZW5kKCR3cmFwcGVyKTsNCiAgICAgICAgdGhpcy4kc2xpZGVzID0gJGNvbnRhaW5lci5maW5kKCcuc2xpZGVzIGxpLnNsaWRlJyk7DQoNCiAgICAgICAgc2xpZGVyQ29udGV4dCA9IG5ldyBTbGlkZXJDb250ZXh0KCk7DQogICAgICAgIHNsaWRlckNvbnRleHQuY2hhbmdlQ3VycmVudFNsaWRlID0gdGhpcy5jaGFuZ2VDdXJyZW50U2xpZGU7DQogICAgICAgIHNsaWRlckNvbnRleHQuZ2V0Q3VycmVudFNsaWRlID0gdGhpcy5nZXRDdXJyZW50U2xpZGU7DQogICAgICAgIHNsaWRlckNvbnRleHQuJHNsaWRlcyA9IHRoaXMuJHNsaWRlczsNCiAgICAgICAgc2xpZGVyQ29udGV4dC4kd3JhcHBlciA9ICR3cmFwcGVyOw0KDQogICAgICAgIHRoaXMuc2xpZGVyID0gbmV3IFNsaWRlcigkLCBzbGlkZXJDb250ZXh0LCBvcHRpb25zKTsNCiAgICAgICAgU2xpZGVySW5pdGlhbGl6ZXIuaW5pdGlhbGl6ZShzbGlkZXJDb250ZXh0KTsNCg0KICAgICAgICB0aGlzLnJlc2V0KCk7DQogICAgICAgIHRoaXMuc2xpZGVyLnJ1bigpOw0KICAgIH07DQogICAgLyoqDQogICAgICogZW5kIG9mIENhcm91c2VsIGNsYXNzDQogICAgICovDQoNCiAgICAvKioNCiAgICAgKiBSZWdpc3RlcnMgZWFjaCBlbGVtZW50cyB0aGF0IG1hdGNoIHRoZSBwcm92aWRlZCBzZWxlY3RvciBhcyBhIGNhcm91c2VsIHdpdGggYSBnaXZlbiBvcHRpb25zLg0KICAgICAqIENhcm91c2VsIG9wdGlvbnMgb2JqZWN0IDoNCiAgICAgKiB7DQogICAgICogICAgIC8vDQogICAgICogICAgIC8vIG5hdmlnYXRpb246IE9iamVjdA0KICAgICAqICAgICAvLw0KICAgICAqICAgICAvLyBUaGUgbmF2aWdhdGlvbiBjb25maWd1cmF0aW9uIG9iamVjdC4NCiAgICAgKiAgICAgLy8NCiAgICAgKiAgICAgJ25hdmlnYXRpb24nOiB7DQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgLy9pc0VuYWJsZWQ6IEJvb2xlYW4NCiAgICAgKiAgICAgICAgIC8vDQogICAgICogICAgICAgICAvLyBTZXRzIHdoZXRoZXIgdGhlIG5hdmlnYXRpb24gaXMgZW5hYmxlZC4NCiAgICAgKiAgICAgICAgIC8vDQogICAgICogICAgICAgICAnaXNFbmFibGVkJzogdHJ1ZSwNCiAgICAgKiAgICAgICAgIC8vDQogICAgICogICAgICAgICAvLyBoYXNQcmV2TmV4dEl0ZW1zOiBCb29sZWFuDQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgLy8gU2V0cyB3aGV0aGVyIHRoZSBuYXZpZ2F0aW9uIGhhcyBwcmV2aW91cyBhbmQgbmV4dCBidXR0b25zLg0KICAgICAqICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgICdoYXNQcmV2TmV4dEl0ZW1zJzogdHJ1ZSwNCiAgICAgKiAgICAgICAgIC8vDQogICAgICogICAgICAgICAvLyBpdGVtOiBPYmplY3QNCiAgICAgKiAgICAgICAgIC8vDQogICAgICogICAgICAgICAvLyBOYXZpZ2F0aW9uIGl0ZW0gY29uZmlndXJhdGlvbiBvYmplY3QuDQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgJ2l0ZW0nOiB7DQogICAgICogICAgICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgICAgICAvLyBsYWJlbDogU3RyaW5nDQogICAgICogICAgICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgICAgICAvLyBMYWJlbCB0ZW1wbGF0ZTsgZWFjaCAnI3tpbmRleH0nIHN0cmluZyB3aWxsIGJlIHJlcGxhY2VkIGJ5IHRoZSBudW1iZXIgb2YgYSBzbGlkZS4NCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgICdsYWJlbCc6ICcje2luZGV4fScsDQogICAgICogICAgICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgICAgICAvLyBzZWxlY3RvcjogU3RyaW5nDQogICAgICogICAgICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgICAgICAvLyBOYXZpZ2F0aW9uIGl0ZW1zIGNvbnRhaW5lciBzZWxlY3RvcjsgaWYgZXF1YWxzIG51bGwsIHRoZSBjb250YWluZXIgd2lsbCBiZSBnZW5lcmF0ZWQNCiAgICAgKiAgICAgICAgICAgICAvLyAoJ2RpdicgZWxlbWVudCB3aXRoICduYXYnIGNsYXNzIGF0dHJpYnV0ZSBpbnNpZGUgdGhlIGNhcm91c2VsKS4NCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgICdzZWxlY3Rvcic6IG51bGwNCiAgICAgKiAgICAgICAgfSwNCiAgICAgKiAgICAgICAgIC8vDQogICAgICogICAgICAgICAvLyBwcmV2SXRlbTogT2JqZWN0DQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgLy8gTmF2aWdhdGlvbiAncHJldmlvdXMgaXRlbScgY29uZmlndXJhdGlvbiBvYmplY3QuDQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgJ3ByZXZJdGVtJzogew0KICAgICAqICAgICAgICAgICAgIC8vDQogICAgICogICAgICAgICAgICAgLy8gbGFiZWw6IFN0cmluZw0KICAgICAqICAgICAgICAgICAgIC8vDQogICAgICogICAgICAgICAgICAgLy8gVGhlICdwcmV2aW91cyBpdGVtJyBsYWJlbC4NCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgICdsYWJlbCc6ICc8JywNCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgIC8vIHNlbGVjdG9yOiBTdHJpbmcNCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgIC8vIE5hdmlnYXRpb24gJ3ByZXZpb3VzIGl0ZW0nIHNlbGVjdG9yOyBpZiBlcXVhbHMgbnVsbCwgdGhlIGl0ZW0gd2lsbCBiZSBnZW5lcmF0ZWQNCiAgICAgKiAgICAgICAgICAgICAvLyAoJ2EnIGVsZW1lbnQgd2l0aCAncHJldicgY2xhc3MgYXR0cmlidXRlIGluc2lkZSB0aGUgbmF2aWdhdGlvbiBjb250YWluZXIpLg0KICAgICAqICAgICAgICAgICAgIC8vDQogICAgICogICAgICAgICAgICAgJ3NlbGVjdG9yJzogbnVsbCwNCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgIC8vIGlzQ29udGFpbmVyOiBCb29sZWFuDQogICAgICogICAgICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgICAgICAvLyBTZXRzIHdoZXRoZXIgdGhlIGVsZW1lbnQgZm91bmQgYnkgc2VsZWN0b3Igc2hvdWxkIGJlIHRyZWF0ZWQgYXMgYSBjb250YWluZXIgKGlmIHRydWUpDQogICAgICogICAgICAgICAgICAgLy8gb3Igc2hvdWxkIGJlIGFkb3B0ZWQgYXMgYSAncHJldmlvdXMgaXRlbScgKGlmIGZhbHNlKS4gSWYgc2VsZWN0b3IgZXF1YWxzIG51bGwgdGhpcyBwcm9wZXJ0eSBpcyBtZWFuaW5nbGVzcy4NCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgICdpc0NvbnRhaW5lcic6IGZhbHNlDQogICAgICogICAgICAgICB9LA0KICAgICAqICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgIC8vIG5leHRJdGVtOiBPYmplY3QNCiAgICAgKiAgICAgICAgIC8vDQogICAgICogICAgICAgICAvLyBOYXZpZ2F0aW9uICduZXh0IGl0ZW0nIGNvbmZpZ3VyYXRpb24gb2JqZWN0Lg0KICAgICAqICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgICduZXh0SXRlbSc6IHsNCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgIC8vIGxhYmVsOiBTdHJpbmcNCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgIC8vIFRoZSAnbmV4dCBpdGVtJyBsYWJlbC4NCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgICdsYWJlbCc6ICc+JywNCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgIC8vIHNlbGVjdG9yOiBTdHJpbmcNCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgIC8vIE5hdmlnYXRpb24gJ25leHQgaXRlbScgc2VsZWN0b3I7IGlmIGVxdWFscyBudWxsLCB0aGUgaXRlbSB3aWxsIGJlIGdlbmVyYXRlZA0KICAgICAqICAgICAgICAgICAgIC8vICgnYScgZWxlbWVudCB3aXRoICduZXh0JyBjbGFzcyBhdHRyaWJ1dGUgaW5zaWRlIHRoZSBuYXZpZ2F0aW9uIGNvbnRhaW5lcikuDQogICAgICogICAgICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgICAgICAnc2VsZWN0b3InOiBudWxsLA0KICAgICAqICAgICAgICAgICAgIC8vDQogICAgICogICAgICAgICAgICAgLy8gaXNDb250YWluZXI6IEJvb2xlYW4NCiAgICAgKiAgICAgICAgICAgICAvLw0KICAgICAqICAgICAgICAgICAgIC8vIFNldHMgd2hldGhlciB0aGUgZWxlbWVudCBmb3VuZCBieSBzZWxlY3RvciBzaG91bGQgYmUgdHJlYXRlZCBhcyBhIGNvbnRhaW5lciAoaWYgdHJ1ZSkNCiAgICAgKiAgICAgICAgICAgICAvLyBvciBzaG91bGQgYmUgYWRvcHRlZCBhcyBhICduZXh0IGl0ZW0nIChpZiBmYWxzZSkuIElmIHNlbGVjdG9yIGVxdWFscyBudWxsIHRoaXMgcHJvcGVydHkgaXMgbWVhbmluZ2xlc3MuDQogICAgICogICAgICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgICAgICAnaXNDb250YWluZXInOiBmYWxzZQ0KICAgICAqICAgICAgICAgfQ0KICAgICAqICAgICB9LA0KICAgICAqICAgICAvLw0KICAgICAqICAgICAvLyB0aW1lb3V0OiBOdW1iZXINCiAgICAgKiAgICAgLy8NCiAgICAgKiAgICAgLy8gVGhlIGludGVydmFsIGJldHdlZW4gdGhlIHNsaWRlcyBpbiBtaWxpc2Vjb25kcy4NCiAgICAgKiAgICAgLy8NCiAgICAgKiAgICAgJ3RpbWVvdXQnOiAxMDAwMCwNCiAgICAgKiAgICAgLy8NCiAgICAgKiAgICAgLy8gdHJhbnNpdGlvbjogU3RyaW5nDQogICAgICogICAgIC8vDQogICAgICogICAgIC8vIE5hbWUgb2YgdGhlIHRyYW5zaXRpb24gY2xhc3MsIHdoaWNoIHdpbGwgYmUgdXNlZC4gUG9zc2libGUgdmFsdWVzIGFyZToNCiAgICAgKiAgICAgLy8gLSBCYXNpY1RyYW5zaXRpb24gLSB3aXRob3V0IGFueSBhbmltYXRpb24sDQogICAgICogICAgIC8vIC0gRmFkZUluVHJhbnNpdGlvbiAtIG5ldyBzbGlkZSBmYWRlcyBpbiwNCiAgICAgKiAgICAgLy8gLSBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb24gLSBuZXcgc2xpZGUgbW92ZXMgZnJvbSByaWdodCAoZnJvbSBsZWZ0IGlmIHVzZXIgc2VsZWN0cyBzbGlkZSB3aXRoIGxvd2VyIGlkIG9yIGNsaWNrcyBvbiAncHJldmlvdXMgaXRlbScpLA0KICAgICAqICAgICAvLyAtIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24gLSBuZXcgc2xpZGUgbW92ZXMgZnJvbSB0b3AgKGZyb20gYm90dG9tIGlmIHVzZXIgc2VsZWN0cyBzbGlkZSB3aXRoIGxvd2VyIGlkIG9yIGNsaWNrcyBvbiAncHJldmlvdXMgaXRlbScpLA0KICAgICAqICAgICAvLyAtIG90aGVyIC0gaWYgaW1wbGVtZW50ZWQgKGRlcml2ZWQgZnJvbSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zLlRyYW5zaXRpb24gY2xhc3MpIGFuZCBhZGRlZCB0byBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zIG1vZHVsZS4NCiAgICAgKiAgICAgLy8NCiAgICAgKiAgICAgJ3RyYW5zaXRpb24nOiAnQmFzaWNUcmFuc2l0aW9uJywNCiAgICAgKiAgICAgLy8NCiAgICAgKiAgICAgLy8gaXNQYXVzZUVuYWJsZWQ6IEJvb2xlYW4NCiAgICAgKiAgICAgLy8NCiAgICAgKiAgICAgLy8gU2V0cyB3aGV0aGVyIHRoZSBwYXVzZSBmZWF0dXJlIGlzIGVuYWJsZWQuDQogICAgICogICAgIC8vIFBhdXNlIGZlYXR1cmUgcGF1c2VzIGNvdW50ZG93biBvZiBjaGFuZ2luZyBzbGlkZXMsIHdoZW4gbW91c2UgaXMgaW4gYSBjYXJvdXNlbCBhcmVhLg0KICAgICAqICAgICAvLw0KICAgICAqICAgICAnaXNQYXVzZUVuYWJsZWQnOiB0cnVlLA0KICAgICAqICAgICAvLw0KICAgICAqICAgICAvLyB0aW1lSW5kaWNhdG9yOiBPYmplY3QNCiAgICAgKiAgICAgLy8NCiAgICAgKiAgICAgLy8gJ1RpbWUgaW5kaWNhdG9yJyBjb25maWd1cmF0aW9uIG9iamVjdC4NCiAgICAgKiAgICAgLy8NCiAgICAgKiAgICAgJ3RpbWVJbmRpY2F0b3InOiB7DQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgLy8gaXNFbmFibGVkOiBCb29sZWFuDQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgLy8gU2V0cyB3aGV0aGVyIHRoZSAndGltZSBpbmRpY2F0b3InIGlzIGVuYWJsZWQuDQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgJ2lzRW5hYmxlZCc6IGZhbHNlLA0KICAgICAqICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgIC8vIHNlbGVjdG9yOiBTdHJpbmcNCiAgICAgKiAgICAgICAgIC8vDQogICAgICogICAgICAgICAvLyAnVGltZSBpbmRpY2F0b3InIHNlbGVjdG9yLg0KICAgICAqICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgICdzZWxlY3Rvcic6IG51bGwsDQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgLy8gdmlldzogU3RyaW5nDQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgLy8gTmFtZSBvZiB0aGUgdmlldyBjbGFzcywgd2hpY2ggd2lsbCBiZSB1c2VkLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOg0KICAgICAqICAgICAgICAgLy8gLSBWaWV3IC0gd2l0aG91dCBhbnkgYW5pbWF0aW9uIChiYXNlIGNsYXNzKSwNCiAgICAgKiAgICAgICAgIC8vIC0gUHJvZ3Jlc3NCYXJWaWV3IC0gc2hvd3MgdGhlIHByb2dyZXNzIG9mIHRpbWUgYXMgcHJvZ3Jlc3MgYmFyLA0KICAgICAqICAgICAgICAgLy8gLSBSb3RhdG9yVmlldyAtIHNob3dzIHRoZSBwcm9ncmVzcyBvZiB0aW1lIHdpdGggdGhlIGZpbGxpbmcgdXAgcmluZw0KICAgICAqICAgICAgICAgLy8gLSBvdGhlciAtIGlmIGltcGxlbWVudGVkIChkZXJpdmVkIGZyb20gWEEuY29tcG9uZW50LmNhcm91c2Vscy5JbmRpY2F0b3JWaWV3cy5WaWV3IGNsYXNzKSBhbmQgYWRkZWQgdG8gWEEuY29tcG9uZW50LmNhcm91c2Vscy5JbmRpY2F0b3JWaWV3cyBtb2R1bGUuDQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgJ3ZpZXcnOiAnVmlldycsDQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgLy8gb3B0aW9uczogT2JqZWN0DQogICAgICogICAgICAgICAvLw0KICAgICAqICAgICAgICAgLy8gJ1RpbWUgaW5kaWNhdG9yJyB2aWV3IHNldHRpbmdzIG9iamVjdC4gRGVwZW5kcyBvbiB2aWV3Lg0KICAgICAqICAgICAgICAgLy8NCiAgICAgKiAgICAgICAgICdvcHRpb25zJzoge30NCiAgICAgKiAgICAgfQ0KICAgICAqIH0NCiAgICAgKi8NCg0KICAgIC8qIHB1Yi5yZWdpc3RlciA9IGZ1bmN0aW9uIChzZWxlY3Rvciwgb3B0aW9ucykgew0KICAgICB2YXIgJGNhcm91c2VscyA9ICQoc2VsZWN0b3IpOw0KICAgICAkY2Fyb3VzZWxzLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAvL3ZhciBjYXJvdXNlbCA9IG5ldyBDYXJvdXNlbCgkKTsNCiAgICAgY29uc29sZS5sb2coJCh0aGlzKSk7DQogICAgIC8vY2Fyb3VzZWwuaW5pdCgkKHRoaXMpLCBvcHRpb25zKTsNCiAgICAgfSk7DQogICAgIH07Ki8NCg0KICAgIENhcm91c2VsLnByb3RvdHlwZS5hZGRSZXNwb25zaXZlID0gZnVuY3Rpb24oY2Fyb3VzZWwpIHsNCiAgICAgICAgZnVuY3Rpb24gc2V0Q2Fyb3VzZWxTaXplKCkgew0KICAgICAgICAgICAgY2Fyb3VzZWwuY3NzKCJ3aWR0aCIsICIxMDAlIik7DQogICAgICAgICAgICBjYXJvdXNlbC5jc3MoImhlaWdodCIsICJhdXRvIik7DQogICAgICAgICAgICBjYXJvdXNlbC5maW5kKCIud3JhcHBlciAsIC5zbGlkZSIpLmNzcygiaGVpZ2h0IiwgImF1dG8iKTsNCg0KICAgICAgICAgICAgdmFyIGNhcm91c2VsV2lkdGggPSBjYXJvdXNlbC53aWR0aCgpLA0KICAgICAgICAgICAgICAgIHNsaWRlcyA9IGNhcm91c2VsLmZpbmQoJy5zbGlkZScpLA0KICAgICAgICAgICAgICAgIHNsaWRlTWF4SGVpZ2h0ID0gMDsNCg0KDQogICAgICAgICAgICBfLmVhY2goc2xpZGVzLCBmdW5jdGlvbihpdGVtKSB7DQogICAgICAgICAgICAgICAgdmFyIHNsaWRlSGVpZ2h0ID0gJChpdGVtKS5vdXRlckhlaWdodCgpOw0KDQogICAgICAgICAgICAgICAgaWYgKHNsaWRlTWF4SGVpZ2h0IDwgc2xpZGVIZWlnaHQpIHsNCiAgICAgICAgICAgICAgICAgICAgc2xpZGVNYXhIZWlnaHQgPSBzbGlkZUhlaWdodDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgY2Fyb3VzZWwuZmluZCgiLnNsaWRlLCAuc2xpZGVzIikuY3NzKCJ3aWR0aCIsIGNhcm91c2VsV2lkdGgpOw0KICAgICAgICAgICAgY2Fyb3VzZWwuZmluZCgiLndyYXBwZXIiKS5jc3MoImhlaWdodCIsIHNsaWRlTWF4SGVpZ2h0KTsNCiAgICAgICAgICAgIGNhcm91c2VsLmZpbmQoIi5zbGlkZSIpLmNzcygiaGVpZ2h0Iiwgc2xpZGVNYXhIZWlnaHQpOw0KICAgICAgICB9DQoNCiAgICAgICAgc2V0Q2Fyb3VzZWxTaXplKCk7DQogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHNldENhcm91c2VsU2l6ZSgpOw0KICAgICAgICB9KTsNCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHNldENhcm91c2VsU2l6ZSgpOw0KCQkJY2Fyb3VzZWwuYWRkQ2xhc3MoImNhcm91c2VsLXJlYWR5Iik7DQogICAgICAgIH0pOw0KICAgIH07DQoNCiAgICAvKiBDYXJvdXNlbCB0b3VjaCBzdXBwb3J0ICovDQogICAgQ2Fyb3VzZWwucHJvdG90eXBlLnN3aXBlU2xpZGUgPSBmdW5jdGlvbiAoZSkgew0KICAgICAgICB2YXIgc2VsZiA9IHRoaXMsDQogICAgICAgICAgICAkd3JhcHBlciA9IHRoaXMuc2xpZGVyLmNvbnRleHQuJHdyYXBwZXIsDQogICAgICAgICAgICBoYW1tZXIgPSBuZXcgSGFtbWVyKCR3cmFwcGVyWzBdKTsNCg0KICAgICAgICBoYW1tZXIub24oInN3aXBlbGVmdCIsIGZ1bmN0aW9uKGUpIHsNCiAgICAgICAgICAgIHNlbGYuc2xpZGVyLmNvbnRleHQub3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoZSwgMSwgc2VsZi5zbGlkZXIuY29udGV4dCk7DQogICAgICAgIH0pOw0KDQogICAgICAgIGhhbW1lci5vbigic3dpcGVyaWdodCIsIGZ1bmN0aW9uKGUpIHsNCiAgICAgICAgICAgIHNlbGYuc2xpZGVyLmNvbnRleHQub3duZXIub25DaGFuZ2VDdXJyZW50U2xpZGUoZSwgLTEsIHNlbGYuc2xpZGVyLmNvbnRleHQpOw0KICAgICAgICB9KTsNCiAgICB9Ow0KDQogICAgQ2Fyb3VzZWwucHJvdG90eXBlLmNoZWNrRm9yRGlzYWJsZXIgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBzbGlkZXMgPSB0aGlzLiRzbGlkZXM7DQogICAgICAgICR3cmFwcGVyID0gdGhpcy5zbGlkZXIuY29udGV4dC4kd3JhcHBlcjsNCiAgICAgICAgXy5lYWNoKHNsaWRlcywgZnVuY3Rpb24oaXRlbSkgew0KICAgICAgICAgICAgdmFyICRpdGVtID0gJChpdGVtKSwNCiAgICAgICAgICAgICAgICBjcGRpc2FibGVkID0gJGl0ZW0uZmluZCgnLmNwZGlzYWJsZXInKSwNCiAgICAgICAgICAgICAgICAkaXRlbUJvcmRlciA9IHBhcnNlSW50KCQoaXRlbSkuY3NzKCdib3JkZXInKSwgMTApID8gcGFyc2VJbnQoJChpdGVtKS5jc3MoJ2JvcmRlcicpLCAxMCkgIDogMTA7DQoNCiAgICAgICAgICAgIGlmIChjcGRpc2FibGVkLnNpYmxpbmdzKCcuY29tcG9uZW50JykubGVuZ3RoIDwgMSkgew0KICAgICAgICAgICAgICAgICR3cmFwcGVyLmNzcyh7DQogICAgICAgICAgICAgICAgICAgICdtaW4taGVpZ2h0JyA6IDI1DQogICAgICAgICAgICAgICAgfSkNCiAgICAgICAgICAgICAgICBjcGRpc2FibGVkLnRleHQoIkVkaXQgZWxlbWVudCBoZXJlIik7DQogICAgICAgICAgICAgICAgY3BkaXNhYmxlZC5wYXJlbnQoKS5jc3Moew0KICAgICAgICAgICAgICAgICAgICAnd2lkdGgnIDogJGl0ZW0ud2lkdGgoKSAtICRpdGVtQm9yZGVyLA0KICAgICAgICAgICAgICAgICAgICAnbWluLWhlaWdodCcgOiAyNSwNCiAgICAgICAgICAgICAgICAgICAgJ2hlaWdodCcgOiAkaXRlbS5oZWlnaHQoKQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9DQoNCg0KICAgIENhcm91c2VsLnByb3RvdHlwZS5yZXNpemVXcmFwcGVyID0gZnVuY3Rpb24oKSB7DQogICAgICAgIHZhciBwYWdlSGVpZ2h0ID0gJChkb2N1bWVudCkub3V0ZXJIZWlnaHQoKSwNCiAgICAgICAgICAgIGhlYWRlckhlaWdodCA9ICQoJyNoZWFkZXInKS5vdXRlckhlaWdodCgpLA0KICAgICAgICAgICAgY29udGVudFBhZGRpbmdUb3AgPSBwYXJzZUludCgkKCcjY29udGVudCcpLmNzcygncGFkZGluZy10b3AnKSwgMTApLA0KICAgICAgICAgICAgY29udGVudFBhZGRpbmdCb3R0b20gPSBwYXJzZUludCgkKCcjY29udGVudCcpLmNzcygncGFkZGluZy1ib3R0b20nKSwgMTApLA0KICAgICAgICAgICAgY29udGVudFBhZGRpbmcgPSBjb250ZW50UGFkZGluZ1RvcCArIGNvbnRlbnRQYWRkaW5nQm90dG9tLA0KICAgICAgICAgICAgZm9vdGVySGVpZ2h0ID0gJCgnI2Zvb3RlcicpLm91dGVySGVpZ2h0KCksDQogICAgICAgICAgICB3cmFwcGVyID0gdGhpcy5zbGlkZXIuY29udGV4dC4kd3JhcHBlciwNCiAgICAgICAgICAgIGNhcm91c2VsSGVpZ2h0ID0gMDsNCg0KICAgICAgICBjYXJvdXNlbEhlaWdodCA9IHBhZ2VIZWlnaHQgLSAoaGVhZGVySGVpZ2h0ICsgZm9vdGVySGVpZ2h0ICsgY29udGVudFBhZGRpbmcpOw0KDQogICAgICAgIHdyYXBwZXIuY3NzKHsNCiAgICAgICAgICAgICdoZWlnaHQnOiBjYXJvdXNlbEhlaWdodA0KICAgICAgICB9KTsNCg0KICAgICAgICB3cmFwcGVyLmZpbmQoJy5zbGlkZXMnKS5jc3Moew0KICAgICAgICAgICAgJ2hlaWdodCc6IGNhcm91c2VsSGVpZ2h0DQogICAgICAgIH0pOw0KICAgIH07DQoNCg0KDQogICAgcHViLmluaXQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgJCgiLmNhcm91c2VsOm5vdCguaW5pdGlhbGl6ZWQpIikuZWFjaChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciBwcm9wZXJ0aWVzID0gJCh0aGlzKS5kYXRhKCJwcm9wZXJ0aWVzIiksDQogICAgICAgICAgICAgICAgY29tcG9uZW50ID0gJCh0aGlzKS5maW5kKCIuY2Fyb3VzZWwtaW5uZXIiKSwNCiAgICAgICAgICAgICAgICBpZCA9IGNvbXBvbmVudC5hdHRyKCJpZCIpOw0KDQogICAgICAgICAgICBpZiAocHJvcGVydGllcykgew0KICAgICAgICAgICAgICAgIHByb3BlcnRpZXMubmF2aWdhdGlvbi5pdGVtLnNlbGVjdG9yID0gIiMiICsgcHJvcGVydGllcy5uYXZpZ2F0aW9uLml0ZW0uc2VsZWN0b3I7DQogICAgICAgICAgICAgICAgcHJvcGVydGllcy5uYXZpZ2F0aW9uLnByZXZJdGVtLnNlbGVjdG9yID0gIiMiICsgaWQgKyAiIC5uYXYiOw0KICAgICAgICAgICAgICAgIHByb3BlcnRpZXMubmF2aWdhdGlvbi5uZXh0SXRlbS5zZWxlY3RvciA9ICIjIiArIGlkICsgIiAubmF2IjsNCg0KICAgICAgICAgICAgICAgIHZhciBjYXJvdXNlbCA9IG5ldyBDYXJvdXNlbCgkKTsNCiAgICAgICAgICAgICAgICBjYXJvdXNlbC5pbml0KGNvbXBvbmVudCwgcHJvcGVydGllcyk7DQogICAgICAgICAgICAgICAgY2Fyb3VzZWwuYWRkUmVzcG9uc2l2ZSgkKHRoaXMpKTsNCg0KICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgZnVuY3Rpb24oZSkgew0KICAgICAgICAgICAgICAgICAgICBpZigkKHNlbGYpLmhhc0NsYXNzKCdjYXJvdXNlbC1jbGllbnRzJykpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNhcm91c2VsLnJlc2l6ZVdyYXBwZXIoKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIGNhcm91c2VsLmNoZWNrRm9yRGlzYWJsZXIoKTsNCiAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgIGNhcm91c2VsLnN3aXBlU2xpZGUoKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygiaW5pdGlhbGl6ZWQiKTsNCiAgICAgICAgfSk7DQogICAgfTsNCg0KICAgIHJldHVybiBwdWI7DQp9KGpRdWVyeSkpOw0KLyoqDQogKiBlbmQgb2YgWEEuY29tcG9uZW50LmNhcm91c2VscyBtb2R1bGUuDQogKi8NCg0KDQpYQS5yZWdpc3RlcigiY2Fyb3VzZWxzIiwgWEEuY29tcG9uZW50LmNhcm91c2Vscyk7DQoNCg0KLyoqDQogKiBDb2duaWZpZGUNCiAqDQogKiBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zIG1vZHVsZS4NCiAqDQogKiBFeHBvc2VzIFRyYW5zaXRpb24gY2xhc3MsIHdoaWNoIGlzIGJhc2UgY2xhc3Mgb2YgYWxsIHRyYW5zaXRpb25zIHVzZWQgYnkgY2Fyb3VzZWxzIChAc2VlIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMsIEBzZWUgU2xpZGVyLCBAc2VlIFRyYW5zaXRpb24pLg0KICogQWxzbyBleHBvc2VzIGltcGxlbWVudGF0aW9uIG9mIGJhc2ljIGVmZmVjdHM6DQogKiAtIEJhc2ljVHJhbnNpdGlvbiAtIHdpdGhvdXQgYW55IGFuaW1hdGlvbiwNCiAqIC0gRmFkZUluVHJhbnNpdGlvbiAtIG5ldyBzbGlkZSBmYWRlcyBpbiwNCiAqIC0gU2xpZGVIb3Jpem9udGFsbHlUcmFuc2l0aW9uIC0gbmV3IHNsaWRlIG1vdmVzIGZyb20gcmlnaHQgKGZyb20gbGVmdCBpZiB1c2VyIHNlbGVjdHMgc2xpZGUgd2l0aCBsb3dlciBpZCBvciBjbGlja3Mgb24gJ3ByZXZpb3VzIGl0ZW0nKSwNCiAqIC0gU2xpZGVWZXJ0aWNhbGx5VHJhbnNpdGlvbiAtIG5ldyBzbGlkZSBtb3ZlcyBmcm9tIHRvcCAoZnJvbSBib3R0b20gaWYgdXNlciBzZWxlY3RzIHNsaWRlIHdpdGggbG93ZXIgaWQgb3IgY2xpY2tzIG9uICdwcmV2aW91cyBpdGVtJykuDQogKiBDYXJvdXNlbCB0YWtlcyB0aGUgY2xhc3MgY29uc3RydWN0b3IgYnkgbmFtZSBmcm9tIHRoaXMgbW9kdWxlIChpdCBpcyBnaXZlbiBpbiBvcHRpb25zIG9iamVjdCBvZiBjYXJvdXNlbDsgQHNlZSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzKS4NCiAqIElmIHRoZXJlIGlzIGEgbmVlZCB0byBpbXBsZW1lbnQgdGhlIG5ldyBlZmZlY3QsIGNyZWF0ZSBhIG5ldyBjbGFzcywgYnkgaW5oZXJpdGluZyBmcm9tIFRyYW5zaXRpb24gY2xhc3MgYW5kIGFkZCBpdCB0byB0aGlzIG1vZHVsZS4NCiAqDQogKiBFeGFtcGxlIGVmZmVjdCBpbXBsZW1lbnRhdGlvbiAoY3VycmVudGx5IGRpc3BsYXllZCBzbGlkZSBpcyBzaHJpbmtpbmcgdG8gY2VudGVyIG9mIHRoZSBjYXJvdXNlbCk6DQogKiAoZnVuY3Rpb24gKCkgew0KKiAgICAgZnVuY3Rpb24gU2FtcGxlVHJhbnNpdGlvbigpIHsgfQ0KKg0KKiAgICAgLy9pbmhlcml0IGZyb20gWEEuY29tcG9uZW50LmNhcm91c2Vscy5UcmFuc2l0aW9ucy5UcmFuc2l0aW9uDQoqICAgICBTYW1wbGVUcmFuc2l0aW9uLnByb3RvdHlwZSA9IG5ldyBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zLlRyYW5zaXRpb24oKTsNCiogICAgIFNhbXBsZVRyYW5zaXRpb24uY29uc3RydWN0b3IgPSBTYW1wbGVUcmFuc2l0aW9uOw0KKg0KKiAgICAgU2FtcGxlVHJhbnNpdGlvbi5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIChzZXR0aW5ncykgew0KKiAgICAgICAgIC8vcG9zaXRpb25pbmcgYWxsIHNsaWRlcyBpbiB0aGUgdG9wIGxlZnQgY29ybmVyIG9mIHRoZSBjYXJvdXNlbA0KKiAgICAgICAgIHNldHRpbmdzLiRzbGlkZXMuY3NzKHsNCiogICAgICAgICAgICAgJ3Bvc2l0aW9uJzogJ2Fic29sdXRlJywNCiogICAgICAgICAgICAgJ3RvcCc6ICcwcHgnLA0KKiAgICAgICAgICAgICAnbGVmdCc6ICcwcHgnDQoqICAgICAgICAgfSk7DQoqICAgICB9Ow0KKg0KKiAgICAgU2FtcGxlVHJhbnNpdGlvbi5wcm90b3R5cGUub25BbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKHNldHRpbmdzLCB3aWR0aCwgaGVpZ2h0KSB7DQoqICAgICAgICAgdmFyIHpJbmRleEF0dHJpYiA9ICd6LWluZGV4JywNCiogICAgICAgICAkY3VycmVudCA9IHNldHRpbmdzLiRjdXJyZW50U2xpZGU7DQoqDQoqICAgICAgICAgJGN1cnJlbnQuaGlkZSgpOw0KICAgICAgICAgIC8vcmV2ZXJ0aW5nIGNoYW5nZXMgaW4gY3NzIHByb3BlcnRpZXMNCiogICAgICAgICAkY3VycmVudC5jc3Moew0KKiAgICAgICAgICAgICAnd2lkdGgnOiB3aWR0aCwNCiogICAgICAgICAgICAgJ2hlaWdodCc6IGhlaWdodCwNCiogICAgICAgICAgICAgJ2xlZnQnOiAwLA0KKiAgICAgICAgICAgICAndG9wJzogMA0KKiAgICAgICAgIH0pOw0KKiAgICAgICAgICRjdXJyZW50LmNzcyh6SW5kZXhBdHRyaWIsICcnKTsNCiogICAgICAgICBzZXR0aW5ncy4kc2xpZGVzLnBhcmVudCgpLmNzcyh6SW5kZXhBdHRyaWIsICcnKTsNCioNCiogICAgICAgICAvL25vdGlmeWluZyB0aGUgY2Fyb3VzZWwsIHRoYXQgYW5pbWF0aW9uIGlzIGNvbXBsZXRlZA0KKiAgICAgICAgIHNldHRpbmdzLmNhbGxiYWNrKCk7DQoqICAgICB9Ow0KKg0KKiAgICAgU2FtcGxlVHJhbnNpdGlvbi5wcm90b3R5cGUucGVyZm9ybSA9IGZ1bmN0aW9uIChzZXR0aW5ncykgew0KKiAgICAgICAgIHZhciBoZWlnaHQgPSBzZXR0aW5ncy4kY3VycmVudFNsaWRlLmhlaWdodCgpLA0KKiAgICAgICAgIHdpZHRoID0gc2V0dGluZ3MuJGN1cnJlbnRTbGlkZS53aWR0aCgpLA0KKiAgICAgICAgIG9uQW5pbWF0aW9uQ29tcGxldGVkID0gdGhpcy5vbkFuaW1hdGlvbkNvbXBsZXRlLA0KKiAgICAgICAgIHpJbmRleEF0dHJpYiA9ICd6LWluZGV4JywNCiogICAgICAgICAkcGFyZW50ID0gc2V0dGluZ3MuJHNsaWRlcy5wYXJlbnQoKSwNCiogICAgICAgICAkY3VycmVudCA9IHNldHRpbmdzLiRjdXJyZW50U2xpZGUsDQoqICAgICAgICAgJG5leHQgPSBzZXR0aW5ncy4kbmV4dFNsaWRlOw0KKg0KKiAgICAgICAgIC8vc2V0dGluZyBhIG5ldyBzbGlkZSB1bmRlciB0aGUgY3VycmVudCBzbGlkZQ0KKiAgICAgICAgICRwYXJlbnQuY3NzKHpJbmRleEF0dHJpYiwgMCk7DQoqICAgICAgICAgJGN1cnJlbnQuY3NzKHpJbmRleEF0dHJpYiwgMSk7DQoqICAgICAgICAgJG5leHQuc2hvdygpOw0KKg0KKiAgICAgICAgIC8vYW5pbWF0ZSBjdXJyZW50IHNsaWRlDQoqICAgICAgICAgJGN1cnJlbnQuYW5pbWF0ZSh7DQoqICAgICAgICAgICAgICd3aWR0aCc6ICcwcHgnLA0KKiAgICAgICAgICAgICAnaGVpZ2h0JzogJzBweCcsDQoqICAgICAgICAgICAgICdsZWZ0Jzogd2lkdGggLyAyLA0KKiAgICAgICAgICAgICAndG9wJzogaGVpZ2h0IC8gMg0KKiAgICAgICAgIH0sIGZ1bmN0aW9uKCkgew0KKiAgICAgICAgICAgICBvbkFuaW1hdGlvbkNvbXBsZXRlZChzZXR0aW5ncywgd2lkdGgsIGhlaWdodCk7DQoqICAgICAgICAgfSk7DQoqICAgICB9Ow0KKg0KKiAgICAgLy9hZGRpbmcgbmV3IGVmZmVjdCB0byBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLlRyYW5zaXRpb25zIG1vZHVsZS4NCiogICAgIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuVHJhbnNpdGlvbnMuU2FtcGxlVHJhbnNpdGlvbiA9IFNhbXBsZVRyYW5zaXRpb247DQoqIH0gKCkpOw0KICoNCiAqLw0KWEEuY29tcG9uZW50LmNhcm91c2Vscy5UcmFuc2l0aW9ucyA9IChmdW5jdGlvbigkKSB7DQogICAgdmFyIHB1YiA9IHt9Ow0KDQogICAgLyoqDQogICAgICogVHJhbnNpdGlvblNldHRpbmdzIGNsYXNzIGhvbGRzIGRhdGEgbmVlZGVkIGZvciBjaGFuZ2luZyBzbGlkZXMNCiAgICAgKiBAY29uc3RydWN0b3INCiAgICAgKi8NCiAgICBmdW5jdGlvbiBUcmFuc2l0aW9uU2V0dGluZ3MoKSB7fQ0KICAgIC8qKg0KICAgICAqIEN1cnJlbnQgc2xpZGUgKGN1cnJlbnRseSBkaXNwbGF5ZWQpIGpRdWVyeSBvYmplY3QNCiAgICAgKg0KICAgICAqIEBtZW1iZXIgVHJhbnNpdGlvblNldHRpbmdzDQogICAgICovDQogICAgVHJhbnNpdGlvblNldHRpbmdzLnByb3RvdHlwZS4kY3VycmVudFNsaWRlID0gbnVsbDsNCiAgICAvKioNCiAgICAgKiBOZXh0IHNsaWRlIGpRdWVyeSBvYmplY3QNCiAgICAgKg0KICAgICAqIEBtZW1iZXIgVHJhbnNpdGlvblNldHRpbmdzDQogICAgICovDQogICAgVHJhbnNpdGlvblNldHRpbmdzLnByb3RvdHlwZS4kbmV4dFNsaWRlID0gbnVsbDsNCiAgICAvKioNCiAgICAgKiBBbGwgc2xpZGVzIChqUXVlcnkgb2JqZWN0KQ0KICAgICAqDQogICAgICogQG1lbWJlciBUcmFuc2l0aW9uU2V0dGluZ3MNCiAgICAgKi8NCiAgICBUcmFuc2l0aW9uU2V0dGluZ3MucHJvdG90eXBlLiRzbGlkZXMgPSBudWxsOw0KICAgIC8qKg0KICAgICAqIE9mZnNldCBiZXR3ZWVuICRjdXJyZW50U2xpZGUgYW5kICRuZXh0U2xpZGUNCiAgICAgKg0KICAgICAqIEBtZW1iZXIgVHJhbnNpdGlvblNldHRpbmdzDQogICAgICovDQogICAgVHJhbnNpdGlvblNldHRpbmdzLnByb3RvdHlwZS5vZmZzZXQgPSAwOw0KICAgIC8qKg0KICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIHdoaWNoIG11c3QgYmUgY2FsbGVkIGFmdGVyIGFuaW1hdGlvbi4NCiAgICAgKg0KICAgICAqIEBtZW1iZXIgVHJhbnNpdGlvblNldHRpbmdzDQogICAgICovDQogICAgVHJhbnNpdGlvblNldHRpbmdzLnByb3RvdHlwZS5jYWxsYmFjayA9IG51bGw7DQogICAgLyoqDQogICAgICogZW5kIG9mIFRyYW5zaXRpb25TZXR0aW5ncyBjbGFzcw0KICAgICAqLw0KICAgIHB1Yi5UcmFuc2l0aW9uU2V0dGluZ3MgPSBUcmFuc2l0aW9uU2V0dGluZ3M7DQoNCiAgICAvKioNCiAgICAgKiBUcmFuc2l0aW9uIGNsYXNzIGlzIGEgYmFzZSBjbGFzcyBvZiBhbGwgdHJhbnNpdGlvbnMuDQogICAgICoNCiAgICAgKiBJbXBvcnRhbnQ6IHNldHRpbmdzLmNhbGxiYWNrKCkgKEBzZWUgVHJhbnNpdGlvblNldHRpbmdzKSBoYXZlIHRvIGJlIGNhbGxlZCBhdCB0aGUgZW5kIG9mIGV4ZWN1dGlvbiB0aGUgcGVyZm9ybSgpIG1ldGhvZC4NCiAgICAgKg0KICAgICAqIEBjb25zdHJ1Y3Rvcg0KICAgICAqLw0KICAgIGZ1bmN0aW9uIFRyYW5zaXRpb24oKSB7fQ0KICAgIFRyYW5zaXRpb24ucHJvdG90eXBlID0gbmV3IFRyYW5zaXRpb24oKTsNCiAgICAvKioNCiAgICAgKiBJbml0aWFsaXplcyBhIHRyYW5zaXRpb24gd2l0aCBnaXZlbiBzZXR0aW5ncyAoQHNlZSBUcmFuc2l0aW9uU2V0dGluZ3MpLg0KICAgICAqDQogICAgICogQG1lbWJlciBUcmFuc2l0aW9uDQogICAgICogQHBhcmFtIHtUcmFuc2l0aW9uU2V0dGluZ3N9IHNldHRpbmdzICB0cmFuc2l0aW9uIHNldHRpbmdzDQogICAgICovDQogICAgVHJhbnNpdGlvbi5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKHNldHRpbmdzKSB7fTsNCiAgICAvKioNCiAgICAgKiBSZXR1cm5zIGEgZmFjdG9yIGFzc29jaWF0ZWQgd2l0aCBzZXR0aW5ncy5vZmZzZXQgKEBzZWUgVHJhbnNpdGlvblNldHRpbmdzKSwgd2hpY2gNCiAgICAgKiBjYW4gYmUgdXNlZnVsbCBmb3Igc29tZSBhbmltYXRpb25zLg0KICAgICAqDQogICAgICogQG1lbWJlciBUcmFuc2l0aW9uDQogICAgICogQHBhcmFtIHtUcmFuc2l0aW9uU2V0dGluZ3N9IHNldHRpbmdzICB0cmFuc2l0aW9uIHNldHRpbmdzDQogICAgICogQHJldHVybiBUaGUgZmFjdG9yOyAxIGlmIG9mZnNldCBpcyBoaWdoZXIgdGhhbiAwLCAtMSBvdGhlcndpc2UNCiAgICAgKiBAdHlwZSBOdW1iZXINCiAgICAgKi8NCiAgICBUcmFuc2l0aW9uLnByb3RvdHlwZS5mYWN0b3IgPSBmdW5jdGlvbihzZXR0aW5ncykgew0KICAgICAgICByZXR1cm4gKHNldHRpbmdzLm9mZnNldCA+IDApID8gMSA6IC0xOw0KICAgIH07DQogICAgLyoqDQogICAgICogVGhpcyBtZXRob2QgaXMgY2FsbGVkIHVzZWQgYnkgY2Fyb3VzZWxzIHRvIGNoYW5nZSBzbGlkZXMuDQogICAgICoNCiAgICAgKiBJbXBvcnRhbnQ6IHNldHRpbmdzLmNhbGxiYWNrKCkgKEBzZWUgVHJhbnNpdGlvblNldHRpbmdzKSBoYXZlIHRvIGJlIGNhbGxlZCBhdCB0aGUgZW5kIG9mIHRoaXMgbWV0aG9kIGV4ZWN1dGlvbi4NCiAgICAgKg0KICAgICAqIEBtZW1iZXIgVHJhbnNpdGlvbg0KICAgICAqIEBwYXJhbSB7VHJhbnNpdGlvblNldHRpbmdzfSBzZXR0aW5ncyAgdHJhbnNpdGlvbiBzZXR0aW5ncw0KICAgICAqLw0KICAgIFRyYW5zaXRpb24ucHJvdG90eXBlLnBlcmZvcm0gPSBmdW5jdGlvbihzZXR0aW5ncykgew0KICAgICAgICBzZXR0aW5ncy5jYWxsYmFjaygpOw0KICAgIH07DQogICAgLyoqDQogICAgICogRW5kIG9mIFRyYW5zaXRpb24gY2xhc3MNCiAgICAgKi8NCiAgICBwdWIuVHJhbnNpdGlvbiA9IFRyYW5zaXRpb247DQoNCiAgICAvKioNCiAgICAgKiBCYXNpY1RyYW5zaXRpb24gY2xhc3MgY2hhbmdlcyBzbGlkZXMgd2l0aG91dCBhbnkgYW5pbWF0aW9uLg0KICAgICAqIERvIG5vdCByZW1vdmUgdGhpcyBjbGFzcywgYmVjYW91c2UgY2Fyb3VzZWxzIHdpbGwgdXNlIGl0IGJ5IGRlZmF1bHQsDQogICAgICogaWYgcmVxdWVzdGVkIHRyYW5zaXRpb24gY2Fubm90IGJlIGZvdW5kLg0KICAgICAqIEBjb25zdHJ1Y3Rvcg0KICAgICAqLw0KICAgIGZ1bmN0aW9uIEJhc2ljVHJhbnNpdGlvbigpIHt9DQogICAgQmFzaWNUcmFuc2l0aW9uLnByb3RvdHlwZSA9IG5ldyBUcmFuc2l0aW9uKCk7DQogICAgQmFzaWNUcmFuc2l0aW9uLmNvbnN0cnVjdG9yID0gQmFzaWNUcmFuc2l0aW9uOw0KICAgIC8qKg0KICAgICAqIEBtZW1iZXIgQmFzaWNUcmFuc2l0aW9uDQogICAgICovDQogICAgQmFzaWNUcmFuc2l0aW9uLnByb3RvdHlwZS5wZXJmb3JtID0gZnVuY3Rpb24oc2V0dGluZ3MpIHsNCiAgICAgICAgc2V0dGluZ3MuJGN1cnJlbnRTbGlkZS5oaWRlKCk7DQogICAgICAgIHNldHRpbmdzLiRuZXh0U2xpZGUuc2hvdygpOw0KDQogICAgICAgIHNldHRpbmdzLmNhbGxiYWNrKCk7DQogICAgfTsNCiAgICAvKioNCiAgICAgKiBFbmQgb2YgQmFzaWNUcmFuc2l0aW9uIGNsYXNzDQogICAgICovDQogICAgcHViLkJhc2ljVHJhbnNpdGlvbiA9IEJhc2ljVHJhbnNpdGlvbjsNCg0KICAgIC8qKg0KICAgICAqIEZhZGVJblRyYW5zaXRpb24gY2xhc3MgY2hhbmdlcyBzbGlkZXMgYnkgZmFkaW5nIGluIG5ldyBzbGlkZS4NCiAgICAgKiBUaGlzIGNsYXNzIGNhbiBiZSByZW1vdmVkIGlmIGVmZmVjdCBpcyBub3QgdXNlZC4NCiAgICAgKiBAY29uc3RydWN0b3INCiAgICAgKi8NCiAgICBmdW5jdGlvbiBGYWRlSW5UcmFuc2l0aW9uKCkge30NCiAgICBGYWRlSW5UcmFuc2l0aW9uLnByb3RvdHlwZSA9IG5ldyBUcmFuc2l0aW9uKCk7DQogICAgRmFkZUluVHJhbnNpdGlvbi5jb25zdHJ1Y3RvciA9IEZhZGVJblRyYW5zaXRpb247DQogICAgLyoqDQogICAgICogQG1lbWJlciBGYWRlSW5UcmFuc2l0aW9uDQogICAgICovDQogICAgRmFkZUluVHJhbnNpdGlvbi5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKHNldHRpbmdzKSB7DQogICAgICAgIC8qc2V0dGluZ3MuJHNsaWRlcy5jc3Moew0KICAgICAgICAgJ3Bvc2l0aW9uJzogJ2Fic29sdXRlJywNCiAgICAgICAgICd0b3AnOiAnMHB4JywNCiAgICAgICAgICdsZWZ0JzogJzBweCcNCiAgICAgICAgIH0pOyovDQogICAgfTsNCiAgICAvKioNCiAgICAgKiBAbWVtYmVyIEZhZGVJblRyYW5zaXRpb24NCiAgICAgKi8NCiAgICBGYWRlSW5UcmFuc2l0aW9uLnByb3RvdHlwZS5wZXJmb3JtID0gZnVuY3Rpb24oc2V0dGluZ3MpIHsNCiAgICAgICAgdmFyIHpJbmRleEF0dHJpYiA9ICd6LWluZGV4JywNCiAgICAgICAgICAgICRwYXJlbnQgPSBzZXR0aW5ncy4kc2xpZGVzLnBhcmVudCgpLA0KICAgICAgICAgICAgJG5leHRTbGlkZSA9IHNldHRpbmdzLiRuZXh0U2xpZGU7DQoNCiAgICAgICAgJHBhcmVudC5jc3MoekluZGV4QXR0cmliLCAwKTsNCiAgICAgICAgJG5leHRTbGlkZS5jc3MoekluZGV4QXR0cmliLCAxKTsNCiAgICAgICAgc2V0dGluZ3MuJHNsaWRlcy5jc3Moew0KICAgICAgICAgICAgJ3Bvc2l0aW9uJzogJ3JlbGF0aXZlJw0KICAgICAgICB9KTsNCg0KICAgICAgICBzZXR0aW5ncy4kbmV4dFNsaWRlLmNzcyh7DQogICAgICAgICAgICAncG9zaXRpb24nOiAnYWJzb2x1dGUnLA0KICAgICAgICAgICAgJ3RvcCc6ICcwcHgnLA0KICAgICAgICAgICAgJ2xlZnQnOiAnMHB4Jw0KICAgICAgICB9KTsNCg0KDQogICAgICAgICRuZXh0U2xpZGUuZmFkZUluKGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgc2V0dGluZ3MuJGN1cnJlbnRTbGlkZS5oaWRlKCk7DQoNCiAgICAgICAgICAgIHNldHRpbmdzLiRuZXh0U2xpZGUuY3NzKHsNCiAgICAgICAgICAgICAgICAncG9zaXRpb24nOiAncmVsYXRpdmUnDQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgJG5leHRTbGlkZS5jc3MoekluZGV4QXR0cmliLCAnJyk7DQogICAgICAgICAgICAkcGFyZW50LmNzcyh6SW5kZXhBdHRyaWIsICcnKTsNCg0KICAgICAgICAgICAgc2V0dGluZ3MuY2FsbGJhY2soKTsNCiAgICAgICAgfSk7DQogICAgfTsNCiAgICAvKioNCiAgICAgKiBFbmQgb2YgRmFkZUluVHJhbnNpdGlvbiBjbGFzcw0KICAgICAqLw0KICAgIHB1Yi5GYWRlSW5UcmFuc2l0aW9uID0gRmFkZUluVHJhbnNpdGlvbjsNCg0KICAgIC8qKg0KICAgICAqIFNsaWRlSG9yaXpvbnRhbGx5VHJhbnNpdGlvbiBjbGFzcyBjaGFuZ2VzIHNsaWRlcyBieSBzbGlkaW5nIHRoZW0gaG9yaXpvbnRhbGx5Lg0KICAgICAqIFRoaXMgY2xhc3MgY2FuIGJlIHJlbW92ZWQgaWYgZWZmZWN0IGlzIG5vdCB1c2VkLg0KICAgICAqIElmIG9mZnNldCAoZGlmZmVyZW5jZSBiZXR3ZWVuIGluZGV4IG9mIGN1cnJlbnRseSBkaXNwbGF5ZWQgc2xpZGUgYW5kIGluZGV4IG9mIHNsaWRlIHRoYXQgd2lsbCBiZSBzaG93bikNCiAgICAgKiBpcyBncmVhdGVyIHRoYW4gMCwgc2xpZGVzIGFyZSBzbGlkaW5nIHRvIHRoZSBsZWZ0LiBPdGhlcndpc2UgKG9mZnNldCBpcyBsb3dlciB0aGFuIDApLCBzbGlkZXMgYXJlIHNsaWRpbmcNCiAgICAgKiB0byB0aGUgbGVmdC4NCiAgICAgKiBXaGVuIHNsaWRlIGNoYW5nZSBpcyByYWlzZWQgYXV0b21hdGljYWxseSwgc2xpZGVzIGFyZSBhbHdheXMgc2xpZGluZyB0byByaWdodCAob2Zmc2V0ID09IDEpLg0KICAgICAqIElmIHVzZXIgcmFpc2VzIHNsaWRlcyBjaGFuZ2UsIHNsaWRlcyBhcmUgc2xpZGluZzoNCiAgICAgKiAtIHRvIGxlZnQsIGlmIG9mZnNldCBpcyBncmVhdGVyIHRoYW4gMCAoc2xpZGUgd2l0aCBoaWdoZXIgaW5kZXggd2lsbCBiZSBzaG93biBvciB1c2VyIGNsaWNrcyBvbiAnbmV4dCcgbmF2aWdhdGlvbiBpdGVtKSwNCiAgICAgKiAtIHRvIHJpZ2h0LCBpZiBvZmZzZXQgaXMgbG93ZXIgdGhhbiAwIChzbGlkZSB3aXRoIGxvd2VyIGluZGV4IHdpbGwgYmUgc2hvd24gb3IgdXNlciBjbGlja3Mgb24gJ3ByZXYnIG5hdmlnYXRpb24gaXRlbSkuDQogICAgICogQGNvbnN0cnVjdG9yDQogICAgICovDQogICAgZnVuY3Rpb24gU2xpZGVIb3Jpem9udGFsbHlUcmFuc2l0aW9uKCkge30NCiAgICBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb24ucHJvdG90eXBlID0gbmV3IFRyYW5zaXRpb24oKTsNCiAgICBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb24uY29uc3RydWN0b3IgPSBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb247DQogICAgLyoqDQogICAgICogQG1lbWJlciBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb24NCiAgICAgKi8NCiAgICBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb24ucHJvdG90eXBlLm9uQW5pbWF0aW9uQ29tcGxldGUgPSBmdW5jdGlvbihzZXR0aW5ncywgJHBhcmVudCkgew0KICAgICAgICBzZXR0aW5ncy4kY3VycmVudFNsaWRlLmhpZGUoKTsNCiAgICAgICAgc2V0dGluZ3MuJG5leHRTbGlkZS5jc3Moew0KICAgICAgICAgICAgJ3Bvc2l0aW9uJzogJycsDQogICAgICAgICAgICAndG9wJzogJycsDQogICAgICAgICAgICAnbGVmdCc6ICcnDQogICAgICAgIH0pOw0KDQogICAgICAgICRwYXJlbnQuY3NzKCdtYXJnaW4tbGVmdCcsICcnKTsNCg0KICAgICAgICBzZXR0aW5ncy5jYWxsYmFjaygpOw0KICAgIH07DQogICAgLyoqDQogICAgICogQG1lbWJlciBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb24NCiAgICAgKi8NCiAgICBTbGlkZUhvcml6b250YWxseVRyYW5zaXRpb24ucHJvdG90eXBlLnBlcmZvcm0gPSBmdW5jdGlvbihzZXR0aW5ncykgew0KICAgICAgICB2YXIgZmFjdG9yID0gdGhpcy5mYWN0b3Ioc2V0dGluZ3MpLA0KICAgICAgICAgICAgb25BbmltYXRpb25Db21wbGV0ZSA9IHRoaXMub25BbmltYXRpb25Db21wbGV0ZSwNCiAgICAgICAgICAgIHdpZHRoID0gc2V0dGluZ3MuJGN1cnJlbnRTbGlkZS53aWR0aCgpLA0KICAgICAgICAgICAgJHBhcmVudCA9IHNldHRpbmdzLiRzbGlkZXMucGFyZW50KCk7DQoNCiAgICAgICAgc2V0dGluZ3MuJG5leHRTbGlkZS5jc3Moew0KICAgICAgICAgICAgJ3Bvc2l0aW9uJzogJ2Fic29sdXRlJywNCiAgICAgICAgICAgICd0b3AnOiAnMHB4JywNCiAgICAgICAgICAgICdsZWZ0JzogZmFjdG9yICogd2lkdGgNCiAgICAgICAgfSk7DQogICAgICAgIHNldHRpbmdzLiRuZXh0U2xpZGUuc2hvdygpOw0KDQogICAgICAgICRwYXJlbnQuYW5pbWF0ZSh7DQogICAgICAgICAgICAnbWFyZ2luLWxlZnQnOiAtZmFjdG9yICogd2lkdGgNCiAgICAgICAgfSwgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICBvbkFuaW1hdGlvbkNvbXBsZXRlKHNldHRpbmdzLCAkcGFyZW50KTsNCiAgICAgICAgfSk7DQogICAgfTsNCiAgICAvKioNCiAgICAgKiBFbmQgb2YgU2xpZGVIb3Jpem9udGFsbHlUcmFuc2l0aW9uIGNsYXNzDQogICAgICovDQogICAgcHViLlNsaWRlSG9yaXpvbnRhbGx5VHJhbnNpdGlvbiA9IFNsaWRlSG9yaXpvbnRhbGx5VHJhbnNpdGlvbjsNCg0KICAgIC8qKg0KICAgICAqIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24gY2xhc3MgY2hhbmdlcyBzbGlkZXMgYnkgc2xpZGluZyB0aGVtIHZlcnRpY2FsbHkuDQogICAgICogVGhpcyBjbGFzcyBjYW4gYmUgcmVtb3ZlZCBpZiB0aGlzIGVmZmVjdCBpcyBub3QgdXNlZC4NCiAgICAgKiBJZiBvZmZzZXQgKGRpZmZlcmVuY2UgYmV0d2VlbiBpbmRleCBvZiBjdXJyZW50bHkgZGlzcGxheWVkIHNsaWRlIGFuZCBpbmRleCBvZiBzbGlkZSB0aGF0IHdpbGwgYmUgc2hvd24pDQogICAgICogaXMgZ3JlYXRlciB0aGFuIDAsIHNsaWRlcyBhcmUgc2xpZGluZyBmcm9tIHVwIHRvIGRvd24uIE90aGVyd2lzZSAob2Zmc2V0IGlzIGxvd2VyIHRoYW4gMCksIHNsaWRlcyBhcmUgc2xpZGluZw0KICAgICAqIGZyb20gZG93biB0byB1cC4NCiAgICAgKiBXaGVuIHNsaWRlIGNoYW5nZSBpcyByYWlzZWQgYXV0b21hdGljYWxseSwgc2xpZGVzIGFyZSBhbHdheXMgc2xpZGluZyBmcm9tIHVwIHRvIGRvd24gKG9mZnNldCA9PSAxKS4NCiAgICAgKiBJZiB1c2VyIHJhaXNlcyBzbGlkZXMgY2hhbmdlLCBzbGlkZXMgYXJlIHNsaWRpbmc6DQogICAgICogLSBmcm9tIHVwIHRvIGRvd24sIGlmIG9mZnNldCBpcyBncmVhdGVyIHRoYW4gMCAoc2xpZGUgd2l0aCBoaWdoZXIgaW5kZXggd2lsbCBiZSBzaG93biBvciB1c2VyIGNsaWNrcyBvbiAnbmV4dCcgbmF2aWdhdGlvbiBpdGVtKSwNCiAgICAgKiAtIGZyb20gZG93biB0byB1cCwgaWYgb2Zmc2V0IGlzIGxvd2VyIHRoYW4gMCAoc2xpZGUgd2l0aCBsb3dlciBpbmRleCB3aWxsIGJlIHNob3duIG9yIHVzZXIgY2xpY2tzIG9uICdwcmV2JyBuYXZpZ2F0aW9uIGl0ZW0pLg0KICAgICAqIEBjb25zdHJ1Y3Rvcg0KICAgICAqLw0KICAgIGZ1bmN0aW9uIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24oKSB7fQ0KICAgIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24ucHJvdG90eXBlID0gbmV3IFRyYW5zaXRpb24oKTsNCiAgICBTbGlkZVZlcnRpY2FsbHlUcmFuc2l0aW9uLmNvbnN0cnVjdG9yID0gU2xpZGVWZXJ0aWNhbGx5VHJhbnNpdGlvbjsNCiAgICAvKioNCiAgICAgKiBAbWVtYmVyIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24NCiAgICAgKi8NCiAgICBTbGlkZVZlcnRpY2FsbHlUcmFuc2l0aW9uLnByb3RvdHlwZS5vbkFuaW1hdGlvbkNvbXBsZXRlID0gZnVuY3Rpb24oc2V0dGluZ3MsICRwYXJlbnQpIHsNCiAgICAgICAgc2V0dGluZ3MuJGN1cnJlbnRTbGlkZS5oaWRlKCk7DQogICAgICAgIHNldHRpbmdzLiRuZXh0U2xpZGUuY3NzKHsNCiAgICAgICAgICAgICdwb3NpdGlvbic6ICcnLA0KICAgICAgICAgICAgJ3RvcCc6ICcnLA0KICAgICAgICAgICAgJ2xlZnQnOiAnJw0KICAgICAgICB9KTsNCg0KICAgICAgICAkcGFyZW50LmNzcygnbWFyZ2luLXRvcCcsICcnKTsNCg0KICAgICAgICBzZXR0aW5ncy5jYWxsYmFjaygpOw0KICAgIH07DQogICAgLyoqDQogICAgICogQG1lbWJlciBTbGlkZVZlcnRpY2FsbHlUcmFuc2l0aW9uDQogICAgICovDQogICAgU2xpZGVWZXJ0aWNhbGx5VHJhbnNpdGlvbi5wcm90b3R5cGUucGVyZm9ybSA9IGZ1bmN0aW9uKHNldHRpbmdzKSB7DQogICAgICAgIHZhciBmYWN0b3IgPSB0aGlzLmZhY3RvcihzZXR0aW5ncyksDQogICAgICAgICAgICBvbkFuaW1hdGlvbkNvbXBsZXRlID0gdGhpcy5vbkFuaW1hdGlvbkNvbXBsZXRlLA0KICAgICAgICAgICAgaGVpZ2h0ID0gc2V0dGluZ3MuJGN1cnJlbnRTbGlkZS5oZWlnaHQoKSwNCiAgICAgICAgICAgICRwYXJlbnQgPSBzZXR0aW5ncy4kc2xpZGVzLnBhcmVudCgpOw0KDQogICAgICAgIHNldHRpbmdzLiRuZXh0U2xpZGUuY3NzKHsNCiAgICAgICAgICAgICdwb3NpdGlvbic6ICdhYnNvbHV0ZScsDQogICAgICAgICAgICAndG9wJzogLWZhY3RvciAqIGhlaWdodCwNCiAgICAgICAgICAgICdsZWZ0JzogJzBweCcNCiAgICAgICAgfSk7DQogICAgICAgIHNldHRpbmdzLiRuZXh0U2xpZGUuc2hvdygpOw0KDQogICAgICAgICRwYXJlbnQuYW5pbWF0ZSh7DQogICAgICAgICAgICAnbWFyZ2luLXRvcCc6IGZhY3RvciAqIGhlaWdodA0KICAgICAgICB9LCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIG9uQW5pbWF0aW9uQ29tcGxldGUoc2V0dGluZ3MsICRwYXJlbnQpOw0KICAgICAgICB9KTsNCiAgICB9Ow0KICAgIC8qKg0KICAgICAqIFNsaWRlVmVydGljYWxseVRyYW5zaXRpb24gY2xhc3MNCiAgICAgKi8NCiAgICBwdWIuU2xpZGVWZXJ0aWNhbGx5VHJhbnNpdGlvbiA9IFNsaWRlVmVydGljYWxseVRyYW5zaXRpb247DQoNCiAgICByZXR1cm4gcHViOw0KfShqUXVlcnkpKTsNCi8qKg0KICogZW5kIG9mIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuVHJhbnNpdGlvbnMgbW9kdWxlLg0KICovDQoNCi8qKg0KICogQ29nbmlmaWRlDQogKg0KICogWEEuY29tcG9uZW50LmNhcm91c2Vscy5JbmRpY2F0b3JWaWV3cyBtb2R1bGUuDQogKg0KICogRXhwb3NlcyBWaWV3IGNsYXNzLCB3aGljaCBpcyBhIGJhc2UgY2xhc3Mgb2YgYWxsICd0aW1lIGluZGljYXRvcicgdmlld3MgdXNlZCBieSBjYXJvdXNlbHMgKEBzZWUgWEEuY29tcG9uZW50LmNhcm91c2VscywgQHNlZSBWaWV3KS4NCiAqIEFsc28gZXhwb3NlcyBpbXBsZW1lbnRhdGlvbiBvZiB0aGVzZSAndGltZSBpbmRpY2F0b3InIHZpZXdzOg0KICogLSBQcm9ncmVzc0JhclZpZXcgLSBzaG93cyB0aGUgcHJvZ3Jlc3Mgb2YgdGltZSwgdGhhdCBsb29rcyBsaWtlIGEgcHJvZ3Jlc3MgYmFyLA0KICogLSBSb3RhdG9yVmlldyAtIHNob3dzIHRoZSBwcm9ncmVzcyBvZiB0aW1lIHdpdGggdGhlIGZpbGxpbmcgdXAgcmluZy4NCiAqIENhcm91c2VsIHRha2VzIHRoZSBjbGFzcyBjb25zdHJ1Y3RvciBieSBuYW1lIGZyb20gdGhpcyBtb2R1bGUgKGl0IGlzIGdpdmVuIGluIG9wdGlvbnMgb2JqZWN0IG9mIGNhcm91c2VsOyBAc2VlIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMpLg0KICogSWYgdGhlcmUgaXMgYSBuZWVkIHRvIGltcGxlbWVudCB0aGUgbmV3ICd0aW1lIGluZGljYXRvcicgdmlldywgY3JlYXRlIGEgbmV3IGNsYXNzLA0KICogYnkgaW5oZXJpdGluZyBmcm9tIFZpZXcgY2xhc3MgYW5kIGFkZCBpdCB0byB0aGlzIG1vZHVsZS4gRHVyaW5nIGltcGxlbWVudGF0aW9uIG9mIGEgbmV3ICd0aW1lIGluZGljYXRvcicNCiAqIHZpZXcgdGhlIFhBLmNvbXBvbmVudC5jYXJvdXNlbHMuSW5kaWNhdG9yc1ZpZXcuVG9vbHMgbmFtZXNwYWNlIG1heSBiZSB1c2VmdWxsLiBJdCBjb250YWluczoNCiAqIC0gaXNDc3NTdXBwb3J0ZWQocHJvcHMpIGZ1bmN0aW9uLCB3aGljaCBjaGVja3MgaWYgYW55IG9mIENTUyBwcm9wZXJ0aWVzIGlzIHN1cHBvcnRlZCAocHJvcHMgLSBhcnJheSBvZiBwcm9wZXJ0aWVzKSwNCiAqIC0gaXNUcmFuc2Zvcm1TdXBwb3J0ZWQoKSBmdW5jdGlvbiwgd2hpY2ggY2hlY2tzIGlmIENTUyAzICd0cmFuc2Zvcm0nIGlzIHN1cHBvcnRlZC4NCiAqDQogKiBFeGFtcGxlIHZpZXcgaW1wbGVtZW50YXRpb24gKG9wYWNpdHkgaW5jcmVhc2VzIHdpdGggYSBwcm9ncmVzcyBvZiB0aGUgdGltZSk6DQogKiAoZnVuY3Rpb24oKSB7DQogKiAgICAgdmFyIFZpZXcgPSBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLkluZGljYXRvclZpZXdzLlZpZXc7DQogKg0KICogICAgIGZ1bmN0aW9uIFNhbXBsZVZpZXcgKHNlbGVjdG9yLCBvcHRpb25zKSB7DQogKiAgICAgICAgIC8vYmFzZSBjb25zdHJ1Y3RvciBoYXZlIHRvIGJlIGNhbGxlZA0KICogICAgICAgICBWaWV3LmNhbGwodGhpcywgc2VsZWN0b3IpOw0KICogICAgIH0NCiAqDQogKiAgICAgU2FtcGxlVmlldy5wcm90b3R5cGUgPSBuZXcgVmlldygpOw0KICogICAgIFNhbXBsZVZpZXcuY29uc3RydWN0b3IgPSBTYW1wbGVWaWV3Ow0KICoNCiAqICAgICBTYW1wbGVWaWV3LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24gKHRpbWVvdXQpIHsNCiAqICAgICAgICAgLy9iYXNlIG1ldGhvZCBoYXZlIHRvIGJlIGNhbGxlZA0KICogICAgICAgICBWaWV3LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcywgdGltZW91dCk7DQogKg0KICogICAgICAgICAvL2luaXRpYWxpemF0aW9uIGNvZGUgLSBub3QgbmVlZGVkIGluIHRoaXMgZXhhbXBsZQ0KICogICAgIH07DQogKg0KICogICAgIFNhbXBsZVZpZXcucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24gKCkgew0KICogICAgICAgICAvL2Jhc2UgbWV0aG9kIGhhdmUgdG8gYmUgY2FsbGVkDQogKiAgICAgICAgIFZpZXcucHJvdG90eXBlLnJlc2V0LmNhbGwodGhpcyk7DQogKg0KICogICAgICAgICAvL3Jlc2V0aW5nICd0aW1lIGluZGljYXRvcicgdmlldw0KICogICAgICAgICB0aGlzLiRpbmRpY2F0b3Iuc3RvcCh0cnVlKTsNCiAqICAgICAgICAgdGhpcy4kaW5kaWNhdG9yLmNzcygnb3BhY2l0eScsIDApOw0KICogICAgIH07DQogKg0KICogICAgIFNhbXBsZVZpZXcucHJvdG90eXBlLnBhdXNlID0gZnVuY3Rpb24gKCkgew0KICogICAgICAgICAvL3N0b3BpbmcgJ3RpbWUgaW5kaWNhdG9yJyB2aWV3IGFuaW1hdGlvbg0KICogICAgICAgICB0aGlzLiRpbmRpY2F0b3Iuc3RvcCh0cnVlKTsNCiAqICAgICB9Ow0KICoNCiAqICAgICBTYW1wbGVWaWV3LnByb3RvdHlwZS5wbGF5ID0gZnVuY3Rpb24gKCkgew0KICogICAgICAgICAvL3N0YXJ0aW5nL3Jlc3VtaW5nICd0aW1lIGluZGljYXRvcicgdmlldyBhbmltYXRpb24NCiAqICAgICAgICAgdGhpcy4kaW5kaWNhdG9yLmFuaW1hdGUoew0KICogICAgICAgICAgICAgJ29wYWNpdHknOiAxDQogKiAgICAgICAgIH0sIHRoaXMudGltZW91dCAtIHRoaXMudGltZUVsYXBzZWQsICdsaW5lYXInKTsNCiAqICAgICB9Ow0KICoNCiAqICAgICBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLkluZGljYXRvclZpZXdzLlNhbXBsZVZpZXcgPSBTYW1wbGVWaWV3Ow0KICogfSgpKTsNCiAqDQogKi8NClhBLmNvbXBvbmVudC5jYXJvdXNlbHMuSW5kaWNhdG9yVmlld3MgPSAoZnVuY3Rpb24oJCkgew0KICAgIHZhciBwdWIgPSB7fSwNCiAgICAgICAgc3VwcG9ydEVsZW1lbnRTdHlsZSA9IG51bGw7DQoNCiAgICAvKioNCiAgICAgKiBDaGVja3MgaWYgYW55IG9mIENTUyBwcm9wZXJ0aWVzIGlzIHN1cHBvcnRlZC4NCiAgICAgKg0KICAgICAqIEBwYXJhbSB7QXJyYXl9IHByb3BzICAgICBhcnJheSBvZiBwcm9wZXJ0aWVzIHRvIGJlIGNoZWNrZWQNCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgYW55IG9mIENTUyBwcm9wZXJ0aWVzIGlzIHN1cHBvcnRlZCwgZmFsc2Ugb3RoZXJ3aXNlDQogICAgICogQHR5cGUgQm9vbGVhbg0KICAgICAqLw0KICAgIGZ1bmN0aW9uIGlzQ3NzU3VwcG9ydGVkKHByb3BzKSB7DQogICAgICAgIHZhciBpLA0KICAgICAgICAgICAgaXNTdXBwb3J0ZWQgPSBmYWxzZTsNCg0KICAgICAgICBpZiAoc3VwcG9ydEVsZW1lbnRTdHlsZSA9PT0gbnVsbCkgew0KICAgICAgICAgICAgc3VwcG9ydEVsZW1lbnRTdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N1cHBvcnRFbGVtZW50Jykuc3R5bGU7DQogICAgICAgIH0NCg0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgIGlmIChzdXBwb3J0RWxlbWVudFN0eWxlW3Byb3BzW2ldXSAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgaXNTdXBwb3J0ZWQgPSB0cnVlOw0KICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIGlzU3VwcG9ydGVkOw0KICAgIH0NCg0KICAgIC8qKg0KICAgICAqIENoZWNrcyBpZiBDU1MgMyAndHJhbnNmb3JtJyBpcyBzdXBwb3J0ZWQuDQogICAgICoNCiAgICAgKiBAcmV0dXJuIHRydWUgaWYgQ1NTIDMgJ3RyYW5zZm9ybScgaXMgc3VwcG9ydGVkLCBmYWxzZSBvdGhlcndpc2UNCiAgICAgKiBAdHlwZSBCb29sZWFuDQogICAgICovDQogICAgZnVuY3Rpb24gaXNUcmFuc2Zvcm1TdXBwb3J0ZWQoKSB7DQogICAgICAgIHJldHVybiBpc0Nzc1N1cHBvcnRlZChbJ3RyYW5zZm9ybVByb3BlcnR5JywgJ1dlYmtpdFRyYW5zZm9ybScsICdNb3pUcmFuc2Zvcm0nLCAnT1RyYW5zZm9ybScsICdtc1RyYW5zZm9ybSddKTsNCiAgICB9DQoNCiAgICAvKioNCiAgICAgKiBYQS5jb21wb25lbnQuY2Fyb3VzZWxzLkluZGljYXRvclZpZXdzLlRvb2xzIG5hbWVzcGFjZQ0KICAgICAqDQogICAgIFRoaXMgbmFtZXNwYWNlIGNhbiBiZSByZW1vdmVkIGlmIFJvdGF0b3JWaWV3IGNsYXNzIGlzIG5vdCB1c2VkIChAc2VlIFJvdGF0b3JWaWV3KQ0KICAgICAqLw0KICAgIHB1Yi5Ub29scyA9IHt9Ow0KICAgIHB1Yi5Ub29scy5pc0Nzc1N1cHBvcnRlZCA9IGlzQ3NzU3VwcG9ydGVkOw0KICAgIHB1Yi5Ub29scy5pc1RyYW5zZm9ybVN1cHBvcnRlZCA9IGlzVHJhbnNmb3JtU3VwcG9ydGVkOw0KICAgIC8qKg0KICAgICAqIEVuZCBvZiBuYW1lc3BhY2UNCiAgICAgKi8NCg0KICAgIC8qKg0KICAgICAqIFZpZXcgY2xhc3MgaXMgYSBiYXNlIGNsYXNzIG9mIGFsbCAndGltZSBpbmRpY2F0b3InIHZpZXdzDQogICAgICogQGNvbnN0cnVjdG9yDQogICAgICogQHBhcmFtIHtTdHJpbmd9IHNlbGVjdG9yIGEgc2VsZWN0b3IgdXNlZCBmb3Igc2VhcmNoaW5nDQogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgICBWaWV3IG9wdGlvbnMgb2JqZWN0DQogICAgICovDQogICAgZnVuY3Rpb24gVmlldyhzZWxlY3Rvciwgb3B0aW9ucykgew0KICAgICAgICAvKioNCiAgICAgICAgICogQSBqUXVlcnkgb2JqZWN0IGNvbnRhaW5pbmcgZWxlbWVudCwgd2hpY2ggd2lsbCBiZSBhbmltYXRlZCB0byBzaG93IHBvZ3Jlc3Mgb2YgdGhlIHRpbWUuDQogICAgICAgICAqDQogICAgICAgICAqIEBtZW1iZXIgVmlldw0KICAgICAgICAgKi8NCiAgICAgICAgdGhpcy4kaW5kaWNhdG9yID0gJChzZWxlY3Rvcik7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIEluaXRpYWxpemVzIHRoZSB2aWV3Lg0KICAgICAqDQogICAgICogQG1lbWJlciBWaWV3aW9uDQogICAgICogQHBhcmFtIHtOdW1iZXJ9IHRpbWVvdXQgICBhIHRpbWVvdXQgdG8gdGhlIGVuZCBvZiB3aG9sZSBpbmRpY2F0b3IgYW5pbWF0aW9uDQogICAgICovDQogICAgVmlldy5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKHRpbWVvdXQpIHsNCiAgICAgICAgdGhpcy50aW1lRWxhcHNlZCA9IDA7DQogICAgICAgIHRoaXMudGltZW91dCA9IHRpbWVvdXQ7DQogICAgfTsNCiAgICAvKioNCiAgICAgKiBSZXNldHMgdGhlIHZpZXcNCiAgICAgKg0KICAgICAqIEBtZW1iZXIgVmlldw0KICAgICAqLw0KICAgIFZpZXcucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24oKSB7DQogICAgICAgIHRoaXMudGltZUVsYXBzZWQgPSAwOw0KICAgIH07DQogICAgLyoqDQogICAgICogU3RhcnRzL1JlbmV3cyB0aGUgdmlldyBhbmltYXRpb24uDQogICAgICoNCiAgICAgKiBAbWVtYmVyIFZpZXcNCiAgICAgKi8NCiAgICBWaWV3LnByb3RvdHlwZS5wbGF5ID0gZnVuY3Rpb24oKSB7fTsNCiAgICAvKioNCiAgICAgKiBQYXVzZXMgdGhlIHZpZXcgYW5pbWF0aW9uLg0KICAgICAqDQogICAgICogQG1lbWJlciBWaWV3DQogICAgICovDQogICAgVmlldy5wcm90b3R5cGUucGF1c2UgPSBmdW5jdGlvbigpIHt9Ow0KICAgIC8qKg0KICAgICAqIFVwZGF0ZXMgdGhlIHRpbWUgdGhhdCBlbGFwc2VkIHNpbmNlIGFuaW1hdGlvbiBiZWdpbi4NCiAgICAgKg0KICAgICAqIEBtZW1iZXIgVmlldw0KICAgICAqLw0KICAgIFZpZXcucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKHRpbWVFbGFwc2VkKSB7DQogICAgICAgIHRoaXMudGltZUVsYXBzZWQgPSB0aW1lRWxhcHNlZDsNCiAgICB9Ow0KICAgIC8qKg0KICAgICAqIGVuZCBvZiBWaWV3IGNsYXNzDQogICAgICovDQogICAgcHViLlZpZXcgPSBWaWV3Ow0KDQogICAgLyoqDQogICAgICogUHJvZ3Jlc3NCYXJWaWV3IGNsYXNzIHByb3ZpZGVzIGEgbG9naWMgZm9yIGFuaW1hdGUgYSAndGltZSBpbmRpY2F0b3InLA0KICAgICAqIHRoYXQgbG9va3MgbGlrZSBwcm9ncmVzcyBiYXIuDQogICAgICoNCiAgICAgKiBPcHRpb25zIG9iamVjdDoNCiAgICAgKiB7DQogICAgICogICAgICdvcGFjaXR5JzogTnVtYmVyIHZhbHVlIC8vYmV0d2VlbiAwIGFuZCAxOyBkZWZhdWx0IGlzIDAuOA0KICAgICAqIH0NCiAgICAgKg0KICAgICAqIFRoaXMgY2xhc3MgY2FuIGJlIHJlbW92ZWQgaWYgdGhpcyBraW5kIG9mIHZpZXcgaXMgbm90IHVzZWQuDQogICAgICoNCiAgICAgKiBAY29uc3RydWN0b3INCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc2VsZWN0b3IgYSBzZWxlY3RvciB1c2VkIGZvciBzZWFyY2hpbmcNCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAgIFZpZXcgb3B0aW9ucyBvYmplY3QNCiAgICAgKi8NCiAgICBmdW5jdGlvbiBQcm9ncmVzc0JhclZpZXcoc2VsZWN0b3IsIG9wdGlvbnMpIHsNCiAgICAgICAgVmlldy5jYWxsKHRoaXMsIHNlbGVjdG9yKTsNCg0KICAgICAgICB2YXIgZGVmYXVsdHMgPSB7DQogICAgICAgICAgICAnb3BhY2l0eSc6IDAuOA0KICAgICAgICB9Ow0KDQogICAgICAgIHRoaXMuc2V0dGluZ3MgPSAkLmV4dGVuZCh0cnVlLCB7fSwgZGVmYXVsdHMsIG9wdGlvbnMpOw0KDQogICAgICAgIHRoaXMuJGNvbnRhaW5lciA9IHRoaXMuJGluZGljYXRvcjsNCiAgICAgICAgdGhpcy4kaW5kaWNhdG9yID0gdGhpcy4kaW5kaWNhdG9yLmZpbmQoJ2RpdicpOw0KICAgIH0NCiAgICBQcm9ncmVzc0JhclZpZXcucHJvdG90eXBlID0gbmV3IFZpZXcoKTsNCiAgICBQcm9ncmVzc0JhclZpZXcuY29uc3RydWN0b3IgPSBQcm9ncmVzc0JhclZpZXc7DQogICAgLyoqDQogICAgICogQG1lbWJlciBQcm9ncmVzc0JhclZpZXcNCiAgICAgKi8NCiAgICBQcm9ncmVzc0JhclZpZXcucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbih0aW1lb3V0KSB7DQogICAgICAgIFZpZXcucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzLCB0aW1lb3V0KTsNCg0KICAgICAgICB2YXIgb3BhY2l0eSA9IHRoaXMuc2V0dGluZ3Mub3BhY2l0eTsNCiAgICAgICAgdGhpcy4kY29udGFpbmVyLmNzcygnb3BhY2l0eScsIG9wYWNpdHkpOw0KICAgICAgICB0aGlzLiRpbmRpY2F0b3IuY3NzKCdvcGFjaXR5Jywgb3BhY2l0eSk7DQogICAgfTsNCiAgICAvKioNCiAgICAgKiBAbWVtYmVyIFByb2dyZXNzQmFyVmlldw0KICAgICAqLw0KICAgIFByb2dyZXNzQmFyVmlldy5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgVmlldy5wcm90b3R5cGUucmVzZXQuY2FsbCh0aGlzKTsNCg0KICAgICAgICB0aGlzLiRpbmRpY2F0b3Iuc3RvcCh0cnVlKTsNCiAgICAgICAgdGhpcy4kaW5kaWNhdG9yLmNzcygnd2lkdGgnLCAnMHB4Jyk7DQogICAgfTsNCiAgICAvKioNCiAgICAgKiBAbWVtYmVyIFByb2dyZXNzQmFyVmlldw0KICAgICAqLw0KICAgIFByb2dyZXNzQmFyVmlldy5wcm90b3R5cGUucGF1c2UgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgdGhpcy4kaW5kaWNhdG9yLnN0b3AodHJ1ZSk7DQogICAgfTsNCiAgICAvKioNCiAgICAgKiBAbWVtYmVyIFByb2dyZXNzQmFyVmlldw0KICAgICAqLw0KICAgIFByb2dyZXNzQmFyVmlldy5wcm90b3R5cGUucGxheSA9IGZ1bmN0aW9uKCkgew0KICAgICAgICB0aGlzLiRpbmRpY2F0b3IuYW5pbWF0ZSh7DQogICAgICAgICAgICAnd2lkdGgnOiAnMTAwJScNCiAgICAgICAgfSwgdGhpcy50aW1lb3V0IC0gdGhpcy50aW1lRWxhcHNlZCwgJ2xpbmVhcicpOw0KICAgIH07DQogICAgLyoqDQogICAgICogZW5kIG9mIFByb2dyZXNzQmFyVmlldyBjbGFzcw0KICAgICAqLw0KICAgIHB1Yi5Qcm9ncmVzc0JhclZpZXcgPSBQcm9ncmVzc0JhclZpZXc7DQoNCiAgICAvKioNCiAgICAgKiBSb3RhdG9yVmlldyBjbGFzcyBwcm92aWRlcyBhIGxvZ2ljIGZvciBhbmltYXRlIGEgJ3RpbWUgaW5kaWNhdG9yJywNCiAgICAgKiB0aGF0IHNob3dzIHRoZSBwcm9ncmVzcyBvZiB0aW1lIHdpdGggdGhlIGZpbGxpbmcgdXAgcmluZw0KICAgICAqDQogICAgICogT3B0aW9ucyBvYmplY3Q6DQogICAgICogew0KICAgICAqICAgICAnb3BhY2l0eSc6IE51bWJlciB2YWx1ZSAvL2JldHdlZW4gMCBhbmQgMTsgZGVmYXVsdCBpcyAwLjUNCiAgICAgKiB9DQogICAgICoNCiAgICAgKiBUaGlzIGNsYXNzIGNhbiBiZSByZW1vdmVkIGlmIHRoaXMga2luZCBvZiB2aWV3IGlzIG5vdCB1c2VkLg0KICAgICAqDQogICAgICogQGNvbnN0cnVjdG9yDQogICAgICogQHBhcmFtIHtTdHJpbmd9IHNlbGVjdG9yIGEgc2VsZWN0b3IgdXNlZCBmb3Igc2VhcmNoaW5nDQogICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgICBWaWV3IG9wdGlvbnMgb2JqZWN0DQogICAgICovDQogICAgZnVuY3Rpb24gUm90YXRvclZpZXcoc2VsZWN0b3IsIG9wdGlvbnMpIHsNCiAgICAgICAgVmlldy5jYWxsKHRoaXMsIHNlbGVjdG9yKTsNCg0KICAgICAgICB2YXIgZGVmYXVsdHMgPSB7DQogICAgICAgICAgICAnb3BhY2l0eSc6IDAuNQ0KICAgICAgICB9Ow0KDQogICAgICAgIHRoaXMuc2V0dGluZ3MgPSAkLmV4dGVuZCh0cnVlLCB7fSwgZGVmYXVsdHMsIG9wdGlvbnMpOw0KICAgICAgICB0aGlzLiRtYXNrID0gdGhpcy4kaW5kaWNhdG9yLmZpbmQoJ3NwYW4ubWFzaycpLmZpcnN0KCk7DQogICAgICAgIHRoaXMuJHJvdGF0b3IgPSB0aGlzLiRpbmRpY2F0b3IuZmluZCgnc3Bhbi5yb3RhdG9yJykuZmlyc3QoKTsNCg0KICAgICAgICBmdW5jdGlvbiByb3RhdGVDc3MoZGVnKSB7DQogICAgICAgICAgICB2YXIgdmFsdWUgPSAncm90YXRlKCcgKyBkZWcgKyAnZGVnKSc7DQoNCiAgICAgICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAgICAgJy13ZWJraXQtdHJhbnNmb3JtJzogdmFsdWUsDQogICAgICAgICAgICAgICAgJy1tb3otdHJhbnNmb3JtJzogdmFsdWUsDQogICAgICAgICAgICAgICAgJy1vLXRyYW5zZm9ybSc6IHZhbHVlLA0KICAgICAgICAgICAgICAgICctbXMtdHJhbnNmb3JtJzogdmFsdWUsDQogICAgICAgICAgICAgICAgJ3RyYW5zZm9ybSc6IHZhbHVlDQogICAgICAgICAgICB9Ow0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gYW5pbWF0ZVJvdGF0b3IoJHJvdGF0b3IsIG9wdGlvbnMpIHsNCiAgICAgICAgICAgIHZhciBkZWZhdWx0cyA9IHsNCiAgICAgICAgICAgICAgICAgICAgJ2ZvbnRTaXplJzogJzE4MHB4JywNCiAgICAgICAgICAgICAgICAgICAgJ2FuaW1hdGVPcHRpb25zJzogew0KICAgICAgICAgICAgICAgICAgICAgICAgJ3N0ZXAnOiBmdW5jdGlvbihub3csIGZ4KSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvdGF0b3IuY3NzKHJvdGF0ZUNzcyhub3cpKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgICAgICAnZWFzaW5nJzogJ2xpbmVhcicNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgc2V0dGluZ3MgPSAkLmV4dGVuZCh0cnVlLCB7fSwgZGVmYXVsdHMsIG9wdGlvbnMpOw0KDQogICAgICAgICAgICAkcm90YXRvci5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAgICAgJ2ZvbnQtc2l6ZSc6IHNldHRpbmdzLmZvbnRTaXplDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBzZXR0aW5ncy5hbmltYXRlT3B0aW9ucyk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBwaGFzZVR3b0FuaW1hdGlvbigkbWFzaywgJHJvdGF0b3IsIGR1cmF0aW9uKSB7DQogICAgICAgICAgICAkcm90YXRvci5hZGRDbGFzcygnaGFsZicpOw0KICAgICAgICAgICAgJG1hc2suYWRkQ2xhc3MoJ2hhbGYnKTsNCg0KICAgICAgICAgICAgYW5pbWF0ZVJvdGF0b3IoJHJvdGF0b3IsIHsNCiAgICAgICAgICAgICAgICAnZm9udFNpemUnOiAnMzYwcHgnLA0KICAgICAgICAgICAgICAgICdhbmltYXRlT3B0aW9ucyc6IHsNCiAgICAgICAgICAgICAgICAgICAgJ2R1cmF0aW9uJzogZHVyYXRpb24NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIHBoYXNlT25lQW5pbWF0aW9uKCRtYXNrLCAkcm90YXRvciwgZHVyYXRpb24sIHBoYXNlVHdvRHVyYXRpb24pIHsNCiAgICAgICAgICAgIGFuaW1hdGVSb3RhdG9yKCRyb3RhdG9yLCB7DQogICAgICAgICAgICAgICAgJ2FuaW1hdGVPcHRpb25zJzogew0KICAgICAgICAgICAgICAgICAgICAnZHVyYXRpb24nOiBkdXJhdGlvbiwNCiAgICAgICAgICAgICAgICAgICAgJ2NvbXBsZXRlJzogZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBwaGFzZVR3b0FuaW1hdGlvbigkbWFzaywgJHJvdGF0b3IsIHBoYXNlVHdvRHVyYXRpb24pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCg0KICAgICAgICB0aGlzLnJlc2V0Q3NzID0gZnVuY3Rpb24oKSB7DQogICAgICAgICAgICB0aGlzLiRyb3RhdG9yLnJlbW92ZUNsYXNzKCdoYWxmJyk7DQogICAgICAgICAgICB0aGlzLiRyb3RhdG9yLmNzcyhyb3RhdGVDc3MoMCkpOw0KICAgICAgICAgICAgdGhpcy4kcm90YXRvci5jc3MoJ2ZvbnQtc2l6ZScsICcwcHgnKTsNCg0KICAgICAgICAgICAgdGhpcy4kbWFzay5yZW1vdmVDbGFzcygnaGFsZicpOw0KICAgICAgICB9Ow0KDQogICAgICAgIHRoaXMucGxheVBoYXNlT25lID0gZnVuY3Rpb24oKSB7DQogICAgICAgICAgICB2YXIgZHVyYXRpb24gPSB0aGlzLnRpbWVvdXQgLyAyIC0gdGhpcy50aW1lRWxhcHNlZDsNCiAgICAgICAgICAgIHBoYXNlT25lQW5pbWF0aW9uKHRoaXMuJG1hc2ssIHRoaXMuJHJvdGF0b3IsIGR1cmF0aW9uLCB0aGlzLnRpbWVvdXQgLyAyKTsNCiAgICAgICAgfTsNCg0KICAgICAgICB0aGlzLnBsYXlQaGFzZVR3byA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgdmFyIGR1cmF0aW9uID0gdGhpcy50aW1lb3V0IC0gdGhpcy50aW1lRWxhcHNlZDsNCiAgICAgICAgICAgIHBoYXNlVHdvQW5pbWF0aW9uKHRoaXMuJG1hc2ssIHRoaXMuJHJvdGF0b3IsIGR1cmF0aW9uKTsNCiAgICAgICAgfTsNCiAgICB9DQogICAgUm90YXRvclZpZXcucHJvdG90eXBlID0gbmV3IFZpZXcoKTsNCiAgICBSb3RhdG9yVmlldy5jb25zdHJ1Y3RvciA9IFJvdGF0b3JWaWV3Ow0KICAgIC8qKg0KICAgICAqIEBtZW1iZXIgUm90YXRvclZpZXcNCiAgICAgKi8NCiAgICBSb3RhdG9yVmlldy5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKHRpbWVvdXQpIHsNCiAgICAgICAgVmlldy5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHRpbWVvdXQpOw0KDQogICAgICAgIGlmIChpc1RyYW5zZm9ybVN1cHBvcnRlZCgpKSB7DQogICAgICAgICAgICB0aGlzLiRpbmRpY2F0b3Iuc2hvdygpOw0KICAgICAgICAgICAgdGhpcy4kbWFzay5jc3MoJ29wYWNpdHknLCB0aGlzLnNldHRpbmdzLm9wYWNpdHkpOw0KICAgICAgICB9DQogICAgfTsNCiAgICAvKioNCiAgICAgKiBAbWVtYmVyIFJvdGF0b3JWaWV3DQogICAgICovDQogICAgUm90YXRvclZpZXcucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24oKSB7DQogICAgICAgIFZpZXcucHJvdG90eXBlLnJlc2V0LmNhbGwodGhpcyk7DQoNCiAgICAgICAgdGhpcy4kcm90YXRvci5zdG9wKHRydWUpOw0KICAgICAgICB0aGlzLnJlc2V0Q3NzKCk7DQogICAgfTsNCiAgICAvKioNCiAgICAgKiBAbWVtYmVyIFJvdGF0b3JWaWV3DQogICAgICovDQogICAgUm90YXRvclZpZXcucHJvdG90eXBlLnBhdXNlID0gZnVuY3Rpb24oKSB7DQogICAgICAgIHRoaXMuJHJvdGF0b3Iuc3RvcCh0cnVlKTsNCiAgICB9Ow0KICAgIC8qKg0KICAgICAqIEBtZW1iZXIgUm90YXRvclZpZXcNCiAgICAgKi8NCiAgICBSb3RhdG9yVmlldy5wcm90b3R5cGUucGxheSA9IGZ1bmN0aW9uKCkgew0KICAgICAgICB2YXIgcGhhc2UgPSB0aGlzLnBsYXlQaGFzZU9uZTsNCiAgICAgICAgaWYgKHRoaXMudGltZUVsYXBzZWQgPj0gdGhpcy50aW1lb3V0IC8gMikgew0KICAgICAgICAgICAgcGhhc2UgPSB0aGlzLnBsYXlQaGFzZVR3bzsNCiAgICAgICAgfQ0KDQogICAgICAgIHBoYXNlLmNhbGwodGhpcyk7DQogICAgfTsNCiAgICAvKioNCiAgICAgKiBlbmQgb2YgUm90YXRvclZpZXcgY2xhc3MNCiAgICAgKi8NCiAgICBwdWIuUm90YXRvclZpZXcgPSBSb3RhdG9yVmlldzsNCg0KICAgIHJldHVybiBwdWI7DQp9KGpRdWVyeSkpOw0KLyoqDQogKiBlbmQgb2YgWEEuY29tcG9uZW50LmNhcm91c2Vscy5JbmRpY2F0b3JWaWV3cyBtb2R1bGUuDQogKi8NClhBLmNvbXBvbmVudC5wYXJhbGxheCA9IChmdW5jdGlvbiAoJCwgXykgew0KCXZhciBhcGkgPSB7fTsNCg0KCWZ1bmN0aW9uIGNoZWNrTW9iaWxlKCkgew0KCQlyZXR1cm4gJCh3aW5kb3cpLndpZHRoKCkgPCA3Njg7DQoJfQ0KDQoJZnVuY3Rpb24gbWFrZVBhcmFsbGF4KCRlbCkgew0KCQl2YXIgJGJnID0gJGVsLmNoaWxkcmVuKCIuY29tcG9uZW50LWNvbnRlbnQiKSwNCgkJCXZIZWlnaHQgPSAkKHdpbmRvdykuaGVpZ2h0KCksDQoJCQllbE9mZnNldCA9ICRiZ1swXS5vZmZzZXRUb3AsDQoJCQllbEhlaWdodCA9ICRiZ1swXS5vZmZzZXRIZWlnaHQsDQoJCQlpc01vYmlsZSA9IGNoZWNrTW9iaWxlKCk7DQoNCgkJZnVuY3Rpb24gcGFyYWxsYXgoKSB7DQoJCQlpZiAoaXNNb2JpbGUpIHsNCgkJCQlyZXR1cm4gZmFsc2U7DQoJCQl9DQoNCgkJCXZhciBvZmZzZXQgPSAkKHdpbmRvdykuc2Nyb2xsVG9wKCk7DQoNCgkJCWlmICgoZWxPZmZzZXQgPD0gb2Zmc2V0ICsgdkhlaWdodCkgJiYgKGVsT2Zmc2V0ICsgZWxIZWlnaHQgPj0gb2Zmc2V0KSkgew0KCQkJCSRiZy5jc3MoImJhY2tncm91bmQtcG9zaXRpb24iLCAiNTAlICIgKyBNYXRoLnJvdW5kKChlbE9mZnNldCAtIG9mZnNldCkgKiAzIC8gOCkgKyAicHgiKTsNCgkJCX0NCgkJfQ0KDQoJCXBhcmFsbGF4KCk7DQoNCgkJJChkb2N1bWVudCkub24oInNjcm9sbCIsIF8udGhyb3R0bGUocGFyYWxsYXgsIDEwKSk7DQoJCSQod2luZG93KS5vbigicmVzaXplIiwgXy50aHJvdHRsZShmdW5jdGlvbigpIHsNCgkJCWlzTW9iaWxlID0gY2hlY2tNb2JpbGUoKTsNCgkJCWlzTW9iaWxlID8gJGJnLmNzcygiYmFja2dyb3VuZC1wb3NpdGlvbiIsICI1MCUgMCIpIDogcGFyYWxsYXgoKTsNCgkJfSwgMTUwKSk7DQoJfQ0KDQoJYXBpLmluaXQgPSBmdW5jdGlvbiAoKSB7DQoJCSQoJy5wYXJhbGxheC1iYWNrZ3JvdW5kOm5vdCguaW5pdGlhbGl6ZWQpJykuZWFjaChmdW5jdGlvbigpIHsNCgkJCW1ha2VQYXJhbGxheCgkKHRoaXMpKTsNCgkJCSQodGhpcykuYWRkQ2xhc3MoJ2luaXRpYWxpemVkJyk7DQoJCX0pOw0KCX07DQoNCglyZXR1cm4gYXBpOw0KDQp9KShqUXVlcnksIF8pOw0KDQpYQS5yZWdpc3RlcigncGFyYWxsYXgtYmFja2dyb3VuZCcsIFhBLmNvbXBvbmVudC5wYXJhbGxheCk7DQpYQS5jb21wb25lbnQuY29va2llID0gKGZ1bmN0aW9uICgkLCBkb2N1bWVudCkgew0KDQogICAgdmFyIGNvb2tpZVdhcm5pbmcsDQogICAgICAgIGNvb2tpZVBvc2l0aW9uID0gInRvcCIsDQogICAgICAgIHN1Ym1pdFRhZywNCiAgICAgICAgYXBpID0gew0KICAgICAgICAgICAgc2V0dGluZ3M6IHsNCiAgICAgICAgICAgICAgICBzdWJtaXQ6ICQoInN1Ym1pdCIpLA0KICAgICAgICAgICAgICAgIGRlZmF1bHRQb3M6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvb2tpZVdhcm5pbmcuaGFzQ2xhc3MoImNvb2tpZS1ib3R0b20iKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgY29va2llUG9zaXRpb24gPSAiYm90dG9tIjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb2tpZVdhcm5pbmcuY3NzKCJkaXNwbGF5IiwgImJsb2NrIik7DQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICBjb29raWVQb3NpdGlvbiA9ICJ0b3AiOw0KICAgICAgICAgICAgICAgICAgICAgICAgY29va2llV2FybmluZy5jc3MoImRpc3BsYXkiLCAiYmxvY2siKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQoNCiAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBjb29raWVXYXJuaW5nID0gJCgiLmNvb2tpZS13YXJuaW5nOm5vdCguaW5pdGlhbGl6ZWQpIik7DQogICAgICAgICAgICAgICAgdmFyIGlzRW1wdHkgPSBjb29raWVXYXJuaW5nLmZpbmQoIi5jb21wb25lbnQtY29udGVudCIpLmNoaWxkcmVuKCkubGVuZ3RoOw0KDQogICAgICAgICAgICAgICAgaWYgKGlzRW1wdHkpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHMgPSB0aGlzLmFwaS5zZXR0aW5nczsNCiAgICAgICAgICAgICAgICAgICAgcy5kZWZhdWx0UG9zKCk7DQogICAgICAgICAgICAgICAgICAgIHN1Ym1pdFRhZyA9ICQoIi5zdWJtaXQgYSIpOw0KICAgICAgICAgICAgICAgICAgICBzdWJtaXRUYWcuYXR0cigidGFiSW5kZXgiLDEpOw0KICAgICAgICAgICAgICAgICAgICBzdWJtaXRUYWcuYXR0cigidGl0bGUiLCJBbGxvdyBjb29raWVzIik7DQogICAgICAgICAgICAgICAgICAgIGlmIChjb29raWVQb3NpdGlvbiA9PSAidG9wIikgew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2VydmUgZnJvbSB0b3Agb2YgcGFnZQ0KICAgICAgICAgICAgICAgICAgICAgICAgc3VibWl0VGFnLm9uKCdjbGljaycsIGZ1bmN0aW9uIChlKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFhBLmNvb2tpZXMuY3JlYXRlQ29va2llKCJjb29raWUtd2FybmluZyIsIDEsIDM2NSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29va2llV2FybmluZy5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiAiLTMwMHB4Ig0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDEwMDAsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29va2llV2FybmluZy5yZW1vdmUoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2VydmUgZnJvbSBib3R0b20gb2YgcGFnZQ0KICAgICAgICAgICAgICAgICAgICAgICAgc3VibWl0VGFnLm9uKCdjbGljaycsIGZ1bmN0aW9uIChlKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFhBLmNvb2tpZXMuY3JlYXRlQ29va2llKCJjb29raWUtd2FybmluZyIsIDEsIDM2NSk7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29va2llV2FybmluZy5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm90dG9tOiAiLTMwMHB4Ig0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDEwMDAsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29va2llV2FybmluZy5yZW1vdmUoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgY29va2llV2FybmluZy5hZGRDbGFzcygiaW5pdGlhbGl6ZWQiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfTsNCg0KICAgIHJldHVybiBhcGk7DQogICAgDQp9KShqUXVlcnksIGRvY3VtZW50KTsNCg0KDQpYQS5yZWdpc3RlcigiY29va2llIiwgWEEuY29tcG9uZW50LmNvb2tpZSk7DQpYQS5jb21wb25lbnQuZGlzcXVzID0gKGZ1bmN0aW9uICgkLCBkb2N1bWVudCkgew0KDQogICAgdmFyIGFwaSA9IHt9Ow0KDQogICAgZnVuY3Rpb24gaW5pdERpc3F1cyhwcm9wKSB7DQogICAgICAgIHZhciBkc3EgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsNCiAgICAgICAgZHNxLnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0JzsNCiAgICAgICAgZHNxLmFzeW5jID0gdHJ1ZTsNCiAgICAgICAgZHNxLnNyYyA9ICcvLycgKyBwcm9wLmRpc3F1c19zaG9ydG5hbWUgKyAnLmRpc3F1cy5jb20vZW1iZWQuanMnOw0KICAgICAgICAoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXSB8fA0KICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdKS5hcHBlbmRDaGlsZChkc3EpOw0KICAgIH0NCg0KDQogICAgYXBpLmluaXQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBkaXNxdXMgPSAkKCcuZGlzcXVzOm5vdCguaW5pdGlhbGl6ZWQpJyk7DQoNCiAgICAgICAgZGlzcXVzLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSAkKHRoaXMpLmRhdGEoJ3Byb3BlcnRpZXMnKTsNCiAgICAgICAgICAgIGlmICgkKHRoaXMpLmZpbmQoIiNkaXNxdXNfdGhyZWFkIikubGVuZ3RoID4gMCkgew0KICAgICAgICAgICAgICAgIGluaXREaXNxdXMocHJvcGVydGllcyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoJ2luaXRpYWxpemVkJyk7DQogICAgICAgIH0pOw0KICAgIH07DQoNCiAgICByZXR1cm4gYXBpOw0KfShqUXVlcnksIGRvY3VtZW50KSk7DQoNClhBLnJlZ2lzdGVyKCdkaXNxdXMnLCBYQS5jb21wb25lbnQuZGlzcXVzKTsNClhBLmNvbXBvbmVudC5kcmFnZ2FibGVDb21wYXJlciA9IGZ1bmN0aW9uKCQpIHsNCiAgICB2YXIgJGNvbXBhcmVyOw0KICAgIHZhciBtYXhQcm9kdWN0czsNCiAgICB2YXIgc2hvd0xhYmVsczsNCg0KICAgIHZhciBpbml0U2VsZWN0b3IgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgJGNvbXBhcmVyLmZpbmQoJy5zaWJsaW5nLWltYWdlJykuZHJhZ2dhYmxlKHsNCiAgICAgICAgICAgIG9wYWNpdHk6IDAuNywNCiAgICAgICAgICAgIGhlbHBlcjogImNsb25lIiwNCiAgICAgICAgICAgIGFwcGVuZFRvOiAnYm9keScsDQogICAgICAgICAgICBzdGFydDogZnVuY3Rpb24oZSkgew0KICAgICAgICAgICAgICAgIHZhciBpc05vdFNlbGVjdGVkID0gJCh0aGlzKS5wYXJlbnRzKCcuY29tcGFyZS1zZWxlY3RvcicpLmxlbmd0aCA9PSAwOw0KICAgICAgICAgICAgICAgIHZhciBtYXhOdW1iZXJBY2hpZXZlZCA9ICRjb21wYXJlci5maW5kKCcuY29tcGFyZS1zZWxlY3RvcicpLmZpbmQoJ2ltZy5zaWJsaW5nLWltYWdlJykubGVuZ3RoID49IG1heFByb2R1Y3RzOw0KDQogICAgICAgICAgICAgICAgaWYgKGlzTm90U2VsZWN0ZWQgJiYgbWF4TnVtYmVyQWNoaWV2ZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQoNCiAgICAgICAgJGNvbXBhcmVyLmZpbmQoJy5jb21wYXJlLXNlbGVjdG9yJykuZHJvcHBhYmxlKHsNCiAgICAgICAgICAgIGFjY2VwdDogJy5kcmFnZ2FibGUtY29tcGFyZXIgLnNpYmxpbmctaW1hZ2UnLA0KICAgICAgICAgICAgZHJvcDogZnVuY3Rpb24oZXZlbnQsIHVpKSB7DQogICAgICAgICAgICAgICAgaWYgKHVpLmRyYWdnYWJsZS5wYXJlbnRzKCcuY29tcGFyZS1zZWxlY3RvcicpLmxlbmd0aCA+IDApIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB2YXIgJGhvbGRlciA9ICQodGhpcykuZmluZCgnLnNpYmxpbmctaW1hZ2UtaG9sZGVyJykubGFzdCgpOw0KICAgICAgICAgICAgICAgIHZhciBwcm9kdWN0SWQgPSB1aS5kcmFnZ2FibGUuZGF0YSgnaWQnKTsNCiAgICAgICAgICAgICAgICB2YXIgJGNsb25lID0gJGhvbGRlci5wYXJlbnQoKS5jbG9uZSgpOw0KICAgICAgICAgICAgICAgICRjbG9uZS5kYXRhKCdpZCcsIHByb2R1Y3RJZCk7DQogICAgICAgICAgICAgICAgJGNsb25lLmZpbmQoJy5zaWJsaW5nLWltYWdlLWhvbGRlcicpLmFwcGVuZCh1aS5kcmFnZ2FibGUpOw0KICAgICAgICAgICAgICAgICRob2xkZXIucGFyZW50KCkuYmVmb3JlKCRjbG9uZSk7DQogICAgICAgICAgICAgICAgJCgnLnNpYmxpbmctbmFtZVtkYXRhLWlkPSInICsgcHJvZHVjdElkICsgJyJdJykucGFyZW50KCkuaGlkZSgpOw0KICAgICAgICAgICAgICAgICQodGhpcykuZmluZCgnLmNvbXBhcmUtYnV0dG9uJykuc2hvdygpOw0KDQogICAgICAgICAgICAgICAgdmFyIG1heE51bWJlckFjaGlldmVkID0gJGNvbXBhcmVyLmZpbmQoJy5jb21wYXJlLXNlbGVjdG9yJykuZmluZCgnaW1nLnNpYmxpbmctaW1hZ2UnKS5sZW5ndGggPj0gbWF4UHJvZHVjdHM7DQogICAgICAgICAgICAgICAgaWYgKG1heE51bWJlckFjaGlldmVkKSB7DQogICAgICAgICAgICAgICAgICAgICQodGhpcykuZmluZCgnLnNpYmxpbmctaW1hZ2UtaG9sZGVyJykubGFzdCgpLmhpZGUoKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KDQogICAgICAgICRjb21wYXJlci5maW5kKCcuc2libGluZ3MnKS5kcm9wcGFibGUoew0KICAgICAgICAgICAgYWNjZXB0OiAnLmRyYWdnYWJsZS1jb21wYXJlciAuc2libGluZy1pbWFnZScsDQogICAgICAgICAgICBkcm9wOiBmdW5jdGlvbihldmVudCwgdWkpIHsNCiAgICAgICAgICAgICAgICB2YXIgcHJvZHVjdElkID0gdWkuZHJhZ2dhYmxlLmRhdGEoJ2lkJyk7DQogICAgICAgICAgICAgICAgdmFyICRob2xkZXIgPSAkKHRoaXMpLmZpbmQoJy5zaWJsaW5nLWltYWdlLWhvbGRlcltkYXRhLWlkPSInICsgcHJvZHVjdElkICsgJyJdJyk7DQogICAgICAgICAgICAgICAgJGhvbGRlci5hcHBlbmQodWkuZHJhZ2dhYmxlKTsNCg0KICAgICAgICAgICAgICAgIHZhciBtYXhOdW1iZXJBY2hpZXZlZCA9ICRjb21wYXJlci5maW5kKCcuY29tcGFyZS1zZWxlY3RvcicpLmZpbmQoJ2ltZy5zaWJsaW5nLWltYWdlJykubGVuZ3RoID49IG1heFByb2R1Y3RzOw0KICAgICAgICAgICAgICAgIGlmICghbWF4TnVtYmVyQWNoaWV2ZWQpIHsNCiAgICAgICAgICAgICAgICAgICAgJGNvbXBhcmVyLmZpbmQoJy5jb21wYXJlLXNlbGVjdG9yJykuZmluZCgnLnNpYmxpbmctaW1hZ2UtaG9sZGVyJykubGFzdCgpLnNob3coKTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAkKCcuY29tcGFyZS1zZWxlY3RvciB0ZCcpLmVhY2goZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLmRhdGEoJ2lkJykgPT0gdWkuZHJhZ2dhYmxlLmRhdGEoJ2lkJykpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5zaWJsaW5nLW5hbWVbZGF0YS1pZD0iJyArIHVpLmRyYWdnYWJsZS5kYXRhKCdpZCcpICsgJyJdJykucGFyZW50KCkuc2hvdygpOw0KICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmUoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKCcuY29tcGFyZS1zZWxlY3RvciB0ZCcpLmxlbmd0aCA9PSAxKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnLmNvbXBhcmUtYnV0dG9uJykuaGlkZSgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgIH07DQoNCiAgICB2YXIgaW5pdEJhY2sgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgJGNvbXBhcmVyLmZpbmQoJy5jb21wYXJlLWJhY2snKS5jbGljayhmdW5jdGlvbihlKSB7DQogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgICAgICAkY29tcGFyZXIuZmluZCgnLmNvbXBvbmVudC1jb250ZW50JykuY3NzKCdoZWlnaHQnLCAnYXV0bycpOw0KICAgICAgICAgICAgJGNvbXBhcmVyLmZpbmQoJy5jb21wYXJlLXJlc3VsdCcpLmZhZGVUbyg0MDAsIDAsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICQodGhpcykuZmluZCgndGFibGUnKS5yZW1vdmUoKTsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLmhpZGUoKTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9KTsNCiAgICB9Ow0KDQogICAgdmFyIGluaXRDb21wYXJlID0gZnVuY3Rpb24oKSB7DQogICAgICAgICRjb21wYXJlci5maW5kKCcucHJvZHVjdC1saXN0LWNvbXBhcmUnKS5jbGljayhmdW5jdGlvbihlKSB7DQogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgICAgICAkY29tcGFyZXIuZmluZCgnLmNvbXBhcmUtcmVzdWx0IHRhYmxlJykucmVtb3ZlKCk7DQogICAgICAgICAgICB2YXIgcHJvZHVjdHNUb0NvbXBhcmUgPSAkY29tcGFyZXIuZGF0YSgnc2l0ZWNvcmUtaWQnKTsNCiAgICAgICAgICAgIHZhciB2YXJpYW50SXRlbUlkID0gJGNvbXBhcmVyLmRhdGEoJ3ZhcmlhbnRpZCcpOw0KICAgICAgICAgICAgdmFyIGxpbmt0YXJnZXQgPSAkY29tcGFyZXIuZGF0YSgnbGlua3RhcmdldCcpOw0KICAgICAgICAgICAgJGNvbXBhcmVyLmZpbmQoJy5jb21wYXJlLXNlbGVjdG9yIHRyIHRkOm5vdCg6bGFzdC1jaGlsZCkgaW1nJykuZWFjaChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICBwcm9kdWN0c1RvQ29tcGFyZSArPSAnLCcgKyAkKHRoaXMpLmRhdGEoJ3NpdGVjb3JlLWlkJyk7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgJC5hamF4KHsNCiAgICAgICAgICAgICAgICB1cmw6ICgnL34vWEEtZmVlZHMvY29tcGFyZWl0ZW1zP2lkcz0nICsgcHJvZHVjdHNUb0NvbXBhcmUgKyAnJnZhcmlhbnRJdGVtSWQ9JyArIHZhcmlhbnRJdGVtSWQpLnRvTG93ZXJDYXNlKCksDQogICAgICAgICAgICAgICAgdHlwZTogIkdFVCIsDQogICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oc2VydmVyRGF0YSkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoc2VydmVyRGF0YS5sZW5ndGggPT0gMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0VtcHR5IGRhdGEnKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB2YXIgJHRhYmxlID0gJChzZXJ2ZXJEYXRhKTsNCiAgICAgICAgICAgICAgICAgICAgdmFyICRjb21wYXJlUmVzdWx0ID0gJGNvbXBhcmVyLmZpbmQoJy5jb21wYXJlLXJlc3VsdCcpOw0KICAgICAgICAgICAgICAgICAgICAkY29tcGFyZVJlc3VsdC5maW5kKCcuY29tcGFyZS1iYWNrLWhvbGRlcicpLmJlZm9yZSgkdGFibGUpOw0KICAgICAgICAgICAgICAgICAgICAkY29tcGFyZVJlc3VsdC5mYWRlVG8oNDAwLCAxKTsNCiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21wYXJlUmVzdWx0SGVpZ2h0ID0gJHRhYmxlLm91dGVySGVpZ2h0KCkgKyA3NTsNCiAgICAgICAgICAgICAgICAgICAgICAgICRjb21wYXJlUmVzdWx0LnBhcmVudCgpLmhlaWdodChjb21wYXJlUmVzdWx0SGVpZ2h0KTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oZGF0YSkgew0KICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGRhdGEpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9KTsNCiAgICB9Ow0KDQogICAgdmFyIHB1YiA9IHt9Ow0KDQogICAgcHViLmluaXQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgJCgnLmRyYWdnYWJsZS1jb21wYXJlcicpLmVhY2goZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAkY29tcGFyZXIgPSAkKHRoaXMpOw0KICAgICAgICAgICAgbWF4UHJvZHVjdHMgPSBwYXJzZUludCgkY29tcGFyZXIuZGF0YSgnbWF4JyksIDEwKTsNCiAgICAgICAgICAgIHNob3dMYWJlbHMgPSAkY29tcGFyZXIuZGF0YSgnbGFiZWxzJykgPT0gJ3RydWUnIHx8ICRjb21wYXJlci5kYXRhKCdsYWJlbHMnKTsNCiAgICAgICAgICAgIC8vWEFTLTE1MzIgLSBhZnRlciBjbG9zaW5nIHRoZSBwcm9wZXJ0aWVzIGRpYWxvZyBhbGwgaW1hZ2VzIGhhcyB2aXNpYmlsaXR5PSdoaWRkZW4nIGFuZCBpbml0aWFsaXphdGlvbiBmYWlscw0KICAgICAgICAgICAgJCgiLnNpYmxpbmctaW1hZ2UiKS5jc3MoJ3Zpc2liaWxpdHknLCAndmlzaWJsZScpOw0KDQogICAgICAgICAgICBpbml0U2VsZWN0b3IoKTsNCiAgICAgICAgICAgIGluaXRDb21wYXJlKCk7DQogICAgICAgICAgICBpbml0QmFjaygpOw0KICAgICAgICB9KTsNCg0KICAgIH07DQoNCiAgICByZXR1cm4gcHViOw0KfSgkKTsNCg0KWEEucmVnaXN0ZXIoImRyYWdnYWJsZS1jb21wYXJlciIsIFhBLmNvbXBvbmVudC5kcmFnZ2FibGVDb21wYXJlcik7DQpYQS5jb21wb25lbnQuZmxhc2ggPSAoZnVuY3Rpb24gKCQsIGRvY3VtZW50KSB7DQoNCiAgICB2YXIgYXBpID0ge307DQoNCiAgICBmdW5jdGlvbiBzZXRTaXplKG9iamVjdCkgew0KICAgICAgICB2YXIgb2xkSGVpZ2h0ID0gb2JqZWN0LmF0dHIoJ2hlaWdodCcpOw0KICAgICAgICB2YXIgb2xkV2lkdGggPSBvYmplY3QuYXR0cignd2lkdGgnKTsNCiAgICAgICAgdmFyIG5ld1dpZHRoID0gb2JqZWN0LndpZHRoKCk7DQogICAgICAgIC8vdmFyIG5ld0hlaWdodCA9IG9sZEhlaWdodCAqIG5ld1dpZHRoIC8gb2xkV2lkdGg7DQogICAgICAgIHZhciBuZXdIZWlnaHQgPSBuZXdXaWR0aCAvIG9iamVjdC5oZWlnaHQoKSAqIDEwMDsNCiAgICAgICAgb2JqZWN0LmNzcygnaGVpZ2h0JywgbmV3SGVpZ2h0KTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBpbml0Rmxhc2goY29tcG9uZW50LCBwcm9wZXJ0aWVzKSB7DQogICAgICAgIHZhciBjb250ZW50ID0gY29tcG9uZW50LmZpbmQoJy5jb21wb25lbnQtY29udGVudCA+IGRpdicpOw0KDQogICAgICAgIGNvbXBvbmVudC5mbGFzaChwcm9wZXJ0aWVzKTsNCiAgICAgICAgLy8gY29udGVudC5mbGFzaChwcm9wZXJ0aWVzKTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBhdHRhY2hFdmVudHMoY29tcG9uZW50KSB7DQogICAgICAgICQod2luZG93KS5sb2FkKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciBvYmplY3QgPSBjb21wb25lbnQuZmluZCgnZW1iZWQnKTsNCiAgICAgICAgICAgIG9iamVjdC5jc3MoJ3dpZHRoJywgJzEwMCUnKTsNCiAgICAgICAgICAgIHNldFNpemUob2JqZWN0KTsNCg0KICAgICAgICAgICAgJCh3aW5kb3cpLnJlc2l6ZShmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgc2V0U2l6ZShvYmplY3QpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0pOw0KICAgIH0NCg0KICAgIGFwaS5pbml0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgZmxhc2ggPSAkKCcuZmxhc2g6bm90KC5pbml0aWFsaXplZCknKTsNCg0KICAgICAgICBmbGFzaC5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIHZhciBwcm9wZXJ0aWVzID0gJCh0aGlzKS5kYXRhKCdwcm9wZXJ0aWVzJyk7DQogICAgICAgICAgICBpbml0Rmxhc2goJCh0aGlzKSwgcHJvcGVydGllcyk7DQogICAgICAgICAgICBhdHRhY2hFdmVudHMoJCh0aGlzKSk7DQoNCiAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoJ2luaXRpYWxpemVkJyk7DQogICAgICAgIH0pOw0KICAgIH07DQoNCiAgICByZXR1cm4gYXBpOw0KfShqUXVlcnksIGRvY3VtZW50KSk7DQoNClhBLnJlZ2lzdGVyKCdmbGFzaCcsIFhBLmNvbXBvbmVudC5mbGFzaCk7DQpYQS5jb21wb25lbnQuZmxpcCA9IChmdW5jdGlvbiAoJCwgZG9jdW1lbnQpIHsNCiAgICB2YXIgYXBpID0ge307DQoNCiAgICBmdW5jdGlvbiBkZXRlY3RNb2JpbGUoKSB7DQogICAgICAgIHJldHVybiAnb250b3VjaHN0YXJ0JyBpbiB3aW5kb3c7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gc2V0SGVpZ2h0KGZsaXApIHsNCg0KICAgICAgICBmbGlwLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmFyICRib2R5ID0gJCgnYm9keScpLA0KICAgICAgICAgICAgICAgIGZsaXBzaWRlID0gJCh0aGlzKS5maW5kKCIuZmxpcHNpZGVzIiksDQogICAgICAgICAgICAgICAgc2lkZTAgPSAkKHRoaXMpLmZpbmQoIi5TaWRlMCIpLA0KICAgICAgICAgICAgICAgIHNpZGUxID0gJCh0aGlzKS5maW5kKCIuU2lkZTEiKSwNCiAgICAgICAgICAgICAgICBzaWRlQXJyID0gW107DQoNCiAgICAgICAgICAgIC8vZml4IGZvciBlZGl0IG1vZGUNCiAgICAgICAgICAgIGlmICgkYm9keS5oYXNDbGFzcygnb24tcGFnZS1lZGl0b3InKSkgew0KICAgICAgICAgICAgICAgIHNpZGUwID0gJCh0aGlzKS5maW5kKCIuU2lkZTBfRURJVCIpOw0KICAgICAgICAgICAgICAgIHNpZGUxID0gJCh0aGlzKS5maW5kKCIuU2lkZTFfRURJVCIpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBzaWRlQXJyLnB1c2goc2lkZTAub3V0ZXJIZWlnaHQoKSk7DQogICAgICAgICAgICBzaWRlQXJyLnB1c2goc2lkZTEub3V0ZXJIZWlnaHQoKSk7DQoNCiAgICAgICAgICAgIGZsaXBzaWRlLmNzcyh7DQogICAgICAgICAgICAgICAgJ2hlaWdodCcgOiAoJGJvZHkuaGFzQ2xhc3MoJ29uLXBhZ2UtZWRpdG9yJykpID8gXy5tYXgoc2lkZUFycikgKiAyIDogXy5tYXgoc2lkZUFycikNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9KTsNCiAgICB9DQoNCiAgICBhcGkuaW5pdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGZsaXAgPSAkKCcuZmxpcDpub3QoLmluaXRpYWxpemVkKScpOw0KDQogICAgICAgIGZsaXAuZWFjaChmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgICAgIGlmICgkKHRoaXMpLmhhc0NsYXNzKCdmbGlwLWhvdmVyJykgJiYgKCFkZXRlY3RNb2JpbGUoKSkpIHsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLmhvdmVyKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgICAgICAgICB9LA0KICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICQodGhpcykub24oJ2NsaWNrJywgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnRvZ2dsZUNsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygnaW5pdGlhbGl6ZWQnKTsNCiAgICAgICAgfSk7DQoNCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHNldEhlaWdodChmbGlwKTsNCiAgICAgICAgfSk7DQoNCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgc2V0SGVpZ2h0KGZsaXApOw0KICAgICAgICB9KTsNCiAgICB9Ow0KDQogICAgcmV0dXJuIGFwaTsNCg0KfShqUXVlcnksIGRvY3VtZW50KSk7DQoNCg0KWEEucmVnaXN0ZXIoJ2ZsaXAnLCBYQS5jb21wb25lbnQuZmxpcCk7DQpYQS5jb21wb25lbnQuY2FsZW5kYXIgPSAoZnVuY3Rpb24gKCQsIGRvY3VtZW50KSB7DQoNCiAgICBmdW5jdGlvbiBHZXRFdmVudHMoc2VsZWN0b3IsIG9wdGlvbnMpIHsNCiAgICAgICAgdGhpcy5kYXRhID0gb3B0aW9ucy5kYXRhOw0KICAgICAgICB0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7DQogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7DQogICAgICAgIHRoaXMuZXZlbnRzID0gW107DQoNCiAgICAgICAgdGhpcy5jaGVja1NvdXJjZSgpOw0KICAgIH0NCg0KICAgIEdldEV2ZW50cy5wcm90b3R5cGUuY2hlY2tTb3VyY2UgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBpbnN0ID0gdGhpczsNCg0KICAgICAgICBzd2l0Y2ggKGluc3Qub3B0aW9ucy5kYXRhVHlwZSkgew0KICAgICAgICAgICAgY2FzZSAianNvbiI6DQogICAgICAgICAgICAgICAgaW5zdC5nZXRKc29uKCk7DQogICAgICAgICAgICAgICAgbmV3IEluaXRDYWxlbmRhcihpbnN0LnNlbGVjdG9yLCBpbnN0Lm9wdGlvbnMsIGluc3QuZXZlbnRzKTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGNhc2UgImdjYWxlbmRhciI6DQogICAgICAgICAgICAgICAgbmV3IEluaXRDYWxlbmRhcihpbnN0LnNlbGVjdG9yLCBpbnN0Lm9wdGlvbnMsIGluc3QuZXZlbnRzKTsNCiAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgfQ0KDQogICAgfTsNCg0KICAgIEdldEV2ZW50cy5wcm90b3R5cGUuZ2V0SnNvbiA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGluc3QgPSB0aGlzLA0KICAgICAgICAgICAgZGF0ZSwgZGF0ZVN0b3AsIGRhdGVFbmQsIGFsbERheSA9IGZhbHNlLA0KICAgICAgICAgICAgdGVtcE9iaiA9IFtdOw0KDQoNCiAgICAgICAgJC5lYWNoKGluc3QuZGF0YSwgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKHRoaXMuZXZlbnRTdGFydCkudG9VVENTdHJpbmcoKTsNCiAgICAgICAgICAgIGRhdGVFbmQgPSBuZXcgRGF0ZSh0aGlzLmV2ZW50RW5kKS50b1VUQ1N0cmluZygpOw0KDQogICAgICAgICAgICBpZiAoZGF0ZSA9PT0gZGF0ZUVuZCkgew0KICAgICAgICAgICAgICAgIGFsbERheSA9IHRydWU7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHRlbXBPYmogPSB7DQogICAgICAgICAgICAgICAgdGl0bGU6IHRoaXMuZXZlbnROYW1lLA0KICAgICAgICAgICAgICAgIHN0YXJ0OiBkYXRlLA0KICAgICAgICAgICAgICAgIGVuZDogZGF0ZUVuZCwNCiAgICAgICAgICAgICAgICBldmVudERlc2NyaXB0aW9uOiB0aGlzLmV2ZW50RGVzY3JpcHRpb24sDQogICAgICAgICAgICAgICAgZXZlbnRMaW5rOiB0aGlzLmV2ZW50TGluaywNCiAgICAgICAgICAgICAgICBldmVudENsYXNzOiB0aGlzLmV2ZW50Q2xhc3MNCiAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgIGluc3QuZXZlbnRzLnB1c2godGVtcE9iaik7DQogICAgICAgIH0pOw0KDQogICAgfTsNCg0KDQogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovDQoNCiAgICBmdW5jdGlvbiB0b0dNVChkYXRlKSB7DQogICAgICAgIHJldHVybiBuZXcgRGF0ZShkYXRlLnZhbHVlT2YoKSArIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKSAqIDYwMDAwKTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBJbml0Q2FsZW5kYXIoc2VsZWN0b3IsIG9wdGlvbnMsIGV2ZW50cykgew0KICAgICAgICB2YXIgaW5zdCA9IHRoaXMsDQogICAgICAgICAgICBwcmV2TmV4dCA9ICIiLA0KICAgICAgICAgICAgdGl0bGUgPSAiIiwNCiAgICAgICAgICAgIGNvbHVtbkZvcm1hdCwNCiAgICAgICAgICAgIGNhbGVuZGFyVHlwZXMgPSAiIjsNCg0KICAgICAgICBpZiAob3B0aW9ucy5kYXRhVHlwZSA9PT0gImdjYWxlbmRhciIpIHsNCiAgICAgICAgICAgIGV2ZW50cyA9IG9wdGlvbnMuZGF0YVVybDsNCiAgICAgICAgfQ0KDQogICAgICAgIG9wdGlvbnMuc2hvd1ByZXZOZXh0PyBwcmV2TmV4dCA9ICJwcmV2LCBuZXh0IiA6ICIiOw0KICAgICAgICBvcHRpb25zLnNob3dNb250aENhcHRpb25zPyB0aXRsZSA9ICJ0aXRsZSIgOiAiIjsNCg0KICAgICAgICBmb3IgKHZhciBpIGluIG9wdGlvbnMuY2FsZW5kYXJUeXBlcykgew0KICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2FsZW5kYXJUeXBlc1tpXSA9PT0gImRheSIpIHsNCiAgICAgICAgICAgICAgICBvcHRpb25zLmNhbGVuZGFyVHlwZXNbaV0gPSAiYmFzaWNEYXkiOw0KICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLmNhbGVuZGFyVHlwZXNbaV0gPT09ICJ3ZWVrIikgew0KICAgICAgICAgICAgICAgIG9wdGlvbnMuY2FsZW5kYXJUeXBlc1tpXSA9ICJiYXNpY1dlZWsiOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKG9wdGlvbnMuY2FsZW5kYXJUeXBlcy5sZW5ndGggPiAxKSB7DQogICAgICAgICAgICBjYWxlbmRhclR5cGVzID0gb3B0aW9ucy5jYWxlbmRhclR5cGVzLmpvaW4oKTsNCiAgICAgICAgfQ0KDQogICAgICAgICQoc2VsZWN0b3IpLmZ1bGxDYWxlbmRhcih7DQogICAgICAgICAgICAvL3RpbWVGb3JtYXQ6IG9wdGlvbnMubG9jYWxpemF0aW9uLnRpbWVGb3JtYXQsDQogICAgICAgICAgICAvL2NvbHVtbkZvcm1hdDogb3B0aW9ucy5sb2NhbGl6YXRpb24uY29sdW1uRm9ybWF0LA0KICAgICAgICAgICAgLy90aXRsZUZvcm1hdDogb3B0aW9ucy5sb2NhbGl6YXRpb24udGl0bGVGb3JtYXQsDQogICAgICAgICAgICBidXR0b25UZXh0OiBvcHRpb25zLmxvY2FsaXphdGlvbi5idXR0b25UZXh0LA0KICAgICAgICAgICAgbW9udGhOYW1lczogb3B0aW9ucy5sb2NhbGl6YXRpb24ubW9udGhOYW1lcywNCiAgICAgICAgICAgIG1vbnRoTmFtZXNTaG9ydDogb3B0aW9ucy5sb2NhbGl6YXRpb24ubW9udGhOYW1lc1Nob3J0LA0KICAgICAgICAgICAgZGF5TmFtZXM6IG9wdGlvbnMubG9jYWxpemF0aW9uLmRheU5hbWVzLA0KICAgICAgICAgICAgZGF5TmFtZXNTaG9ydDogb3B0aW9ucy5sb2NhbGl6YXRpb24uZGF5TmFtZXNTaG9ydCwNCg0KICAgICAgICAgICAgaGVhZGVyOiB7DQogICAgICAgICAgICAgICAgbGVmdDogcHJldk5leHQsDQogICAgICAgICAgICAgICAgY2VudGVyOiB0aXRsZSwNCiAgICAgICAgICAgICAgICByaWdodDogY2FsZW5kYXJUeXBlcw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGV2ZW50czogZXZlbnRzLA0KICAgICAgICAgICAgZGVmYXVsdFZpZXc6IG9wdGlvbnMuY2FsZW5kYXJUeXBlc1swXSwNCiAgICAgICAgICAgIHJlbmRlckV2ZW50OiBmYWxzZSwNCiAgICAgICAgICAgIGV2ZW50UmVuZGVyOiBmdW5jdGlvbiAoZXZlbnQsIGVsZW1lbnQpIHsNCiAgICAgICAgICAgICAgICBpZiAoKG9wdGlvbnMuY29tcGFjdFZpZXcpICYmIChvcHRpb25zLmRhdGFUeXBlID09PSAianNvbiIpKSB7DQogICAgICAgICAgICAgICAgICAgICQoZWxlbWVudCkuY3NzKCJkaXNwbGF5IiwgIm5vbmUiKTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5kYXRhVHlwZSA9PT0gImpzb24iKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LmF0dGFjaFRvb2x0aXAoZXZlbnQsIGVsZW1lbnQsIGZhbHNlKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoZXZlbnQuZXZlbnRDbGFzcyk7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgZXZlbnRBZnRlckFsbFJlbmRlcjogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIGlmICgob3B0aW9ucy5jb21wYWN0VmlldykgJiYgKG9wdGlvbnMuZGF0YVR5cGUgPT09ICJqc29uIikpIHsNCiAgICAgICAgICAgICAgICAgICAgaW5zdC5yZW5kZXJDb21wYWN0Q2FsZW5kYXJFdmVudHMoc2VsZWN0b3IsIGV2ZW50cyk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9DQoNCiAgICBJbml0Q2FsZW5kYXIucHJvdG90eXBlLmF0dGFjaFRvb2x0aXAgPSBmdW5jdGlvbiAoZXZlbnQsIGVsZW1lbnQsIGNvbXBhY3RDYWxlbmRhcikgew0KICAgICAgICB2YXIgaW5zdCA9IHRoaXMsDQogICAgICAgICAgICAkdG9vbHRpcCwNCiAgICAgICAgICAgIHRvb2x0aXBDb250ZW50LA0KICAgICAgICAgICAgdG9wID0gMDsNCg0KICAgICAgICAkKGVsZW1lbnQpLm9uKCJtb3VzZWVudGVyIiwgZnVuY3Rpb24gKGV2KSB7DQogICAgICAgICAgICB0b29sdGlwQ29udGVudCA9ICIiOw0KICAgICAgICAgICAgJCgiLmNhbGVuZGFyLXRvb2x0aXAiKS5mYWRlT3V0KCk7DQogICAgICAgICAgICAkKCIuY2FsZW5kYXItdG9vbHRpcCIpLnJlbW92ZSgpOw0KDQogICAgICAgICAgICBpZiAoY29tcGFjdENhbGVuZGFyKSB7DQogICAgICAgICAgICAgICAgdG9vbHRpcENvbnRlbnQgPSAiIjsNCiAgICAgICAgICAgICAgICAkLmVhY2goZXZlbnQsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgdG9vbHRpcENvbnRlbnQgKz0gIjxkaXYgY2xhc3M9J2NvbXBhY3QtZXZlbnQnPiIgKw0KICAgICAgICAgICAgICAgICAgICAiPHNwYW4gY2xhc3M9J3RpdGxlJz4iICsgdGhpcy50aXRsZSArICI8L3NwYW4+IiArDQogICAgICAgICAgICAgICAgICAgICI8c3BhbiBjbGFzcz0nZGVzY3JpcHRpb24nPiIgKyB0aGlzLmV2ZW50RGVzY3JpcHRpb24gKyAiPC9zcGFuPiIgKw0KICAgICAgICAgICAgICAgICAgICAiPHNwYW4gY2xhc3M9J2xpbmsnPjxhIGhyZWY9JyIgKyB0aGlzLmV2ZW50TGluayArICInPkxpbms8L2E+PC9zcGFuPjwvZGl2PiI7DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHRvb2x0aXBDb250ZW50ID0gIjxzcGFuIGNsYXNzPSdkZXNjcmlwdGlvbic+IiArIGV2ZW50LmV2ZW50RGVzY3JpcHRpb24gKyAiPC9zcGFuPiIgKw0KICAgICAgICAgICAgICAgICI8c3BhbiBjbGFzcz0nbGluayc+IiArIGV2ZW50LmV2ZW50TGluayArICI8L3NwYW4+IjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgICR0b29sdGlwID0gJCgiPGRpdiBjbGFzcz0nY2FsZW5kYXItdG9vbHRpcCc+PGRpdiBjbGFzcz0nYXJyb3cnPiIgKw0KICAgICAgICAgICAgIjwvZGl2PjxkaXYgY2xhc3M9J2V2ZW50cyc+IiArIHRvb2x0aXBDb250ZW50ICsgIjwvZGl2PjwvZGl2PiIpOw0KICAgICAgICAgICAgJCgiYm9keSIpLmFwcGVuZCgkdG9vbHRpcCk7DQoNCg0KICAgICAgICAgICAgJHRvb2x0aXAuY3NzKHsNCiAgICAgICAgICAgICAgICAibGVmdCI6ICQodGhpcykub2Zmc2V0KCkubGVmdCArICQodGhpcykud2lkdGgoKSAvIDIgLSA4MA0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAkdG9vbHRpcC5jc3Moew0KICAgICAgICAgICAgICAgICJ0b3AiOiAkKHRoaXMpLm9mZnNldCgpLnRvcCArICQodGhpcykuaGVpZ2h0KCkgLyAyICsgNQ0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIHZhciB0aW1lb3V0Ow0KICAgICAgICAgICAgJCh0aGlzKS51bmJpbmQoIm1vdXNlbGVhdmUiKTsNCiAgICAgICAgICAgICQodGhpcykub24oIm1vdXNlbGVhdmUiLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAkdG9vbHRpcC5mYWRlT3V0KGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykucmVtb3ZlKCk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0sIDMwMCk7DQoNCiAgICAgICAgICAgICAgICAkdG9vbHRpcC51bmJpbmQoIm1vdXNlZW50ZXIiKTsNCiAgICAgICAgICAgICAgICAkdG9vbHRpcC5vbigibW91c2VlbnRlciIsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOw0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfSk7DQoNCg0KICAgICAgICAgICAgJHRvb2x0aXAudW5iaW5kKCJtb3VzZWxlYXZlIik7DQogICAgICAgICAgICAkdG9vbHRpcC5vbigibW91c2VsZWF2ZSIsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLmZhZGVPdXQoZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnJlbW92ZSgpOw0KICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICB9KTsNCg0KICAgICAgICB9KTsNCiAgICB9Ow0KDQogICAgLy9hdHRhY2ggZXZlbnRzIGZvciBzaW5nbGUgZGF5cyAtIGNvbXBhY3QgY2FsZW5kYXIqLw0KICAgIEluaXRDYWxlbmRhci5wcm90b3R5cGUucmVuZGVyQ29tcGFjdENhbGVuZGFyRXZlbnRzID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBldmVudHMpIHsNCiAgICAgICAgdmFyIGluc3QgPSB0aGlzLA0KICAgICAgICAgICAgY3VycmVudERheSwNCiAgICAgICAgICAgIGN1cnJlbnREYXRlLA0KICAgICAgICAgICAgY3VycmVudEV2ZW50LA0KICAgICAgICAgICAgZGMsIG1jLCB5YywNCiAgICAgICAgICAgIGQsIG0sIHksIGRlLCBtZSwgeWUsIGhlLA0KICAgICAgICAgICAgc3RhcnREYXRlLA0KICAgICAgICAgICAgZW5kRGF0ZSwNCiAgICAgICAgICAgIGRheUV2ZW50cyA9IFtdOw0KDQogICAgICAgICQoc2VsZWN0b3IpLmZpbmQoIi5mYy1kYXkiKS5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIGN1cnJlbnREYXkgPSB0aGlzOw0KDQogICAgICAgICAgICBjdXJyZW50RGF0ZSA9IG5ldyBEYXRlKCQodGhpcykuZGF0YSgiZGF0ZSIpKTsNCiAgICAgICAgICAgIGRjID0gY3VycmVudERhdGUuZ2V0RGF0ZSgpOw0KICAgICAgICAgICAgbWMgPSBjdXJyZW50RGF0ZS5nZXRNb250aCgpOw0KICAgICAgICAgICAgeWMgPSBjdXJyZW50RGF0ZS5nZXRGdWxsWWVhcigpOw0KDQogICAgICAgICAgICBkYXlFdmVudHMgPSBbXTsNCiAgICAgICAgICAgICQuZWFjaChldmVudHMsIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBjdXJyZW50RXZlbnQgPSB0aGlzOw0KICAgICAgICAgICAgICAgIHN0YXJ0RGF0ZSA9IHRvR01UKG5ldyBEYXRlKHRoaXMuc3RhcnQpKTsNCiAgICAgICAgICAgICAgICBkID0gc3RhcnREYXRlLmdldERhdGUoKTsNCiAgICAgICAgICAgICAgICBtID0gc3RhcnREYXRlLmdldE1vbnRoKCk7DQogICAgICAgICAgICAgICAgeSA9IHN0YXJ0RGF0ZS5nZXRGdWxsWWVhcigpOw0KDQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZW5kKSB7DQogICAgICAgICAgICAgICAgICAgIGVuZERhdGUgPSB0b0dNVChuZXcgRGF0ZSh0aGlzLmVuZCkpOw0KICAgICAgICAgICAgICAgICAgICBkZSA9IGVuZERhdGUuZ2V0RGF0ZSgpOw0KICAgICAgICAgICAgICAgICAgICBtZSA9IGVuZERhdGUuZ2V0TW9udGgoKTsNCiAgICAgICAgICAgICAgICAgICAgeWUgPSBlbmREYXRlLmdldEZ1bGxZZWFyKCk7DQogICAgICAgICAgICAgICAgICAgIGhlID0gZW5kRGF0ZS5nZXRIb3VycygpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmICgoeWMgPj0geSkgJiYgKHljIDw9IHllKSAmJiAobWMgPj0gbSkgJiYgKG1jIDw9IG1lKSAmJiAoZGMgPj0gZCkgJiYgKGRjIDw9IGRlKSkgew0KICAgICAgICAgICAgICAgICAgICBpZiAoKHljID09IHllKSAmJiAobWMgPT0gbWUpICYmIChkYyA9PSBkZSkgJiYgKGhlIDwgOSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIGxhc3QgZGF5IGRvIG5vdGhpbmcgYnV0IGhvdXIgPCA5DQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAkKGN1cnJlbnREYXkpLmFkZENsYXNzKCJzZWxlY3RlZC1kYXkiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGRheUV2ZW50cy5wdXNoKGN1cnJlbnRFdmVudCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgaWYgKGRheUV2ZW50cy5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICBpbnN0LmF0dGFjaFRvb2x0aXAoZGF5RXZlbnRzLCBjdXJyZW50RGF5LCB0cnVlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQoNCiAgICB9Ow0KDQoNCiAgICBmdW5jdGlvbiByZXNpemVDYWxlbmRhcihzZWxlY3Rvcikgew0KICAgICAgICAkKHNlbGVjdG9yKS5mdWxsQ2FsZW5kYXIoInJlbmRlciIpOw0KICAgIH0NCg0KDQogICAgdmFyIHB1YiA9IHt9Ow0KDQogICAgcHViLmluaXQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgICQoIi5ldmVudC1jYWxlbmRhcjpub3QoLmluaXRpYWxpemVkKSIpLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSAkKHRoaXMpLmRhdGEoInByb3BlcnRpZXMiKSwNCiAgICAgICAgICAgICAgICBzZWxlY3RvciA9ICIjIiArICQodGhpcykuZmluZCgiLmV2ZW50LWNhbGVuZGFyLWlubmVyIikuYXR0cigiaWQiKTsNCg0KICAgICAgICAgICAgaWYgKChwcm9wZXJ0aWVzLmNvbXBhY3RWaWV3KSAmJiAocHJvcGVydGllcy5kYXRhVHlwZSA9PT0gImpzb24iKSkgew0KICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoImNvbXBhY3QtbW9kZSIpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBuZXcgR2V0RXZlbnRzKHNlbGVjdG9yLCBwcm9wZXJ0aWVzKTsNCg0KICAgICAgICAgICAgJCh3aW5kb3cpLnJlc2l6ZShmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgcmVzaXplQ2FsZW5kYXIoc2VsZWN0b3IpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoImluaXRpYWxpemVkIik7DQogICAgICAgIH0pOw0KICAgIH07DQoNCiAgICByZXR1cm4gcHViOw0KDQp9KShqUXVlcnksIGRvY3VtZW50KTsNCg0KWEEucmVnaXN0ZXIoImNhbGVuZGFyIiwgWEEuY29tcG9uZW50LmNhbGVuZGFyKTsNClhBLmNvbXBvbmVudC5nYWxsZXJpYSA9IChmdW5jdGlvbiAoJCwgZG9jdW1lbnQpIHsNCg0KICAgIHZhciBhcGkgPSB7fTsNCg0KICAgIGZ1bmN0aW9uIGNoZWNrUGFnZUVkaXRvcigpIHsNCiAgICAgICAgaWYgKCQoImJvZHkiKS5oYXNDbGFzcygib24tcGFnZS1lZGl0b3IiKSkgew0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gaW5pdEdhbGxlcmlhKGNvbXBvbmVudCwgcHJvcCkgew0KICAgICAgICB2YXIgaWQgPSBjb21wb25lbnQuZmluZCgiLmdhbGxlcnktaW5uZXIiKS5hdHRyKCJpZCIpOw0KICAgICAgICBHYWxsZXJpYS5sb2FkVGhlbWUocHJvcC50aGVtZSk7DQogICAgICAgIEdhbGxlcmlhLmNvbmZpZ3VyZSh7DQogICAgICAgICAgICB0cmFuc2l0aW9uOiAnZmFkZScsDQogICAgICAgICAgICBpbWFnZUNyb3A6IHRydWUNCiAgICAgICAgfSk7DQogICAgICAgIEdhbGxlcmlhLnJ1bigiIyIgKyBpZCwgcHJvcCk7DQogICAgfQ0KDQogICAgYXBpLmluaXQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIGlmICghY2hlY2tQYWdlRWRpdG9yKCkpIHsNCiAgICAgICAgICAgIHZhciBnYWxsZXJ5ID0gJCgiLmdhbGxlcnk6bm90KC5pbml0aWFsaXplZCkiKTsNCg0KICAgICAgICAgICAgZ2FsbGVyeS5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICB2YXIgcHJvcGVydGllcyA9ICQodGhpcykuZGF0YSgicHJvcGVydGllcyIpOw0KICAgICAgICAgICAgICAgIGluaXRHYWxsZXJpYSgkKHRoaXMpLCBwcm9wZXJ0aWVzKTsNCg0KICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoImluaXRpYWxpemVkIik7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KICAgIH07DQoNCiAgICByZXR1cm4gYXBpOw0KfShqUXVlcnksIGRvY3VtZW50KSk7DQoNClhBLnJlZ2lzdGVyKCJnYWxsZXJpYSIsIFhBLmNvbXBvbmVudC5nYWxsZXJpYSk7DQpYQS5jb21wb25lbnQubGFuZ3VhZ2VTZWxlY3RvciA9IChmdW5jdGlvbiAoJCwgZG9jdW1lbnQpIHsNCg0KICAgIHZhciBhcGkgPSB7fTsNCg0KICAgIGZ1bmN0aW9uIHJlYWREYXRhQXR0cmlidXRlcyhpdGVtKSB7DQogICAgICAgIHZhciBsYW5nID0gaXRlbS5kYXRhKCJsYW5ndWFnZS1jb2RlIiksDQogICAgICAgICAgICBjb3VudHJ5ID0gaXRlbS5kYXRhKCJjb3VudHJ5LWNvZGUiKTsNCg0KICAgICAgICByZXR1cm4gImZsYWdzLSIgKyBjb3VudHJ5Ow0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGluaXRMYW5ndWFnZVNlbGVjdG9yKGluc3RhbmNlKSB7DQogICAgICAgIHZhciBlbCA9ICQoaW5zdGFuY2UpLA0KICAgICAgICAgICAgaGVhZGVyID0gZWwuZmluZCgiLmxhbmd1YWdlLXNlbGVjdG9yLXNlbGVjdC1pdGVtIiksDQogICAgICAgICAgICBkcm9wRG93bkxpc3QgPSBlbC5maW5kKCIubGFuZ3VhZ2Utc2VsZWN0b3ItaXRlbS1jb250YWluZXIiKSwNCiAgICAgICAgICAgIGRyb3BEb3duSXRlbSA9IGRyb3BEb3duTGlzdC5maW5kKCIubGFuZ3VhZ2Utc2VsZWN0b3ItaXRlbSIpOw0KDQogICAgICAgIHZhciBjbGFzc05hbWUgPSByZWFkRGF0YUF0dHJpYnV0ZXMoaGVhZGVyKTsNCiAgICAgICAgaGVhZGVyLmZpbmQoIj5hIikuYWRkQ2xhc3MoY2xhc3NOYW1lKTsNCg0KICAgICAgICBkcm9wRG93bkxpc3QuZmluZCgiLmxhbmd1YWdlLXNlbGVjdG9yLWl0ZW0iKS5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIGNsYXNzTmFtZSA9IHJlYWREYXRhQXR0cmlidXRlcygkKHRoaXMpKTsNCiAgICAgICAgICAgICQodGhpcykuZmluZCgiPmEiKS5hZGRDbGFzcyhjbGFzc05hbWUpOw0KICAgICAgICB9KTsNCg0KICAgICAgICBoZWFkZXIub24oImNsaWNrIiwgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgZHJvcERvd25MaXN0LnNsaWRlVG9nZ2xlKCk7DQogICAgICAgIH0pOw0KDQogICAgICAgIGRyb3BEb3duSXRlbS5vbigiY2xpY2siLCBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICB2YXIgdXJsID0gJCh0aGlzKS5maW5kKCJhIikuYXR0cigiaHJlZiIpOw0KDQogICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IHVybDsNCiAgICAgICAgfSk7DQogICAgfQ0KDQoNCiAgICBhcGkuaW5pdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgdmFyIGxhbmd1YWdlU2VsZWN0b3IgPSAkKCIubGFuZ3VhZ2Utc2VsZWN0b3I6bm90KC5pbml0aWFsaXplZCkiKTsNCg0KICAgICAgICBsYW5ndWFnZVNlbGVjdG9yLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgaW5pdExhbmd1YWdlU2VsZWN0b3IodGhpcyk7DQogICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJpbml0aWFsaXplZCIpOw0KICAgICAgICB9KTsNCiAgICB9Ow0KDQogICAgcmV0dXJuIGFwaTsNCn0oalF1ZXJ5LCBkb2N1bWVudCkpOw0KDQpYQS5yZWdpc3RlcigibGFuZ3VhZ2Utc2VsZWN0b3IiLCBYQS5jb21wb25lbnQubGFuZ3VhZ2VTZWxlY3Rvcik7DQpYQS5jb21wb25lbnQubGlua3MgPSAoZnVuY3Rpb24oJCwgZG9jdW1lbnQpIHsNCg0KICAgIHZhciBwdWIgPSB7fSwNCiAgICAgICAgaGlkZGVuSWQ7DQoNCiAgICBmdW5jdGlvbiBnZXRIaWRkZW5JZCgpew0KICAgICAgICBoaWRkZW5JZCA9ICQoIi5oaWRkZW4taWQgLmZpZWxkLWlkIikuaHRtbCgpOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGNoYW5nZUxpbmsoKSB7DQogICAgICAgIHZhciBsaW5rcyA9ICQoIi5zdGFuZGFyZC1lbnF1aXJ5LWxpbmssIC5wcm9taW5lbnQtZW5xdWlyeS1saW5rLCAuaW1wb3J0YW50LWVucXVpcnktbGluayIpLA0KICAgICAgICAgICAgbGlua0hyZWY7DQoNCiAgICAgICAgXy5lYWNoKGxpbmtzLCBmdW5jdGlvbihsaW5rKXsNCiAgICAgICAgICAgIGxpbmtIcmVmID0gJChsaW5rKS5hdHRyKCJocmVmIik7DQogICAgICAgICAgICBsaW5rSHJlZiA9IGxpbmtIcmVmLnJlcGxhY2UoIiRpdGVtaWQkIiwgaGlkZGVuSWQpOw0KICAgICAgICAgICAgJChsaW5rKS5hdHRyKCJocmVmIiwgbGlua0hyZWYpOw0KICAgICAgICB9KTsNCiAgICB9DQoNCiAgICBwdWIuaW5pdCA9IGZ1bmN0aW9uKCkgew0KICAgICAgICBnZXRIaWRkZW5JZCgpOw0KICAgICAgICBjaGFuZ2VMaW5rKCk7DQogICAgfTsNCg0KICAgIHJldHVybiBwdWI7DQoNCn0pKGpRdWVyeSwgZG9jdW1lbnQpOw0KDQpYQS5yZWdpc3RlcigibGlua3MiLCBYQS5jb21wb25lbnQubGlua3MpOw0KWEEuY29tcG9uZW50LmxpdmVmeXJlID0gKGZ1bmN0aW9uICgkLCBkb2N1bWVudCkgew0KDQogICAgdmFyIGFwaSA9IHt9Ow0KDQogICAgZnVuY3Rpb24gaW5pdExpdmVmeXJlKHByb3ApIHsNCiAgICAgICAgdmFyIGFydGljbGVJZCA9IGZ5cmUuY29udi5sb2FkLm1ha2VBcnRpY2xlSWQobnVsbCk7DQogICAgICAgIGZ5cmUuY29udi5sb2FkKHt9LCBbew0KICAgICAgICAgICAgZWw6ICdsaXZlZnlyZS1jb21tZW50cycsDQogICAgICAgICAgICBuZXR3b3JrOiAibGl2ZWZ5cmUuY29tIiwNCiAgICAgICAgICAgIHNpdGVJZDogcHJvcC5zaXRlSWQsDQogICAgICAgICAgICBhcnRpY2xlSWQ6IGFydGljbGVJZCwNCiAgICAgICAgICAgIHNpZ25lZDogZmFsc2UsDQogICAgICAgICAgICBjb2xsZWN0aW9uTWV0YTogew0KICAgICAgICAgICAgICAgIGFydGljbGVJZDogYXJ0aWNsZUlkLA0KICAgICAgICAgICAgICAgIHVybDogZnlyZS5jb252LmxvYWQubWFrZUNvbGxlY3Rpb25VcmwoKSwNCiAgICAgICAgICAgIH0NCiAgICAgICAgfV0sIGZ1bmN0aW9uICgpIHt9KTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBsb2FkU2NyaXB0KGh0dHAsIGh0dHBzKSB7DQogICAgICAgIGlmICh3aW5kb3cuZnlyZSA9PT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2w7DQoNCiAgICAgICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsNCiAgICAgICAgICAgIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7DQogICAgICAgICAgICBzY3JpcHQuYXN5bmMgPSB0cnVlOw0KICAgICAgICAgICAgc2NyaXB0LnNyYyA9IChwcm90b2NvbCA9PT0gImh0dHBzOiIpID8gaHR0cHMgOiBodHRwOw0KICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXS5hcHBlbmRDaGlsZChzY3JpcHQpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgYXBpLmluaXQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBsaXZlZnlyZSA9ICQoIi5saXZlZnlyZS1jb21tZW50czpub3QoLmluaXRpYWxpemVkKSIpOw0KDQogICAgICAgIGxpdmVmeXJlLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSAkKHRoaXMpLmRhdGEoInByb3BlcnRpZXMiKTsNCg0KICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMuc2l0ZUlkKSB7DQogICAgICAgICAgICAgICAgbG9hZFNjcmlwdCgnaHR0cDovL3pvci5saXZlZnlyZS5jb20vd2pzL3YzLjAvamF2YXNjcmlwdHMvbGl2ZWZ5cmUuanMnLCAnaHR0cHM6Ly9jZG4ubGl2ZWZ5cmUuY29tL2xpYnMvZnlyZS5jb252LmxvYWQuanMnKTsNCg0KICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgIGluaXRMaXZlZnlyZShwcm9wZXJ0aWVzKTsNCiAgICAgICAgICAgICAgICB9LCAxMDAwKTsNCg0KICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoImluaXRpYWxpemVkIik7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgIH07DQoNCiAgICByZXR1cm4gYXBpOw0KfShqUXVlcnksIGRvY3VtZW50KSk7DQoNClhBLnJlZ2lzdGVyKCJsaXZlZnlyZSIsIFhBLmNvbXBvbmVudC5saXZlZnlyZSk7DQoNClhBLmNvbXBvbmVudC5uYXZpZ2F0aW9uID0gKGZ1bmN0aW9uICgkLCBkb2N1bWVudCkgew0KDQogICAgdmFyIHRpbWVvdXQgPSAyMDAsDQogICAgICAgIHRpbWVyID0gMCwNCiAgICAgICAgc3VibWVudSwNCiAgICAgICAgZHJvcERvd25FdmVudHMgPSB7DQogICAgICAgICAgICBzaG93OiBmdW5jdGlvbiAoc20pIHsNCiAgICAgICAgICAgICAgICB0aGlzLmRlYm91bmNlKCk7DQogICAgICAgICAgICAgICAgaWYgKHN1Ym1lbnUpIHsNCiAgICAgICAgICAgICAgICAgICAgc3VibWVudS5wYXJlbnQoKS5yZW1vdmVDbGFzcygic2hvdyIpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICBzdWJtZW51ID0gc207DQogICAgICAgICAgICAgICAgc3VibWVudS5wYXJlbnQoKS5hZGRDbGFzcygic2hvdyIpOw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGRlYm91bmNlOiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgaWYgKHRpbWVyKSB7DQogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7DQogICAgICAgICAgICAgICAgICAgIHRpbWVyID0gbnVsbDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgaGlkZTogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIGlmIChzdWJtZW51KSB7DQogICAgICAgICAgICAgICAgICAgIHN1Ym1lbnUucGFyZW50KCkucmVtb3ZlQ2xhc3MoInNob3ciKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBxdWV1ZUhpZGU6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgIGRyb3BEb3duRXZlbnRzLmhpZGUoKTsNCiAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBmb2N1czogZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICQodGhpcykucGFyZW50KCkuc2libGluZ3MoKS5yZW1vdmVDbGFzcygic2hvdyIpOw0KICAgICAgICAgICAgICAgICQodGhpcykucGFyZW50KCkuYWRkQ2xhc3MoInNob3ciKTsNCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBibHVyOiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgaWYgKCQodGhpcykucGFyZW50KCkuaXMoIi5sYXN0IikpIHsNCiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnRzKCIucmVsLWxldmVsMSIpLnJlbW92ZUNsYXNzKCJzaG93Iik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KDQogICAgICAgIH07DQoNCiAgICBmdW5jdGlvbiBkcm9wRG93bk5hdmlnYXRpb24obmF2aSkgew0KICAgICAgICBuYXZpLm9uKCJtb3VzZW92ZXIiLCAiLnJlbC1sZXZlbDEgPiBhIiwgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5yZW1vdmVDbGFzcygic2hvdyIpOw0KICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5zaWJsaW5ncygpLnJlbW92ZUNsYXNzKCJzaG93Iik7DQogICAgICAgICAgICB2YXIgZWxlbSA9ICQodGhpcykuc2libGluZ3MoInVsIik7DQogICAgICAgICAgICBkcm9wRG93bkV2ZW50cy5zaG93KGVsZW0pOw0KICAgICAgICB9KTsNCiAgICAgICAgbmF2aS5vbigibW91c2VsZWF2ZSIsICIucmVsLWxldmVsMSA+IGEiLCBkcm9wRG93bkV2ZW50cy5xdWV1ZUhpZGUpOw0KICAgICAgICBuYXZpLm9uKCJtb3VzZW92ZXIiLCAiLnJlbC1sZXZlbDEgPiB1bCIsIGRyb3BEb3duRXZlbnRzLmRlYm91bmNlKTsNCiAgICAgICAgbmF2aS5vbigibW91c2VsZWF2ZSIsICIucmVsLWxldmVsMSA+IHVsIiwgZHJvcERvd25FdmVudHMucXVldWVIaWRlKTsNCiAgICAgICAgbmF2aS5vbigiZm9jdXMiLCAiLnJlbC1sZXZlbDEgPiBhIiwgZHJvcERvd25FdmVudHMuZm9jdXMpOw0KICAgICAgICBuYXZpLm9uKCJibHVyIiwgIi5yZWwtbGV2ZWwyID4gYSIsIGRyb3BEb3duRXZlbnRzLmJsdXIpOw0KDQogICAgICAgIG5hdmkuZmluZCgiLnJlbC1sZXZlbDEiKS5lYWNoKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgIGlmICgkKHRoaXMpLmZpbmQoInVsIikubGVuZ3RoKSB7DQogICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygic3VibWVudSIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCg0KICAgICAgICBuYXZpLmZpbmQoIi5yZWwtbGV2ZWwyIikuZWFjaChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAvL2lmIGxldmVsMiBtZW51IGhhdmUgY2hpbGRyZW4NCg0KICAgICAgICAgICAgaWYgKCQodGhpcykucGFyZW50cygnI2hlYWRlcicpLmxlbmd0aCA+IDApIHsNCiAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5maW5kKCJ1bCIpLmxlbmd0aCkgew0KICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJzdWJtZW51Iik7DQogICAgICAgICAgICAgICAgICAgICQodGhpcykucGFyZW50cygnLnJlbC1sZXZlbDEnKS5hZGRDbGFzcygnd2lkZS1uYXYnKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vaWYgbGV2ZWwyIG1lbnUgc2hvdWxkIGJlIG5hdmlnYXRpb24taW1hZ2UgdmFyaWFudA0KICAgICAgICAgICAgaWYgKCQodGhpcykuZmluZCgnPiBpbWcnKS5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJzdWJtZW51IG5hdmlnYXRpb24taW1hZ2UiKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gbW9iaWxlTmF2aWdhdGlvbihuYXZpKSB7DQoNCiAgICAgICAgZnVuY3Rpb24gY2hlY2tDaGlsZHJlbihuYXYpIHsNCiAgICAgICAgICAgIG5hdi5maW5kKCIucmVsLWxldmVsMSIpLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgIGlmICghJCh0aGlzKS5maW5kKCJ1bCIpLmxlbmd0aCkgew0KICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJuby1jaGlsZCIpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gYmluZEV2ZW50cyhuYXYpIHsNCiAgICAgICAgICAgIG5hdi5maW5kKCIucmVsLWxldmVsMSIpLm9uKCJjbGljayIsIGZ1bmN0aW9uIChlKSB7DQogICAgICAgICAgICAgICAgdmFyIG5hdmx2bCA9ICQodGhpcyksDQogICAgICAgICAgICAgICAgICAgIG1lbnVQYXJlbnQgPSBuYXZsdmwucGFyZW50cygnLm5hdmlnYXRpb24nKTsNCg0KICAgICAgICAgICAgICAgIGlmIChtZW51UGFyZW50Lmhhc0NsYXNzKCduYXZpZ2F0aW9uLW1vYmlsZScpKSB7DQogICAgICAgICAgICAgICAgICAgIGlmICghJChlLnRhcmdldCkuaXMoImEiKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hdmx2bC5oYXNDbGFzcygiYWN0aXZlIikpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYXZsdmwuZmluZCgidWwiKS5zbGlkZVRvZ2dsZShmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hdmx2bC5yZW1vdmVDbGFzcygiYWN0aXZlIik7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hdmx2bC5maW5kKCJ1bCIpLnNsaWRlVG9nZ2xlKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmF2bHZsLmFkZENsYXNzKCJhY3RpdmUiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBuYXYuZmluZCgiLnJlbC1sZXZlbDEgPiBhIikub24oImZvY3VzIiwgZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgICAgICQodGhpcykuc2libGluZ3MoInVsIikuc2xpZGVEb3duKCk7DQogICAgICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5zaWJsaW5ncygpLmZpbmQoInVsIikuc2xpZGVVcCgpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCg0KICAgICAgICBjaGVja0NoaWxkcmVuKG5hdmkpOw0KICAgICAgICBiaW5kRXZlbnRzKG5hdmkpOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIHRvZ2dsZUljb24odG9nZ2xlKXsNCiAgICAgICAgJCh0b2dnbGUpLmNsb3Nlc3QoJy5ncmlkLTcnKS5maW5kKCcubmF2aWdhdGlvbicpLnRvZ2dsZUNsYXNzKCJhY3RpdmUiKTsNCiAgICAgICAgJCh0b2dnbGUpLnRvZ2dsZUNsYXNzKCJhY3RpdmUiKTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBoZWFkZXJNZW51Rml4KG5hdikgew0KICAgICAgICB2YXIgaGVhZGVyID0gJCgnI2hlYWRlcicpLA0KICAgICAgICAgICAgaGVhZGVyV2lkdGggPSBoZWFkZXIuZmluZCgnLmNvbnRhaW5lci5ib3hlZCAuY29tcG9uZW50LWNvbnRlbnQnKS53aWR0aCgpLA0KICAgICAgICAgICAgbmF2UGFkZGluZyA9IHBhcnNlSW50KG5hdi5wYXJlbnQoKS5jc3MoJ21hcmdpbi1sZWZ0JyksIDEwKSwNCiAgICAgICAgICAgIGhlYWRlckxvZ28gPSBoZWFkZXIuZmluZCgnLmltYWdlJykucGFyZW50KCkud2lkdGgoKSwNCiAgICAgICAgICAgIHdpZGVNZW51ID0gbmF2LmZpbmQoJy53aWRlLW5hdiA+IHVsJyksDQogICAgICAgICAgICBtZW51UG9zaXRpb24gPSBoZWFkZXJMb2dvICsgbmF2UGFkZGluZzsNCg0KDQogICAgICAgIGlmICgkKHdpbmRvdykud2lkdGgoKSA+PSAnNzY3Jykgew0KICAgICAgICAgICAgaWYgKG5hdi5wYXJlbnRzKCcjaGVhZGVyJykubGVuZ3RoID4gMCkgew0KICAgICAgICAgICAgICAgIHdpZGVNZW51LmNzcyh7DQogICAgICAgICAgICAgICAgICAgICd3aWR0aCc6IGhlYWRlcldpZHRoLA0KICAgICAgICAgICAgICAgICAgICAnbGVmdCc6IC1tZW51UG9zaXRpb24NCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHdpZGVNZW51LmNzcyh7DQogICAgICAgICAgICAgICAgJ3dpZHRoJzogJ2F1dG8nLA0KICAgICAgICAgICAgICAgICdsZWZ0JzogMA0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCg0KICAgIH0NCg0KDQogICAgdmFyIGFwaSA9IHt9Ow0KDQogICAgYXBpLmluaXQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgdmFyIG5hdmlnYXRpb24gPSAkKCIubmF2aWdhdGlvbjpub3QoLmluaXRpYWxpemVkKSIpOw0KDQogICAgICAgIG5hdmlnYXRpb24uZWFjaChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIGlmICgkKHRoaXMpLmhhc0NsYXNzKCJuYXZpZ2F0aW9uLW1haW4iKSkgew0KICAgICAgICAgICAgICAgIGRyb3BEb3duTmF2aWdhdGlvbigkKHRoaXMpKTsNCiAgICAgICAgICAgICAgICBtb2JpbGVOYXZpZ2F0aW9uKCQodGhpcykpOw0KICAgICAgICAgICAgfSBlbHNlIGlmICgkKHRoaXMpLmhhc0NsYXNzKCJuYXZpZ2F0aW9uLW1vYmlsZSIpKSB7DQogICAgICAgICAgICAgICAgbW9iaWxlTmF2aWdhdGlvbigkKHRoaXMpKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKCQodGhpcykucGFyZW50cygiI2hlYWRlciIpKSB7DQogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSAkKHRoaXMpOw0KICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgIGhlYWRlck1lbnVGaXgoc2VsZik7DQogICAgICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgIGhlYWRlck1lbnVGaXgoc2VsZik7DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoImluaXRpYWxpemVkIik7DQogICAgICAgIH0pOw0KDQogICAgICAgIHZhciB0b2dnbGUgPSAkKCIubW9iaWxlLW5hdjpub3QoLmluaXRpYWxpemVkKSIpOw0KICAgICAgICB0b2dnbGUuZWFjaChmdW5jdGlvbihrZXksIGl0ZW0pew0KICAgICAgICAgICAgdmFyICRtZW51ID0gJChpdGVtKTsNCg0KICAgICAgICAgICAgJG1lbnUub24oImNsaWNrIiwgZnVuY3Rpb24oZSkgew0KICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7DQogICAgICAgICAgICAgICAgdG9nZ2xlSWNvbigkbWVudSk7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgJCgnYm9keScpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIGlmKCRtZW51Lmhhc0NsYXNzKCdhY3RpdmUnKSkgew0KICAgICAgICAgICAgICAgICAgICB0b2dnbGVJY29uKCRtZW51KTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygiaW5pdGlhbGl6ZWQiKTsNCiAgICAgICAgfSk7DQogICAgfTsNCg0KICAgIHJldHVybiBhcGk7DQp9KGpRdWVyeSwgZG9jdW1lbnQpKTsNCg0KWEEucmVnaXN0ZXIoIm5hdmlnYXRpb24iLCBYQS5jb21wb25lbnQubmF2aWdhdGlvbik7DQpYQS5jb21wb25lbnQub3ZlcmxheSA9IGZ1bmN0aW9uICgkKSB7DQoNCiAgICB2YXIgYXBpID0ge30sDQogICAgICAgIGhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZiwNCiAgICAgICAgaG9zdCA9IGxvY2F0aW9uLmhvc3QsDQogICAgICAgIGxhYmVsLA0KICAgICAgICBvdmVybGF5UGxhY2Vob2xkZXIgPSBmYWxzZSwNCiAgICAgICAgbWFyZ2luVG9wID0gMTAwOw0KDQogICAgZnVuY3Rpb24gaXNQcmV2aWV3TW9kZSgpDQogICAgew0KICAgICAgICBpZiAoaHJlZi5pbmRleE9mKCJzY19tb2RlPXByZXZpZXciKSA+IC0xKQ0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQoNCiAgICAgICAgdmFyICRoZFBhZ2VNb2RlID0gJCgnI2hkUGFnZU1vZGUnKTsNCg0KICAgICAgICByZXR1cm4gJGhkUGFnZU1vZGUubGVuZ3RoID4gMCAmJiAkaGRQYWdlTW9kZS5hdHRyKCd2YWx1ZScpID09ICdwcmV2aWV3JzsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBpc0VkaXRNb2RlKCkgew0KICAgICAgICBpZiAoaHJlZi5pbmRleE9mKCJzY19tb2RlPWVkaXQiKSA+IC0xKQ0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQoNCiAgICAgICAgdmFyICRoZFBhZ2VNb2RlID0gJCgnI2hkUGFnZU1vZGUnKTsNCg0KICAgICAgICByZXR1cm4gJGhkUGFnZU1vZGUubGVuZ3RoID4gMCAmJiAkaGRQYWdlTW9kZS5hdHRyKCd2YWx1ZScpID09ICdlZGl0JzsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBpc092ZXJsYXlQYWdlKCkgew0KICAgICAgICByZXR1cm4gJCgnI3dyYXBwZXInKS5oYXNDbGFzcygnb3ZlcmxheS1wYWdlJyk7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gcmVzaXplT3ZlcmxheShpbm5lciwgY29udGVudCwgb3B0aW9ucykgew0KICAgICAgICB2YXIgdW5pdCA9ICJweCI7DQogICAgICAgIHZhciBjc3MgPSB7DQogICAgICAgICAgICAid2lkdGgiIDogIiIsDQogICAgICAgICAgICAiaGVpZ2h0IiA6ICIiDQogICAgICAgIH07DQogICAgICAgIHZhciB3aCA9ICQod2luZG93KS5oZWlnaHQoKTsNCg0KICAgICAgICBpZiAob3B0aW9ucy5wZXJjZW50KSB7DQogICAgICAgICAgICB1bml0ID0gIiUiOw0KICAgICAgICAgICAgaW5uZXIuYWRkQ2xhc3MoIm92ZXJsYXktcGVyY2VudCIpOw0KICAgICAgICAgICAgaWYoaXNFZGl0TW9kZSgpKXsNCiAgICAgICAgICAgICAgICBpbm5lci5hZGRDbGFzcygiZWRpdCIpDQogICAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBpbm5lci5yZW1vdmVDbGFzcygib3ZlcmxheS1wZXJjZW50Iik7DQogICAgICAgICAgICBpZihpc0VkaXRNb2RlKCkpew0KICAgICAgICAgICAgICAgIGlubmVyLnJlbW92ZUNsYXNzKCJlZGl0IikNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChvcHRpb25zLndpZHRoKSB7DQogICAgICAgICAgICBjc3NbIndpZHRoIl0gPSBvcHRpb25zLndpZHRoICsgdW5pdDsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3B0aW9ucy5oZWlnaHQpIHsNCiAgICAgICAgICAgIGNzc1siaGVpZ2h0Il0gPSBvcHRpb25zLmhlaWdodCArIHVuaXQ7DQogICAgICAgIH0NCg0KICAgICAgICBjc3NbIm1heC1oZWlnaHQiXSA9ICh3aCAtIG1hcmdpblRvcCAtIDAuMSAqIHdoKSArICJweCI7DQogICAgICAgIA0KICAgICAgICBjb250ZW50LmNzcyhjc3MpOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGdldFVybFZhcmlhYmxlcyh1cmwpIHsNCiAgICAgICAgdmFyIHEgPSB1cmwuc3BsaXQoJz8nKVsxXSwNCiAgICAgICAgICAgIHZhcnMgPSBbXSwNCiAgICAgICAgICAgIGhhc2g7DQoNCiAgICAgICAgaWYgKHEgIT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICBxID0gcS5zcGxpdCgnJicpOw0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgaGFzaCA9IHFbaV0uc3BsaXQoJz0nKTsNCiAgICAgICAgICAgICAgICB2YXJzLnB1c2goaGFzaFsxXSk7DQogICAgICAgICAgICAgICAgdmFyc1toYXNoWzBdXSA9IGhhc2hbMV07DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdmFyczsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBnZXRTaXplKHZhcnMpew0KICAgICAgICB2YXIgb2JqID0ge307DQoNCiAgICAgICAgaWYodmFyc1sid2lkdGgiXSAhPT0gbnVsbCkgew0KICAgICAgICAgICAgb2JqWyJ3aWR0aCJdID0gdmFyc1sid2lkdGgiXTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmKHZhcnNbImhlaWdodCJdICE9PSBudWxsKSB7DQogICAgICAgICAgICBvYmpbImhlaWdodCJdID0gdmFyc1siaGVpZ2h0Il07DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gb2JqOw0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGNoZWNrSW50ZXJuYWwodXJsKXsNCiAgICAgICAgaWYodXJsLmluZGV4T2YoaG9zdCkgPiAtMSl7DQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KDQogICAgZnVuY3Rpb24gIGNoZWNrSW1hZ2UodXJsKXsNCiAgICAgICAgdmFyIGV4dCA9IHVybC5zcGxpdCgiPyIpWzBdLnNwbGl0KCcuJykucG9wKCk7DQogICAgICAgIGlmICgkLmluQXJyYXkoZXh0LCBbJ2dpZicsICdwbmcnLCAnanBnJywgJ2pwZWcnXSkgPiAtMSkgew0KICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KDQoNCiAgICBmdW5jdGlvbiBsb2FkT3ZlcmxheSh1cmwsIG92ZXJsYXkpIHsNCiAgICAgICAgdmFyIGhvc3QgPSBsb2NhdGlvbi5ob3N0LA0KICAgICAgICAgICAgY29udGVudCA9IG92ZXJsYXkuZmluZCgiLm92ZXJsYXktaW5uZXIiKSwNCiAgICAgICAgICAgIG92ZXJsYXlDb250ZW50ID0gb3ZlcmxheS5maW5kKCIuY29tcG9uZW50LWNvbnRlbnQiKSwNCiAgICAgICAgICAgIHZhcnMgPSBnZXRVcmxWYXJpYWJsZXModXJsKSwNCiAgICAgICAgICAgIGludGVybmFsTGluayA9IGNoZWNrSW50ZXJuYWwodXJsKSwNCiAgICAgICAgICAgIG92ZXJsYXlTaXplID0gZ2V0U2l6ZSh2YXJzKSwNCiAgICAgICAgICAgIHN1ZmZpeDsNCg0KICAgICAgICBjb250ZW50LnJlbW92ZUF0dHIoJ3N0eWxlJyk7DQoNCiAgICAgICAgaWYoaW50ZXJuYWxMaW5rKXsNCiAgICAgICAgICAgIGlmIChjaGVja0ltYWdlKHVybCkpIHsNCiAgICAgICAgICAgICAgICBjb250ZW50LmVtcHR5KCkuYXBwZW5kKCQoIjxpbWc+IiwgeyBzcmM6IHVybCB9KSk7DQogICAgICAgICAgICAgICAgY29udGVudC5jc3Mob3ZlcmxheVNpemUpOw0KICAgICAgICAgICAgICAgIHNob3dPdmVybGF5KG92ZXJsYXkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAodXJsLmluZGV4T2YoIm92ZXJsYXl0eXBlPWlmcmFtZSIpID4gLTEpIHsNCiAgICAgICAgICAgICAgICBjb250ZW50LmVtcHR5KCkuYXBwZW5kKCQoIjxpZnJhbWU+IiwgeyBzcmM6IHVybCwgc3R5bGU6ICJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlIiB9KSk7DQogICAgICAgICAgICAgICAgY29udGVudC5jc3Mob3ZlcmxheVNpemUpOw0KICAgICAgICAgICAgICAgIHNob3dPdmVybGF5KG92ZXJsYXkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgc3VmZml4ID0gInNjX2RldmljZT1vdmVybGF5IjsNCiAgICAgICAgICAgICAgICB1cmwgKz0gKHVybC5pbmRleE9mKCI/IikgPT0gLTEgPyAiPyIgOiAiJiIpICsgc3VmZml4Ow0KDQogICAgICAgICAgICAgICAgaWYgKGlzUHJldmlld01vZGUoKSkgew0KICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSAiY2Zfb3ZlcmxheT0xIjsNCiAgICAgICAgICAgICAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UoInNpdGVjb3JlL3NoZWxsLyIpOw0KICAgICAgICAgICAgICAgICAgICB1cmwgKz0gKHVybC5pbmRleE9mKCI/IikgPT0gLTEgPyAiPyIgOiAiJiIpICsgc3VmZml4DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgJC5nZXQodXJsLCBmdW5jdGlvbihkYXRhKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciBvdmVybGF5RGF0YSA9ICQoZGF0YSkuYmVmb3JlKCkuZmlyc3QoKTsNCg0KICAgICAgICAgICAgICAgICAgICByZXNpemVPdmVybGF5KGNvbnRlbnQsIG92ZXJsYXlDb250ZW50LCB7DQogICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogb3ZlcmxheURhdGEuYXR0cigiZGF0YS13aWR0aCIpLA0KICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBvdmVybGF5RGF0YS5kYXRhKCJoZWlnaHQiKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIHBlcmNlbnQ6IG92ZXJsYXlEYXRhLmRhdGEoInBlcmNlbnQiKQ0KICAgICAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgICAgICBjb250ZW50LmVtcHR5KCkuYXBwZW5kKGRhdGEpOw0KICAgICAgICAgICAgICAgICAgICBYQS5pbml0KCk7DQogICAgICAgICAgICAgICAgICAgIHNob3dPdmVybGF5KG92ZXJsYXkpOw0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgaWYoY2hlY2tJbWFnZSh1cmwpKSB7DQogICAgICAgICAgICAgICAgY29udGVudC5lbXB0eSgpLmFwcGVuZCgkKCI8aW1nPiIsIHsgc3JjOiB1cmwgfSkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgY29udGVudC5lbXB0eSgpLmFwcGVuZCgkKCI8aWZyYW1lID4iLCB7IHNyYzogdXJsLCBzdHlsZTogIndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCUiIH0pKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNvbnRlbnQuY3NzKG92ZXJsYXlTaXplKTsNCiAgICAgICAgICAgIHNob3dPdmVybGF5KG92ZXJsYXkpOw0KICAgICAgICB9DQoNCiAgICB9Ow0KDQogICAgZnVuY3Rpb24gcHJlU2hvd092ZXJsYXkob3ZlcmxheSwgb3ZlcmxheUNvbnRlbnQpIHsNCiAgICAgICAgb3ZlcmxheS5jc3Moew0KICAgICAgICAgICAgIm9wYWNpdHkiOiAxDQogICAgICAgIH0pLnNob3coKTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBzaG93T3ZlcmxheShvdmVybGF5KSB7DQogICAgICAgIHZhciBpLHEsbGlua3MsY2xvc2UsY29udGVudDsNCiAgICAgICAgb3ZlcmxheS5zaG93KCkuYW5pbWF0ZSh7DQogICAgICAgICAgICBvcGFjaXR5OiAxDQogICAgICAgIH0pOw0KDQogICAgICAgIGNsb3NlID0gb3ZlcmxheS5maW5kKCIub3ZlcmxheS1jbG9zZS1saW5rIik7DQogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtjbG9zZS5mb2N1cygpO30sMCk7DQogICAgICAgIGxpbmtzID0gb3ZlcmxheS5maW5kKCJhOm5vdCgub3ZlcmxheS1jbG9zZS1saW5rKSIpOw0KICAgICAgICBpID0gMjsNCiAgICAgICAgZm9yKHE9MDtxPGxpbmtzLmxlbmd0aDtxKyspew0KICAgICAgICAgICAgJChsaW5rc1txXSkuYXR0cigidGFiSW5kZXgiLGkrKyk7DQogICAgICAgIH0NCiAgICAgICAgY29udGVudCA9IG92ZXJsYXkuZmluZCgiLm92ZXJsYXktaW5uZXIiKTsNCiAgICAgICAgY29udGVudC5hdHRyKCJ0YWJJbmRleCIsaSk7DQogICAgICAgIGNvbnRlbnQuYmx1cihmdW5jdGlvbihhcmdzKXsNCiAgICAgICAgICAgIGFyZ3MucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgIGFyZ3Muc3RvcFByb3BhZ2F0aW9uKCk7DQogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7Y2xvc2UuZm9jdXMoKX0sMCk7DQogICAgICAgIH0pOw0KDQogICAgICAgIENvZ25pZmlkZS5UcmFja2luZy50cmFjaygNCiAgICAgICAgICAgIENvZ25pZmlkZS5Eb21haW4uVHJhY2tpbmdUeXBlcygpLmV2ZW50LA0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgIGNhdGVnb3J5OiAiT3ZlcmxheSIsDQogICAgICAgICAgICAgICAgZXZlbnQ6ICJvcGVuIiwNCiAgICAgICAgICAgICAgICBsYWJlbDogbGFiZWwsDQogICAgICAgICAgICAgICAgZGF0YTogMA0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICJzeW5jIg0KICAgICAgICApOw0KICAgICAgICByZXR1cm4gb3ZlcmxheTsNCiAgICB9Ow0KDQogICAgZnVuY3Rpb24gaGlkZU92ZXJsYXkob3ZlcmxheSkgew0KICAgICAgICB2YXIgY29udGVudCA9IG92ZXJsYXkuZmluZCgiLm92ZXJsYXktaW5uZXIiKTsNCg0KICAgICAgICBvdmVybGF5LmFuaW1hdGUoDQogICAgICAgICAgICB7IG9wYWNpdHk6IDAgfSwNCiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICBvdmVybGF5LmhpZGUoKTsNCiAgICAgICAgICAgICAgICBjb250ZW50LmVtcHR5KCk7DQoNCiAgICAgICAgICAgICAgICBpZiAobWVqcykgew0KICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBwIGluIG1lanMucGxheWVycykgew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQoIiMiICsgbWVqcy5wbGF5ZXJzW3BdLmlkKS5wYXJlbnRzKCIub3ZlcmxheSIpLmxlbmd0aCA9PSAxKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiIyIgKyBtZWpzLnBsYXllcnNbcF0uaWQgKyAnIHZpZGVvJykuYXR0cignc3JjJywgJycpOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lanMucGxheWVyc1twXS5yZW1vdmUoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWpzLnBsYXllcnMuc3BsaWNlKHAsIDEpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICApOw0KDQogICAgICAgIENvZ25pZmlkZS5UcmFja2luZy50cmFjaygNCiAgICAgICAgICAgIENvZ25pZmlkZS5Eb21haW4uVHJhY2tpbmdUeXBlcygpLmV2ZW50LA0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgIGNhdGVnb3J5OiAiT3ZlcmxheSIsDQogICAgICAgICAgICAgICAgZXZlbnQ6ICJjbG9zZSIsDQogICAgICAgICAgICAgICAgbGFiZWw6IGxhYmVsLA0KICAgICAgICAgICAgICAgIGRhdGE6IDANCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICAic3luYyINCiAgICAgICAgKTsNCiAgICAgICAgcmV0dXJuIG92ZXJsYXk7DQogICAgfTsNCg0KICAgIGZ1bmN0aW9uIGNyZWF0ZU92ZXJsYXkoKSB7DQogICAgICAgIHZhciBvdmVybGF5ID0gIjxkaXYgY2xhc3M9J292ZXJsYXktd3JhcHBlcic+IiArDQogICAgICAgICAgICAgICAgICAgICAgICAiPGRpdiBjbGFzcz0nb3ZlcmxheSBjb21wb25lbnQnPiIgKw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICI8ZGl2IGNsYXNzPSdjb21wb25lbnQtY29udGVudCc+IiArDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICI8ZGl2IGNsYXNzPSdvdmVybGF5LWNsb3NlJz48YSB0YWJJbmRleD0nMScgY2xhc3M9J292ZXJsYXktY2xvc2UtbGluaycgaHJlZj0nIyc+w5c8L2E+PC9kaXY+IiArDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICI8ZGl2IGNsYXNzPSdvdmVybGF5LWlubmVyJyB0YWJJbmRleD0nMic+PC9kaXY+IiArDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIjwvZGl2PiIgKw0KICAgICAgICAgICAgICAgICAgICAgICAgICI8L2Rpdj4iKw0KICAgICAgICAgICAgICAgICAgICAgICAgIjwvZGl2PiI7DQoNCiAgICAgICAgJCgiYm9keSIpLmFwcGVuZChvdmVybGF5KTsNCiAgICB9DQoNCiAgICBhcGkuaW5pdCA9IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgaWYoIW92ZXJsYXlQbGFjZWhvbGRlcil7DQogICAgICAgICAgICBjcmVhdGVPdmVybGF5KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoaXNPdmVybGF5UGFnZSgpKSB7DQogICAgICAgICAgICB2YXIgcGFnZSA9ICQoIi5vdmVybGF5LXBhZ2UiKSwNCiAgICAgICAgICAgICAgICBvdmVybGF5ID0gJCgiI3Nwbk92ZXJsYXkiKSwNCiAgICAgICAgICAgICAgICBvdmVybGF5Q29udGVudCA9IHBhZ2UuY2hpbGRyZW4oIi5jb21wb25lbnQtY29udGVudCIpLA0KICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBvdmVybGF5Q29udGVudC5jaGlsZHJlbigiLm92ZXJsYXktaW5uZXIiKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcmVzaXplT3ZlcmxheShjb250ZW50LCBvdmVybGF5Q29udGVudCwgew0KICAgICAgICAgICAgICAgIHdpZHRoOiBvdmVybGF5LmRhdGEoIndpZHRoIiksDQogICAgICAgICAgICAgICAgaGVpZ2h0OiBvdmVybGF5LmRhdGEoImhlaWdodCIpLA0KICAgICAgICAgICAgICAgIHBlcmNlbnQ6IG92ZXJsYXkuZGF0YSgicGVyY2VudCIpDQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIG92ZXJsYXlDb250ZW50Lm9uKCJjbGljayIsIGZ1bmN0aW9uKGV2ZW50KXsNCiAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIHBhZ2Uub24oImNsaWNrIiwgZnVuY3Rpb24gKGV2ZW50KSB7DQogICAgICAgICAgICAgICAgaWYgKGlzUHJldmlld01vZGUoKSkgew0KICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgic2NfbW9kZT1wcmV2aWV3Iiwic2NfbW9kZT1lZGl0IikNCiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgIA0KICAgICAgICAgICAgfSk7ICAgICANCiAgICAgICAgfQ0KDQogICAgICAgIHZhciBvdmVybGF5ID0gJCgiLm92ZXJsYXktd3JhcHBlciA+IC5vdmVybGF5IiksDQogICAgICAgICAgICBvdmVybGF5Q29udGVudCA9IG92ZXJsYXkuZmluZCgiLmNvbXBvbmVudC1jb250ZW50IiksDQogICAgICAgICAgICBvdmVybGF5Q2xvc2UgPSBvdmVybGF5LmZpbmQoIi5vdmVybGF5LWNsb3NlIiksDQogICAgICAgICAgICBvdmVybGF5U291cmNlID0gJCgiLm92ZXJsYXktc291cmNlIGE6bm90KC5pbml0aWFsaXplZCksIGEub3ZlcmxheS1zb3VyY2U6bm90KC5pbml0aWFsaXplZCkiKSwNCiAgICAgICAgICAgIG92ZXJsYXlJbm5lciA9ICQoIi5vdmVybGF5LWlubmVyIiksDQogICAgICAgICAgICBvdmVybGF5Q2xvc2VMaW5rID0gb3ZlcmxheS5maW5kKCIub3ZlcmxheS1jbG9zZS1saW5rIiksDQogICAgICAgICAgICBjbG9zZUFjdGlvbiwNCiAgICAgICAgICAgIG92ZXJsYXlDbGlja1NvdXJjZTsNCg0KICAgICAgICBjbG9zZUFjdGlvbiA9IGZ1bmN0aW9uKCl7DQogICAgICAgICAgICBoaWRlT3ZlcmxheShvdmVybGF5KTsNCiAgICAgICAgICAgIG92ZXJsYXlJbm5lci5vZmYoImJsdXIiKTsNCiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICBpZihvdmVybGF5Q2xpY2tTb3VyY2UgIT0gbnVsbCl7DQogICAgICAgICAgICAgICAgICAgIG92ZXJsYXlDbGlja1NvdXJjZS5mb2N1cygpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0sMCk7DQogICAgICAgIH07DQoNCiAgICAgICAgaWYoIW92ZXJsYXlQbGFjZWhvbGRlcil7DQogICAgICAgICAgICBvdmVybGF5Q29udGVudC5vbigiY2xpY2siLCBmdW5jdGlvbihldmVudCl7DQogICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgb3ZlcmxheS5vbigiY2xpY2siLCBmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgICBjbG9zZUFjdGlvbigpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgICQoImJvZHkiKS5rZXl1cChmdW5jdGlvbihhcmdzKXsNCiAgICAgICAgICAgICAgICBhcmdzLnN0b3BQcm9wYWdhdGlvbigpOw0KICAgICAgICAgICAgICAgIGlmKGFyZ3Mud2hpY2ggPT0gMjcpew0KICAgICAgICAgICAgICAgICAgICBjbG9zZUFjdGlvbigpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBvdmVybGF5Q2xvc2VMaW5rLm9uKCJjbGljayIsIGZ1bmN0aW9uKGFyZ3Mpew0KICAgICAgICAgICAgICAgIGFyZ3MucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgICAgICBjbG9zZUFjdGlvbigpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJyZXNpemUiLCBmdW5jdGlvbigpew0KICAgICAgICAgICAgICAgIHZhciBoZWlnaHQgPSAkKHdpbmRvdykuaGVpZ2h0KCk7DQogICAgICAgICAgICAgICAgaGVpZ2h0ID0gaGVpZ2h0IC0gbWFyZ2luVG9wIC0gMC4xICogaGVpZ2h0Ow0KICAgICAgICAgICAgICAgIG92ZXJsYXlDb250ZW50LmNzcygibWF4LWhlaWdodCIsIGhlaWdodCArICJweCIpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIG92ZXJsYXlQbGFjZWhvbGRlciA9IHRydWU7DQogICAgICAgIH0NCg0KDQogICAgICAgIG92ZXJsYXlTb3VyY2UuZWFjaChmdW5jdGlvbigpew0KICAgICAgICAgICAgaWYgKGlzRWRpdE1vZGUoKSkgew0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgJCh0aGlzKS5vbigiY2xpY2siLCBmdW5jdGlvbiAoZXZlbnQpIHsNCiAgICAgICAgICAgICAgICBvdmVybGF5Q2xpY2tTb3VyY2UgPSBldmVudC5jdXJyZW50VGFyZ2V0Ow0KICAgICAgICAgICAgICAgIGlmICghaXNFZGl0TW9kZSgpKSB7DQogICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgICAgICAgICAgICAgIHByZVNob3dPdmVybGF5KG92ZXJsYXksIG92ZXJsYXlDb250ZW50KTsNCg0KICAgICAgICAgICAgICAgICAgICB2YXIgdXJpID0gdGhpcy5ocmVmOw0KICAgICAgICAgICAgICAgICAgICBsb2FkT3ZlcmxheSh1cmksIG92ZXJsYXkpOw0KDQogICAgICAgICAgICAgICAgICAgIHZhciBocmVmID0gdGhpcy5ocmVmLnNwbGl0KCcvJyk7DQogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IGhyZWYubGVuZ3RoOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsID0gaHJlZi5wb3AoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsYWJlbC5sZW5ndGggPT0gMCkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgICQodGhpcykuZm9jdXMoZnVuY3Rpb24oYXJncyl7DQogICAgICAgICAgICAgICAgYXJncy5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICAgICAgICAgIGlmKGFyZ3MuY3VycmVudFRhcmdldCA9PT0gb3ZlcmxheUNsaWNrU291cmNlKXsNCiAgICAgICAgICAgICAgICAgICAgb3ZlcmxheUNsaWNrU291cmNlID0gbnVsbDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygiaW5pdGlhbGl6ZWQiKTsNCiAgICAgICAgfSk7DQoNCg0KICAgIH07DQoNCiAgICByZXR1cm4gYXBpOw0KDQp9IChqUXVlcnkpOw0KDQpYQS5yZWdpc3Rlcigib3ZlcmxheSIsIFhBLmNvbXBvbmVudC5vdmVybGF5KTsNCg0KDQogICAgDQoNClhBLmNvbXBvbmVudC5wYWdlTGlzdCA9IChmdW5jdGlvbiAoJCwgZG9jdW1lbnQpIHsNCiAgICB2YXIgYXBpID0ge307DQoNCiAgICBhcGkuaW5pdCA9IGZ1bmN0aW9uICgpIHsNCg0KICAgICAgICAvL21ha2UgY2Fyb3VzZWwgZnJvbSBwYWdlLWxpc3QgY29tcG9uZW50DQoNCiAgICAgICAgJCgnLnBhZ2UtbGlzdC1jYXJvdXNlbCcpLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmFyICRwYWdlTGlzdCA9ICQodGhpcyksDQogICAgICAgICAgICAgICAgJGl0ZW1zID0gJHBhZ2VMaXN0LmZpbmQoJy5pdGVtJyksDQogICAgICAgICAgICAgICAgJGZpcnN0ID0gJGl0ZW1zLmZpcnN0KCkuYWRkQ2xhc3MoJ2ZpcnN0JyksDQogICAgICAgICAgICAgICAgJGxhc3QgPSAkaXRlbXMubGFzdCgpLmFkZENsYXNzKCdsYXN0JyksDQogICAgICAgICAgICAgICAgJGN1cnJlbnQgPSAkZmlyc3QuYWRkQ2xhc3MoJ2FjdGl2ZScpOw0KDQogICAgICAgICAgICBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgJGN1cnJlbnQucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgICAgICRjdXJyZW50ID0gJGN1cnJlbnQuaGFzQ2xhc3MoJ2xhc3QnKSA/ICRmaXJzdCA6ICRjdXJyZW50Lm5leHQoKTsNCiAgICAgICAgICAgICAgICAkY3VycmVudC5hZGRDbGFzcygnYWN0aXZlJyk7DQogICAgICAgICAgICB9LCAyMDAwKTsNCg0KICAgICAgICAgICAgJHBhZ2VMaXN0LmFkZENsYXNzKCdpbml0aWFsaXplZCcpOw0KICAgICAgICB9KTsNCg0KDQoNCiAgICAgICAgLy9tYWtlIGNhcm91c2VsIGZyb20gc3VtbWFyeSBjb21wb25lbnQNCg0KICAgICAgICAkKCcuc3VtbWFyeS1jYXJvdXNlbCcpLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmFyICRwYWdlTGlzdCA9ICQodGhpcyksDQogICAgICAgICAgICAgICAgJGl0ZW1zID0gJHBhZ2VMaXN0LmZpbmQoJy5zbGlkZScpLA0KICAgICAgICAgICAgICAgIGN1cnJlbnQsDQogICAgICAgICAgICAgICAgbGFzdCwNCiAgICAgICAgICAgICAgICBzbGlkZXMgPSBbXTsNCg0KICAgICAgICAgICAgY3VycmVudCA9ICRpdGVtcy5maXJzdCgpLmFkZENsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgIGxhc3QgPSAkaXRlbXMubGFzdCgpLmFkZENsYXNzKCdsYXN0Jyk7DQoNCg0KICAgICAgICAgICAgXy5lYWNoKCRpdGVtcywgZnVuY3Rpb24gKGl0ZW0pIHsNCiAgICAgICAgICAgICAgICBzbGlkZXMucHVzaChpdGVtKQ0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAkLmVhY2goc2xpZGVzLCBmdW5jdGlvbiAoa2V5LCBzbGlkZSkgew0KICAgICAgICAgICAgICAgICAgICB2YXIgZmlyc3QgPSAkKHNsaWRlKS5wYXJlbnQoKS5jaGlsZHJlbignLnNsaWRlOmZpcnN0Jyk7DQogICAgICAgICAgICAgICAgICAgIGlmICgkKHNsaWRlKS5oYXNDbGFzcygnYWN0aXZlJykpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICQoc2xpZGUpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSAkKHNsaWRlKS5oYXNDbGFzcygnbGFzdCcpID8gZmlyc3QgOiAkKHNsaWRlKS5uZXh0KCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgIGN1cnJlbnQuYWRkQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgfSwgMjAwMCk7DQoNCiAgICAgICAgICAgICRwYWdlTGlzdC5hZGRDbGFzcygnaW5pdGlhbGl6ZWQnKTsNCiAgICAgICAgfSk7DQogICAgfTsNCg0KICAgIHJldHVybiBhcGk7DQp9KGpRdWVyeSwgZG9jdW1lbnQpKTsNCg0KWEEucmVnaXN0ZXIoInBhZ2VMaXN0IiwgWEEuY29tcG9uZW50LnBhZ2VMaXN0KTsNCg0KWEEuY29tcG9uZW50LnByb21vID0gKGZ1bmN0aW9uICgkLCBkb2N1bWVudCkgew0KICAgIHZhciBhcGkgPSB7fTsNCg0KICAgIGZ1bmN0aW9uIG1ha2VIZXJvQmFja2dyb3VuZChpdGVtKSB7DQogICAgICAgIHZhciBiYWNrZ3JvdW5kSWNvbiA9ICQoaXRlbSkuZmluZCgnLmZpZWxkLXByb21vaWNvbicpLA0KICAgICAgICAgICAgYmFja2dyb3VuZCA9ICQoaXRlbSkuZmluZCgnaW1nJyksDQogICAgICAgICAgICBiYWNrZ3JvdW5kU3JjID0gYmFja2dyb3VuZC5hdHRyKCdzcmMnKSwNCiAgICAgICAgICAgIGltYWdlSGVpZ2h0ID0gYmFja2dyb3VuZC5hdHRyKCdoZWlnaHQnKTsNCg0KDQogICAgICAgIGlmIChiYWNrZ3JvdW5kU3JjKSB7DQoNCiAgICAgICAgICAgIGJhY2tncm91bmRJY29uLmNzcyh7DQogICAgICAgICAgICAgICAgJ3dpZHRoJzogIjEwMCUiLA0KICAgICAgICAgICAgICAgICdoZWlnaHQnOiBpbWFnZUhlaWdodCwNCiAgICAgICAgICAgICAgICAnYmFja2dyb3VuZCc6ICd1cmwoJyArIGJhY2tncm91bmRTcmMgKyAnKScsDQogICAgICAgICAgICAgICAgJ2JhY2tncm91bmQtc2l6ZSc6ICdjb3ZlcicsDQogICAgICAgICAgICAgICAgJ2JhY2tncm91bmQtcmVwZWF0JzogJ25vLXJlcGVhdCcsDQogICAgICAgICAgICAgICAgJ2JhY2tncm91bmQtcG9zaXRpb24nOiAnNTAlIDUwJScNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBiYWNrZ3JvdW5kLmhpZGUoKTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGFwaS5pbml0ID0gZnVuY3Rpb24gKCkgew0KICAgICAgICB2YXIgcHJvbW9IZXJvID0gJCgnLnByb21vLWhlcm86bm90KC5pbml0aWFsaXplZCknKTsNCg0KICAgICAgICBfLmVhY2gocHJvbW9IZXJvLCBmdW5jdGlvbiAoaXRlbSkgew0KICAgICAgICAgICAgbWFrZUhlcm9CYWNrZ3JvdW5kKGl0ZW0pOw0KDQogICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCdpbml0aWFsaXplZCcpOw0KICAgICAgICB9KTsNCg0KICAgIH07DQoNCiAgICByZXR1cm4gYXBpOw0KfShqUXVlcnksIGRvY3VtZW50KSk7DQoNClhBLnJlZ2lzdGVyKCJwcm9tbyIsIFhBLmNvbXBvbmVudC5wcm9tbyk7DQoNCihmdW5jdGlvbigkKSB7DQogICAgJC5mbi5zY3JvbGxMaXN0ID0gZnVuY3Rpb24ocHJvcGVydGllcykgew0KDQogICAgICAgIGZ1bmN0aW9uIFNjcm9sbExpc3QoZWxlbSkgew0KICAgICAgICAgICAgdGhpcy5wcm9wZXJ0aWVzID0gew0KICAgICAgICAgICAgICAgICJlbGVtIjogZWxlbSwNCiAgICAgICAgICAgICAgICAidmlzaWJsZUl0ZW1zIjogMiwNCiAgICAgICAgICAgICAgICAiYXV0b3BsYXkiOiBmYWxzZSwNCiAgICAgICAgICAgICAgICAiYXV0b3BsYXlEZWxheSI6IDMwMDAsDQogICAgICAgICAgICAgICAgInRyYW5zaXRpb25UaW1lIjogMTAwMCwNCiAgICAgICAgICAgICAgICAiaG9yaXpvbnRhbCI6IHRydWUsDQogICAgICAgICAgICAgICAgImNpcmN1bGFyIjogZmFsc2UsDQogICAgICAgICAgICAgICAgImhlaWdodCI6IDMwMCwNCiAgICAgICAgICAgICAgICAic3RlcCI6IDEsDQogICAgICAgICAgICAgICAgIm1vYmlsZSI6IFtdLA0KICAgICAgICAgICAgICAgIG9uU2xpZGVDaGFuZ2VkOiBmdW5jdGlvbigpIHsNCg0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIFNjcm9sbExpc3QucHJvdG90eXBlLmdldFByb3BlcnRpZXMgPSBmdW5jdGlvbihwcm9wZXJ0aWVzKSB7DQogICAgICAgICAgICBpZiAoIXByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoImhlaWdodCIpKSB7DQogICAgICAgICAgICAgICAgcHJvcGVydGllcy5oZWlnaHQgPSAkKHRoaXMucHJvcGVydGllcy5lbGVtKS5oZWlnaHQoKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMuYXV0b3BsYXlEZWxheSA8IHByb3BlcnRpZXMudHJhbnNpdGlvblRpbWUpIHsNCiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzLnRyYW5zaXRpb25UaW1lID0gcHJvcGVydGllcy5hdXRvcGxheURlbGF5Ow0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAkLmV4dGVuZCh0aGlzLnByb3BlcnRpZXMsIHByb3BlcnRpZXMpOw0KICAgICAgICAgICAgLy9hZGQgcHJvcGVydHkgdG8gcmVtZW1iZXIgZGVmYXVsdCB2aXNpYmxlIGl0ZW1zIG51bWJlcg0KICAgICAgICAgICAgdGhpcy5wcm9wZXJ0aWVzLnZpc2libGVJdGVtc0RlZmF1bHQgPSB0aGlzLnByb3BlcnRpZXMudmlzaWJsZUl0ZW1zOw0KICAgICAgICB9DQoNCiAgICAgICAgU2Nyb2xsTGlzdC5wcm90b3R5cGUuY3JlYXRlTmF2aWdhdGlvbiA9IGZ1bmN0aW9uKHdyYXBwZXIpIHsNCiAgICAgICAgICAgIHdyYXBwZXIuYWZ0ZXIoIjxkaXYgY2xhc3M9J25hdic+IiArDQogICAgICAgICAgICAiPGRpdiBjbGFzcz0ncHJldic+PGEgaHJlZj0nIyc+cHJldjwvYT48L2Rpdj4iICsNCiAgICAgICAgICAgICI8ZGl2IGNsYXNzPSduZXh0Jz48YSBocmVmPScjJz5uZXh0PC9hPjwvZGl2PiIgKw0KICAgICAgICAgICAgIjwvZGl2PiIpOw0KICAgICAgICB9DQoNCiAgICAgICAgU2Nyb2xsTGlzdC5wcm90b3R5cGUuYXV0b3BsYXkgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciBpbnN0ID0gdGhpcywNCiAgICAgICAgICAgICAgICBzY3JvbGxMaXN0ID0gJCh0aGlzLnByb3BlcnRpZXMuZWxlbSk7DQoNCiAgICAgICAgICAgIGlmICgoaW5zdC5wcm9wZXJ0aWVzLmF1dG9wbGF5KSAmJiAoaW5zdC5wcm9wZXJ0aWVzLmNpcmN1bGFyKSkgew0KICAgICAgICAgICAgICAgIHZhciBkZWxheVRpbWUgPSB0aGlzLnByb3BlcnRpZXMuYXV0b3BsYXlEZWxheSwNCiAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWwgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbExpc3QuZmluZCgiLm5hdiAubmV4dCIpLnRyaWdnZXIoImNsaWNrIik7DQogICAgICAgICAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgICAgICBpbnN0LnByb3BlcnRpZXMuaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKGludGVydmFsLCBkZWxheVRpbWUpOw0KICAgICAgICAgICAgICAgIHNjcm9sbExpc3QuaG92ZXIoDQogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnN0LnByb3BlcnRpZXMuaW50ZXJ2YWxJZCk7DQogICAgICAgICAgICAgICAgICAgIH0sDQogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaW5zdC5wcm9wZXJ0aWVzLmludGVydmFsSWQgPSBzZXRJbnRlcnZhbChpbnRlcnZhbCwgZGVsYXlUaW1lKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICk7DQoNCiAgICAgICAgICAgICAgICAkKHdpbmRvdykucmVzaXplKGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGluc3QucHJvcGVydGllcy5pbnRlcnZhbElkKTsNCiAgICAgICAgICAgICAgICAgICAgaW5zdC5wcm9wZXJ0aWVzLmludGVydmFsSWQgPSBzZXRJbnRlcnZhbChpbnRlcnZhbCwgZGVsYXlUaW1lKTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQoNCiAgICAgICAgU2Nyb2xsTGlzdC5wcm90b3R5cGUucmVwbGFjZU1vYmlsZVByb3BlcnRpZXMgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciBpbnN0ID0gdGhpcywNCiAgICAgICAgICAgICAgICBjb21wb25lbnRXaWR0aCA9ICQoaW5zdC5wcm9wZXJ0aWVzLmVsZW0pLndpZHRoKCksDQogICAgICAgICAgICAgICAgdmlzaWJsZUl0ZW1zQ2hhbmdlZCA9IGZhbHNlOw0KDQoNCiAgICAgICAgICAgIGlmIChpbnN0LnByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoIm1vYmlsZSIpKSB7DQogICAgICAgICAgICAgICAgJC5lYWNoKGluc3QucHJvcGVydGllcy5tb2JpbGUsIGZ1bmN0aW9uKGksIGl0ZW0pIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKChjb21wb25lbnRXaWR0aCA+IGl0ZW0ubWluV2lkdGgpICYmIChjb21wb25lbnRXaWR0aCA8IGl0ZW0ubWF4V2lkdGgpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnByb3BlcnRpZXMudmlzaWJsZUl0ZW1zID0gaXRlbS52aXNpYmxlSXRlbXM7DQogICAgICAgICAgICAgICAgICAgICAgICB2aXNpYmxlSXRlbXNDaGFuZ2VkID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAgICAgaWYgKCF2aXNpYmxlSXRlbXNDaGFuZ2VkKSB7DQogICAgICAgICAgICAgICAgICAgIGluc3QucHJvcGVydGllcy52aXNpYmxlSXRlbXMgPSBpbnN0LnByb3BlcnRpZXMudmlzaWJsZUl0ZW1zRGVmYXVsdDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBTY3JvbGxMaXN0LnByb3RvdHlwZS5hbmltYXRlID0gZnVuY3Rpb24oKSB7DQoNCiAgICAgICAgfQ0KDQogICAgICAgIFNjcm9sbExpc3QucHJvdG90eXBlLmhvcml6b250YWxFdmVudHMgPSBmdW5jdGlvbih3cmFwcGVyLCBzY3JvbGxJdGVtcywgc2Nyb2xsU2l6ZSkgew0KICAgICAgICAgICAgdmFyIGluc3QgPSB0aGlzLA0KICAgICAgICAgICAgICAgIGxlZnQgPSAwLA0KICAgICAgICAgICAgICAgIGl0ZW1zTGVuZ3RoID0gc2Nyb2xsSXRlbXMuY2hpbGRyZW4oImxpIikubGVuZ3RoLA0KICAgICAgICAgICAgICAgIHRyYW5zaXRpb25UaW1lID0gaW5zdC5wcm9wZXJ0aWVzLnRyYW5zaXRpb25UaW1lOw0KDQogICAgICAgICAgICBzY3JvbGxJdGVtcy5jc3Moew0KICAgICAgICAgICAgICAgIGxlZnQ6IDANCiAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgaWYgKCFpbnN0LnByb3BlcnRpZXMuY2lyY3VsYXIpIHsNCiAgICAgICAgICAgICAgICB3cmFwcGVyLm5leHQoKS5maW5kKCIucHJldiIpLmFkZENsYXNzKCJoaWRlIik7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHdyYXBwZXIudW5iaW5kKCJ0b3VjaHN0YXJ0Iik7DQogICAgICAgICAgICB3cmFwcGVyLm9uKCJ0b3VjaHN0YXJ0IiwgZnVuY3Rpb24oZSkgew0KICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGluc3QucHJvcGVydGllcy5pbnRlcnZhbElkKTsNCiAgICAgICAgICAgICAgICB2YXIgcG9zWCA9IGUub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWDsNCg0KICAgICAgICAgICAgICAgICQodGhpcykudW5iaW5kKCJ0b3VjaGVuZCIpOw0KICAgICAgICAgICAgICAgICQodGhpcykub24oInRvdWNoZW5kIiwgZnVuY3Rpb24oZXYpIHsNCiAgICAgICAgICAgICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgICAgICAgICAgdmFyIHBvc1hFbmQgPSBldi5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYOw0KICAgICAgICAgICAgICAgICAgICBpZiAoKHBvc1ggLSBwb3NYRW5kKSA+IDEwMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgd3JhcHBlci5uZXh0KCkuZmluZCgiLm5leHQiKS50cmlnZ2VyKCJjbGljayIpOw0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChwb3NYIC0gcG9zWEVuZCkgPCAtMTAwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICB3cmFwcGVyLm5leHQoKS5maW5kKCIucHJldiIpLnRyaWdnZXIoImNsaWNrIik7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICB3cmFwcGVyLm5leHQoKS5maW5kKCIubmV4dCBhLC5wcmV2IGEiKS5vbigiY2xpY2siLCBmdW5jdGlvbihlKSB7DQogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIHdyYXBwZXIubmV4dCgpLmZpbmQoIi5uZXh0IikudW5iaW5kKCJjbGljayIpOw0KICAgICAgICAgICAgd3JhcHBlci5uZXh0KCkuZmluZCgiLm5leHQiKS5vbigiY2xpY2siLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsUG9zaXRpb24xID0gbGVmdCwNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsUG9zaXRpb24yID0gLWl0ZW1zTGVuZ3RoICogc2Nyb2xsU2l6ZSAvIGluc3QucHJvcGVydGllcy5zdGVwICsgaW5zdC5wcm9wZXJ0aWVzLnZpc2libGVJdGVtcyAqIHNjcm9sbFNpemUgLyBpbnN0LnByb3BlcnRpZXMuc3RlcDsNCg0KICAgICAgICAgICAgICAgIGlmIChNYXRoLnJvdW5kKHNjcm9sbFBvc2l0aW9uMSkgPiBNYXRoLnJvdW5kKHNjcm9sbFBvc2l0aW9uMikpIHsNCiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IGxlZnQgLSBzY3JvbGxTaXplOw0KDQogICAgICAgICAgICAgICAgICAgIHNjcm9sbEl0ZW1zLnN0b3AoKS5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IGxlZnQNCiAgICAgICAgICAgICAgICAgICAgfSwgdHJhbnNpdGlvblRpbWUsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaW5zdC5wcm9wZXJ0aWVzLm9uU2xpZGVDaGFuZ2VkLmNhbGwoaW5zdCk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAgICAgICAgIGlmIChsZWZ0IDw9IHNjcm9sbFBvc2l0aW9uMikgew0KICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygiaGlkZSIpOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5maW5kKCIucHJldiIpLnJlbW92ZUNsYXNzKCJoaWRlIik7DQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0LnByb3BlcnRpZXMuY2lyY3VsYXIpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1Ub1JlbW92ZSA9IHNjcm9sbEl0ZW1zLmNoaWxkcmVuKCJsaSIpLmZpcnN0KCk7DQogICAgICAgICAgICAgICAgICAgIHNjcm9sbEl0ZW1zLmNoaWxkcmVuKCJsaSIpLmZpcnN0KCkucmVtb3ZlKCk7DQogICAgICAgICAgICAgICAgICAgIHNjcm9sbEl0ZW1zLmFwcGVuZChpdGVtVG9SZW1vdmUpOw0KDQogICAgICAgICAgICAgICAgICAgIHNjcm9sbEl0ZW1zLmNzcyh7DQogICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiBsZWZ0ICsgc2Nyb2xsU2l6ZQ0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsSXRlbXMuc3RvcCgpLmFuaW1hdGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogbGVmdA0KICAgICAgICAgICAgICAgICAgICB9LCB0cmFuc2l0aW9uVGltZSwgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LnByb3BlcnRpZXMub25TbGlkZUNoYW5nZWQuY2FsbChpbnN0KTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgd3JhcHBlci5uZXh0KCkuZmluZCgiLnByZXYiKS51bmJpbmQoImNsaWNrIik7DQogICAgICAgICAgICB3cmFwcGVyLm5leHQoKS5maW5kKCIucHJldiIpLm9uKCJjbGljayIsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIGlmIChNYXRoLnJvdW5kKGxlZnQgKyBzY3JvbGxTaXplKSA8PSAwKSB7DQogICAgICAgICAgICAgICAgICAgIGxlZnQgPSBsZWZ0ICsgc2Nyb2xsU2l6ZTsNCg0KICAgICAgICAgICAgICAgICAgICBzY3JvbGxJdGVtcy5zdG9wKCkuYW5pbWF0ZSh7DQogICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiBsZWZ0DQogICAgICAgICAgICAgICAgICAgIH0sIHRyYW5zaXRpb25UaW1lLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGluc3QucHJvcGVydGllcy5vblNsaWRlQ2hhbmdlZC5jYWxsKGluc3QpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yb3VuZChsZWZ0KSA9PT0gMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygiaGlkZSIpOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5maW5kKCIubmV4dCIpLnJlbW92ZUNsYXNzKCJoaWRlIik7DQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0LnByb3BlcnRpZXMuY2lyY3VsYXIpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1Ub1JlbW92ZSA9IHNjcm9sbEl0ZW1zLmNoaWxkcmVuKCJsaSIpLmxhc3QoKTsNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsSXRlbXMuY2hpbGRyZW4oImxpIikubGFzdCgpLnJlbW92ZSgpOw0KICAgICAgICAgICAgICAgICAgICBzY3JvbGxJdGVtcy5wcmVwZW5kKGl0ZW1Ub1JlbW92ZSk7DQoNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsSXRlbXMuY3NzKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IC1zY3JvbGxTaXplDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgICAgICBzY3JvbGxJdGVtcy5zdG9wKCkuYW5pbWF0ZSh7DQogICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiBsZWZ0DQogICAgICAgICAgICAgICAgICAgIH0sIHRyYW5zaXRpb25UaW1lLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGluc3QucHJvcGVydGllcy5vblNsaWRlQ2hhbmdlZC5jYWxsKGluc3QpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQoNCiAgICAgICAgU2Nyb2xsTGlzdC5wcm90b3R5cGUuZ2VuZXJhdGVIb3Jpem9udGFsU2Nyb2xsID0gZnVuY3Rpb24ocHJvcCkgew0KICAgICAgICAgICAgdmFyIGluc3QgPSB0aGlzLA0KICAgICAgICAgICAgICAgIHNjcm9sbFNpemUsDQogICAgICAgICAgICAgICAgc2Nyb2xsV3JhcHBlciA9ICQoaW5zdC5wcm9wZXJ0aWVzLmVsZW0pLmZpbmQoIi5zY3JvbGwtd3JhcHBlciIpLA0KICAgICAgICAgICAgICAgIHNjcm9sbEl0ZW1zID0gc2Nyb2xsV3JhcHBlci5jaGlsZHJlbigidWwiKSwNCiAgICAgICAgICAgICAgICBzY3JvbGxJdGVtID0gc2Nyb2xsSXRlbXMuY2hpbGRyZW4oImxpIiksDQogICAgICAgICAgICAgICAgd3JhcHBlcldpZHRoID0gc2Nyb2xsV3JhcHBlci53aWR0aCgpLA0KICAgICAgICAgICAgICAgIGl0ZW1QYWRkaW5nTGVmdCA9IHBhcnNlSW50KHNjcm9sbEl0ZW0uY3NzKCJwYWRkaW5nLWxlZnQiKSksDQogICAgICAgICAgICAgICAgaXRlbVBhZGRpbmdSaWdodCA9IHBhcnNlSW50KHNjcm9sbEl0ZW0uY3NzKCJwYWRkaW5nLXJpZ2h0IikpLA0KICAgICAgICAgICAgICAgIGl0ZW1NYXJnaW5MZWZ0ID0gcGFyc2VJbnQoc2Nyb2xsSXRlbS5jc3MoIm1hcmdpbi1sZWZ0IikpLA0KICAgICAgICAgICAgICAgIGl0ZW1NYXJnaW5SaWdodCA9IHBhcnNlSW50KHNjcm9sbEl0ZW0uY3NzKCJtYXJnaW4tcmlnaHQiKSksDQogICAgICAgICAgICAgICAgaXRlbUJvcmRlcldpZHRoID0gcGFyc2VJbnQoc2Nyb2xsSXRlbS5jc3MoImJvcmRlci1sZWZ0LXdpZHRoIikpLA0KICAgICAgICAgICAgICAgIGl0ZW1XaWR0aCA9ICh3cmFwcGVyV2lkdGggLSBpbnN0LnByb3BlcnRpZXMudmlzaWJsZUl0ZW1zICogaXRlbVBhZGRpbmdMZWZ0IC0NCiAgICAgICAgICAgICAgICAgICAgaW5zdC5wcm9wZXJ0aWVzLnZpc2libGVJdGVtcyAqIGl0ZW1QYWRkaW5nUmlnaHQpIC8gaW5zdC5wcm9wZXJ0aWVzLnZpc2libGVJdGVtcyAtDQogICAgICAgICAgICAgICAgICAgIDIgKiBpdGVtQm9yZGVyV2lkdGggLSBpdGVtTWFyZ2luUmlnaHQgLSBpdGVtTWFyZ2luTGVmdDsNCg0KDQogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIHNjcm9sbFdyYXBwZXIuaGVpZ2h0KHNjcm9sbEl0ZW0ub3V0ZXJIZWlnaHQoKSk7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIHNjcm9sbFdyYXBwZXIuaGVpZ2h0KHNjcm9sbEl0ZW0ub3V0ZXJIZWlnaHQoKSk7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgc2Nyb2xsSXRlbS53aWR0aChpdGVtV2lkdGgpOw0KDQogICAgICAgICAgICBpZiAoIXByb3AucmVzaXplKSB7DQogICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVOYXZpZ2F0aW9uKHNjcm9sbFdyYXBwZXIpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBzY3JvbGxTaXplID0gaXRlbVdpZHRoICsgaXRlbVBhZGRpbmdMZWZ0ICsgaXRlbVBhZGRpbmdSaWdodCArIGl0ZW1Cb3JkZXJXaWR0aCAqIDIgKyBpdGVtTWFyZ2luUmlnaHQgKyBpdGVtTWFyZ2luTGVmdDsNCiAgICAgICAgICAgIHNjcm9sbFNpemUgPSBzY3JvbGxTaXplICogaW5zdC5wcm9wZXJ0aWVzLnN0ZXA7DQoNCiAgICAgICAgICAgIHRoaXMuaG9yaXpvbnRhbEV2ZW50cyhzY3JvbGxXcmFwcGVyLCBzY3JvbGxJdGVtcywgc2Nyb2xsU2l6ZSk7DQogICAgICAgIH0NCg0KDQoNCg0KICAgICAgICBTY3JvbGxMaXN0LnByb3RvdHlwZS5nZW5lcmF0ZVZlcnRpY2FsU2Nyb2xsID0gZnVuY3Rpb24ocHJvcCkgew0KICAgICAgICAgICAgdmFyIGluc3QgPSB0aGlzLA0KICAgICAgICAgICAgICAgIHNjcm9sbFdyYXBwZXIgPSAkKGluc3QucHJvcGVydGllcy5lbGVtKS5maW5kKCIuc2Nyb2xsLXdyYXBwZXIiKSwNCiAgICAgICAgICAgICAgICBzY3JvbGxTaXplLA0KICAgICAgICAgICAgICAgIHNjcm9sbEl0ZW1zID0gc2Nyb2xsV3JhcHBlci5jaGlsZHJlbigidWwiKSwNCiAgICAgICAgICAgICAgICBzY3JvbGxJdGVtID0gc2Nyb2xsSXRlbXMuY2hpbGRyZW4oImxpIiksDQogICAgICAgICAgICAgICAgaXRlbVBhZGRpbmdUb3AgPSBwYXJzZUludChzY3JvbGxJdGVtLmNzcygicGFkZGluZy10b3AiKSksDQogICAgICAgICAgICAgICAgaXRlbVBhZGRpbmdCb3R0b20gPSBwYXJzZUludChzY3JvbGxJdGVtLmNzcygicGFkZGluZy1ib3R0b20iKSksDQogICAgICAgICAgICAgICAgaXRlbU1hcmdpblRvcCA9IHBhcnNlSW50KHNjcm9sbEl0ZW0uY3NzKCJtYXJnaW4tdG9wIikpLA0KICAgICAgICAgICAgICAgIGl0ZW1NYXJnaW5Cb3R0b20gPSBwYXJzZUludChzY3JvbGxJdGVtLmNzcygibWFyZ2luLWJvdHRvbSIpKSwNCiAgICAgICAgICAgICAgICBpdGVtQm9yZGVySGVpZ2h0ID0gcGFyc2VJbnQoc2Nyb2xsSXRlbS5jc3MoImJvcmRlci10b3Atd2lkdGgiKSksDQogICAgICAgICAgICAgICAgbGlzdFBhZGRpbmcgPSA4MCwNCiAgICAgICAgICAgICAgICBpdGVtSGVpZ2h0ID0gKHRoaXMucHJvcGVydGllcy5oZWlnaHQgLSBpbnN0LnByb3BlcnRpZXMudmlzaWJsZUl0ZW1zICogaXRlbVBhZGRpbmdUb3AgLQ0KICAgICAgICAgICAgICAgICAgICBpbnN0LnByb3BlcnRpZXMudmlzaWJsZUl0ZW1zICogaXRlbVBhZGRpbmdCb3R0b20pIC8gaW5zdC5wcm9wZXJ0aWVzLnZpc2libGVJdGVtcyAtDQogICAgICAgICAgICAgICAgICAgIGl0ZW1Cb3JkZXJIZWlnaHQgKiAyIC0gaXRlbU1hcmdpblRvcCAtIGl0ZW1NYXJnaW5Cb3R0b207DQoNCg0KICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICBzY3JvbGxXcmFwcGVyLmhlaWdodChzY3JvbGxJdGVtLm91dGVySGVpZ2h0KCkgKyBsaXN0UGFkZGluZyk7DQogICAgICAgICAgICAgICAgc2Nyb2xsSXRlbS5oZWlnaHQoc2Nyb2xsSXRlbS5vdXRlckhlaWdodCgpIC8gaW5zdC5wcm9wZXJ0aWVzLnZpc2libGVJdGVtcyk7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIHNjcm9sbFdyYXBwZXIuaGVpZ2h0KHNjcm9sbEl0ZW0ub3V0ZXJIZWlnaHQoKSArIGxpc3RQYWRkaW5nKTsNCiAgICAgICAgICAgICAgICBzY3JvbGxJdGVtLmhlaWdodChzY3JvbGxJdGVtLm91dGVySGVpZ2h0KCkgLyBpbnN0LnByb3BlcnRpZXMudmlzaWJsZUl0ZW1zKTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBpZiAoIXByb3AucmVzaXplKSB7DQogICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVOYXZpZ2F0aW9uKHNjcm9sbFdyYXBwZXIpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgLy9pdGVtSGVpZ2h0ICsgaXRlbVBhZGRpbmdUb3AgKyBpdGVtUGFkZGluZ0JvdHRvbSArIDIgKiBpdGVtQm9yZGVySGVpZ2h0ICsgaXRlbU1hcmdpblRvcCArIGl0ZW1NYXJnaW5Cb3R0b207DQogICAgICAgICAgICAvL3Njcm9sbFNpemUgPSBzY3JvbGxTaXplICogaW5zdC5wcm9wZXJ0aWVzLnN0ZXA7DQoNCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgc2Nyb2xsU2l6ZSA9IChzY3JvbGxJdGVtLm91dGVySGVpZ2h0KCkgLyBpbnN0LnByb3BlcnRpZXMudmlzaWJsZUl0ZW1zKSAqIGluc3QucHJvcGVydGllcy5zdGVwOw0KICAgICAgICAgICAgICAgIGluc3QudmVydGljYWxFdmVudHMoc2Nyb2xsV3JhcHBlciwgc2Nyb2xsSXRlbXMsIHNjcm9sbFNpemUpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCg0KDQogICAgICAgIFNjcm9sbExpc3QucHJvdG90eXBlLnZlcnRpY2FsRXZlbnRzID0gZnVuY3Rpb24od3JhcHBlciwgc2Nyb2xsSXRlbXMsIHNjcm9sbFNpemUpIHsNCiAgICAgICAgICAgIHZhciBpbnN0ID0gdGhpcywNCiAgICAgICAgICAgICAgICB0b3AgPSAwLA0KICAgICAgICAgICAgICAgIGl0ZW1zTGVuZ3RoID0gc2Nyb2xsSXRlbXMuY2hpbGRyZW4oImxpIikubGVuZ3RoLA0KICAgICAgICAgICAgICAgIHRyYW5zaXRpb25UaW1lID0gaW5zdC5wcm9wZXJ0aWVzLnRyYW5zaXRpb25UaW1lOw0KDQogICAgICAgICAgICBzY3JvbGxJdGVtcy5jc3Moew0KICAgICAgICAgICAgICAgIHRvcDogMA0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICBpZiAoIWluc3QucHJvcGVydGllcy5jaXJjdWxhcikgew0KICAgICAgICAgICAgICAgIHdyYXBwZXIubmV4dCgpLmZpbmQoIi5wcmV2IikuYWRkQ2xhc3MoImhpZGUiKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgd3JhcHBlci5uZXh0KCkuZmluZCgiLm5leHQgYSwucHJldiBhIikub24oImNsaWNrIiwgZnVuY3Rpb24oZSkgew0KICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICB3cmFwcGVyLnVuYmluZCgidG91Y2hzdGFydCIpOw0KICAgICAgICAgICAgd3JhcHBlci5vbigidG91Y2hzdGFydCIsIGZ1bmN0aW9uKGUpIHsNCiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnN0LnByb3BlcnRpZXMuaW50ZXJ2YWxJZCk7DQogICAgICAgICAgICAgICAgdmFyIHBvc1kgPSBlLm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVk7DQoNCiAgICAgICAgICAgICAgICAkKHRoaXMpLnVuYmluZCgidG91Y2hlbmQiKTsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLm9uKCJ0b3VjaGVuZCIsIGZ1bmN0aW9uKGV2KSB7DQogICAgICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgICAgICAgICAgICAgIHZhciBwb3NZRW5kID0gZXYub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKChwb3NZIC0gcG9zWUVuZCkgPiAxMDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHdyYXBwZXIubmV4dCgpLmZpbmQoIi5uZXh0IikudHJpZ2dlcigiY2xpY2siKTsNCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgocG9zWSAtIHBvc1lFbmQpIDwgLTEwMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgd3JhcHBlci5uZXh0KCkuZmluZCgiLnByZXYiKS50cmlnZ2VyKCJjbGljayIpOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgd3JhcHBlci5uZXh0KCkuZmluZCgiLm5leHQiKS51bmJpbmQoImNsaWNrIik7DQogICAgICAgICAgICB3cmFwcGVyLm5leHQoKS5maW5kKCIubmV4dCIpLm9uKCJjbGljayIsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgIHZhciBzY3JvbGxQb3NpdGlvbjEgPSB0b3AsDQogICAgICAgICAgICAgICAgICAgIHNjcm9sbFBvc2l0aW9uMiA9IHNjcm9sbFNpemUgLyBpbnN0LnByb3BlcnRpZXMuc3RlcDsvLyArIGluc3QucHJvcGVydGllcy52aXNpYmxlSXRlbXMgKiBzY3JvbGxTaXplIC8gaW5zdC5wcm9wZXJ0aWVzLnN0ZXA7DQoNCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5yb3VuZChzY3JvbGxQb3NpdGlvbjEpID4gTWF0aC5yb3VuZChzY3JvbGxQb3NpdGlvbjIpKSB7DQogICAgICAgICAgICAgICAgICAgIHRvcCA9IHRvcCAtIHNjcm9sbFNpemU7DQoNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsSXRlbXMuc3RvcCgpLmFuaW1hdGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiB0b3ANCiAgICAgICAgICAgICAgICAgICAgfSwgdHJhbnNpdGlvblRpbWUsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgaW5zdC5wcm9wZXJ0aWVzLm9uU2xpZGVDaGFuZ2VkLmNhbGwoaW5zdCk7DQogICAgICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJvdW5kKHRvcCkgPD0gTWF0aC5yb3VuZChzY3JvbGxQb3NpdGlvbjIpKSB7DQogICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJoaWRlIik7DQogICAgICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnBhcmVudCgpLmZpbmQoIi5wcmV2IikucmVtb3ZlQ2xhc3MoImhpZGUiKTsNCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluc3QucHJvcGVydGllcy5jaXJjdWxhcikgew0KICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbVRvUmVtb3ZlID0gc2Nyb2xsSXRlbXMuY2hpbGRyZW4oImxpIikuZmlyc3QoKTsNCg0KICAgICAgICAgICAgICAgICAgICBzY3JvbGxJdGVtcy5jc3Moew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiB0b3AgKyBzY3JvbGxTaXplDQogICAgICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAgICAgICAgIHNjcm9sbEl0ZW1zLnN0b3AoKS5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogdG9wDQogICAgICAgICAgICAgICAgICAgIH0sIHRyYW5zaXRpb25UaW1lLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGluc3QucHJvcGVydGllcy5vblNsaWRlQ2hhbmdlZC5jYWxsKGluc3QpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgICAgICBzY3JvbGxJdGVtcy5jaGlsZHJlbigibGkiKS5maXJzdCgpLnJlbW92ZSgpOw0KICAgICAgICAgICAgICAgICAgICBzY3JvbGxJdGVtcy5hcHBlbmQoaXRlbVRvUmVtb3ZlKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgd3JhcHBlci5uZXh0KCkuZmluZCgiLnByZXYiKS51bmJpbmQoImNsaWNrIik7DQogICAgICAgICAgICB3cmFwcGVyLm5leHQoKS5maW5kKCIucHJldiIpLm9uKCJjbGljayIsIGZ1bmN0aW9uKCkgew0KDQogICAgICAgICAgICAgICAgaWYgKE1hdGgucm91bmQodG9wICsgc2Nyb2xsU2l6ZSkgPD0gMCkgew0KICAgICAgICAgICAgICAgICAgICB0b3AgPSB0b3AgKyBzY3JvbGxTaXplOw0KDQogICAgICAgICAgICAgICAgICAgIHNjcm9sbEl0ZW1zLnN0b3AoKS5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogdG9wDQogICAgICAgICAgICAgICAgICAgIH0sIHRyYW5zaXRpb25UaW1lLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGluc3QucHJvcGVydGllcy5vblNsaWRlQ2hhbmdlZC5jYWxsKGluc3QpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucm91bmQodG9wKSA9PT0gMCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygiaGlkZSIpOw0KICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5maW5kKCIubmV4dCIpLnJlbW92ZUNsYXNzKCJoaWRlIik7DQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0LnByb3BlcnRpZXMuY2lyY3VsYXIpIHsNCiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1Ub1JlbW92ZSA9IHNjcm9sbEl0ZW1zLmNoaWxkcmVuKCJsaSIpLmxhc3QoKTsNCg0KICAgICAgICAgICAgICAgICAgICBzY3JvbGxJdGVtcy5jc3Moew0KICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiB0b3AgLSBzY3JvbGxTaXplDQogICAgICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAgICAgICAgIHNjcm9sbEl0ZW1zLnN0b3AoKS5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogdG9wDQogICAgICAgICAgICAgICAgICAgIH0sIHRyYW5zaXRpb25UaW1lLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGluc3QucHJvcGVydGllcy5vblNsaWRlQ2hhbmdlZC5jYWxsKGluc3QpOw0KICAgICAgICAgICAgICAgICAgICB9KTsNCg0KDQogICAgICAgICAgICAgICAgICAgIHNjcm9sbEl0ZW1zLmNoaWxkcmVuKCJsaSIpLmxhc3QoKS5yZW1vdmUoKTsNCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsSXRlbXMucHJlcGVuZChpdGVtVG9SZW1vdmUpOw0KDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCg0KDQogICAgICAgIHZhciBzY3JvbGxMaXN0ID0gbmV3IFNjcm9sbExpc3QodGhpcyk7DQogICAgICAgIHNjcm9sbExpc3QuZ2V0UHJvcGVydGllcyhwcm9wZXJ0aWVzKTsNCiAgICAgICAgc2Nyb2xsTGlzdC5yZXBsYWNlTW9iaWxlUHJvcGVydGllcygpOw0KDQogICAgICAgIGlmIChzY3JvbGxMaXN0LnByb3BlcnRpZXMuY2lyY3VsYXIpIHsNCiAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoImNpcmN1bGFyIik7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoc2Nyb2xsTGlzdC5wcm9wZXJ0aWVzLmhvcml6b250YWwpIHsNCiAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoImhvcml6b250YWwiKTsNCiAgICAgICAgICAgIHNjcm9sbExpc3QuZ2VuZXJhdGVIb3Jpem9udGFsU2Nyb2xsKHsNCiAgICAgICAgICAgICAgICByZXNpemU6IGZhbHNlDQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgJCh3aW5kb3cpLnJlc2l6ZShmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICBzY3JvbGxMaXN0LnJlcGxhY2VNb2JpbGVQcm9wZXJ0aWVzKCk7DQogICAgICAgICAgICAgICAgc2Nyb2xsTGlzdC5nZW5lcmF0ZUhvcml6b250YWxTY3JvbGwoew0KICAgICAgICAgICAgICAgICAgICByZXNpemU6IHRydWUNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygidmVydGljYWwiKTsNCiAgICAgICAgICAgIHNjcm9sbExpc3QuZ2VuZXJhdGVWZXJ0aWNhbFNjcm9sbCh7DQogICAgICAgICAgICAgICAgcmVzaXplOiBmYWxzZQ0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgICQod2luZG93KS5yZXNpemUoZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgc2Nyb2xsTGlzdC5yZXBsYWNlTW9iaWxlUHJvcGVydGllcygpOw0KICAgICAgICAgICAgICAgIHNjcm9sbExpc3QuZ2VuZXJhdGVWZXJ0aWNhbFNjcm9sbCh7DQogICAgICAgICAgICAgICAgICAgIHJlc2l6ZTogdHJ1ZQ0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCg0KICAgICAgICBzY3JvbGxMaXN0LmF1dG9wbGF5KCk7DQoNCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICB9DQp9KShqUXVlcnkpOw0KDQoNClhBLmNvbXBvbmVudC5zY3JvbGxMaXN0ID0gKGZ1bmN0aW9uKCQsIGRvY3VtZW50KSB7DQogICAgdmFyIGFwaSA9IHt9Ow0KICAgIGFwaS5pbml0ID0gZnVuY3Rpb24oKSB7DQogICAgICAgIHZhciBzY3JvbGxMaXN0ID0gJCgiLnNjcm9sbC1saXN0Iik7DQoNCiAgICAgICAgc2Nyb2xsTGlzdC5lYWNoKGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgdmFyIHByb3BlcnRpZXMgPSAkKHRoaXMpLmRhdGEoInByb3BlcnRpZXMiKTsNCiAgICAgICAgICAgICQodGhpcykuc2Nyb2xsTGlzdChwcm9wZXJ0aWVzKTsNCiAgICAgICAgfSk7DQogICAgfTsNCg0KICAgIHJldHVybiBhcGk7DQp9KGpRdWVyeSwgZG9jdW1lbnQpKTsNCg0KWEEucmVnaXN0ZXIoInNjcm9sbExpc3QiLCBYQS5jb21wb25lbnQuc2Nyb2xsTGlzdCk7DQpYQS5jb21wb25lbnQuc29jaWFsID0gKGZ1bmN0aW9uKCQsIGRvY3VtZW50KSB7DQoNCiAgICB2YXIgYXBpID0ge30sDQogICAgICAgIGF0dGFjaEV4dGVybmFsU2NyaXB0Ow0KDQogICAgYXBpLmluaXRGYWNlYm9vayA9IGZ1bmN0aW9uKCkgew0KICAgICAgICAoZnVuY3Rpb24oZCwgcywgaWQpIHsNCiAgICAgICAgICAgIHZhciBqcywgZmpzID0gZC5nZXRFbGVtZW50c0J5VGFnTmFtZShzKVswXTsNCiAgICAgICAgICAgIGlmIChkLmdldEVsZW1lbnRCeUlkKGlkKSkgew0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGpzID0gZC5jcmVhdGVFbGVtZW50KHMpOw0KICAgICAgICAgICAganMuaWQgPSBpZDsNCiAgICAgICAgICAgIGpzLnNyYyA9ICIvL2Nvbm5lY3QuZmFjZWJvb2submV0L2VuX1VTL2FsbC5qcyN4ZmJtbD0xIjsNCiAgICAgICAgICAgIGZqcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZShqcywgZmpzKTsNCiAgICAgICAgfShkb2N1bWVudCwgJ3NjcmlwdCcsICdmYWNlYm9vay1qc3NkaycpKTsNCiAgICB9DQoNCiAgICBhdHRhY2hFeHRlcm5hbFNjcmlwdCA9IGZ1bmN0aW9uKHByb3BlcnRpZXMpew0KICAgICAgICB2YXIgY29tcG9uZW50ID0gJCgiLnNoYXJldGhpcyIpLA0KICAgICAgICAgICAgc2hhcmVUaGlzRXh0ZXJuYWw7DQogICAgICAgIGlmKHdpbmRvdy5zdExpZ2h0ID09PSB1bmRlZmluZWQpew0KICAgICAgICAgICAgc2hhcmVUaGlzRXh0ZXJuYWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsNCiAgICAgICAgICAgIHNoYXJlVGhpc0V4dGVybmFsLnR5cGUgPSAidGV4dC9qYXZhc2NyaXB0IjsNCiAgICAgICAgICAgIHNoYXJlVGhpc0V4dGVybmFsLnNyYyA9ICJodHRwOi8vdy5zaGFyZXRoaXMuY29tL2J1dHRvbi9idXR0b25zLmpzIjsNCiAgICAgICAgICAgICQod2luZG93KS5vbigibG9hZCIsZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICAkKHByb3BlcnRpZXMpLmVhY2goZnVuY3Rpb24oKXsNCiAgICAgICAgICAgICAgICAgICAgc3RMaWdodC5vcHRpb25zKHRoaXMpOw0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAkKGNvbXBvbmVudFswXSkuYXBwZW5kKHNoYXJlVGhpc0V4dGVybmFsKTsNCiAgICAgICAgfSANCiAgICB9Ow0KDQogICAgYXBpLmluaXQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgdmFyIHNoYXJlVGhpcyA9ICQoIi5zaGFyZXRoaXM6bm90KC5pbml0aWFsaXplZCkiKSwNCiAgICAgICAgICAgIHNoYXJlUHJvcGVydGllcyA9IFtdOw0KICAgICAgICBzaGFyZVRoaXMuZWFjaChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciBwcm9wZXJ0aWVzID0gJCh0aGlzKS5kYXRhKCJwcm9wZXJ0aWVzIik7DQogICAgICAgICAgICBzaGFyZVByb3BlcnRpZXMucHVzaChwcm9wZXJ0aWVzKTsNCiAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoImluaXRpYWxpemVkIik7DQogICAgICAgIH0pOw0KICAgICAgICBhdHRhY2hFeHRlcm5hbFNjcmlwdChzaGFyZVByb3BlcnRpZXMpOyAgICAgICANCiAgICB9Ow0KDQogICAgcmV0dXJuIGFwaTsNCn0oalF1ZXJ5LCBkb2N1bWVudCkpOw0KDQpYQS5yZWdpc3Rlcigic29jaWFsIiwgWEEuY29tcG9uZW50LnNvY2lhbCk7DQpYQS5jb21wb25lbnQuc29jaWFsLmluaXRGYWNlYm9vaygpOw0KWEEuY29tcG9uZW50LnRhYnMgPSAoZnVuY3Rpb24oJCkgew0KDQogICAgdmFyIHB1YiA9IHt9Ow0KDQogICAgZnVuY3Rpb24gcGFnZUVkaXRvcigpIHsNCiAgICAgICAgaWYgKCQoJ2JvZHknKS5oYXNDbGFzcygnb24tcGFnZS1lZGl0b3InKSkgew0KICAgICAgICAgICAgU2l0ZWNvcmUuUGFnZU1vZGVzLkNocm9tZU1hbmFnZXIucmVzZXRDaHJvbWVzKCk7IC8vcGFnZSBlZGl0b3IgbGluZXMgZml4DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBmdW5jdGlvbiB0YWJzU2Nyb2xsYWJsZSgkdGFic1Njcm9sbCkgew0KICAgICAgICB2YXIgc3BlZWQgPSAxNTA7IC8vdGFicyBzY3JvbGwgc3BlZWQNCg0KICAgICAgICBmdW5jdGlvbiBpbml0TmF2U2Nyb2xsKCR0YWJzTmF2KSB7DQogICAgICAgICAgICB2YXIgc3VtID0gMCwNCiAgICAgICAgICAgICAgICBtYXhIZWlnaHQgPSAwLA0KICAgICAgICAgICAgICAgIG1heFdpZHRoID0gMDsNCg0KICAgICAgICAgICAgaWYgKCR0YWJzTmF2Lmxlbmd0aCkgew0KICAgICAgICAgICAgICAgICR0YWJzTmF2LnBhcmVudCgpLmZpbmQoIi5wcmV2IikucmVtb3ZlKCk7DQogICAgICAgICAgICAgICAgJHRhYnNOYXYucGFyZW50KCkuZmluZCgiLm5leHQiKS5yZW1vdmUoKTsNCiAgICAgICAgICAgICAgICAkdGFic05hdi51bndyYXAoKTsNCg0KICAgICAgICAgICAgICAgICR0YWJzTmF2LmNzcygid2lkdGgiLCAiYXV0byIpOw0KICAgICAgICAgICAgICAgICR0YWJzTmF2LmNzcygiaGVpZ2h0IiwgImF1dG8iKTsNCiAgICAgICAgICAgICAgICAkdGFic05hdi5jc3MoImxlZnQiLCAwKTsNCiAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICAkdGFic05hdi5maW5kKCJsaSIpLmVhY2goZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgc3VtICs9ICQodGhpcykub3V0ZXJXaWR0aCh0cnVlKTsNCiAgICAgICAgICAgIH0pOw0KDQoNCiAgICAgICAgICAgICR0YWJzTmF2LmZpbmQoImxpIikuZWFjaChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICBtYXhIZWlnaHQgPSBNYXRoLm1heChtYXhIZWlnaHQsICQodGhpcykuaGVpZ2h0KCkpOw0KICAgICAgICAgICAgfSk7DQoNCg0KICAgICAgICAgICAgJHRhYnNOYXYud3JhcCgiPGRpdiBjbGFzcz0nd3JhcHBlcic+Iik7DQogICAgICAgICAgICAkKCI8ZGl2IGNsYXNzPSduZXh0IHRhYi1zbGlkZXInPj48L2Rpdj4iKS5pbnNlcnRBZnRlcigkdGFic05hdik7DQogICAgICAgICAgICAkKCI8ZGl2IGNsYXNzPSdwcmV2IHRhYi1zbGlkZXInPjw8L2Rpdj4iKS5pbnNlcnRCZWZvcmUoJHRhYnNOYXYpOw0KDQoNCiAgICAgICAgICAgICR0YWJzTmF2LnBhcmVudCgpLmNzcygiaGVpZ2h0IiwgcGFyc2VJbnQobWF4SGVpZ2h0LCAxMCkpOw0KICAgICAgICAgICAgJHRhYnNOYXYucGFyZW50KCkuZmluZCgiLnRhYi1zbGlkZXIiKS5jc3MoImhlaWdodCIsIHBhcnNlSW50KG1heEhlaWdodCwgMTApIC0gMik7DQoNCg0KICAgICAgICAgICAgaWYgKHN1bSA+ICR0YWJzTmF2LnBhcmVudCgpLndpZHRoKCkpIHsNCiAgICAgICAgICAgICAgICAkdGFic05hdi5wYXJlbnQoKS5maW5kKCIucHJldiIpLmhpZGUoKTsNCiAgICAgICAgICAgICAgICAkdGFic05hdi53aWR0aChzdW0pOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAkdGFic05hdi5wYXJlbnQoKS5maW5kKCIucHJldiIpLmhpZGUoKTsNCiAgICAgICAgICAgICAgICAkdGFic05hdi5wYXJlbnQoKS5maW5kKCIubmV4dCIpLmhpZGUoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQoNCiAgICAgICAgZnVuY3Rpb24gYmluZFByZXZOZXh0RXZlbnRzKGN1cnJlbnQsICR0YWJzTmF2KSB7DQogICAgICAgICAgICBjdXJyZW50LmZpbmQoIi5wcmV2IikuY2xpY2soZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgdmFyIGxlZnQgPSBwYXJzZUludCgkdGFic05hdi5jc3MoImxlZnQiKSwgMTApOw0KICAgICAgICAgICAgICAgIGxlZnQgKz0gc3BlZWQ7DQoNCiAgICAgICAgICAgICAgICBpZiAobGVmdCA+IDApIHsNCiAgICAgICAgICAgICAgICAgICAgbGVmdCA9IDA7DQogICAgICAgICAgICAgICAgICAgICR0YWJzTmF2LnN0b3AoKS5hbmltYXRlKHsNCiAgICAgICAgICAgICAgICAgICAgICAgICJsZWZ0IjogbGVmdA0KICAgICAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgICAgICAkdGFic05hdi5wYXJlbnQoKS5maW5kKCIucHJldiIpLmhpZGUoKTsNCiAgICAgICAgICAgICAgICAgICAgJHRhYnNOYXYucGFyZW50KCkuZmluZCgiLm5leHQiKS5zaG93KCk7DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgJHRhYnNOYXYuc3RvcCgpLmFuaW1hdGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgImxlZnQiOiBsZWZ0DQogICAgICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAgICAgICAgICR0YWJzTmF2LnBhcmVudCgpLmZpbmQoIi5wcmV2Iikuc2hvdygpOw0KICAgICAgICAgICAgICAgICAgICAkdGFic05hdi5wYXJlbnQoKS5maW5kKCIubmV4dCIpLnNob3coKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCg0KDQogICAgICAgICAgICBjdXJyZW50LmZpbmQoIi5uZXh0IikuY2xpY2soZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgdmFyIGxlZnQgPSBwYXJzZUludCgkdGFic05hdi5jc3MoImxlZnQiKSwgMTApLA0KICAgICAgICAgICAgICAgICAgICBuYXZXaWR0aCA9ICR0YWJzTmF2LndpZHRoKCksDQogICAgICAgICAgICAgICAgICAgIG5hdlBhcmVudFdpZHRoID0gJHRhYnNOYXYucGFyZW50KCkud2lkdGgoKTsNCg0KICAgICAgICAgICAgICAgIGxlZnQgLT0gc3BlZWQ7DQoNCiAgICAgICAgICAgICAgICBpZiAoKG5hdldpZHRoICsgbGVmdCkgPCBuYXZQYXJlbnRXaWR0aCkgew0KICAgICAgICAgICAgICAgICAgICBsZWZ0ID0gbmF2V2lkdGggLSBuYXZQYXJlbnRXaWR0aDsNCiAgICAgICAgICAgICAgICAgICAgJHRhYnNOYXYuc3RvcCgpLmFuaW1hdGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgImxlZnQiOiAtbGVmdA0KICAgICAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgICAgICAkdGFic05hdi5wYXJlbnQoKS5maW5kKCIucHJldiIpLnNob3coKTsNCiAgICAgICAgICAgICAgICAgICAgJHRhYnNOYXYucGFyZW50KCkuZmluZCgiLm5leHQiKS5oaWRlKCk7DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgJHRhYnNOYXYuc3RvcCgpLmFuaW1hdGUoew0KICAgICAgICAgICAgICAgICAgICAgICAgImxlZnQiOiBsZWZ0DQogICAgICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAgICAgICAgICR0YWJzTmF2LnBhcmVudCgpLmZpbmQoIi5wcmV2Iikuc2hvdygpOw0KICAgICAgICAgICAgICAgICAgICAkdGFic05hdi5wYXJlbnQoKS5maW5kKCIubmV4dCIpLnNob3coKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGJpbmRDaGFuZ2VUYWJzKCR0YWJzTmF2LCAkdGFic0NvbnRhaW5lcikgew0KICAgICAgICAgICAgJHRhYnNOYXYuZmluZCgibGkiKS5jbGljayhmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSAkKHRoaXMpLmluZGV4KCk7DQoNCiAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJhY3RpdmUiKTsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3MoImFjdGl2ZSIpOw0KDQogICAgICAgICAgICAgICAgJHRhYnNDb250YWluZXIuZmluZCgiLnRhYiIpLnJlbW92ZUNsYXNzKCJhY3RpdmUiKTsNCiAgICAgICAgICAgICAgICAkdGFic0NvbnRhaW5lci5maW5kKCIudGFiOmVxKCIgKyBpbmRleCArICIpIikuYWRkQ2xhc3MoImFjdGl2ZSIpOw0KDQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBpbml0VGFic1Njcm9sbGFibGUoJHRhYnMpIHsNCiAgICAgICAgICAgICR0YWJzLmVhY2goZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgdmFyICR0YWJzTmF2ID0gJCh0aGlzKS5maW5kKCIudGFicy1oZWFkaW5nIiksDQogICAgICAgICAgICAgICAgICAgICR0YWJzQ29udGFpbmVyID0gJCh0aGlzKS5maW5kKCIudGFicy1jb250YWluZXIiKTsNCg0KICAgICAgICAgICAgICAgICR0YWJzTmF2LmZpbmQoImxpOmZpcnN0LWNoaWxkIikuYWRkQ2xhc3MoImFjdGl2ZSIpOw0KICAgICAgICAgICAgICAgICR0YWJzQ29udGFpbmVyLmZpbmQoIi50YWI6ZXEoMCkiKS5hZGRDbGFzcygiYWN0aXZlIik7DQoNCiAgICAgICAgICAgICAgICBiaW5kQ2hhbmdlVGFicygkdGFic05hdiwgJHRhYnNDb250YWluZXIpOw0KICAgICAgICAgICAgICAgIGluaXROYXZTY3JvbGwoJHRhYnNOYXYpOw0KICAgICAgICAgICAgICAgIGJpbmRQcmV2TmV4dEV2ZW50cygkKHRoaXMpLCAkdGFic05hdik7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgaW5pdFRhYnNTY3JvbGxhYmxlKCR0YWJzU2Nyb2xsKTsNCiAgICAgICAgJCh3aW5kb3cpLnJlc2l6ZShmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIGluaXRUYWJzU2Nyb2xsYWJsZSgkdGFic1Njcm9sbCk7DQogICAgICAgIH0pOw0KDQogICAgfQ0KDQogICAgcHViLmluaXQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgdmFyICR0YWJzID0gJCgiLnRhYnM6bm90KC5pbml0aWFsaXplZCkiKTsNCiAgICAgICAgJHRhYnMuZWFjaChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICR0YWJNb2R1bGUgPSAkKHRoaXMpLmZpbmQoIi50YWJzLWlubmVyIik7DQoNCiAgICAgICAgICAgIGlmICgkKHRoaXMpLmhhc0NsYXNzKCJ0YWJzLXNjcm9sbGFibGUiKSkgew0KICAgICAgICAgICAgICAgIHRhYnNTY3JvbGxhYmxlKCQodGhpcykpOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAkdGFiTW9kdWxlLmVhY2goZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgICAgIHZhciAkdGFiTmF2ID0gJCh0aGlzKS5maW5kKCIudGFicy1oZWFkaW5nID4gbGkiKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICR0YWJzID0gJCh0aGlzKS5maW5kKCI+IC50YWJzLWNvbnRhaW5lciA+IC50YWIiKTsNCiAgICAgICAgICAgICAgICAgICAgJHRhYk5hdi5maXJzdCgpLmFkZENsYXNzKCJhY3RpdmUiKTsNCiAgICAgICAgICAgICAgICAgICAgJHRhYnMuZmlyc3QoKS5hZGRDbGFzcygiYWN0aXZlIik7DQogICAgICAgICAgICAgICAgICAgICR0YWJOYXYuY2xpY2soZnVuY3Rpb24oZXZlbnQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCA9ICQodGhpcykuaW5kZXgoKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuc2libGluZ3MoKS5yZW1vdmVDbGFzcygiYWN0aXZlIik7DQogICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnBhcmVudCgpLnBhcmVudCgpLmZpbmQoIj4gLnRhYnMtY29udGFpbmVyID4gLnRhYiIpLnJlbW92ZUNsYXNzKCJhY3RpdmUiKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoImFjdGl2ZSIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgJCgkKHRoaXMpLnBhcmVudCgpLnBhcmVudCgpLmZpbmQoIj4gLnRhYnMtY29udGFpbmVyID4gLnRhYiIpLmVxKGluZGV4KSkuYWRkQ2xhc3MoImFjdGl2ZSIpOw0KICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUVkaXRvcigpOw0KICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoImluaXRpYWxpemVkIik7DQogICAgICAgIH0pOw0KICAgIH0NCg0KICAgIHJldHVybiBwdWI7DQp9KGpRdWVyeSkpOw0KDQpYQS5yZWdpc3RlcigidGFicyIsIFhBLmNvbXBvbmVudC50YWJzKTsNClhBLmNvbXBvbmVudC50b2dnbGUgPSAoZnVuY3Rpb24gKCQsIGRvY3VtZW50KSB7DQoNCiAgICB2YXIgdG9vZ2xlRXZlbnRzID0gew0KICAgICAgICAgICAgZm9jdXM6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJzaG93Iik7DQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgYmx1cjogZnVuY3Rpb24gKCkgeyAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAkKHRoaXMpLnJlbW92ZUNsYXNzKCJzaG93Iik7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfTsNCg0KICAgIGZ1bmN0aW9uIGluaXRFdmVudHMoaGVhZGVyKSB7DQogICAgICAgIGhlYWRlci5vbigibW91c2VvdmVyIiwgdG9vZ2xlRXZlbnRzLmZvY3VzKTsNCiAgICAgICAgaGVhZGVyLm9uKCJtb3VzZWxlYXZlIiwgdG9vZ2xlRXZlbnRzLmJsdXIpOw0KICAgICAgICBoZWFkZXIub24oImZvY3VzIiwgdG9vZ2xlRXZlbnRzLmZvY3VzKTsNCiAgICAgICAgaGVhZGVyLm9uKCJibHVyIiwgdG9vZ2xlRXZlbnRzLmJsdXIpOw0KICAgICAgICBoZWFkZXIub24oImtleXVwIiwgZnVuY3Rpb24gKGUpIHsNCiAgICAgICAgICAgIGlmIChlLmtleUNvZGUgPT0gMTMpIHsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLmNsaWNrKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgIH07DQogICAgDQogICAgdmFyIGFwaSA9IHt9Ow0KDQogICAgYXBpLmluaXQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciB0b29nbGVIZWFkZXJzID0gJCgiLnRvZ2dsZS1oZWFkZXI6bm90KC5pbml0aWFsaXplZCkiKTsNCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b29nbGVIZWFkZXJzLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICB2YXIgaGVhZGVyID0gJCh0b29nbGVIZWFkZXJzW2ldKTsNCiAgICAgICAgICAgIGluaXRFdmVudHMoaGVhZGVyKTsNCiAgICAgICAgICAgIGhlYWRlci5hZGRDbGFzcygiaW5pdGlhbGl6ZWQiKTsNCiAgICAgICAgfTsNCiAgICB9Ow0KDQogICAgcmV0dXJuIGFwaTsNCn0oalF1ZXJ5LCBkb2N1bWVudCkpOw0KDQpYQS5yZWdpc3RlcigidG9nZ2xlIiwgWEEuY29tcG9uZW50LnRvZ2dsZSk7DQpYQS5jb21wb25lbnQucGxheWxpc3QgPSAoZnVuY3Rpb24gKCQsIGRvY3VtZW50KSB7DQoNCiAgICB2YXIgYXBpID0ge307DQoNCiAgICBmdW5jdGlvbiBQbGF5bGlzdChwbGF5bGlzdCwgcHJvcGVydGllcykgew0KICAgICAgICB0aGlzLnByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzOw0KICAgICAgICB0aGlzLnBsYXlsaXN0ID0gcGxheWxpc3Q7DQogICAgICAgIHRoaXMuYWN0aXZlVmlkZW8gPSAwOw0KICAgICAgICB0aGlzLnBsYXlsaXN0SXRlbXMgPSAwOw0KICAgIH0NCg0KICAgIFBsYXlsaXN0LnByb3RvdHlwZS5jcmVhdGVOZXdTb3VyY2VzID0gZnVuY3Rpb24gKHNvdXJjZSwgdmlkZW9Db250YWluZXIpIHsNCiAgICAgICAgdmFyIG5ld1NvdXJjZTsNCg0KICAgICAgICB2YXIgc291cmNlQnVpbGRlciA9IGZ1bmN0aW9uIChwYXRoKSB7DQogICAgICAgICAgICB2YXIgbmV3U291cmNlID0gJCgiPHNvdXJjZT4iKSwNCiAgICAgICAgICAgICAgICB0eXBlOw0KDQogICAgICAgICAgICBpZiAocGF0aC5tYXRjaCgvXC4obXA0KSQvKSkgew0KICAgICAgICAgICAgICAgIHR5cGUgPSAidmlkZW8vbXA0IjsNCiAgICAgICAgICAgIH0gZWxzZSBpZiAocGF0aC5tYXRjaCgvXC4od2VibSkkLykpIHsNCiAgICAgICAgICAgICAgICB0eXBlID0gInZpZGVvL3dlYm0iOw0KICAgICAgICAgICAgfSBlbHNlIGlmIChwYXRoLm1hdGNoKC9cLihvZ3YpJC8pKSB7DQogICAgICAgICAgICAgICAgdHlwZSA9ICJ2aWRlby9vZ2ciOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICB0eXBlID0gInZpZGVvL3lvdXR1YmUiOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBuZXdTb3VyY2UuYXR0cih7DQogICAgICAgICAgICAgICAgInR5cGUiOiB0eXBlLA0KICAgICAgICAgICAgICAgICJzcmMiOiBwYXRoDQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgcmV0dXJuIG5ld1NvdXJjZTsNCiAgICAgICAgfTsNCg0KICAgICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgQXJyYXkpIHsNCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc291cmNlLmxlbmd0aDsgaSsrKSB7DQogICAgICAgICAgICAgICAgbmV3U291cmNlID0gc291cmNlQnVpbGRlcihzb3VyY2VbaV0pOw0KICAgICAgICAgICAgICAgIHZpZGVvQ29udGFpbmVyLmZpbmQoInZpZGVvIikuYXBwZW5kKG5ld1NvdXJjZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBuZXdTb3VyY2UgPSBzb3VyY2VCdWlsZGVyKHNvdXJjZSk7DQogICAgICAgICAgICB2aWRlb0NvbnRhaW5lci5maW5kKCJ2aWRlbyIpLmFwcGVuZChuZXdTb3VyY2UpOw0KICAgICAgICB9DQogICAgfTsNCg0KICAgIFBsYXlsaXN0LnByb3RvdHlwZS5yZXBsYWNlU291cmNlID0gZnVuY3Rpb24gKGl0ZW1JbmRleCwgbG9hZEZyb21FdmVudCkgew0KICAgICAgICB2YXIgaW5zdCA9IHRoaXMsDQogICAgICAgICAgICB2aWRlb0NvbnRhaW5lciwNCiAgICAgICAgICAgIHZpZGVvQ2xvbmUsDQogICAgICAgICAgICBuZXdTcmMgPSBpbnN0LnByb3BlcnRpZXMuc291cmNlc1tpdGVtSW5kZXhdLnNyYywNCiAgICAgICAgICAgIHNvdXJjZXMsDQogICAgICAgICAgICB2aWRlb0lkLA0KICAgICAgICAgICAgdmlkZW9Db250YWluZXJIZWlnaHQgPSAwOw0KDQogICAgICAgICQoaW5zdC5wcm9wZXJ0aWVzLnBsYXlsaXN0SWQpLmVhY2goZnVuY3Rpb24gKCkgew0KICAgICAgICAgICAgdmlkZW9Db250YWluZXIgPSAkKHRoaXMpOw0KICAgICAgICAgICAgdmlkZW9JZCA9IGluc3QucHJvcGVydGllcy5wbGF5bGlzdElkOw0KDQogICAgICAgICAgICBpZiAoKHZpZGVvQ29udGFpbmVyLmlzKHZpZGVvSWQpICYmIChuZXdTcmMubGVuZ3RoKSkpIHsNCiAgICAgICAgICAgICAgICB2aWRlb0NvbnRhaW5lci5hZGRDbGFzcygic2hvdyIpOw0KDQogICAgICAgICAgICAgICAgLyptZWpzLnBsYXllcnNbaWRdLnBhdXNlKCk7DQogICAgICAgICAgICAgICAgbWVqcy5wbGF5ZXJzW2lkXS5zZXRTcmMobmV3U3JjKTsgICAgICAgIA0KICAgICAgICAgICAgICAgIG1lanMucGxheWVyc1tpZF0ubWVkaWEubG9hZCgpOw0KICAgICAgICAgICAgICAgIG1lanMucGxheWVyc1tpZF0ucGxheSgpOyovDQogICAgICAgICAgICAgICAgLyphYm92ZSBkb2VzZW50IHdvcmsgd2hlbiBjaG5hZ2luZyBiZWV0d2VlbiBob3N0ZWQgYW5kIHlvdXR1YmUgdmlkZW9zKi8NCg0KICAgICAgICAgICAgICAgIHNvdXJjZXMgPSB2aWRlb0NvbnRhaW5lci5maW5kKCJzb3VyY2UiKTsNCiAgICAgICAgICAgICAgICBzb3VyY2VzLnJlbW92ZSgpOw0KICAgICAgICAgICAgICAgIGluc3QuY3JlYXRlTmV3U291cmNlcyhuZXdTcmMsIHZpZGVvQ29udGFpbmVyKTsNCiAgICAgICAgICAgICAgICB2aWRlb0NvbnRhaW5lci5maW5kKCJ2aWRlbyIpLmF0dHIoew0KICAgICAgICAgICAgICAgICAgICBzcmM6ICIiDQogICAgICAgICAgICAgICAgfSkuc2hvdygpOw0KDQogICAgICAgICAgICAgICAgdmFyIGF1dG9wbGF5VmlkZW8gPSBmYWxzZTsNCiAgICAgICAgICAgICAgICBpZihsb2FkRnJvbUV2ZW50KXsNCiAgICAgICAgICAgICAgICAgICAgaWYoaW5zdC5wcm9wZXJ0aWVzLmF1dG9QbGF5U2VsZWN0ZWQpew0KICAgICAgICAgICAgICAgICAgICAgICAgYXV0b3BsYXlWaWRlbyA9IHRydWU7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIGlmIChpbnN0LnByb3BlcnRpZXMuYXV0b1BsYXkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9wbGF5VmlkZW8gPSB0cnVlOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgaWYoYXV0b3BsYXlWaWRlbykgew0KICAgICAgICAgICAgICAgICAgICB2aWRlb0NvbnRhaW5lci5maW5kKCJ2aWRlbyIpLmF0dHIoew0KICAgICAgICAgICAgICAgICAgICAgICAgYXV0b3BsYXk6ICIiDQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIHZpZGVvQ2xvbmUgPSB2aWRlb0NvbnRhaW5lci5maW5kKCJ2aWRlbyIpLmNsb25lKCk7DQogICAgICAgICAgICAgICAgdmlkZW9Db250YWluZXJIZWlnaHQgPSB2aWRlb0NvbnRhaW5lci5oZWlnaHQoKTsNCiAgICAgICAgICAgICAgICB2aWRlb0NvbnRhaW5lci5jc3Moew0KICAgICAgICAgICAgICAgICAgICAiaGVpZ2h0IjogdmlkZW9Db250YWluZXJIZWlnaHQNCiAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgIHZhciBpZCA9IHZpZGVvQ29udGFpbmVyLmZpbmQoIi5tZWpzLWNvbnRhaW5lciIpLmF0dHIoImlkIik7DQogICAgICAgICAgICAgICAgaWYgKGlkKSB7DQogICAgICAgICAgICAgICAgICAgICQoIiMiICsgaWQpLnJlbW92ZSgpOw0KICAgICAgICAgICAgICAgICAgICBkZWxldGUgbWVqcy5wbGF5ZXJzW2lkXTsNCiAgICAgICAgICAgICAgICAgICAgdmlkZW9Db250YWluZXIuZmluZCgiLmNvbXBvbmVudC1jb250ZW50IikuYXBwZW5kKHZpZGVvQ2xvbmUpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIHZhciBwbGF5ZXIgPSBYQS5jb21wb25lbnQudmlkZW8uaW5pdFZpZGVvRnJvbVBsYXlsaXN0KHZpZGVvQ29udGFpbmVyLCBpbnN0LnBsYXlsaXN0KTsNCiAgICAgICAgICAgICAgICB2aWRlb0NvbnRhaW5lci5jc3Moew0KICAgICAgICAgICAgICAgICAgICAiaGVpZ2h0IjogImF1dG8iDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgIH07DQoNCiAgICBQbGF5bGlzdC5wcm90b3R5cGUubG9hZFBsYXlsaXN0VmlkZW8gPSBmdW5jdGlvbigpIHsNCiAgICAgICAgdmFyIGluc3QgPSB0aGlzLA0KICAgICAgICAgICAgcGxheWxpc3RJdGVtcyA9ICQoaW5zdC5wbGF5bGlzdCkuZmluZCgiLnBsYXlsaXN0LWl0ZW0iKSwNCiAgICAgICAgICAgIGFjdGl2ZUxpc3RJdGVtOw0KDQogICAgICAgIGluc3QucGxheWxpc3RJdGVtcyA9IHBsYXlsaXN0SXRlbXMubGVuZ3RoOw0KICAgICAgICB2YXIgbG9hZFZpZGVvRnJvbVBsYXlsaXN0ID0gZnVuY3Rpb24obG9hZEZyb21FdmVudCkgew0KICAgICAgICAgICAgaW5zdC5yZXBsYWNlU291cmNlKGluc3QuYWN0aXZlVmlkZW8sIGxvYWRGcm9tRXZlbnQpOw0KICAgICAgICAgICAgYWN0aXZlTGlzdEl0ZW0gPSBwbGF5bGlzdEl0ZW1zLmVxKGluc3QuYWN0aXZlVmlkZW8pOw0KICAgICAgICAgICAgYWN0aXZlTGlzdEl0ZW0uYWRkQ2xhc3MoImFjdGl2ZSIpOw0KICAgICAgICAgICAgYWN0aXZlTGlzdEl0ZW0uc2libGluZ3MoKS5yZW1vdmVDbGFzcygiYWN0aXZlIik7DQogICAgICAgIH0NCg0KICAgICAgICBsb2FkVmlkZW9Gcm9tUGxheWxpc3QoKTsNCiAgICAgICAgJChpbnN0LnBsYXlsaXN0KS5vbigiY2hhbmdlLXZpZGVvIiwgZnVuY3Rpb24oZXZlbnQsIHByb3BlcnRpZXMpIHsNCiAgICAgICAgICAgIHZhciBsb2FkTmV3VmlkZW8gPSBmYWxzZTsNCg0KICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMpIHsNCiAgICAgICAgICAgICAgICBpZiAocHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eSgiYmFjayIpKSB7DQogICAgICAgICAgICAgICAgICAgIGluc3QuYWN0aXZlVmlkZW8tLTsNCiAgICAgICAgICAgICAgICAgICAgaWYgKGluc3QuYWN0aXZlVmlkZW8gPCAwKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LmFjdGl2ZVZpZGVvID0gMDsNCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWROZXdWaWRlbyA9IHRydWU7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBpbnN0LmFjdGl2ZVZpZGVvKys7DQogICAgICAgICAgICAgICAgICAgIGlmIChpbnN0LmFjdGl2ZVZpZGVvID09PSBpbnN0LnBsYXlsaXN0SXRlbXMpIHsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3QucHJvcGVydGllcy5yZXBlYXRBZnRlckFsbCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3QuYWN0aXZlVmlkZW8gPSAwOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWROZXdWaWRlbyA9IHRydWUNCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdC5hY3RpdmVWaWRlbyA9IGluc3QucGxheWxpc3RJdGVtcyAtIDE7DQogICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICBsb2FkTmV3VmlkZW8gPSB0cnVlOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGlmIChpbnN0LnByb3BlcnRpZXMucGxheU5leHQpIHsNCiAgICAgICAgICAgICAgICAgICAgaWYgKChpbnN0LmFjdGl2ZVZpZGVvICsgMSkgPD0gaW5zdC5wbGF5bGlzdEl0ZW1zKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBpbnN0LmFjdGl2ZVZpZGVvKys7DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0LmFjdGl2ZVZpZGVvID09PSBpbnN0LnBsYXlsaXN0SXRlbXMpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0LmFjdGl2ZVZpZGVvID0gMDsNCg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0LnByb3BlcnRpZXMucmVwZWF0QWZ0ZXJBbGwpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZE5ld1ZpZGVvID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3QuYWN0aVZpZGVvLS07DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZE5ld1ZpZGVvID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgaWYgKGxvYWROZXdWaWRlbykgew0KICAgICAgICAgICAgICAgIGxvYWRWaWRlb0Zyb21QbGF5bGlzdCh0cnVlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQogICAgfTsNCg0KICAgIFBsYXlsaXN0LnByb3RvdHlwZS5hdHRhY2hFdmVudHMgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgdmFyIGluc3QgPSB0aGlzLA0KICAgICAgICAgICAgbGluayA9ICQoaW5zdC5wbGF5bGlzdCkuZmluZCgiLnBsYXlsaXN0LXNlY3Rpb24gYSIpLA0KICAgICAgICAgICAgbmF2SXRlbXMgPSAkKGluc3QucGxheWxpc3QpLmZpbmQoIi5wbGF5bGlzdC1uYXYgYSIpLA0KICAgICAgICAgICAgcGxheWxpc3RJdGVtOw0KDQogICAgICAgIGxpbmsub24oImNsaWNrIiwgZnVuY3Rpb24oZXZlbnQpIHsNCiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoNCiAgICAgICAgICAgIHBsYXlsaXN0SXRlbSA9ICQodGhpcykucGFyZW50cygiLnBsYXlsaXN0LWl0ZW0iKTsNCiAgICAgICAgICAgIGl0ZW1JbmRleCA9IHBsYXlsaXN0SXRlbS5pbmRleCgpOw0KDQogICAgICAgICAgICBpZiAoaXRlbUluZGV4ICE9PSBpbnN0LmFjdGl2ZVZpZGVvKSB7DQogICAgICAgICAgICAgICAgcGxheWxpc3RJdGVtLmFkZENsYXNzKCJhY3RpdmUiKTsNCiAgICAgICAgICAgICAgICBwbGF5bGlzdEl0ZW0uc2libGluZ3MoKS5yZW1vdmVDbGFzcygiYWN0aXZlIik7DQogICAgICAgICAgICAgICAgaW5zdC5yZXBsYWNlU291cmNlKGl0ZW1JbmRleCwgdHJ1ZSk7DQogICAgICAgICAgICAgICAgaW5zdC5hY3RpdmVWaWRlbyA9IGl0ZW1JbmRleDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSk7DQoNCiAgICAgICAgbmF2SXRlbXMub24oImNsaWNrIiwgZnVuY3Rpb24oZXZlbnQpIHsNCiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQogICAgICAgICAgICB2YXIgcHJvcGVydGllcyA9IHt9Ow0KDQogICAgICAgICAgICBpZiAoJCh0aGlzKS5wYXJlbnQoKS5oYXNDbGFzcygicGxheWxpc3QtcHJldiIpKSB7DQogICAgICAgICAgICAgICAgcHJvcGVydGllcy5iYWNrID0gdHJ1ZTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgJChpbnN0LnBsYXlsaXN0KS50cmlnZ2VyKCJjaGFuZ2UtdmlkZW8iLCBwcm9wZXJ0aWVzKTsNCiAgICAgICAgfSk7DQoNCiAgICB9Ow0KDQoNCiAgICBhcGkuaW5pdCA9IGZ1bmN0aW9uKCkgew0KICAgICAgICB2YXIgcGxheWxpc3RzID0gJCgiLnBsYXlsaXN0LmNvbXBvbmVudDpub3QoLmluaXRpYWxpemVkKSIpLA0KICAgICAgICAgICAgcHJvcGVydGllcywNCiAgICAgICAgICAgIHBsYXlsaXN0Ow0KDQogICAgICAgIHBsYXlsaXN0cy5lYWNoKGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgcHJvcGVydGllcyA9ICQodGhpcykuZGF0YSgicHJvcGVydGllcyIpOw0KDQogICAgICAgICAgICAkKHByb3BlcnRpZXMucGxheWxpc3RJZCkuYWRkQ2xhc3MoImluaXRpYWxpemVkIik7IC8vcHJldmVudCB2aWRlbyBpbml0IGluIGNvbXBvbmVudC12aWRlby5qcw0KICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMuc291cmNlcy5sZW5ndGgpIHsNCiAgICAgICAgICAgICAgICBwbGF5bGlzdCA9IG5ldyBQbGF5bGlzdCh0aGlzLCBwcm9wZXJ0aWVzKTsNCiAgICAgICAgICAgICAgICBwbGF5bGlzdC5sb2FkUGxheWxpc3RWaWRlbygpOw0KICAgICAgICAgICAgICAgIHBsYXlsaXN0LmF0dGFjaEV2ZW50cygpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCJpbml0aWFsaXplZCIpOw0KICAgICAgICB9KTsNCiAgICB9Ow0KDQogICAgcmV0dXJuIGFwaTsNCn0oalF1ZXJ5LCBkb2N1bWVudCkpOw0KDQpYQS5yZWdpc3RlcigicGxheWxpc3QiLCBYQS5jb21wb25lbnQucGxheWxpc3QpOw0KWEEuY29tcG9uZW50LnZpZGVvID0gKGZ1bmN0aW9uKCQsIGRvY3VtZW50KSB7DQoNCiAgICB2YXIgYXBpID0ge307DQoNCiAgICBmdW5jdGlvbiBjaGVja1NpemUodmlkZW8pIHsNCiAgICAgICAgdmFyIHZpZGVvV2lkdGggPSB2aWRlby53aWR0aCgpOw0KICAgICAgICB2aWRlby5yZW1vdmVDbGFzcygidmlkZW8tc21hbGwgaGlkZS1jb250cm9scyIpOw0KDQogICAgICAgIGlmICgodmlkZW9XaWR0aCA8IDQ4MSkgJiYgKHZpZGVvV2lkdGggPj0gMzIxKSkgew0KICAgICAgICAgICAgdmlkZW8uYWRkQ2xhc3MoInZpZGVvLXNtYWxsIik7DQogICAgICAgIH0gZWxzZSBpZiAodmlkZW9XaWR0aCA8IDMyMSkgew0KICAgICAgICAgICAgdmlkZW8uYWRkQ2xhc3MoImhpZGUtY29udHJvbHMiKTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGZ1bmN0aW9uIGNoZWNrSUUxMSgpIHsNCiAgICAgICAgaWYgKG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL1RyaWRlbnRcLzcuMC8pKSB7DQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICB9DQoNCiAgICBmdW5jdGlvbiBpbml0VmlkZW8odmlkZW8sIHByb3BlcnRpZXMpIHsNCiAgICAgICAgdmFyIGNvbnRlbnQgPSB2aWRlby5maW5kKCJ2aWRlbyIpOw0KDQogICAgICAgIGlmKCFjb250ZW50Lmxlbmd0aCl7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIW1vdmllVHJhY2tlcikgew0KICAgICAgICAgICAgbW92aWVUcmFja2VyID0gWEFDb250ZXh0LlRyYWNraW5nLk1vdmllcygkKTsNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgdmFyIGNhbGxiYWNrID0gZnVuY3Rpb24obWVkaWFFbGVtZW50LCBkb21PYmplY3QpIHsNCiAgICAgICAgICAgIG1lZGlhRWxlbWVudC5tb3ZpZU5hbWUgPSAnTW92aWUnOw0KICAgICAgICAgICAgbW92aWVUcmFja2VyLnJlZ2lzdGVyKHsNCiAgICAgICAgICAgICAgICBuYW1lOiAnTW92aWUnLA0KICAgICAgICAgICAgICAgIGFwaTogbWVkaWFFbGVtZW50LA0KICAgICAgICAgICAgICAgIHRyYWNrZXJJZDogJ21lanMnLA0KICAgICAgICAgICAgICAgIGNvbXBsZXRlZFRpbWU6IG51bGwNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAkKG1lZGlhRWxlbWVudCkub24oImVuZGVkIiwgZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgaWYgKHByb3BlcnRpZXMuZnJvbVBsYXlsaXN0KSB7DQogICAgICAgICAgICAgICAgICAgICQocHJvcGVydGllcy5wbGF5bGlzdCkudHJpZ2dlcigiY2hhbmdlLXZpZGVvIik7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSk7DQogICAgICAgIH07DQoNCiAgICAgICAgJC5leHRlbmQocHJvcGVydGllcywgew0KICAgICAgICAgICAgInBsdWdpbnMiOiBbJ2ZsYXNoJywgJ3NpbHZlcmxpZ2h0J10sDQogICAgICAgICAgICAibW9kZSIgOiAic2hpbSIsDQogICAgICAgICAgICAic2lsdmVybGlnaHROYW1lIjogJ3NpbHZlcmxpZ2h0bWVkaWFlbGVtZW50LnhhcCcsDQogICAgICAgICAgICAic3VjY2VzcyI6IGNhbGxiYWNrDQogICAgICAgIH0pOw0KDQogICAgICAgIGlmIChjaGVja0lFMTEoKSkgew0KICAgICAgICAgICAgcHJvcGVydGllcyA9IG51bGw7DQogICAgICAgIH0NCg0KICAgICAgICBjb250ZW50LmF0dHIoew0KICAgICAgICAgICAgJ3dpZHRoJyA6IGNvbnRlbnQud2lkdGgoKSwNCiAgICAgICAgICAgICdoZWlnaHQnIDogY29udGVudC5oZWlnaHQoKQ0KICAgICAgICB9KTsNCg0KICAgICAgICByZXR1cm4gbmV3IE1lZGlhRWxlbWVudFBsYXllcihjb250ZW50LCBwcm9wZXJ0aWVzKTsNCiAgICB9DQoNCiAgICBhcGkuaW5pdFZpZGVvRnJvbVBsYXlsaXN0ID0gZnVuY3Rpb24odmlkZW8sIHBsYXlsaXN0KSB7DQogICAgICAgIHZhciBwcm9wZXJ0aWVzID0gJCh2aWRlbykuZGF0YSgicHJvcGVydGllcyIpOw0KDQogICAgICAgICQuZXh0ZW5kKHByb3BlcnRpZXMsIHsNCiAgICAgICAgICAgICJmcm9tUGxheWxpc3QiOiB0cnVlLA0KICAgICAgICAgICAgInBsYXlsaXN0IjogcGxheWxpc3QNCiAgICAgICAgfSk7DQoNCiAgICAgICAgcmV0dXJuIGluaXRWaWRlbyh2aWRlbywgcHJvcGVydGllcyk7DQogICAgfTsNCg0KDQogICAgYXBpLmluaXQgPSBmdW5jdGlvbigpIHsNCiAgICAgICAgaWYoWEEuY29tcG9uZW50Lmhhc093blByb3BlcnR5KCJwbGF5bGlzdCIpKXsNCiAgICAgICAgICAgIFhBLmNvbXBvbmVudC5wbGF5bGlzdC5pbml0KCk7DQogICAgICAgIH0NCg0KICAgICAgICB2YXIgdmlkZW8gPSAkKCIudmlkZW8uY29tcG9uZW50Om5vdCguaW5pdGlhbGl6ZWQpIik7DQoNCiAgICAgICAgdmlkZW8uZWFjaChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHZhciBwcm9wZXJ0aWVzID0gJCh0aGlzKS5kYXRhKCJwcm9wZXJ0aWVzIik7DQoNCiAgICAgICAgICAgIGluaXRWaWRlbygkKHRoaXMpLCBwcm9wZXJ0aWVzKTsNCiAgICAgICAgICAgIGNoZWNrU2l6ZSgkKHRoaXMpKTsNCg0KICAgICAgICAgICAgJCh3aW5kb3cpLnJlc2l6ZShmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICBjaGVja1NpemUoJCh0aGlzKSk7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygiaW5pdGlhbGl6ZWQiKTsNCiAgICAgICAgfSk7DQoNCiAgICAgICAgJChkb2N1bWVudCkub24oJ21vemZ1bGxzY3JlZW5jaGFuZ2UnLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7DQogICAgICAgICAgICAgICAgJCh3aW5kb3cpLnJlc2l6ZSgpOw0KICAgICAgICAgICAgfSwgMjAwKTsgLy9tb3ppbGxhIGJ1ZyBmaXgNCiAgICAgICAgfSk7DQogICAgfTsNCg0KICAgIHJldHVybiBhcGk7DQp9KGpRdWVyeSwgZG9jdW1lbnQpKTsNCg0KWEEucmVnaXN0ZXIoInZpZGVvIiwgWEEuY29tcG9uZW50LnZpZGVvKTsNClhBLmNvbXBvbmVudC5lcXVhbEhlaWdodCA9IChmdW5jdGlvbigkLCBjb25maWcpIHsKICAgIHZhciBzZXR0aW5ncyA9IHsKICAgICAgICBwYXJlbnRTZWxlY3RvcjogJy5lcXVhbGl6ZWQtY29udGVudCcsCiAgICAgICAgc2VsZWN0b3I6ICcuZXF1YWwnCiAgICB9OwoKICAgIHZhciBhcGkgPSB7fTsKCiAgICBmdW5jdGlvbiBmaXhIZWlnaHQoKSB7CgogICAgICAgICQoc2V0dGluZ3MucGFyZW50U2VsZWN0b3IpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciAkZWxlbWVudHMgPSAkKHRoaXMpLmZpbmQoc2V0dGluZ3Muc2VsZWN0b3IpLAogICAgICAgICAgICAgICAgbWF4SGVpZ2h0ID0gMCwKICAgICAgICAgICAgICAgIG1heFBhZGRpbmcgPSAwLAogICAgICAgICAgICAgICAgJGxpbmsgPSBudWxsOwoKICAgICAgICAgICAgJGVsZW1lbnRzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkKHRoaXMpLmNzcygnbWluLWhlaWdodCcsICdpbmhlcml0Jyk7CgogICAgICAgICAgICAgICAgJGxpbmsgPSAkKHRoaXMpLmZpbmQoJy5wcm9tby1saW5rJyk7CiAgICAgICAgICAgICAgICBpZiAoJGxpbmsubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgJGxpbmsgPSAkKHRoaXMpLmZpbmQoJy5zdW1tYXJ5LWxpbmsnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoJGxpbmsuY3NzKCdwb3NpdGlvbicpID09ICdhYnNvbHV0ZScpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJGxpbmsubGVuZ3RoICYmICRsaW5rLmhlaWdodCgpID4gbWF4UGFkZGluZykgewogICAgICAgICAgICAgICAgICAgICAgICBtYXhQYWRkaW5nID0gJGxpbmsuaGVpZ2h0KCkgKyBwYXJzZUludCgkbGluay5jc3MoJ3BhZGRpbmctdG9wJyksIDEwKSArIHBhcnNlSW50KCRsaW5rLmNzcygncGFkZGluZy1ib3R0b20nKSwgMTApICsgcGFyc2VJbnQoJGxpbmsuY3NzKCdtYXJnaW4tdG9wJyksIDEwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCQodGhpcykuaGVpZ2h0KCkgPiBtYXhIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBtYXhIZWlnaHQgPSAkKHRoaXMpLm91dGVySGVpZ2h0KHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAobWF4SGVpZ2h0ID4gMCkgewogICAgICAgICAgICAgICAgJGVsZW1lbnRzLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgJ3BhZGRpbmctYm90dG9tJzogbWF4UGFkZGluZywKICAgICAgICAgICAgICAgICAgICAnbWluLWhlaWdodCc6IG1heEhlaWdodAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KCiAgICBhcGkuaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICQod2luZG93KS5iaW5kKCdsb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZml4SGVpZ2h0LCAwKTsKICAgICAgICB9KTsKCiAgICAgICAgJCh3aW5kb3cpLmJpbmQoJ3Jlc2l6ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmaXhIZWlnaHQoKTsKICAgICAgICB9KTsKICAgIH07CgogICAgcmV0dXJuIGFwaTsKCn0oalF1ZXJ5LCBkb2N1bWVudCkpOwoKWEEucmVnaXN0ZXIoImVxdWFsSGVpZ2h0IiwgWEEuY29tcG9uZW50LmVxdWFsSGVpZ2h0KTsNClhBLmNvbXBvbmVudC5nZW9zcGF0aWFsc2VhcmNoID0gZnVuY3Rpb24oJCwgZG9jdW1lbnQpew0KICAgIHZhciBhcGkgPSB7fTsNCg0KICAgIGFwaS5pbml0ID0gZnVuY3Rpb24oKXsNCiAgICAgICAgdmFyIGdlb3NwYXRpYWwgPSAkKCJib2R5Lmdlb3NwYXRpYWwtc2VhcmNoIiksDQogICAgICAgICAgICBtYXAsDQogICAgICAgICAgICB0YXJnZXQsDQogICAgICAgICAgICBoZWFkZXIgPSAkKCIjaGVhZGVyIiksDQogICAgICAgICAgICBoOw0KICAgICAgICBpZihnZW9zcGF0aWFsLmxlbmd0aCAhPT0gMSl7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBtYXAgPSBnZW9zcGF0aWFsLmZpbmQoIi5jb21wb25lbnQubWFwIik7DQogICAgICAgIGdlb3NwYXRpYWwub24oImNsaWNrIixmdW5jdGlvbihhcmdzKXsNCiAgICAgICAgICAgIHRhcmdldCA9ICQoYXJncy50YXJnZXQpOw0KICAgICAgICAgICAgaWYodGFyZ2V0LnBhcmVudHMoIi5zZWFyY2gtcmVzdWx0LWxpc3QiKS5sZW5ndGggIT09IDApew0KICAgICAgICAgICAgICAgIGggPSBtYXAucG9zaXRpb24oKS50b3AgLSAzMDsNCiAgICAgICAgICAgICAgICBnZW9zcGF0aWFsLmFuaW1hdGUoe3Njcm9sbFRvcCA6IGh9LDMzMyk7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KICAgIH07DQoNCiAgICByZXR1cm4gYXBpOw0KfShqUXVlcnksIGRvY3VtZW50KTsNClhBLnJlZ2lzdGVyKCJnZW9zcGF0aWFsc2VhcmNoIixYQS5jb21wb25lbnQuZ2Vvc3BhdGlhbHNlYXJjaCk7DQoNClhBLmNvbXBvbmVudC5yZWxlYXNlbm90ZXMgPSBmdW5jdGlvbigkLGRvY3VtZW50KXsNCiAgICB2YXIgYXBpID0ge307DQoNCg0KICAgIGFwaS5pbml0ID0gZnVuY3Rpb24oKXsNCiAgICAgICAgYXBpLmJpc29uKCk7DQogICAgfTsNCg0KICAgIGFwaS5iaXNvbiA9IGZ1bmN0aW9uKCl7DQogICAgICAgIHZhciBwYWdlID0gJCgiLnJlbGVhc2Utbm90ZXMtYmlzb24iKSwNCiAgICAgICAgICAgIGhlYWRlciA9ICQoIiNoZWFkZXIiKTsNCiAgICAgICAgLy8gJChwYWdlLmZpbmQoIiNjb250ZW50IC5yb3c6bnRoLWNoaWxkKDIpIikpLmZpbmQoIi5jb21wb25lbnQuaW1hZ2UsIC5yaWNoLXRleHQiKS5hZGRDbGFzcygiYWN0aXZlIik7DQoNCiAgICAgICAgdmFyIGltYWdlcyA9IHBhZ2UuZmluZCgiI2NvbnRlbnQgLmNvbXBvbmVudC5pbWFnZSIpOw0KICAgICAgICBpbWFnZXMub24oImNsaWNrIixmdW5jdGlvbihhcmdzKXsNCiAgICAgICAgICAgIHZhciB0YXJnZXQgPSAkKGFyZ3MudGFyZ2V0KSwNCiAgICAgICAgICAgICAgICBjb21wb25lbnRJbWFnZTsNCiAgICAgICAgICAgIHBhZ2UuZmluZCgiLmFjdGl2ZSIpLnJlbW92ZUNsYXNzKCJhY3RpdmUiKTsNCiAgICAgICAgICAgIGNvbXBvbmVudEltYWdlID0gdGFyZ2V0LmlzKCIuY29tcG9uZW50LmltYWdlIikgPyB0YXJnZXQgOiB0YXJnZXQucGFyZW50cygiLmNvbXBvbmVudC5pbWFnZSIpOw0KICAgICAgICAgICAgY29tcG9uZW50SW1hZ2UuYWRkQ2xhc3MoImFjdGl2ZSIpOw0KICAgICAgICAgICAgY29tcG9uZW50SW1hZ2Uuc2libGluZ3MoIi5yaWNoLXRleHQiKS5hZGRDbGFzcygiYWN0aXZlIik7DQogICAgICAgICAgICBwYWdlLmZpbmQoIiNjb250ZW50IC5jb21wb25lbnQudGl0bGUiKS5hZGRDbGFzcygiaGlkZGVuIik7DQogICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0pOw0KDQogICAgICAgIHZhciBwYXJhbGxheCA9IHBhZ2UuZmluZCgiI2NvbnRlbnQgLnBhcmFsbGF4LWJhY2tncm91bmQiKTsNCiAgICAgICAgcGFyYWxsYXgub24oImNsaWNrIixmdW5jdGlvbihhcmdzKXsNCiAgICAgICAgICAgIHZhciB0YXJnZXQgPSAkKGFyZ3MudGFyZ2V0KTsNCiAgICAgICAgICAgIGlmKHRhcmdldC5wYXJlbnQoKS5oYXNDbGFzcygicGFyYWxsYXgtYmFja2dyb3VuZCIpIHx8DQogICAgICAgICAgICAodGFyZ2V0LnBhcmVudHMoIi5yaWNoLXRleHQiKS5sZW5ndGggPT09IDAgJiYgdGFyZ2V0LnBhcmVudHMoIi5jb21wb25lbnQuaW1hZ2UiKS5sZW5ndGggPT09IDAgJiYgIXRhcmdldC5pcygiLnJpY2gtdGV4dCIpICYmICF0YXJnZXQuaXMoIi5jb21wb25lbnQuaW1hZ2UiKSkpew0KICAgICAgICAgICAgICAgIHBhZ2UuZmluZCgiLmFjdGl2ZSIpLnJlbW92ZUNsYXNzKCJhY3RpdmUiKTsNCiAgICAgICAgICAgICAgICBwYWdlLmZpbmQoIiNjb250ZW50IC5jb21wb25lbnQudGl0bGUiKS5yZW1vdmVDbGFzcygiaGlkZGVuIik7DQogICAgICAgICAgICB9DQogICAgICAgIH0pOw0KDQogICAgICAgICQod2luZG93KS5vbigic2Nyb2xsIixmdW5jdGlvbihhcmdzKXsNCiAgICAgICAgICAgIGlmKHdpbmRvdy5zY3JvbGxZID49IDEwMCl7DQogICAgICAgICAgICAgICAgaGVhZGVyLmFkZENsYXNzKCJzY3JvbGxlZCIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSB7DQogICAgICAgICAgICAgICAgaGVhZGVyLnJlbW92ZUNsYXNzKCJzY3JvbGxlZCIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCiAgICB9Ow0KDQogICAgcmV0dXJuIGFwaTsNCn0oalF1ZXJ5LCBkb2N1bWVudCk7DQoNClhBLnJlZ2lzdGVyKCJyZWxlYXNlbm90ZXMiLFhBLmNvbXBvbmVudC5yZWxlYXNlbm90ZXMpOw0KDQpYQS5jb21wb25lbnQudXRpbHMgPSAoZnVuY3Rpb24gKCQsIGRvY3VtZW50KSB7DQoNCiAgICB2YXIgYXBpID0ge307DQoNCiAgICBmdW5jdGlvbiBhdHRhY2hFdmVudHMoaXRlbSkgew0KICAgICAgICB2YXIgJGl0ZW0gPSAkKGl0ZW0pLA0KICAgICAgICAgICAgJHNlYXJjaElucHV0ID0gJChpdGVtKS5wYXJlbnQoKS5maW5kKCcuc2VhcmNoLWJveCcpOw0KDQogICAgICAgICRpdGVtLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgJGl0ZW0udG9nZ2xlQ2xhc3MoJ2FjdGl2ZScpOw0KICAgICAgICAgICAgJHNlYXJjaElucHV0LnRvZ2dsZUNsYXNzKCdhY3RpdmUnKTsNCiAgICAgICAgfSk7DQoNCiAgICAgICAgJGl0ZW0uYWRkQ2xhc3MoImluaXRpYWxpemVkIik7DQogICAgfQ0KDQogICAgYXBpLmluaXQgPSBmdW5jdGlvbiAoKSB7DQogICAgICAgIHZhciBoZWFkZXJTZWFyY2hCdXR0b24gPSAkKCIuc2VhcmNoLWljb246bm90KC5pbml0aWFsaXplZCkiKTsNCg0KICAgICAgICBpZiAoaGVhZGVyU2VhcmNoQnV0dG9uLmxlbmd0aCA+IDApIHsNCiAgICAgICAgICAgIGF0dGFjaEV2ZW50cyhoZWFkZXJTZWFyY2hCdXR0b24pOw0KICAgICAgICB9DQogICAgfTsNCg0KICAgIHJldHVybiBhcGk7DQp9KGpRdWVyeSwgZG9jdW1lbnQpKTsNCg0KWEEucmVnaXN0ZXIoInV0aWxzIiwgWEEuY29tcG9uZW50LnV0aWxzKTsNCg==
- ID: "6954b7c7-2487-423f-8600-436cb3b6dc0e"
  Hint: Size
  Value: 171730
- ID: "6f47a0a5-9c94-4b48-abeb-42d38def6054"
  Hint: Mime Type
  Value: "application/x-javascript"
- ID: "c06867fe-9a43-4c7d-b739-48780492d06f"
  Hint: Extension
  Value: js
Languages:
- Language: en
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20170328T231913Z
    - ID: "5dd74568-4d4b-44c1-b513-0af5f4cda34f"
      Hint: __Created by
      Value: sitecore\Admin
